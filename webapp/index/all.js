var soy=soy||{};(function(){var a=navigator.userAgent;var b=a.indexOf("Opera")==0;soy.IS_OPERA_=b;soy.IS_IE_=!b&&a.indexOf("MSIE")!=-1;soy.IS_WEBKIT_=!b&&a.indexOf("WebKit")!=-1})();soy.StringBuilder=function(a,b){this.buffer_=soy.IS_IE_?[]:"";if(a!=null){this.append.apply(this,arguments)}};soy.StringBuilder.prototype.bufferLength_=0;soy.StringBuilder.prototype.append=function(a,b,c){if(soy.IS_IE_){if(b==null){this.buffer_[this.bufferLength_++]=a}else{this.buffer_.push.apply(this.buffer_,arguments);this.bufferLength_=this.buffer_.length}}else{this.buffer_+=a;if(b!=null){for(var d=1;d<arguments.length;d++){this.buffer_+=arguments[d]}}}return this};soy.StringBuilder.prototype.clear=function(){if(soy.IS_IE_){this.buffer_.length=0;this.bufferLength_=0}else{this.buffer_=""}};soy.StringBuilder.prototype.toString=function(){if(soy.IS_IE_){var a=this.buffer_.join("");this.clear();if(a){this.append(a)}return a}else{return(this.buffer_)}};soy.renderElement=function(a,b,c){a.innerHTML=b(c)};soy.renderAsFragment=function(a,b){var c=document.createElement("div");c.innerHTML=a(b);if(c.childNodes.length==1){return c.firstChild}else{var d=document.createDocumentFragment();while(c.firstChild){d.appendChild(c.firstChild)}return d}};soy.$$augmentData=function(a,b){function c(){}c.prototype=a;var d=new c();for(var e in b){d[e]=b[e]}return d};soy.$$escapeHtml=function(a){a=String(a);if(!soy.$$EscapeHtmlRe_.ALL_SPECIAL_CHARS.test(a)){return a}if(a.indexOf("&")!=-1){a=a.replace(soy.$$EscapeHtmlRe_.AMP,"&amp;")}if(a.indexOf("<")!=-1){a=a.replace(soy.$$EscapeHtmlRe_.LT,"&lt;")}if(a.indexOf(">")!=-1){a=a.replace(soy.$$EscapeHtmlRe_.GT,"&gt;")}if(a.indexOf('"')!=-1){a=a.replace(soy.$$EscapeHtmlRe_.QUOT,"&quot;")}return a};soy.$$EscapeHtmlRe_={ALL_SPECIAL_CHARS:/[&<>\"]/,AMP:/&/g,LT:/</g,GT:/>/g,QUOT:/\"/g};soy.$$escapeJs=function(a){a=String(a);var b=[];for(var c=0;c<a.length;c++){b[c]=soy.$$escapeChar(a.charAt(c))}return b.join("")};soy.$$escapeChar=function(a){if(a in soy.$$escapeCharJs_){return soy.$$escapeCharJs_[a]}var b=a;var c=a.charCodeAt(0);if(c>31&&c<127){b=a}else{if(c<256){b="\\x";if(c<16||c>256){b+="0"}}else{b="\\u";if(c<4096){b+="0"}}b+=c.toString(16).toUpperCase()}return soy.$$escapeCharJs_[a]=b};soy.$$escapeCharJs_={"\b":"\\b","\f":"\\f","\n":"\\n","\r":"\\r","\t":"\\t","\x0B":"\\x0B",'"':'\\"',"'":"\\'","\\":"\\\\"};soy.$$escapeUri=function(a){a=String(a);if(!soy.$$ENCODE_URI_REGEXP_.test(a)){return encodeURIComponent(a)}else{return a}};soy.$$ENCODE_URI_REGEXP_=/^[a-zA-Z0-9\-_.!~*'()]*$/;soy.$$insertWordBreaks=function(a,b){a=String(a);var c=[];var d=0;var e=false;var g=false;var f=0;var j=0;for(var h=0,k=a.length;h<k;++h){var i=a.charCodeAt(h);if(f>=b&&i!=soy.$$CharCode_.SPACE){c[d++]=a.substring(j,h);j=h;c[d++]=soy.WORD_BREAK_;f=0}if(e){if(i==soy.$$CharCode_.GREATER_THAN){e=false}}else{if(g){switch(i){case soy.$$CharCode_.SEMI_COLON:g=false;++f;break;case soy.$$CharCode_.LESS_THAN:g=false;e=true;break;case soy.$$CharCode_.SPACE:g=false;f=0;break}}else{switch(i){case soy.$$CharCode_.LESS_THAN:e=true;break;case soy.$$CharCode_.AMPERSAND:g=true;break;case soy.$$CharCode_.SPACE:f=0;break;default:++f;break}}}}c[d++]=a.substring(j);return c.join("")};soy.$$CharCode_={SPACE:32,AMPERSAND:38,SEMI_COLON:59,LESS_THAN:60,GREATER_THAN:62};soy.WORD_BREAK_=soy.IS_WEBKIT_?"<wbr></wbr>":soy.IS_OPERA_?"&shy;":"<wbr>";soy.$$changeNewlineToBr=function(a){a=String(a);if(!soy.$$CHANGE_NEWLINE_TO_BR_RE_.test(a)){return a}return a.replace(/(\r\n|\r|\n)/g,"<br>")};soy.$$CHANGE_NEWLINE_TO_BR_RE_=/[\r\n]/;soy.$$bidiTextDir=function(a,b){a=soy.$$bidiStripHtmlIfNecessary_(a,b);if(!a){return 0}return soy.$$bidiDetectRtlDirectionality_(a)?-1:1};soy.$$bidiDirAttr=function(a,b,c){var d=soy.$$bidiTextDir(b,c);if(d!=a){return d<0?"dir=rtl":d>0?"dir=ltr":""}return""};soy.$$bidiMarkAfter=function(a,b,c){var d=soy.$$bidiTextDir(b,c);return soy.$$bidiMarkAfterKnownDir(a,d,b,c)};soy.$$bidiMarkAfterKnownDir=function(a,b,c,d){return(a>0&&(b<0||soy.$$bidiIsRtlExitText_(c,d))?"\u200E":a<0&&(b>0||soy.$$bidiIsLtrExitText_(c,d))?"\u200F":"")};soy.$$bidiStripHtmlIfNecessary_=function(a,b){return b?a.replace(soy.$$BIDI_HTML_SKIP_RE_," "):a};soy.$$BIDI_HTML_SKIP_RE_=/<[^>]*>|&[^;]+;/g;soy.$$bidiSpanWrap=function(a,b){b=String(b);var c=soy.$$bidiTextDir(b,true);var d=soy.$$bidiMarkAfterKnownDir(a,c,b,true);if(c>0&&a<=0){b="<span dir=ltr>"+b+"</span>"}else{if(c<0&&a>=0){b="<span dir=rtl>"+b+"</span>"}}return b+d};soy.$$bidiUnicodeWrap=function(a,b){b=String(b);var c=soy.$$bidiTextDir(b,true);var d=soy.$$bidiMarkAfterKnownDir(a,c,b,true);if(c>0&&a<=0){b="\u202A"+b+"\u202C"}else{if(c<0&&a>=0){b="\u202B"+b+"\u202C"}}return b+d};soy.$$bidiLtrChars_="A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02B8\u0300-\u0590\u0800-\u1FFF\u2C00-\uFB1C\uFDFE-\uFE6F\uFEFD-\uFFFF";soy.$$bidiNeutralChars_="\u0000-\u0020!-@[-`{-\u00BF\u00D7\u00F7\u02B9-\u02FF\u2000-\u2BFF";soy.$$bidiRtlChars_="\u0591-\u07FF\uFB1D-\uFDFD\uFE70-\uFEFC";soy.$$bidiRtlDirCheckRe_=new RegExp("^[^"+soy.$$bidiLtrChars_+"]*["+soy.$$bidiRtlChars_+"]");soy.$$bidiNeutralDirCheckRe_=new RegExp("^["+soy.$$bidiNeutralChars_+"]*$|^http://");soy.$$bidiIsRtlText_=function(a){return soy.$$bidiRtlDirCheckRe_.test(a)};soy.$$bidiIsNeutralText_=function(a){return soy.$$bidiNeutralDirCheckRe_.test(a)};soy.$$bidiRtlDetectionThreshold_=0.4;soy.$$bidiRtlWordRatio_=function(a){var b=0;var c=0;var d=a.split(" ");for(var e=0;e<d.length;e++){if(soy.$$bidiIsRtlText_(d[e])){b++;c++}else{if(!soy.$$bidiIsNeutralText_(d[e])){c++}}}return c==0?0:b/c};soy.$$bidiDetectRtlDirectionality_=function(a){return soy.$$bidiRtlWordRatio_(a)>soy.$$bidiRtlDetectionThreshold_};soy.$$bidiLtrExitDirCheckRe_=new RegExp("["+soy.$$bidiLtrChars_+"][^"+soy.$$bidiRtlChars_+"]*$");soy.$$bidiRtlExitDirCheckRe_=new RegExp("["+soy.$$bidiRtlChars_+"][^"+soy.$$bidiLtrChars_+"]*$");soy.$$bidiIsLtrExitText_=function(a,b){a=soy.$$bidiStripHtmlIfNecessary_(a,b);return soy.$$bidiLtrExitDirCheckRe_.test(a)};soy.$$bidiIsRtlExitText_=function(a,b){a=soy.$$bidiStripHtmlIfNecessary_(a,b);return soy.$$bidiRtlExitDirCheckRe_.test(a)};

if(!this.JSON){this.JSON={}}(function(){function m(e){return e<10?"0"+e:e}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(e){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+m(this.getUTCMonth()+1)+"-"+m(this.getUTCDate())+"T"+m(this.getUTCHours())+":"+m(this.getUTCMinutes())+":"+m(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(e){return this.valueOf()}}var p=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,q=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,i,n,s={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},k;function r(g){q.lastIndex=0;return q.test(g)?'"'+g.replace(q,function(a){var e=s[a];return typeof e==="string"?e:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+g+'"'}function o(e,g){var c,f,d,j,l=i,h,b=g[e];if(b&&typeof b==="object"&&typeof b.toJSON==="function"){b=b.toJSON(e)}if(typeof k==="function"){b=k.call(g,e,b)}switch(typeof b){case"string":return r(b);case"number":return isFinite(b)?String(b):"null";case"boolean":case"null":return String(b);case"object":if(!b){return"null"}i+=n;h=[];if(Object.prototype.toString.apply(b)==="[object Array]"){j=b.length;for(c=0;c<j;c+=1){h[c]=o(c,b)||"null"}d=h.length===0?"[]":i?"[\n"+i+h.join(",\n"+i)+"\n"+l+"]":"["+h.join(",")+"]";i=l;return d}if(k&&typeof k==="object"){j=k.length;for(c=0;c<j;c+=1){f=k[c];if(typeof f==="string"){d=o(f,b);if(d){h.push(r(f)+(i?": ":":")+d)}}}}else{for(f in b){if(Object.hasOwnProperty.call(b,f)){d=o(f,b);if(d){h.push(r(f)+(i?": ":":")+d)}}}}d=h.length===0?"{}":i?"{\n"+i+h.join(",\n"+i)+"\n"+l+"}":"{"+h.join(",")+"}";i=l;return d}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(e,g,c){var f;i="";n="";if(typeof c==="number"){for(f=0;f<c;f+=1){n+=" "}}else{if(typeof c==="string"){n=c}}k=g;if(g&&typeof g!=="function"&&(typeof g!=="object"||typeof g.length!=="number")){throw new Error("JSON.stringify");}return o("",{"":e})}}JSON.parse=function(j,l){var h;function b(e,g){var c,f,d=e[g];if(d&&typeof d==="object"){for(c in d){if(Object.hasOwnProperty.call(d,c)){f=b(d,c);if(f!==undefined){d[c]=f}else{delete d[c]}}}}return l.call(e,g,d)}j=String(j);p.lastIndex=0;if(p.test(j)){j=j.replace(p,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(j.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){h=eval("("+j+")");return typeof l==="function"?b({"":h},""):h}throw new SyntaxError("JSON.parse");}}());

(function(){var r=/^<(\w+)((?:\s+\w+(?:\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+))?)*)\s*(\/?)>/,s=/^<\/(\w+)[^>]*>/,v=/(\w+)(?:\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|([^>\s]+)))?/g;var w=o("area,base,basefont,br,col,frame,hr,img,input,isindex,link,meta,param,embed");var x=o("address,applet,blockquote,button,center,dd,del,dir,div,dl,dt,fieldset,form,frameset,hr,iframe,ins,isindex,li,map,menu,noframes,noscript,object,ol,p,pre,script,table,tbody,td,tfoot,th,thead,tr,ul");var y=o("a,abbr,acronym,applet,b,basefont,bdo,big,br,button,cite,code,del,dfn,em,font,i,iframe,img,input,ins,kbd,label,map,object,q,s,samp,script,select,small,span,strike,strong,sub,sup,textarea,tt,u,var");var z=o("colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr");var A=o("checked,compact,declare,defer,disabled,ismap,multiple,nohref,noresize,noshade,nowrap,readonly,selected");var B=o("script,style");var t=this.HTMLParser=function(a,f,p){var p=$.extend({removeUnOpenedTags:true,closeOpenedTags:true},p);var j,i,n,h=[],u=a;h.last=function(){return this[this.length-1]};while(a){i=true;if(!h.last()||!B[h.last()]){if(a.indexOf("<!--")==0){j=a.indexOf("-->");if(j>=0){if(f.comment){f.comment(a.substring(4,j))}a=a.substring(j+3);i=false}}else{if(a.indexOf("</")==0){n=a.match(s);if(n){a=a.substring(n[0].length);n[0].replace(s,q);i=false}}else{if(a.indexOf("<")==0){n=a.match(r);if(n){a=a.substring(n[0].length);n[0].replace(r,C);i=false}}}}if(i){j=a.indexOf("<");var D=j<0?a:a.substring(0,j);a=j<0?"":a.substring(j);if(f.chars){f.chars(D)}}}else{a=a.replace(new RegExp("(.*?)</"+h.last()+"[^>]*>"),function(c,d){d=d.replace(/<!--(.*?)-->/g,"$1").replace(/<!\[CDATA\[(.*?)]]>/g,"$1");if(f.chars){f.chars(d)}return""});q("",h.last())}if(a==u){throw"Parse Error: "+a;}u=a}if(p.closeOpenedTags){q()}function C(e,k,l,b){if(x[k]){while(h.last()&&y[h.last()]){q("",h.last())}}if(z[k]&&h.last()==k){q("",k)}b=w[k]||!!b;if(!b){h.push(k)}if(f.start){var m=[];l.replace(v,function(c,d){var g=arguments[2]?arguments[2]:arguments[3]?arguments[3]:arguments[4]?arguments[4]:A[d]?d:"";m.push({name:d,value:g,escaped:g.replace(/(^|[^\\])"/g,'$1\\"')})});if(f.start){f.start(k,m,b)}}}function q(c,d){if(!d){var g=0}else{for(var g=h.length-1;g>=0;g--){if(h[g]==d){break}}}if(g>=0){for(var e=h.length-1;e>=g;e--){if(f.end){f.end(h[e])}}h.length=g}else{if(!p.removeUnOpenedTags){f.end(d)}}}};this.HTMLtoXML=function(k){var l="";t(k,{start:function(c,d,g){l+="<"+c;for(var e=0;e<d.length;e++){l+=" "+d[e].name+'="'+d[e].escaped+'"'}l+=(g?"/":"")+">"},end:function(c){l+="</"+c+">"},chars:function(c){l+=c},comment:function(c){l+="<!--"+c+"-->"}});return l};this.HTMLtoDOM=function(l,b){var m=o("html,head,body,title");var a={link:"head",base:"head"};if(!b){if(typeof DOMDocument!="undefined"){b=new DOMDocument()}else{if(typeof document!="undefined"&&document.implementation&&document.implementation.createDocument){b=document.implementation.createDocument("","",null)}else{if(typeof ActiveX!="undefined"){b=new ActiveXObject("Msxml.DOMDocument")}}}}else{b=b.ownerDocument||b.getOwnerDocument&&b.getOwnerDocument()||b}var f=[],p=b.documentElement||b.getDocumentElement&&b.getDocumentElement();if(!p&&b.createElement){(function(){var c=b.createElement("html");var d=b.createElement("head");d.appendChild(b.createElement("title"));c.appendChild(d);c.appendChild(b.createElement("body"));b.appendChild(c)})()}if(b.getElementsByTagName){for(var j in m){m[j]=b.getElementsByTagName(j)[0]}}var i=m.body;t(l,{start:function(c,d,g){if(m[c]){i=m[c];return}var e=b.createElement(c);for(var k in d){e.setAttribute(d[k].name,d[k].value)}if(a[c]&&typeof m[a[c]]!="boolean"){m[a[c]].appendChild(e)}else{if(i&&i.appendChild){i.appendChild(e)}}if(!g){f.push(e);i=e}},end:function(c){f.length-=1;i=f[f.length-1]},chars:function(c){i.appendChild(b.createTextNode(c))},comment:function(c){}});return b};function o(c){var d={},g=c.split(",");for(var e=0;e<g.length;e++){d[g[e]]=true}return d}})();

var DatePicker={version:0.31,constantHeight:false,useDropForYear:false,useDropForMonth:false,yearsPriorInDrop:5,yearsNextInDrop:10,year:new Date().getFullYear(),firstDayOfWeek:0,abbreviateMonthInLink:true,abbreviateYearInLink:false,showDaySuffixInLink:false,showDaySuffixInCalendar:false,largeCellSize:22,urlBase:null,showCancelLink:true,_idsToHide:[],_allowNil:[],_allowNone:[],_allowNilText:[],_allowNoneText:[],_priorLinkText:[],_priorDate:[],months:"January,February,March,April,May,June,July,August,September,October,November,December".split(","),days:"Sun,Mon,Tue,Wed,Thu,Fri,Sat".split(","),toggleDatePicker:function(b,c,e,g,h,f){var j=this.findCalendarElement(b);if(j.css("display")=="block"){j.css("display","none");j.html("");this._idsToHide[b].forEach(function(a){$(a).css("visibility","visible")})}else{f.forEach(function(a){$(a).css("visibility","hidden")});j.css("display","block");this._idsToHide[b]=f;this._allowNil[b]=c;this._allowNilText[b]=e;this._allowNone[b]=g;this._allowNoneText[b]=h;this._priorLinkText[b]=this.findLinkElement(b).html();this._priorDate[b]=$(b).val();this.writeCalendar(b)}},cancel:function(b){this.findLinkElement(b).html(this._priorLinkText[b]);$(b).val(this._priorDate[b]);this.findCalendarElement(b).css("display","none");this._idsToHide[b].forEach(function(a){$(a).css("visibility","visible")})},unclipDates:function(a,b){if(b.getDate()!=a.getDate()){b=new Date(b.getFullYear(),b.getMonth(),0)}return b},changeCalendar:function(a,b){var c=this.getSelectedDate(a),e;if(b%12==0){e=new Date(c.getFullYear()+b/12,c.getMonth(),c.getDate())}else{if(c.getMonth()==0&&b==-1){e=new Date(c.getFullYear()-1,11,c.getDate())}else{e=new Date(c.getFullYear(),c.getMonth()+b,c.getDate())}}e=this.unclipDates(c,e);ansi_date=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate();this.setDate(a,ansi_date);this.writeCalendar(a)},setDate:function(a,b){if(this._allowNil[a]&&b==""){this.findLinkElement(a).html(this._allowNilText[a])}else{if(this._allowNone[a]&&(b=="none")){this.findLinkElement(a).html(this._allowNoneText[a])}else{var c=(this.showDaySuffixInLink?this.formatDay(b.split("-")[2]):b.split("-")[2]);var e=(this.abbreviateYearInLink?b.split("-")[0].substring(2,4):b.split("-")[0]);var g=this.getMonthName(Number(b.split("-")[1])-1);if(g){if(this.abbreviateMonthInLink){g=g.substring(0,3)}this.findLinkElement(a).html(e+" "+g+" "+c)}}}$(a).val(b)},pickDate:function(a,b){this.setDate(a,b);this.toggleDatePicker(a);if(this.urlBase){document.location.href=this.urlBase+b}},getMonthName:function(a){return this.months[a]},dateFromAnsiDate:function(a){return new Date(a.split("-")[0],Number(a.split("-")[1])-1,a.split("-")[2])},ansiDateFromDate:function(a){alert(a.getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate())},getSelectedDate:function(a){if($(a).val()==""||$(a).val()=="none"){return new Date()}return this.dateFromAnsiDate($(a).val())},makeChangeCalendarLink:function(a,b,c){return('<a href="#" onclick="DatePicker.changeCalendar(\''+a+"',"+c+'); return false;">'+b+"</a>")},formatDay:function(a){var b;switch(String(a)){case"1":case"21":case"31":b="st";break;case"2":case"22":b="nd";break;case"3":case"23":b="rd";break;default:b="th"}return a+b},writeMonth:function(a,b){if(this.useDropForMonth){var c="";for(i in this.months){sel=(i==this.getSelectedDate(a).getMonth()?'selected="selected" ':"");c+="<option "+sel+'value="'+i+'">'+this.getMonthName(i)+"</option>"}return"<select onchange=\"DatePicker.selectMonth('"+a+"', this.value)\">"+c+"</select>"}else{return this.getMonthName(b)}},writeYear:function(a,b){if(this.useDropForYear){var c=this.year-this.yearsPriorInDrop;var e=this.year+this.yearsNextInDrop;var g="";for(i=c;i<e;i++){sel=(i==this.getSelectedDate(a).getFullYear()?'selected="selected" ':"");g+="<option "+sel+'value="'+i+'">'+i+"</option>"}return"<select onchange=\"DatePicker.selectYear('"+a+"', this.value)\">"+g+"</select>"}else{return b}},selectMonth:function(a,b){d=this.getSelectedDate(a);d2=new Date(d.getFullYear(),b,d.getDate());d2=this.unclipDates(d,d2);this.setDate(a,d2.getFullYear()+"-"+(Number(b)+1)+"-"+d2.getDate());this.writeCalendar(a)},selectYear:function(a,b){d=this.getSelectedDate(a);d2=new Date(b,d.getMonth(),d.getDate());d2=this.unclipDates(d,d2);this.setDate(a,b+"-"+(d2.getMonth()+1)+"-"+d2.getDate());this.writeCalendar(a)},writeCalendar:function(a){var b=this.getSelectedDate(a);var c=new Date();var e=new Date(b.getFullYear(),b.getMonth(),1).getDay();var g=new Date(b.getFullYear(),b.getMonth()+1,0).getDate();var h=1;this.findLinkElement(a).html(this.findLinkElement(a).html());var f='<table cellspacing="0" cellpadding="0" border="0">';f+="<tr>";f+='<th style="text-align:left">'+this.makeChangeCalendarLink(a,"<img src='/images/previous.png' alt='Previous' />",-1)+'</th><th colspan="5">'+this.writeYear(a,b.getFullYear())+" "+this.writeMonth(a,b.getMonth())+'</th><th style="text-align:right">'+this.makeChangeCalendarLink(a,"<img src='/images/next.png' alt='Next' />",1)+"</th>";f+='</tr><tr class="day_labels">';for(var j=0;j<this.days.length;j++){f+="<th>"+this.days[(j+this.firstDayOfWeek)%7]+"</th>"}f+="</tr>";for(rows=1;rows<7&&(this.constantHeight||h<=g);rows++){f+="<tr>";for(var k=0;k<this.days.length;k++){var l=(this.firstDayOfWeek+k)%7;if((l>=e||h>1)&&(h<=g)){args=[a,(b.getFullYear()+"-"+(b.getMonth()+1)+"-"+h)];cellstyle=(this.selectMonth?'style="width: '+this.largeCellSize+'px"':"");cellclass="";if(c.getFullYear()==b.getFullYear()&&c.getMonth()==b.getMonth()&&c.getDate()==h){cellclass+="today"}if(b.getDate()==h){cellclass+=" selected"}f+="<td "+cellstyle+" class='"+cellclass+'\'><a href="#" onclick="DatePicker.pickDate(\''+args.join("','")+"'); return false;\">"+h+"</a></td>";h++}else{f+="<td>&nbsp;</td>"}}f+="</tr>"}f+="</table>";if(this.showCancelLink){f+='<div class="actions"><span class="nil_butt">'+(this._allowNil[a]?'<a href="#" onclick="DatePicker.pickDate(\''+a+"', ''); return false;\">"+this._allowNilText[a]+"</a>":"")+'</span><span class="nil_butt">'+(this._allowNone[a]?'<a href="#" onclick="DatePicker.pickDate(\''+a+"', 'none'); return false;\">"+(this._allowNilText[a]?" | ":"")+this._allowNoneText[a]+"</a>":"")+'</span><span class="cancel_butt"><a href="#" onclick="DatePicker.cancel(\''+a+"'); return false;\">Cancel</a></span></div>"}this.findCalendarElement(a).html(f)},findCalendarElement:function(a){return $(a+"_calendar")},findLinkElement:function(a){return $(a+"_link")}};

function typeOf(c){var e=typeof c;if(e==="object"){if(c){if(typeof c.length==="number"&&!(c.propertyIsEnumerable("length"))){if(typeof c.splice==="function"){e="array"}else{e="string"}}else{if(c instanceof Date){e="date"}else{if(typeof c=="boolean"||c instanceof Boolean){e="boolean"}else{if(typeof c=="number"||c instanceof Number){e="number"}}}}}else{e="null"}}return e}function isEmpty(object){for(var c in object){if(object.hasOwnProperty(c)){return false}}return true}function jsonToString(d){var f="{";$.each(d,function(c,e){f+=c+": "+e+", "});f=f.slice(0,f.length-2)+"}";return f}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(c){var e=this.length>>>0;var d=Number(arguments[1])||0;if(d<0){d+=e}for(;d<e;d++){if(d in this&&this[d]===c){return d}}return-1}}if(!Array.prototype.lastIndexOf){Array.prototype.lastIndexOf=function(c){var e=this.length;var d=Number(arguments[1]);if(isNaN(d)){d=e-1}else{if(d<0){d+=e}else{if(d>=e){d=e-1}}}for(;d>-1;d--){if(d in this&&this[d]===c){return d}}return-1}}if(!Array.prototype.map){Array.prototype.map=function(c){var e=this.length>>>0;if(typeof c!="function"){throw new TypeError();}var d=new Array(e);var f=arguments[1];for(var g=0;g<e;g++){if(g in this){d[g]=c.call(f,this[g],g,this)}}return d}}if(!Array.prototype.filter){Array.prototype.filter=function(c){var e=this.length>>>0;if(typeof c!="function"){throw new TypeError();}var d=new Array();var f=arguments[1];for(var g=0;g<e;g++){if(g in this){var m=this[g];if(c.call(f,m,g,this)){d.push(m)}}}return d}}if(!Array.prototype.forEach){Array.prototype.forEach=function(c){var e=this.length>>>0;if(typeof c!="function"){throw new TypeError();}var d=arguments[1];for(var f=0;f<e;f++){if(f in this){c.call(d,this[f],f,this)}}}}if(!Array.prototype.every){Array.prototype.every=function(c){var e=this.length>>>0;if(typeof c!="function"){throw new TypeError();}var d=arguments[1];for(var f=0;f<e;f++){if(f in this&&!c.call(d,this[f],f,this)){return false}}return true}}if(!Array.prototype.sortByExpression){Array.prototype.sortByExpression=function(n){if(!this.length||this.length<=1){return this}var o=this;if(n){if(typeOf(n)!="array"){n=n.split(",")}var p=[];n.map(function(c,e){var d="ASC";var f=c.trim();var g=f.match(/.+(?=(\s+(desc|asc)))/i);if(g!=null){f=g[0].trim();if(g[2]&&g[2].toUpperCase()!="ASC"){d="DESC"}}var object=o[0];var m=f;if(!f.match(/\bobject\./)){m="object."+f}if(eval(m)instanceof Date){f="("+m+").getTime()"}p.push({field:f,order:d,isExpression:!!f.match(/\bobject\./)})});$.each(o,function(c,object){object._expressions=[]});var result,h,j,k,l;o.sort(function(object,b){result=0;h=-1;do{h++;j=p[h];k=l=null;try{if(j.isExpression){k=object._expressions[h]=object._expressions[h]||eval(j.field);l=b._expressions[h]=b._expressions[h]||eval(j.field.replace(/object\./g,"b."));k=object._expressions[h];l=b._expressions[h]}else{k=object[j.field];l=b[j.field]}}catch(exc){}if(k==l){result=0}else{if((k>l&&j.order=="ASC")||(k<l&&j.order=="DESC")){result=1}else{result=-1}}}while(result==0&&h<p.length-1);return result})}return o}}Array.prototype.remove=function(object){var c=-1;do{c=this.indexOf(object);if(c>=0){this.splice(c,1)}}while(c>=0);return this};Array.prototype.pushUnique=function(object){var c=this.indexOf(object);if(c<0){this.push(object)}return this};Array.prototype.pushUniqueId=function(object,c){c=c||"id";var e=-1;for(i=this.length-1;i>=0;i--){if(this[i][c]==object[c]){e=i;break}}if(e>=0){this[e]=object}else{this.push(object)}return this};if(!Array.prototype.intersect){Array.prototype.intersect=function(d){if(!(d instanceof Array)){d=[d]}if(this==[]||d==[]){return[]}var result=[];var self=this;$.each(this,function(c,e){if(d.indexOf(e)>=0){result.push(e)}});return result}}Array.prototype.first=function(){return this[0]};Array.prototype.last=function(){var a=this;return a[a.length-1]};if(!Array.prototype.include){Array.prototype.include=function(object){return this.indexOf(object)>=0}}if(!String.prototype.endsWith){String.prototype.endsWith=function(c){if(c.length>this.length){return false}return this.lastIndexOf(c)==(this.length-c.length)}}blank=function(c){return(c==null||c.length<=0)};if(!String.prototype.humanize){String.prototype.humanize=function(){var c=this.replace(/_/g," ").capitalize();if(c.endsWith("_id")){c=c.slice(0,-3)}return c}}if(!String.prototype.camelize){String.prototype.camelize=function(){var e=this;var d=e.split("_");var f=d.map(function(c){return c.humanize()}).join("");return f}}if(!String.prototype.capitalize){String.prototype.capitalize=function(){var f=this;f=f.toString();if(f.length){if(f.include("_")){f=f.replace("_"," ")}return f.replace(/(^|\s)([a-z])/g,function(c,e,d){return e+d.toUpperCase()})}else{return f}}}if(!String.prototype.include){String.prototype.include=function(c){return this.indexOf(c)>=0}}String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};String.prototype.ltrim=function(){return this.replace(/^\s+/g,"")};String.prototype.rtrim=function(){return this.replace(/\s+$/g,"")};if(!Date.prototype.justDate){Date.prototype.justDate=function(){var c=this;var result=new Date(c.getFullYear(),c.getMonth(),c.getDate());return result}}if(!Date.prototype.equals){Date.prototype.equals=function(c){return this.toString()==c.toString()}}monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];if(!Date.prototype.getMonthNameShort){Date.prototype.getMonthNameShort=function(){return monthNames[this.getMonth()].substr(0,3)}}if(!Date.prototype.getMonthName){Date.prototype.getMonthName=function(){return monthNames[this.getMonth()]}}dayNames=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];if(!Date.prototype.getDayName){Date.prototype.getDayName=function(){return dayNames[this.getDay()]}}if(!Date.prototype.getDayNameShort){Date.prototype.getDayNameShort=function(){return dayNames[this.getDay()-1].substr(0,3)}}if(!Date.prototype.getTime12H){Date.prototype.getTime12H=function(){var c=this.getHours();var e=this.getMinutes();var d="";if(e<=9){e="0"+e}if(c>12){c=c-12;d="pm"}else{d="am"}if(c==12){d="pm"}if(c==0){c="12"}return c+":"+e+d}}if(!Date.prototype._setFullYear){Date.prototype._setFullYear=function(c){this.setFullYear(c);return this}}if(!Date.prototype._setMonth){Date.prototype._setMonth=function(c){this.setMonth(c);return this}}if(!Date.prototype._setDate){Date.prototype._setDate=function(c){this.setDate(c);return this}}nMinutes=function(c){return(c*60*1000)};nDays=function(c){return(c*24*60*60*1000)};nMonths=function(c){return(c*30*24*60*60*1000)};function sleep(c){var e=new Date().getTime();while(new Date().getTime()<e+c){}}var Url={encode:function(c){return escape(this._utf8_encode(c))},decode:function(c){return this._utf8_decode(unescape(c))},_utf8_encode:function(c){c=c.replace(/\r\n/g,"\n");var e="";for(var d=0;d<c.length;d++){var f=c.charCodeAt(d);if(f<128){e+=String.fromCharCode(f)}else{if((f>127)&&(f<2048)){e+=String.fromCharCode((f>>6)|192);e+=String.fromCharCode((f&63)|128)}else{e+=String.fromCharCode((f>>12)|224);e+=String.fromCharCode(((f>>6)&63)|128);e+=String.fromCharCode((f&63)|128)}}}return e},_utf8_decode:function(c){var e="";var d=0;var f=c1=c2=0;while(d<c.length){f=c.charCodeAt(d);if(f<128){e+=String.fromCharCode(f);d++}else{if((f>191)&&(f<224)){c2=c.charCodeAt(d+1);e+=String.fromCharCode(((f&31)<<6)|(c2&63));d+=2}else{c2=c.charCodeAt(d+1);c3=c.charCodeAt(d+2);e+=String.fromCharCode(((f&15)<<12)|((c2&63)<<6)|(c3&63));d+=3}}}return e}};

jQuery.extend({createUploadIframe:function(g,h){var a="jUploadFrame"+g;if(window.ActiveXObject){var b;if($.browser.msie&&parseFloat($.browser.version)<=7){b=document.createElement('<iframe id="'+a+'" name="'+a+'" />')}else{b=document.createElement("iframe");b.id=a;b.name=a}if(typeof h=="boolean"){b.src="javascript:false"}else{if(typeof h=="string"){b.src=h}}}else{var b=document.createElement("iframe");b.id=a;b.name=a}b.style.position="absolute";b.style.top="-1000px";b.style.left="-1000px";document.body.appendChild(b);return b},createUploadForm:function(g,h){var a="jUploadForm"+g;var b="jUploadFile"+g;var f=$('<form onsubmit="return false;"  action="" method="POST" name="'+a+'" id="'+a+'" enctype="multipart/form-data"></form>');var j=$("#"+h);var k=$(j).clone();$(j).attr("id",b);$(j).attr("name","file");$(j).before(k);$(j).appendTo(f);$(f).css("position","absolute");$(f).css("top","-1200px");$(f).css("left","-1200px");$(f).appendTo("body");return f},ajaxFileUpload:function(c){c=jQuery.extend({},jQuery.ajaxSettings,c);var l=new Date().getTime();var i=jQuery.createUploadForm(l,c.fileElementId);var o=jQuery.createUploadIframe(l,c.secureuri||false);var m="jUploadFrame"+l;var q="jUploadForm"+l;if(c.global&&!jQuery.active++){jQuery.event.trigger("ajaxStart")}var p=false;var d={};if(c.global){jQuery.event.trigger("ajaxSend",[d,c])}var n=function(a){try{d.responseXML=$("#"+m).contents()}catch(e){jQuery.handleError(c,d,null,e)}if(d||a=="timeout"){p=true;var b;try{b=a!="timeout"?"success":"error";if(d.responseXML.find("errors")[0]){b="error"}if(d.responseXML.text().indexOf("<errors>")>=0){b="error";var f=d.responseXML.text().match(/<errors>(.*)<\/errors>/)[1].replace(/<\/error>/g,"").substr(7).split(/<error>/);d.responseXML=$("<response/>");var j=$("<errors/>").appendTo(d.responseXML);$.each(f,function(g,h){j.append($("<error>").text(h))})}if(b!="error"){if(d.responseXML.text().indexOf("<key>")>=0){var k=$("<upload/>");k.html($("<key/>").text(d.responseXML.text().match(/<key>(.*)<\/key>/)[1]));if(d.responseXML.text().indexOf("<content-type>")>=0){k.append($("<contenttype/>").text(d.responseXML.text().match(/<content-type>(.*)<\/content-type>/)[1]))}d.responseXML=k}var r=d.responseXML;if(c.success){c.success(r,b)}if(c.global){jQuery.event.trigger("ajaxSuccess",[d,c])}}else{jQuery.handleError(c,d,b)}}catch(e){b="error";jQuery.handleError(c,d,b,e)}if(c.global){jQuery.event.trigger("ajaxComplete",[d,c])}if(c.global&&!--jQuery.active){jQuery.event.trigger("ajaxStop")}if(c.complete){c.complete(d,b)}jQuery(o).unbind();setTimeout(function(){try{$(o).remove();$(i).remove()}catch(e){jQuery.handleError(c,d,null,e)}},100);d=null}};if(c.timeout>0){setTimeout(function(){if(!p){n("timeout")}},c.timeout)}try{var i=$("#"+q);$(i).attr("action",c.url);$(i).attr("method","POST");$(i).attr("target",m);if(i.encoding){i.encoding="multipart/form-data"}else{i.enctype="multipart/form-data"}$(i).submit()}catch(e){jQuery.handleError(c,d,null,e)}if(window.attachEvent){document.getElementById(m).attachEvent("onload",n)}else{document.getElementById(m).addEventListener("load",n,false)}return{abort:function(){}}}});(function($){$.fn.easyTooltip=function(a){var b={xOffset:10,yOffset:25,tooltipId:"easyTooltip",clickRemove:false,content:"",useElement:""};var a=$.extend(b,a);var f;this.each(function(){var h=$(this).attr("title");$(this).hover(function(g){f=(a.content!="")?a.content:h;f=(a.useElement!="")?$("#"+a.useElement).html():f;$(this).attr("title","");if(f!=""&&f!=undefined){$("body").append($("<div class='easyTooltip' id='"+a.tooltipId+"' />").append(f));$("#"+a.tooltipId).css("position","absolute").css("top",(g.pageY-a.yOffset+30)+"px").css("left",(g.pageX+a.xOffset)+"px")}},function(){$("#"+a.tooltipId).remove();$(this).attr("title",h)});$(this).mousemove(function(g){$("#"+a.tooltipId).css("top",(g.pageY-a.yOffset+30)+"px").css("left",(g.pageX+a.xOffset)+"px")});if(a.clickRemove){$(this).mousedown(function(g){$("#"+a.tooltipId).remove();$(this).attr("title",h)})}})}})(jQuery);

Unfuddle={};Unfuddle.Config={baseUrl:baseUrl||"",baseApiUrl:baseApiUrl||"/api/v1",baseTemplatesUrl:"/templates/",subdomain:subdomain,accountTitle:accountTitle||"",refreshTimeout:600000,currentProjectID:0,development:development||false,ssl:ssl||false,assets_random:assets_random||Math.random(),aseetsPageCssUrl:asset_pageCss||"/stylesheets/page.css",aseetsPageCssIE7Url:asset_pageCssIE7||"/stylesheets/page_ie7.css",mobileUrlPrefix:"m",switchToMobile:true};Config=Unfuddle.Config;

Unfuddle.Utilities={singularKeys:{category:"categories",person:"people",reporitory:"repositories",severity:"severities"},buildPluralKeys:function(){if(!Unfuddle.Utilities.pluralKeys){Unfuddle.Utilities.pluralKeys={};$.each(Unfuddle.Utilities.singularKeys,function(a,c){Unfuddle.Utilities.pluralKeys[c]=a})}},getSingular:function(a){if(Unfuddle.Utilities.pluralKeys[a]){return Unfuddle.Utilities.pluralKeys[a]}else{if(a.endsWith("s")){return a.substr(0,a.length-1)}}},getPlural:function(a){if(Unfuddle.Utilities.singularKeys[a]){return Unfuddle.Utilities.singularKeys[a]}else{return a+"s"}},parseDate:function(a,c){if(a&&a instanceof Date){return a}c=$.extend({},{useTimeZone:false},c);if(!a||!a.length){return null}var b=a.match(/(\d{4})-(\d{1,2})-(\d{1,2})(?:(T(\d{1,2}):(\d{1,2}):(\d{1,2}))?)(?:([\+\-Z])?)(?:((\d{1,2}):(\d{1,2}))?)/);if(b==null){return b}var result;if(b[5]){result=(b[8]&&(b[8]=="+"||b[8]=="-"))?new Date(Date.UTC(b[1],b[2]-1,b[3],((b[8]=="+")?(parseInt(b[5],10)-parseInt(b[10],10)).toString():(parseInt(b[5],10)+parseInt(b[10],10)).toString()),((b[8]=="+")?(parseInt(b[6],10)-parseInt(b[11],10)).toString():(parseInt(b[6],10)+parseInt(b[11],10)).toString()),b[7])):new Date(Date.UTC(b[1],b[2]-1,b[3],b[5],b[6],b[7]))}else{result=new Date(b[1],b[2]-1,b[3])}return result},formatDate:function(a,c){if(typeOf(a)=="string"){a=Utilities.parseDate(a)}a=a||new Date();c=$.extend({format:"auto",prefix:false,hover:true},c);var b=" on ";var d=(new Date()).justDate();var e="";switch(c.format){case"auto":if(d.equals(a.justDate())){b=" at ";e=a.getTime12H()}else{e=Utilities.zeroLeading(a.getDate(),2)+" "+a.getMonthNameShort()+" "+a.getFullYear()}break;case"tiny":if(d.equals(a.justDate())){b=" at ";e=a.getTime12H()}else{if(d.getYear()==a.getYear()){e=a.getMonthNameShort()+" "+Utilities.zeroLeading(a.getDate(),2)}else{e=Utilities.zeroLeading(a.getMonth()+1,2)+"/"+Utilities.zeroLeading(a.getDate(),2)+"/"+Utilities.zeroLeading(a.getYear()-100,2)}}break;case"withWeekdayName":e=a.getDayName()+", "+Utilities.zeroLeading(a.getDate(),2)+" "+a.getMonthNameShort()+" "+a.getFullYear();break;case"withTime":e=Utilities.zeroLeading(a.getDate(),2)+" "+a.getMonthNameShort()+" "+a.getFullYear()+" "+Utilities.zeroLeading(a.getHours(),2)+":"+Utilities.zeroLeading(a.getMinutes(),2);break;case"dashStyle":e=a.getFullYear()+"-"+Utilities.zeroLeading(a.getMonth()+1,2)+"-"+Utilities.zeroLeading(a.getDate(),2);break;case"datePicker":e=a.getFullYear()+" "+a.getMonthNameShort()+" "+Utilities.zeroLeading(a.getDate(),2);break;case"justMY":e=a.getMonthName()+" "+a.getFullYear();break;case"noTime":e=Utilities.zeroLeading(a.getDate(),2)+" "+a.getMonthNameShort()+" "+a.getFullYear();break;case"utcString":e=a.getFullYear()+"-"+Utilities.zeroLeading(a.getMonth()+1,2)+"-"+Utilities.zeroLeading(a.getDate(),2)+"T"+a.getUTCHours()+":"+a.getUTCMinutes()+":"+a.getUTCSeconds()+"Z";break;default:e=Utilities.zeroLeading(a.getDate(),2)+" "+a.getMonthNameShort()+" "+a.getFullYear()}if(c.hover){var f=Utilities.zeroLeading(a.getDate(),2)+" "+a.getMonthNameShort()+" "+a.getFullYear()+" "+Utilities.zeroLeading(a.getHours(),2)+":"+Utilities.zeroLeading(a.getMinutes(),2);e="<span title='"+f+"'>"+e+"</span>"}if(c.prefix){e=b+e}return e},formatText:function(c,b){if(!c){return""}var b=b||{};var d=Formatting.formatText(c,b);if(!isEmpty(b.sourceUrls)&&b.callback){var e=new Formatting.GenericDepencyHandler(b.sourceUrls,function(){var a=Formatting.formatText(c,b);if(d!=a){b.callback(a)}})}return d},formatBytes:function(a,c){c=$.extend({unit:"auto",value_only:false,decimal_format:"2"},c);a=Number(a).toFixed();if(c.value_only){switch(c.unit){case"kilobytes":return(a/1024);case"megabytes":return(a/1024/1024);case"gigabytes":return(a/1024/1024/1024);default:return a}}if(c.unit=="auto"){c.unit="bytes";if(a>1024){c.unit="kilobytes"}if(a>1024*1024){c.unit="megabytes"}if(a>1024*1024*1024){c.unit="gigabytes"}}switch(c.unit){case"kilobytes":return(a/1024).toFixed()+"KB";case"megabytes":return(Number(a).toFixed()/1024/1024).toFixed(c.decimal_format)+"MB";case"gigabytes":return(Number(a).toFixed()/1024/1024/1024).toFixed(c.decimal_format)+"GB";default:return a+"B"}},formatDiff:function(b){var d=b.split("\n");$.each(d,function(a,c){switch(c[0]){case"@":d[a]="...\n"+d[a];break;case"-":d[a]="<del class='pagedel'>"+d[a]+"</del>";break;case"+":d[a]="<ins class='pageins'>"+d[a]+"</ins>";break}});return"<pre>"+d.join("\n")+"</pre>"},formatDiffCommit:function(l,h){h=h||0;var g=l.split("\n").slice(2);var j=[];var o=[];var m=0;var n=0;var p="";$.each(g,function(a,c){switch(c.substring(0,1)){case"@":var b=g[a].split("@@")[1].split(" ");m=parseInt(b[1].split(",")[0].slice(1))-1;n=parseInt(b[2].split(",")[0].slice(1))-1;g[a]="<div class='diff_line "+(g[a].split("@@")[2].trim()?"diff_message":"")+"'>"+soy.$$escapeHtml(g[a].split("@@")[2])+"</div>";j.push("<div class='line-numbers'>  ... |  ... </div>");o.push("file"+h+"linenumber"+m+"fileversionold");break;case"+":g[a]="<div class='diff_line diff_add'>+ "+soy.$$escapeHtml(g[a].slice(1))+"</div>";n+=1;j.push("<div class='line_numbers'>      | "+Utilities.whiteSpaceLeading(n,4)+"</div>");o.push("file"+h+"linenumber"+n+"fileversionnew");break;case"-":g[a]="<div class='diff_line diff_remove'>- "+soy.$$escapeHtml(g[a].slice(1))+"</div>";m+=1;j.push("<div class='line_numbers'> "+Utilities.whiteSpaceLeading(m,4)+" |      </div>");o.push("file"+h+"linenumber"+m+"fileversionold");break;default:g[a]="<div class='diff_line'> "+soy.$$escapeHtml(g[a])+"</div>";m+=1;n+=1;j.push("<div class='line_numbers'> "+Utilities.whiteSpaceLeading(m,4)+" | "+Utilities.whiteSpaceLeading(n,4)+"</div>");o.push("file"+h+"linenumber"+m+"fileversionold");break}var d=o[a];var e="<tr id='"+d+"' valign='top' class='commit_comment'>";var f="<td class='line_numbers' width='10%'><pre class='idle'>"+j[a];var i="<td class='code_contents' width='88%'><pre class='idle'><div class='code_fixer'>"+g[a];var k="<td width='2%' class='comment_scroll'><pre class='idle'><div class='commit_comment_icon' id='"+d+"_comment'><div class='commit_comment_number' rel='0'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></div>";p+=e+(Globals.currentAccount.hasFeature("beta")?k+"</pre></td>":"")+f+"</pre></td>"+i+"</div></pre></td></tr>"});return p},whiteSpaceLeading:function(a,c){var b="                         "+a;return b.substr(b.length-c,c)},zeroLeading:function(a,c){var b="000000000000000000000000000"+a;return b.substr(b.length-c,c)},xLeading:function(a,c){var b="xxxxxxxxxxxxxxxxxxxxxxxxx"+a;return b.substr(b.length-c,c)},changeTextareaInputFormat:function(c,b,d,e){if(d){jQuery.markItUp({target:"#"+c,beforeInsert:function(a){return Utilities.miu.hideCustomPreview(a)}})}else{jQuery.markItUp({beforeInsert:function(a){return Utilities.miu.hideCustomPreview(a)}})}jQuery("#"+c).markItUpRemove();jQuery("."+c+"_markup_selector").css({"margin-bottom":"-32px"});jQuery(".resize_"+c).remove();if(b=="textile"){textileSettings={previewParserPath:"",resizeHandle:true,onShiftEnter:{keepDefault:false,replaceWith:"\n\n"},markupSet:[{name:"Heading 1",className:"button_heading1",openWith:"h1(!(([![Class]!]))!). ",placeHolder:"Your title here..."},{name:"Heading 2",className:"button_heading2",openWith:"h2(!(([![Class]!]))!). ",placeHolder:"Your title here..."},{name:"Heading 3",className:"button_heading3",openWith:"h3(!(([![Class]!]))!). ",placeHolder:"Your title here..."},{name:"Paragraph",className:"button_paragraph",openWith:"p(!(([![Class]!]))!). "},{separator:"---------------"},{name:"Bold",className:"button_bold",closeWith:"*",openWith:"*"},{name:"Italic",className:"button_italic",closeWith:"_",openWith:"_"},{name:"Strike through",className:"button_strike",closeWith:"-",openWith:"-"},{separator:"---------------"},{name:"Bulleted List",className:"button_bullet_list",replaceWith:function(a){return selection.replace(/(\n)(.+)/g,"$1* $2").replace(/^/,"* ")}},{name:"Numeric List",className:"button_number_list",replaceWith:function(a){return selection.replace(/(\n)(.+)/g,"$1# $2").replace(/^/,"# ")}},{separator:"---------------"},{name:"Link",className:"button_link",openWith:'"',closeWith:'([![Title]!])":[![Link:!:http://]!]',placeHolder:"Your text to link here..."},{name:"Picture",className:"button_picture",replaceWith:"![![Source:!:http://]!]([![Title]!])!"},{separator:"---------------"},{name:"Quotes",className:"button_quote",openWith:"bq(!(([![Class]!]))!). "},{name:"Code",className:"button_code",openWith:"<pre>\n<code>",closeWith:"</code>\n</pre>"},{separator:"---------------"},{name:"Ticket",className:"button_ticket",openWith:"#",placeHolder:"Number..."},{name:"Repository Revision",className:"button_commit",openWith:"[",closeWith:"]",placeHolder:"Revision..."},{name:"Repository Source File",className:"button_source",openWith:"source:",openWith:function(a){return Utilities.miu.sourcePath("open")},closeWith:function(a){return Utilities.miu.sourcePath("close")},placeHolder:"/path/to/filename.dat"},{name:"Notebook Page",className:"button_page",openWith:function(a){return Utilities.miu.notebookPage("open")},closeWith:function(a){return Utilities.miu.notebookPage("close")},placeHolder:"Page Title..."},{separator:"---------------"},{name:"Preview",className:"button_preview",beforeInsert:function(a){return Utilities.miu.customPreview($.extend({},e,a))}},{name:"Help",className:"help",beforeInsert:function(a){return Utilities.miu.customHelp(a)}}]};jQuery("#"+c).markItUp(textileSettings)}else{if(b=="markdown"){markdownSettings={previewParserPath:"",resizeHandle:true,onShiftEnter:{keepDefault:false,openWith:"\n\n"},markupSet:[{name:"Heading 1",className:"button_heading1",placeHolder:"Your title here...",closeWith:function(a){return Utilities.miu.markdownTitle(a,"=")}},{name:"Heading 2",className:"button_heading2",placeHolder:"Your title here...",closeWith:function(a){return Utilities.miu.markdownTitle(a,"-")}},{name:"Heading 3",className:"button_heading3",openWith:"### ",placeHolder:"Your title here..."},{separator:"---------------"},{name:"Bold",className:"button_bold",openWith:"**",closeWith:"**"},{name:"Italic",className:"button_italic",openWith:"_",closeWith:"_"},{separator:"---------------"},{name:"Bulleted List",className:"button_bullet_list",replaceWith:function(a){return selection.replace(/(\n)(.+)/g,"$1- $2").replace(/^/,"- ")}},{name:"Numeric List",className:"button_number_list",replaceWith:function(a){return selection.replace(/(\n)(.+)/g,"$1"+a.line+". $2").replace(/^/,a.line+". ")}},{separator:"---------------"},{name:"Link",className:"button_link",openWith:"[",closeWith:']([![Url:!:http://]!] "[![Title]!]")',placeHolder:"Your text to link here..."},{name:"Picture",className:"button_picture",replaceWith:'![]([![Source:!:http://]!] "[![Title]!]")'},{separator:"---------------"},{name:"Quotes",className:"button_quote",openWith:"> "},{name:"Code",className:"button_code",replaceWith:function(a){return selection.replace(/\n/g,"\n    ").replace(/^/,"    ")}},{separator:"---------------"},{name:"Ticket",className:"button_ticket",openWith:"#",placeHolder:"Number..."},{name:"Repository Revision",className:"button_commit",openWith:"[",closeWith:"]",placeHolder:"Revision..."},{name:"Repository Source File",className:"button_source",openWith:"source:",openWith:function(a){return Utilities.miu.sourcePath("open")},closeWith:function(a){return Utilities.miu.sourcePath("close")},placeHolder:"/path/to/filename.dat"},{name:"Notebook Page",className:"button_page",openWith:function(a){return Utilities.miu.notebookPage("open")},closeWith:function(a){return Utilities.miu.notebookPage("close")},placeHolder:"Page Title..."},{separator:"---------------"},{name:"Preview",className:"button_preview",beforeInsert:function(a){return Utilities.miu.customPreview($.extend({},e,a))}},{name:"Help",className:"help",beforeInsert:function(a){return Utilities.miu.customHelp(a)}}]};jQuery("#"+c).markItUp(markdownSettings)}else{jQuery("."+c+"_markup_selector").css({"margin-bottom":"-5px"});Utilities.addTextEditorResizeHandle(jQuery("#"+c),jQuery("#"+c),c)}}},miu:{markdownTitle:function(a,c){var b="";var d=jQuery.trim(a.selection||a.placeHolder).length;for(var e=0;e<d;e++){b+=c}return"\n"+b},notebookPage:function(a){if(a=="open"){var c=prompt("Specify a notebook title (optional -- will default to current notebook, if any)");return"[["+(c.length>0?c+":":"")}else{var b=prompt("Specify an alternate title to display (optional)");return(b.length>0?" | "+b:"")+"]]"}},notebookAttachmentPath:function(){var a=prompt("Specify a notebook title (optional -- will default to current notebook, if any)");return"{{"+(a.length>0?a+":":"")},sourcePath:function(a){if(a=="open"){var c=prompt("Specify an optional repository abbreviation and/or click 'Ok' to continue");return"source:"+(c.length>0?c+":":"")}else{var b=prompt("Specify a specific revision (optional)");return(b.length>0?"@"+b:"")}},customPreview:function(c){var b=jQuery("#"+c.textarea.id+"_preview");var d=jQuery("#"+c.textarea.id);var e=d.parent().find(".markItUpFooter");if(!b.is(":visible")){b.html(Unfuddle.Utilities.formatText(c.textarea.value,$.extend({},{format:$("#"+c.textarea.id+"_markup").val(),callback:function(a){b.html(a)}},c.unfParams)));d.css("position","absolute");d.css("left","-99999px");e.hide();b.show();d.parent().find(".button_preview a").css("background-image","url(/images/silk/magifier_zoom_out.png)")}else{b.hide();b.html("");d.css("position","static");d.css("left","0px");e.show();d.parent().find(".button_preview a").css("background-image","url(/images/silk/magnifier.png)")}},hideCustomPreview:function(a){var c=jQuery("#"+a.textarea.id+"_preview");var b=jQuery("#"+a.textarea.id);var d=b.parent().find(".markItUpFooter");c.hide();c.html("");b.css("position","static");b.css("left","0px");d.show();b.parent().find(".button_preview a").css("background-image","url(/images/silk/magnifier.png)")},customHelp:function(a){help_path=jQuery("#"+a.textarea.id+"_help_path_base").text()+jQuery("#"+a.textarea.id+"_markup").val();window.open(help_path,"help_window","height=400,width=600,scrollbars=1,resizable=1")}},addTextEditorResizeHandle:function(i,k,l){var h=jQuery('<div class="custom_resize_handle resize_'+l+'"></div>').insertAfter(k).bind("mousedown",function(c){var b=k.height(),d=c.clientY,e,f;e=function(a){k.css("height",Math.max(20,a.clientY+b-d)+"px");return false};f=function(a){jQuery("html").unbind("mousemove",e).unbind("mouseup",f);return false};jQuery("html").bind("mousemove",e).bind("mouseup",f)});if(jQuery.browser.safari!==true){if(!i.hasClass("markup_textarea")){i.append(h)}else{h.insertAfter(i)}}else{if(!i.hasClass("markup_textarea")){i.append(h)}}},eventChain:function(c,b){b=b||{};if(!c||c.length==0){if(b.onSuccess){b.onSuccess()}else{return true}}else{var d=c.pop();d.action(function(a){if(d.resource.action_results&&d.resource.action_results.success){if(d.onSuccess){d.onSuccess(a)}Unfuddle.Utilities.eventChain(c,b)}else{d.onError()}})}},getDefaultMarkup:function(){return Globals.currentPerson&&Globals.currentPerson.text_markup&&Account.VALID_MARKUP.map(function(a){return a.name}).include(Globals.currentPerson.text_markup)&&Globals.currentAccount.textMarkupList().include(Globals.currentPerson.text_markup)?Globals.currentPerson.text_markup:Globals.currentAccount.textMarkupDefault()},isMSIE:function(){return window.navigator.userAgent.toLowerCase().indexOf("msie")>=0},isMSIE7:function(){return window.navigator.userAgent.toLowerCase().indexOf("msie 7")>=0},isMSIE9:function(){return window.navigator.userAgent.toLowerCase().indexOf("msie 9")>=0},getMSIEv:function(){return $.browser.msie?parseFloat($.browser.version):0},isFF:function(){return window.navigator.userAgent.toLowerCase().indexOf("firefox")>=0},linkToHelp:function(a,c,b,d){d=d||{};d.height=d.height||"400";d.width=d.width||"600";d.title=d.title||"Help";d.klass=d.klass||"";d.tabIndex=d.tabIndex||"none";d.repo=d.repo||"";var e="";if(c=="button"){e="<img src='/images/icons/help.gif' alt='What is this>' class='help_button' />"}else{e=c}a.html(e);a.attr("href","http://unfuddle.com/docs/topics/"+b);a.attr("title",d.title);a.attr("class",d.klass);a.attr("onclick","window.open(this.href,'help_window','height="+d.height+",width="+d.width+",scrollbars=1,resizable=1');return false;");if(d.tabIndex!="none"){a.attr("tabIndex",d.tabIndex)}},parseTemplate:function(e,f){var i=/<%=(.*?)%>/g;$.each(e.match(i),function(a,c){var b=/<%=(.*?)%>/;var d=c.match(b)[1];e=e.replace(c,eval(d))});e=e.replace("<%","<script type='text/javascript'>","g");e=e.replace("%>","<\/script>","g");var i=/<script.*?>\/\/eval(.|\n|\r)*?<\/script>/gi;$.each(e.match(i),function(a,c){var b=/<script.*?>((.|\n|\r)*?)<\/script>/i;var d=c.match(b)[1];with(f){eval(d)}e=e.replace(c,"<!-- "+c+" -->")});return e},showHideToggle:function(a,c,b){b=$.extend({elReset:null,elFocus:null},b);a.hide();c.show();if(b.elReset!=null&&typeOf(b.elReset[0])!="undefined"){b.elReset[0].reset()}if(b.elFocus!=null&&typeOf(b.elFocus[0])!="undefined"){b.elFocus[0].focus()}return(false)},loadJsCssfile:function(a,c){if(c=="js"){var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("src",a)}else{if(c=="css"){var b=document.createElement("link");b.setAttribute("rel","stylesheet");b.setAttribute("type","text/css");b.setAttribute("href",a)}}if(typeof b!="undefined"){document.getElementsByTagName("head")[0].appendChild(b)}},xmlEscape:function(a){return a.replace(/\&/g,"&amp;").replace(/\</g,"&lt;").replace(/\>/g,"&gt;")},jsonToXml:function(k,l,h,g){var self=k;var j="<"+l+">\n";$.each(self,function(b,d){if(!h||h(b)){if(g){var e=g(b,d)}if(g&&e!=""){j+=e}else{var f=b.replace("_","-","g");if(d instanceof Array){if(d.length>0){j+="  <"+f+">\n";var b=Unfuddle.Utilities.getSingular(f);$.each(d,function(a,c){j+="<"+b+" id='"+c+"'/>\n"});j+="  </"+f+">\n"}else{j+="  <"+f+"/>\n"}}else{var i="";if(d!=null){if(d instanceof Date){i=Utilities.formatDate(d,{format:"dashStyle",hover:false})}else{i=Utilities.xmlEscape(d.toString())}}j+="  <"+f+">"+i+"</"+f+">\n"}}}});j+="</"+l+">";return j},readCookie:function(a){var c=a+"=";var b=document.cookie.split(";");for(var d=0;d<b.length;d++){var e=b[d];while(e.charAt(0)==" "){e=e.substring(1,e.length)}if(e.indexOf(c)==0){return e.substring(c.length,e.length)}}return null},isAuthenticated:function(){return Utilities.readCookie("authenticated")=="true"},checkSessionExpiration:function(){if(Unfuddle.Utilities.isAuthenticated()){Unfuddle.Utilities.lastLoggedInCheck=new Date}else{if(Unfuddle.Utilities.lastLoggedInCheck){UI.Helpers.checkSessionExpired();if(!Unfuddle.Utilities.delaySessionExpiration){var a=60*60*1000;if((new Date).getTime()-Unfuddle.Utilities.lastLoggedInCheck.getTime()>=2*a){Unfuddle.Utilities.lastLoggedInCheck=null;location.reload()}}}else{if(Globals.currentPerson){UI.Helpers.checkSessionExpired();Unfuddle.Utilities.lastLoggedInCheck=new Date}}}},delaySessionExpirationWith:function(a){Unfuddle.Utilities.delaySessionExpiration=true;setTimeout("Unfuddle.Utilities.delaySessionExpiration = null",a)},sendPersonInvitation:function(l,h){var g=false;$.ajax({type:"POST",url:Config.baseApiUrl+"/people/invite.json",data:JSON.stringify(l),dataType:"application/json",contentType:"application/json",success:function(){g=true},error:function(a,c,b){var d=[];try{d=JSON.parse(a.responseText)}catch(err){}if(d.length<=0){d=["An unexpected error occured while sending the invitation. Please try again!"]}if(h){h({success:false,errors:d})}},complete:function(e,f){var i=e.getResponseHeader("Location");if(g&&i){var k=i.split("/").pop();Unfuddle.Data.Person.Cache.retrieve({sourceUrl:"/people/"+k,callback:function(b){var d=Person.find(k)[0];d.init(b);d.action_results={success:true,textStatus:f,action:"created"};d.afterSave();Unfuddle.Data.Involvement.Cache.retrieve({sourceUrl:"/projects/"+l.involvement.project_id+"/involvements",callback:function(a){var c=Involvement.find({conditions:{person_id:d.id}})[0];c.init(a);c.action_results={success:true,textStatus:f,action:"created"};c.afterSave();if(h){h({success:true,errors:[]})}}})}})}}})},searchItemLocation:function(result){var a="#"+(Config.development?("/"+result.location.split("/").slice(3).join("/")):result.location);switch(result.type){case"Message":return a;break;case"Milestone":return a.split("/milestones/")[0]+"/milestones";break;case"Page":return a;break;case"Ticket":return a.split("/tickets/")[0]+"/tickets/by_number/"+result.title.slice(1).split(":")[0];break;case"Comment":var c=a.split("/comments/");if(result.parent_type=="Message"){return c[0]+"[comment_"+c[1]+"]";break}if(result.parent_type=="Ticket"){return c[0].split("/tickets/")[0]+"/tickets/by_number/"+result.ticket_number+"[comment_"+c[1]+"]";break}case"Changeset":var c=a.split("commit/");return c[0]+"commit?commit="+c[1];break;case"CommitComment":var c=a.split("commit/");return c[0]+"commit?commit="+c[1];break;default:return"/account"}}};Utilities=Unfuddle.Utilities;Unfuddle.Utilities.buildPluralKeys();

var Showdown={};Showdown.converter=function(){var A;var B;var G;var L=0;this.makeHtml=function(c){A=new Array();B=new Array();G=new Array();c=c.replace(/~/g,"~T");c=c.replace(/\$/g,"~D");c=c.replace(/\r\n/g,"\n");c=c.replace(/\r/g,"\n");c="\n\n"+c+"\n\n";c=u(c);c=c.replace(/^[ \t]+$/mg,"");c=v(c);c=S(c);c=E(c);c=t(c);c=c.replace(/~D/g,"$$");c=c.replace(/~T/g,"~");return c};var S=function(g){var g=g.replace(/^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|\Z)/gm,function(c,e,d,f,h){e=e.toLowerCase();A[e]=y(d);if(f){return f+h}else{if(h){B[e]=h.replace(/"/g,"&quot;")}}return""});return g};var v=function(c){c=c.replace(/\n/g,"\n\n");var e="p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del";var d="p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math";c=c.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n<\/\2>[ \t]*(?=\n+))/gm,z);c=c.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math)\b[^\r]*?.*<\/\2>[ \t]*(?=\n+)\n)/gm,z);c=c.replace(/(\n[ ]{0,3}(<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g,z);c=c.replace(/(\n\n[ ]{0,3}<!(--[^\r]*?--\s*)+>[ \t]*(?=\n{2,}))/g,z);c=c.replace(/(?:\n\n)([ ]{0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g,z);c=c.replace(/\n\n/g,"\n");return c};var z=function(c,e){var d=e;d=d.replace(/\n\n/g,"\n");d=d.replace(/^\n/,"");d=d.replace(/\n+$/g,"");d="\n\n~K"+(G.push(d)-1)+"K\n\n";return d};var E=function(c){c=C(c);var e=r("<hr />");c=c.replace(/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm,e);c=c.replace(/^[ ]{0,2}([ ]?\-[ ]?){3,}[ \t]*$/gm,e);c=c.replace(/^[ ]{0,2}([ ]?\_[ ]?){3,}[ \t]*$/gm,e);c=H(c);c=I(c);c=T(c);c=v(c);c=N(c);return c};var n=function(c){c=U(c);c=V(c);c=W(c);c=J(c);c=O(c);c=X(c);c=y(c);c=Y(c);c=c.replace(/  +\n/g," <br />\n");return c};var V=function(d){var f=/(<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--.*?--\s*)+>)/gi;d=d.replace(f,function(c){var e=c.replace(/(.)<\/?code>(?=.)/g,"$1`");e=F(e,"\\`*_");return e});return d};var O=function(c){c=c.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,M);c=c.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()<?(.*?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,M);c=c.replace(/(\[([^\[\]]+)\])()()()()()/g,M);return c};var M=function(c,e,d,f,h,g,k,o){if(o==undefined){o=""}var l=e;var w=d;var p=f.toLowerCase();var s=h;var q=o;if(s==""){if(p==""){p=w.toLowerCase().replace(/ ?\n/g," ")}s="#"+p;if(A[p]!=undefined){s=A[p];if(B[p]!=undefined){q=B[p]}}else{if(l.search(/\(\s*\)$/m)>-1){s=""}else{return l}}}s=F(s,"*_");var result='<a href="'+s+'"';if(q!=""){q=q.replace(/"/g,"&quot;");q=F(q,"*_");result+=' title="'+q+'"'}result+=">"+w+"</a>";return result};var J=function(c){c=c.replace(/(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,K);c=c.replace(/(!\[(.*?)\]\s?\([ \t]*()<?(\S+?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,K);return c};var K=function(c,e,d,f,h,g,k,o){var l=e;var w=d;var p=f.toLowerCase();var s=h;var q=o;if(!q){q=""}if(s==""){if(p==""){p=w.toLowerCase().replace(/ ?\n/g," ")}s="#"+p;if(A[p]!=undefined){s=A[p];if(B[p]!=undefined){q=B[p]}}else{return l}}w=w.replace(/"/g,"&quot;");s=F(s,"*_");var result='<img src="'+s+'" alt="'+w+'"';q=q.replace(/"/g,"&quot;");q=F(q,"*_");result+=' title="'+q+'"';result+=" />";return result};var C=function(h){h=h.replace(/^(.+)[ \t]*\n=+[ \t]*\n+/gm,function(c,e){return r("<h1>"+n(e)+"</h1>")});h=h.replace(/^(.+)[ \t]*\n-+[ \t]*\n+/gm,function(c,e){return r("<h2>"+n(e)+"</h2>")});h=h.replace(/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm,function(c,e,d){var f=e.length;return r("<h"+f+">"+n(d)+"</h"+f+">")});return h};var D;var H=function(o){o+="~0";var l=/^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm;if(L){o=o.replace(l,function(c,e,d){var f=e;var h=(d.search(/[*+-]/g)>-1)?"ul":"ol";f=f.replace(/\n{2,}/g,"\n\n\n");var result=D(f);result=result.replace(/\s+$/,"");result="<"+h+">"+result+"</"+h+">\n";return result})}else{l=/(\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/g;o=o.replace(l,function(c,e,d,f){var h=e;var g=d;var k=(f.search(/[*+-]/g)>-1)?"ul":"ol";var g=g.replace(/\n{2,}/g,"\n\n\n");var result=D(g);result=h+"<"+k+">\n"+result+"</"+k+">\n";return result})}o=o.replace(/~0/,"");return o};D=function(l){L++;l=l.replace(/\n{2,}$/,"\n");l+="~0";l=l.replace(/(\n)?(^[ \t]*)([*+-]|\d+[.])[ \t]+([^\r]+?(\n{1,2}))(?=\n*(~0|\2([*+-]|\d+[.])[ \t]+))/gm,function(c,e,d,f,h){var g=h;var k=e;var o=d;if(k||(g.search(/\n{2,}/)>-1)){g=E(x(g))}else{g=H(x(g));g=g.replace(/\n$/,"");g=n(g)}return"<li>"+g+"\n</li>\n"});l=l.replace(/~0/g,"");L--;return l};var I=function(g){g+="~0";g=g.replace(/(?:\n\n?|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g,function(c,e,d){var f=e;var h=d;f=P(x(f));f=u(f);f=f.replace(/^\n+/g,"");f=f.replace(/\n+$/g,"");f="<pre><code>"+f+"\n</code></pre>";return r(f)+h});g=g.replace(/~0/,"");return g};var r=function(c){c=c.replace(/(^\n+|\n+$)/g,"");return"\n\n~K"+(G.push(c)-1)+"K\n\n"};var U=function(k){k=k.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,function(c,e,d,f,h){var g=f;g=g.replace(/^([ \t]*)/g,"");g=g.replace(/[ \t]*$/g,"");g=P(g);return e+"<code>"+g+"</code>"});return k};var P=function(c){c=c.replace(/&/g,"&amp;");c=c.replace(/</g,"&lt;");c=c.replace(/>/g,"&gt;");c=F(c,"*_{}[]\\",false);return c};var Y=function(c){c=c.replace(/(^|\s)?(\*\*|__)(?=\S)([^\r]*?\S[*_]*)\2(\s|$|[!'#S%&'()*+,-.\/:;<=>?\@[\]^_{|}~])/g,"$1<strong>$3</strong>$4");c=c.replace(/(^|\s)?(\*|_)(?=\S)([^\r]*?\S)\2(\s|$|[!'#S%&'()*+,-.\/:;<=>?\@[\]^_{|}~])/g,"$1<em>$3</em>$4");return c};var T=function(k){k=k.replace(/((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)/gm,function(f,h){var g=h;g=g.replace(/^[ \t]*>[ \t]?/gm,"~0");g=g.replace(/~0/g,"");g=g.replace(/^[ \t]+$/gm,"");g=E(g);g=g.replace(/(^|\n)/g,"$1  ");g=g.replace(/(\s*<pre>[^\r]+?<\/pre>)/gm,function(c,e){var d=e;d=d.replace(/^  /mg,"~0");d=d.replace(/~0/g,"");return d});return r("<blockquote>\n"+g+"\n</blockquote>")});return k};var N=function(c){c=c.replace(/^\n+/g,"");c=c.replace(/\n+$/g,"");var e=c.split(/\n{2,}/g);var d=new Array();var f=e.length;for(var h=0;h<f;h++){var g=e[h];if(g.search(/~K(\d+)K/g)>=0){d.push(g)}else{if(g.search(/\S/)>=0){g=n(g);g=g.replace(/^([ \t]*)/g,"<p>");g+="</p>";d.push(g)}}}f=d.length;for(var h=0;h<f;h++){while(d[h].search(/~K(\d+)K/)>=0){var k=G[RegExp.$1];k=k.replace(/\$/g,"$$$$");d[h]=d[h].replace(/~K\d+K/,k)}}return d.join("\n\n")};var y=function(c){c=c.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g,"&amp;");c=c.replace(/<(?![a-z\/?\$!])/gi,"&lt;");return c};var W=function(c){c=c.replace(/\\(\\)/g,Q);c=c.replace(/\\([`*_{}\[\]()>#+-.!])/g,Q);return c};var X=function(d){d=d.replace(/<((https?|ftp|dict):[^'">\s]+)>/gi,'<a href="$1">$1</a>');d=d.replace(/<(?:mailto:)?([-.\w]+\@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)>/gi,function(c,e){return R(t(e))});return d};var R=function(f){function h(c){var e="0123456789ABCDEF";var d=c.charCodeAt(0);return(e.charAt(d>>4)+e.charAt(d&15))}var g=[function(c){return"&#"+c.charCodeAt(0)+";"},function(c){return"&#x"+h(c)+";"},function(c){return c}];f="mailto:"+f;f=f.replace(/./g,function(c){if(c=="@"){c=g[Math.floor(Math.random()*2)](c)}else{if(c!=":"){var e=Math.random();c=(e>0.9?g[2](c):e>0.45?g[1](c):g[0](c))}}return c});f='<a href="'+f+'">'+f+"</a>";f=f.replace(/">.+:/g,'">');return f};var t=function(f){f=f.replace(/~E(\d+)E/g,function(c,e){var d=parseInt(e);return String.fromCharCode(d)});return f};var x=function(c){c=c.replace(/^(\t|[ ]{1,4})/gm,"~0");c=c.replace(/~0/g,"");return c};var u=function(k){k=k.replace(/\t(?=\t)/g,"    ");k=k.replace(/\t/g,"~A~B");k=k.replace(/~B(.+?)~A/g,function(c,e,d){var f=e;var h=4-f.length%4;for(var g=0;g<h;g++){f+=" "}return f});k=k.replace(/~A/g,"    ");k=k.replace(/~B/g,"");return k};var F=function(c,e,d){var f="(["+e.replace(/([\[\]\\])/g,"\\$1")+"])";if(d){f="\\\\"+f}var h=new RegExp(f,"g");c=c.replace(h,Q);return c};var Q=function(c,e){var d=e.charCodeAt(0);return"~E"+d+"E"}};var FabricWire={};FabricWire.converter=function(){var v,z,E,n;var V=new Array;var O={">":"right","<":"left","=":"center","<>":"justify","~":"bottom","^":"top"};var M={"'":"&#8217;"," - ":" &#8211; ","--":"&#8212;"," x ":" &#215; ","\\.\\.\\.":"&#8230;","\\(C\\)":"&#169;","\\(R\\)":"&#174;","\\(TM\\)":"&#8482;"};var J={b:"\\*\\*",i:"__",em:"_",strong:"\\*",cite:"\\?\\?",sup:"\\^",sub:"~",span:"\\%",del:"-",code:"@",ins:"\\+",del:"-"};var K="\n\n";var C=0,D="",H="",I=0,r="";var U=/^p(\S*)\.\s*(.*)/;var P=/^fn(\d+)\.\s*(.*)/;var Y=/^bq\.(\.)?\s*/;var T=/^table\s*{(.*)}\..*/;var N=/^\{(\S+)\}\.\s*\|/;function y(f){for(i in M){f=f.replace(new RegExp(i,"g"),M[i])}for(i in J){f=W(f,RegExp("^"+J[i]+"(.+?)"+J[i]),i,"");f=W(f,RegExp(" "+J[i]+"(.+?)"+J[i]),i," ")}f=f.replace(/\[(\d+)\]/g,'<sup><a href="#fn$1">$1</a></sup>');f=f.replace(/([A-Z]+)\((.*?)\)/g,'<acronym title="$2">$1</acronym>');f=f.replace(/\"([^\"]+)\":((?:(?:http|https|mailto):)?\S+)/g,'<a href="$2">$1</a>');f=X(f,/!([^!\s]+)!:(\S+)/);f=X(f,/!([^!\s]+)!/);f=f.replace(/"([^\"]+)":(\S+)/g,function(c,e,d){return x("a",t("href",V[d]),e)});f=f.replace(/(=)?"([^\"]+)"/g,function(c,e,d){return(e)?c:"&#8220;"+d+"&#8221;"});return(v?"<br />":"")+f}function W(c,e,d,f){while(m=e.exec(c)){var h=R(m[1]);m[1]=m[1].replace(/^[\[\{\(].+?[\]\}\)]/g,"");m[1]=m[1].replace(/^[<>=()]+/,"");c=c.replace(e,f+x(d,h,m[1]))}return c}function X(c,e){var d;while(d=e.exec(c)){var f="";var h="";var g=/\((.*)\)$/.exec(d[1]);if(g!=null){f=t("alt",g[1])+t("title",g[1]);d[1]=d[1].replace(/\((.*)\)$/,"")}if(d[1].match(/^[><]/)){h="float:"+((d[1].indexOf(">")==0)?"right;":"left;");d[1]=d[1].replace(/^[><]/,"")}var k=/(\(+)/.exec(d[1]);if(k){h+="padding-left:"+k[1].length+"em;"}var o=/(\)+)/.exec(d[1]);if(o){h+="padding-right:"+o[1].length+"em;"}if(h){f+=t("style",h)}var l='<img src="'+d[1]+'"'+f+" />";if(d.length>2){l=x("a",t("href",d[2]),l)}c=c.replace(e,l)}return c}function R(c){var e="";var d="";if(!c){return""}var f=/\[(\w\w)\]/.exec(c);if(f!=null){d+=t("lang",f[1])}var h=/\((\S+)\)/.exec(c);if(h!=null){c=c.replace(/\((\S+)\)/,"");d+=h[1].replace(/#(.*)$/,' id="$1"').replace(/^(\S+)/,' class="$1"')}var g=/(<>|=|<|>)/.exec(c);if(g){e+="text-align:"+O[g[1]]+";"}var k=/\{(.+?)\}/.exec(c);if(k){e+=k[1];if(!k[1].match(/;$/)){e+=";"}}var o=/(\(+)/.exec(c);if(o){e+="padding-left:"+o[1].length+"em;"}var l=/(\)+)/.exec(c);if(l){e+="padding-right:"+l[1].length+"em;"}if(e){d+=t("style",e)}return d}function t(a,c){return" "+a+'="'+c+'"'}function x(c,a,e){return"<"+c+a+">"+e+"</"+c+">"}function u(b){if(b){E=0}if(v){n+="</p>"+K;v=0}if(z&&!E){n+="</blockquote>"+K;z=0}}var F=function(c){var e=c.split(/\r?\n/);n="";v=z=E=0;for(var d=0;d<e.length;d++){if(e[d].indexOf("[")==0){var f=e[d].indexOf("]");V[e[d].substring(1,f)]=e[d].substring(f+1)}}for(d=0;d<e.length;d++){if(e[d].indexOf("[")==0){continue}if(r=U.exec(e[d])){u(1);v=1;n+=e[d].replace(U,"<p"+R(r[1])+">"+y(r[2]));continue}if(r=/^h(\d)(\S*)\.\s*(.*)/.exec(e[d])){u(1);n+=x("h"+r[1],R(r[2]),y(r[3]))+K;continue}if(r=P.exec(e[d])){u(1);v=1;n+=e[d].replace(P,'<p id="fn'+r[1]+'"><sup>'+r[1]+"</sup>"+y(r[2]));continue}if(e[d].search(/\*+?\s/)==0){D="<ul>";H="</ul>"}else{if(e[d].search(/\#+?\s/)==0){D="<ol>";H="</ol>"}else{while(C>0){n+=H;if(C>1){n+="</li>"}else{n+="\n"}n+="\n";C--}D=""}}if(D){u(1);var f=/^([*#]+)\s*(.*)/.exec(e[d]);var h=f[1].length;while(h<C){n+=H+"</li>\n";C--}while(C<h){n=n.replace(/<\/li>\n$/,"\n");n+=D;C++}n+=x("li","",y(f[2]))+"\n";continue}if(e[d].match(T)){u(1);I=1;n+=e[d].replace(T,'<table style="$1;">\n');continue}if((e[d].indexOf("|")==0)||(e[d].match(N))){u(1);if(!I){n+="<table>\n";I=1}var g="";var k="";var o=N.exec(e[d]);if(o){g=t("style",o[1]);e[d]=e[d].replace(N,"|")}var l=e[d].split("|");for(j=1;j<l.length-1;j++){var w="td";if(l[j].indexOf("_.")==0){w="th";l[j]=l[j].substring(2)}l[j]=y(l[j]);var p=/^(_?)([<>=^~\/\\\{]+.*?)\.(.*)/.exec(l[j]);var s="",q="";if(p!=null){l[j]=p[3];if(p[1]){w="th"}var A=/\\(\d+)/.exec(p[2]);if(A!=null){s+=t("colspan",A[1])}var B=/\/(\d+)/.exec(p[2]);if(B!=null){s+=t("rowspan",B[1])}var G=/([\^~])/.exec(p[2]);if(G!=null){q+="vertical-align:"+O[G[1]]+";"}var L=/(<>|=|<|>)/.exec(p[2]);if(L!=null){q+="text-align:"+O[L[1]]+";"}var S=/\{([^\}]+)\}/.exec(p[2]);if(S!=null){q+=S[1]}if(q!=""){s+=t("style",q)}}k+=x(w,s,l[j])}n+="\t"+x("tr",g,k)+"\n";continue}if(I){n+="</table>"+K;I=0}if(e[d]==""){u()}else{if(!v){if(r=Y.exec(e[d])){e[d]=e[d].replace(Y,"");n+="<blockquote>";z=1;if(r[1]){E=1}}n+="<p>"+y(e[d]);v=1}else{n+=y(e[d])}}}u();return n};var Q=function(e){var d=[];var f=0;if(e.indexOf("@")>=0){e=e.replace(/@.+?@/igm,function(c){d[f]="<code>"+soy.$$escapeHtml(c.slice(1,c.length-1))+"</code>";return"rawCode729587135813457135random123591391358135_"+f++})}e=F(e);if(f){for(var h=0;h<f;h++){e=e.replace("rawCode729587135813457135random123591391358135_"+h,d[h])}}return e};this.toHtml=function(e){var d=[];var f=0;if(e.indexOf("<code>")>=0){e=e.replace(/<code>[\s\S]*?<\/code>/img,function(c){d[f]=c;return"rawCodeBlock729587135813457135random123591391358135_"+f++})}e=Q(e);if(f){for(var h=0;h<f;h++){e=e.replace("rawCodeBlock729587135813457135random123591391358135_"+h,d[h])}}return e}};

Unfuddle.Formatting=Unfuddle.Formatting||{};Formatting=Unfuddle.Formatting;Formatting.formatText=function(f,c){var c=c||{};var j=$.extend({account:null,project:null,person:null,notebook:null,format:"default",autolink:true,constrain:null,whiteList:true,sourceUrls:{}},c);$.extend(c,j);if(!c.person){c.person=Person.current()}if(!c.account){c.account=Account.current()}if(c.account&&c.format=="default"){c.format=c.account.textMarkupDefault()}if(!f){return""}var m=f;try{if(c.constrain&&f.length>c.constrain){f=(f.slice(0,(c.constrain-1))+"...")}}catch(err){f=m}m=f;var l=(c.format=="markdown"||c.format=="textile");var g=function(d,i){if(i.autolink&&i.project&&i.person){d=Formatting.autolinkText(Formatting.autolinkUrls(d,i),i)}if(i.whiteList){d=Formatting.whiteList(d)}return d};if(l){if(c.format=="markdown"){f=f.replace(/\t/g,"    ")}f=Unfuddle.Formatting.conditionallyManipulate(f,$.extend(c,{notCodeCallback:g}))}try{switch(c.format){case"textile":var p=new FabricWire.converter();f="<div class='textile_formatted'>"+p.toHtml(f)+"</div>";break;case"markdown":var p=new Showdown.converter();f="<div class='markdown_formatted'>"+p.makeHtml(f)+"</div>";break;case"plain":f=soy.$$escapeHtml(f).replace(/\n/g,"<br/>").replace(/\s\s/g," &nbsp;");break;case"compact":f=soy.$$escapeHtml(f).replace(/\n/g," ");break;default:f=soy.$$escapeHtml(f).split("\n").join("<br/>")}}catch(err){f=soy.$$escapeHtml(m).split("\n").join("<br/>")}if(!l){f=Unfuddle.Formatting.conditionallyManipulate(f,$.extend(c,{notCodeCallback:g}))}try{var o=[];var q=null;HTMLParser(f,{start:function(d,i,h){var k="<"+d;for(var e=0;e<i.length;e++){k+=" "+i[e].name+'="'+i[e].escaped+'"'}k+=(h?"/":"")+">";o.push(k)},end:function(d){var i="</"+d+">";o.push(i)},chars:function(d){o.push(d)},comment:function(d){o.push("<!--"+d+"-->")}});return o.join("")}catch(err){}return f};Formatting.conditionallyManipulate=function(c,j){var j=j||{};var m=c;try{if(j.format=="default"){j.format=(j.account?j.account.text_markup:"markdown")}var l=null;if(j.format=="markdown"){l=/(.*?)(`.*?`)(.*?(?=(`)|$|\z)?)/g}else{if(j.format=="textile"){l=/(.*?)((?:\W@).*?(?:@\W))(.*?)/g}}var g=function(e){if((j.format=="markdown"&&e.indexOf("    ")<0)||(j.format=="textile")||(j.format=="plain")){if(l&&e.match(l)){e=e.replace(l,function(d,i,h,k){if(j.notCodeCallback&&i!=""){i=j.notCodeCallback(i,j)}if(j.notCodeCallback&&k!=""){k=j.notCodeCallback(k,j)}if(j.inCodeCallback&&h!=""){h=j.inCodeCallback(h,j)}return i+h+k})}else{if(j.notCodeCallback){e=j.notCodeCallback(e,j)}}}return e};if(c.indexOf("<code>")>=0){c=c.replace(/([\s\S]*?)(<code>[\s\S]*?<\/code>)([\s\S]*?(?=<code>)|[\s\S]*)/img,function(h,k,e,f){k=k.split("\n").map(function(d){return g(d)}).join("\n");f=f.split("\n").map(function(d){return g(d)}).join("\n");if(["markdown","textile"].include(j.format)){e=e.replace(/(<code>)([\s\S]*?)(<\/code>)/img,function(d,a,i,b){return a+soy.$$escapeHtml(i)+b})}if(j.inCodeCallback&&e!=""){e=j.inCodeCallback(e,j)}return k+e+f})}else{c=c.split("\n").map(function(d){return g(d)}).join("\n")}}catch(err){}return c};Formatting.autolinkText=function(l,g){if(g.project&&g.person){if(g.person.seeIf(g.project,"canReadNotebooks")){l=l.replace(/\[\[(.*?)\]\]/g,function(i,h){h=h.replace(/<em>|<\/em>|<i>|<\/i>/g,"_");h=h.replace(/<span class="caps">|<\/span>/g,"");h=h.replace(/\</g,"&lt;");h=h.replace(/\>/g,"&gt;");var k=h,e=null,f=null,c=null,j=null;if(k.include("|")){k=h.split("|").last()}if(h.include(":")){var a=h.split("|").first().split(":").map(function(d){return d.trim()});c=a[0];j=a[1]}else{j=h.split("|").first().trim()}if(!g.notebook&&!c){return"[["+h+"]]"}var e=c?Notebook.find({conditions:{project_id:g.project.id,title:c}})[0]:g.notebook;var f=Page.find({conditions:{title:j},evaluate:"object.notebook().title == "+c})[0];if(!e){g.sourceUrls["/projects/"+g.project.id+"/notebooks/by_title/"+c]={type:"Notebook"}}else{c=c||e.title}if(!f&&c){g.sourceUrls["/projects/"+g.project.id+"/notebooks/by_title/"+c+"/pages/by_title/"+j]={type:"Page"}}if(g.format=="markdown"){k=k.replace("_","_","g")}if(f&&e){return'<span class="notebook_page_existing"><a href="'+Bookmarker.bookmarkFor("notebook_page_show",{project_id:g.project.id,notebook_id:e.id,page_id:f.id})+'/latest">'+k+"</a></span>"}else{if(e){return'<span class="notebook_page_new"><a href="'+Bookmarker.bookmarkFor("notebook_page_new",{project_id:g.project.id,notebook_id:e.id})+"?title="+Url.encode(j).replace(/\+/g,"%2B").replace(/%20/g,"+")+'">'+k+"</a></span>"}else{return"[["+h+"]]"}}});l=l.replace(/\{\{(.*?)\}\}/g,function(i,h){h=h.replace(/<em>|<\/em>|<i>|<\/i>/g,"_");var k=null,e=null,f=null,a=h;if(h.include(":")){var b=h.split(":").map(function(d){return d.trim()});f=b[0];a=b[1]}if(!g.notebook&&!f){return"{{"+h+"}}"}var k=f?Notebook.find({conditions:{project_id:g.project.id,title:f}})[0]:g.notebook;if(!k){g.sourceUrls["/projects/"+g.project.id+"/notebooks/by_title/"+f]={type:"Notebook"}}if(k){e=Attachment.find({conditions:{parent_id:k.id,filename:a}})[0]}if(!e){g.sourceUrls["/projects/"+g.project.id+"/notebooks/by_title/"+f+"/attachments/by_filename"]={type:"Attachment",apiParams:{filename:a}}}if(e){return Config.baseUrl+Bookmarker.bookmarkFor("notebook_attachments",{project_id:g.project.id,notebook_id:k.id}).slice(1)+"/"+e.id+"/download"}else{return"{{"+h+"}}"}})}if(g.person.seeIf(g.project,"canReadSource")){l=l.replace(/\b(revision|commit):(?:([a-zA-Z0-9\-]+):)?(\w+)|(?:\[(?:([a-zA-Z0-9\-]+):)?(\w+)\](?=([^\(]|$)))/g,function(d,i,h,k,e,f){var c=h?h:(e?e:"");var j=k?k:(f?f:"");if(!j){return d}var m=null;if(c){m=Repository.find({conditions:{abbreviation:c}})[0];if(!m){g.sourceUrls["/repositories/by_abbreviation/"+c]={type:"Repository"}}}else{m=Repository.find({evaluate:"object.projects.include("+g.project.id+")"})[0];if(!m){g.sourceUrls["/projects/"+g.project.id+"/repositories"]={type:"Repository"}}}if(m){return'<a href="'+Bookmarker.bookmarkFor("project_repository_commit",{project_id:g.project.id,repository_id:m.id})+"?commit="+j+'">'+d+"</a>"}else{return d}});l=l.replace(/\bsource:(?:([a-zA-Z0-9\-]+):)?([^@\s\t\r\n\f\<\)]*)@?([a-zA-Z0-9]+)?/g,function(d,i,h,k){var e=null;if(i){e=Repository.find({conditions:{abbreviation:i}})[0];if(!e){g.sourceUrls["/repositories/by_abbreviation/"+i]={type:"Repository"}}}else{e=Repository.find({evaluate:"object.projects.include("+g.project.id+")"})[0];if(!e){g.sourceUrls["/projects/"+g.project.id+"/repositories"]={type:"Repository"}}}h=h.replace(/^\//g,"");if(!k){k="head"}if(g.format=="markdown"){d=d.replace("_","_","g")}if(e){return'<a href="'+Bookmarker.bookmarkFor("project_repository_file",{project_id:g.project.id,repository_id:e.id})+"?path="+h+"&commit="+k+'">'+d+"</a>"}else{return d}})}if(g.person.seeIf(g.project,"canReadTickets")){var p=/(?:(ticket:\d+)|(#\d+))/ig;l=l.replace(p,function(d,i,h){var k=i?i:h;var e=d.replace(/\D+/,"");var f=Ticket.getSourceUrl({project_id:g.project.id,number:e});g.sourceUrls[f]={type:"Ticket"};var c=Ticket.find({sourceUrl:f})[0];return c?(c.status=="closed"?"<span class='closed'>":"")+'<a title="'+soy.$$escapeHtml(c.summary.replace(/\'/g,"&quot;"))+'" href="'+Bookmarker.bookmarkFor("ticket_show_by_number",{project_id:g.project.id,number:e})+'">'+k+"</a>"+(c.status=="closed"?"</span>":""):d;return d})}}return l};Formatting.whiteList=function(r,n,t){n=$.extend({badTags:["script"],tags:"strong em b i p code pre tt output samp kbd var sub sup dfn cite big small address hr br div span h1 h2 h3 h4 h5 h6 ul ol li dt dd abbr acronym a img blockquote del ins fieldset legend table tr td tbody th tfoot thead".split(" "),attributes:"href src width height alt cite datetime title class cellpadding cellspacing border align name style".split(" "),styles:"background background-attachment background-color background-image background-position background-repeat border border-bottom border-bottom-color border-bottom-style border-bottom-width border-collapse border-color border-left border-left-color border-left-style border-left-width border-right border-right-color border-right-style border-right-width border-spacing border-style border-top border-top-color border-top-style border-top-width border-width bottom caption-side clear clip color content counter-increment counter-reset cursor direction display empty-cells float font font-family font-size font-size-adjust font-stretch font-style font-variant font-weight height left letter-spacing line-height list-style list-style-image list-style-position list-style-type margin margin-bottom margin-left margin-right margin-top marker-offset max-height max-width min-height min-width outline outline-color outline-style outline-width overflow padding padding-bottom padding-left padding-right padding-top position quotes right table-layout text-align text-decoration text-indent text-shadow text-transform top unicode-bidi vertical-align visibility white-space width word-spacing z-index".split(" "),styleValues:"absolute armenian auto baseline bidi-override blink block bold bolder both bottom capitalize caption center circle cjk-ideographic collapse compact condensed crosshair dashed decimal decimal-leading-zero default disc dotted double e-resize embed expanded extra-condensed extra-expanded fixed georgian groove hebrew help hidden hiragana hiragana-iroha icon inline inline-table inset inside invert italic justify katakana katakana-iroha large larger left lighter line-through list-item lower-alpha lower-greek lower-latin lower-roman lowercase ltr marker medium menu message-box middle move n-resize narrower ne-resize no-repeat none normal nowrap nw-resize oblique outset outside overline pointer pre relative repeat-x repeat-y ridge right run-in s-resize scroll se-resize semi-condensed semi-expanded separate shoe show small small-caps small-caption smaller solid square static status-bar sub super sw-resize table table-caption table-cell table-column table-column-group table-footer-group table-header-group table-row table-row-group text text-bottom text-top thick thin top transparent ultra-condensed ultra-expanded underline upper-alpha upper-latin upper-roman uppercase visible w-resize wait wider x-large x-small xx-large xx-small".split(" "),styleValueRegex:/^(#[0-9a-f]+|rgb\(\d+%?,\d*%?,?\d*%?\)?|\d{0,2}\.?\d{0,2}(cm|em|ex|in|mm|pc|pt|px|%|,|\))?)$/,protocols:"ed2k ftp http https irc mailto news gopher nntp telnet webcal xmpp callto feed".split(" "),protocolAttributes:"src href".split(" "),protocolSeparator:/:|(&#0*58)|(&#x70)|(%|&#37;)3A/},n);if(!r||!r.include("<")){return r}t=t||function(d,i){return n.badTags.include(i.toLowerCase())?d.replace(/</g,"&lt;").replace(/>/g,"&gt;"):d};try{var s=[];var u=null;HTMLParser(r,{start:function(l,g,p){var o="<"+l;if(g){$.each(g,function(f,c){if(!c){return true}if(c.name=="style"){var j=[];var m=c.value.replace(/\n|\r/g,"").split(";");$.each(m,function(d,i){var h=i.split(":");var k=h[0].trim();var e=h[1].trim();if(!n.styles.include(k)){return true}if(e.split(" ").map(function(v){return n.styleValues.include(v)||v.match(n.styleValueRegex)}).include(false)){return true}j.push(k+": "+e)});if(j.length==0){g.remove(c)}else{c.escaped=j.join(";")}}else{if(!n.attributes.include(c.name)||(n.protocolAttributes.include(c.name)&&(c.value.match(n.protocolSeparator)&&!n.protocols.include(c.value.split(n.protocolSeparator).first())))){g.remove(c)}else{c.escaped=c.value.replace("'","&#39;","g").replace('"',"&quot;","g").replace("<","&lt;","g").replace(">","&gt;","g")}}})}for(var q=0;q<g.length;q++){o+=" "+g[q].name+'="'+g[q].escaped+'"'}o+=(p?"/":"")+">";if(!n.tags.include(l)){o=t(o,l)}s.push(o)},end:function(d){var i="</"+d+">";if(!n.tags.include(d)){u=d;i=t(i,u)}s.push(i)},chars:function(d){s.push(d)},comment:function(d){s.push("<!--"+d+"-->")}},{removeUnOpenedTags:false,closeOpenedTags:false});return s.join("")}catch(err){return soy.$$escapeHtml(r)}};Formatting.GenericDepencyHandler=function(k,e){this.tmp=Unfuddle.UI.Renderer;this.tmp({});delete this.tmp;this.containerID="#content";this.domID="#generic_dependency_handler";var self=this;$.each(k,function(d,i){var h=i.apiParams?{apiParams:i.apiParams}:{};self.dependsOn(i.type,d,{essential:true,findParams:h})});this.renderMain=function(){this.renderMainLocked=true;this.close();e()}};Formatting.autolinkUrls=function(e,f){if(e.match(/\[\!\[.*?\]\(/)&&f.format=="markdown"){return e}var c=/(<\w+.*?>|\[.*?\]\(|\[.*?\]\:\s+\<?|\".*?\"\:[^\s]|[^=!:\'"\/]|^)((?:https?:\/\/)|(?:www\.))((?:\w+?\:?\w+?@))?([-\w]+(?:\.[-\w]+)*(?::\d+)?(?:\/(?:(?:\#|[~\w\+%-]|(?:[,.;:][^\s><$]))+)?)*(?:\?[\w\+%&=.;-]+)?(?:\#[\w\-]*)?)([-\!"#\$%&'\(\)\*\+,\.\/\:;<\=>\?@\[\]\^_`{\|}~]|\s|<|$)/g;e=e.replace(c,function(d,a,b,i,h,k){i=i||"";if(a.match(/<a\s/i)){return d}else{if(a.match(/\[.*?\]\(/)&&f.format=="markdown"){return d}else{if(a.match(/\[.*?\]\:\s+\<?/)&&f.format=="markdown"){return d}else{if(a.match(/\[.*?\]\(/)&&(b.indexOf("http")==0||b.indexOf("www")==0)&&f.format=="textile"){return d}else{if(a.match(/.*\".*?\"\:[^\s]/)&&f.format=="textile"){return d}else{if(d.match(/\<[^\<\s]*\>/)&&b&&b.indexOf("http")==0&&f.format=="markdown"){return d}else{e=b+i+h;if(f.format=="markdown"){e=e.replace("_","_")}return a+'<a href="'+(b=="www."?"http://www.":b)+i+h+'">'+e+"</a>"+k}}}}}}});return e};

Unfuddle.Data={Cache:function(m){m=m||{};this.indices=m.indices||[];this.specialIndices=m.specialIndices||{};this.retrievers=[];this.resourceType=m.resourceType||"";this.data={id:{},array:[],sources:{}};this.subscriptions={};this.subscribers=[];this.refreshTimeout=10;this.urlPrefix=m.urlPrefix||Unfuddle.Config.baseApiUrl;this.dataType=m.dataType||"json";this.sendSslHeader=m.sendSslHeader||false;this.write=function(i,h,l){var self=this;var l=l||{};var n=isEmpty(l)?h:h+"|"+jsonToString(l);if(!(i instanceof Array)){i=[i]}if(i.length==0&&h){this.data.sources[n]={time:new Date,objects:[]};this.notifySubscribers(h);return}var e={};$.extend(e,this.data);var self=this;var o=new Date;if(h){var p=[h];e.sources=e.sources||{};e.sources[n]=e.sources[n]||{};e.sources[n].objects=i;e.sources[n].time=o}i.forEach(function(f,j){if(self.dataType=="json"&&h){var k=e.id[f.id]==null;if(f.id&&!h.endsWith("/"+f.id)){var g=h+"/"+f.id;e.sources[g]=e.sources[g]||{};e.sources[g].objects=[f];e.sources[g].time=o;p.push(g)}else{$.each(e.sources,function(c,b){if(h.indexOf(c)==0&&h.length!=c.length){if(k){b.objects.push(f)}p.push(c)}})}}if(k){$.each(self.indices,function(c,b){e[b]=e[b]||{};e[b][f[b]]=e[b][f[b]]||[];e[b][f[b]].push(f)});$.each(self.specialIndices,function(a,d){e[d]=e[d]||{};$.each(f[a],function(c,b){e[d][b]=e[d][b]||[];e[d][b].push(f)})});if(f.id!=null){e.id=e.id||{};e.id[f.id]=f}e.array=e.array||[];e.array.push(f)}});tmp=this.data;this.data=e;delete tmp;if(p){$.each(p,function(c,b){self.notifySubscribers(b)})}};this.unCache=function(j,k){k=k||false;var g=[];if(!(j instanceof Array)){j=[j]}var self=this;$.each(j,function(f,object){if(object&&object.id&&self.data.id[object.id]){object=self.data.id[object.id];$.each(self.data,function(a,d){switch(a){case"sources":$.each(self.data.sources,function(c,b){b.objects.remove(object);if(b.objects.length==0){delete self.data.sources[c]}});break;case"array":self.data.array.remove(object);break;case"id":if(self.data.id[object.id]){delete self.data.id[object.id]}break;default:$.each(d,function(c,b){b.remove(object)});break}});if(k){g.pushUnique(Unfuddle.Data[self.resourceType].getSourceUrl(object));delete object.id;g.pushUnique(Unfuddle.Data[self.resourceType].getSourceUrl(object))}}});if(g){$.each(g,function(c,b){self.notifySubscribers(b)})}};this.read=function(a){var d=false;var f=false;var result=null;var j=true;var k="id";var g=a&&a.apiParams?a.apiParams:{};var self=this;var i={};if(a!=null){if(typeOf(a)=="number"||typeOf(a)=="string"){a={conditions:{id:a}}}else{if(a.id){a.conditions=a}}if(isEmpty(a.conditions)){delete a.conditions}$.extend(i,a.conditions)}var h=a&&a.sourceUrl?a.sourceUrl:Unfuddle.Data[this.resourceType].getSourceUrl(i);if(h!=""){var l=isEmpty(g)?h:h+"|"+jsonToString(g);if(this.data.sources&&this.data.sources[l]){var n=this.data.sources[l].time;if(a&&(a.sourceUrl||a.apiParams)){result=this.data.sources[l].objects.slice();j=false}if(((new Date)-n)>nMinutes(this.refreshTimeout)){this.retrieve({sourceUrl:h,apiParams:g,criteria:(a&&a.conditions?a.conditions:{})});f=true}}else{if(a&&(a.sourceUrl||a.apiParams)){this.retrieve({sourceUrl:h,apiParams:g,criteria:(a&&a.conditions?a.conditions:{})});result=[]}d=self.retrievers.include(l)}}var e="true";if(self.data.array.length){if(i.id!=null){if([self.data.id[i.id]]){result=self.data.id[i.id]}}else{result=result||self.data.array.slice();$.each(i,function(c,b){if(self.indices.indexOf(c)>=0&&self.data[c]){if(self.data[c][b]&&self.data[c][b].length){if(j&&self.data[c][b].length<result.length){result=self.data[c][b]}}else{result=[];return false}}if(c!="evaluate"){if(["null","boolean","number"].indexOf(typeOf(b))<0){b="'"+b+"'"}e+=" && object."+c+" == "+b}else{e+=" && "+b}});if(result.length&&e!="true"){eval("result = result.filter(function(object) { return "+e+"})")}}}result=result||[];if(!(result instanceof Array)){result=[result]}var o=result.length;if(a&&result.length>0){if(a.order){result.sortByExpression(a.order)}if(a.skip!=null){result=result.slice(a.skip)}if(a.limit!=null){result=result.slice(0,a.limit)}if(a.last!=null){result=result.reverse();result=result.slice(0,a.last);result=result.reverse()}}result.objects=["You don't have to use .objects for the find result!"];return $.extend(result,{pending:d,expired:f,totalItems:o})};this.retrieve=function(d){d=$.extend({sourceUrl:"",criteria:{},apiParams:{}},d);var f=isEmpty(d.apiParams)?d.sourceUrl:d.sourceUrl+"|"+jsonToString(d.apiParams);var self=this;var j=self.retrievers.include(f);var k=d.sourceUrl.indexOf("?")<0?".json?"+Config.assets_random:"";if(!j){if(Utilities.isAuthenticated()){self.retrievers.push(f)}var g=$.ajax({type:"GET",data:d.apiParams,dataType:self.dataType,url:self.urlPrefix+d.sourceUrl+k,success:function(c,b){if(c==null){c=[]}self.process(c,d.sourceUrl,{criteria:d.criteria,apiParams:d.apiParams,originalResource:d.originalResource});self.retrievers.remove(f);if(d.callback){d.callback(c)}},error:function(c,b,a){self.retrievers.remove(f);self.write([],d.sourceUrl,d.apiParams);if(d.callback){d.callback()}}})}};this.preProcess=function(c,b){return c};this.process=function(a,d,f){f=f||{};var j=f.criteria||{};var k=f.forceWrite||false;var g=[];var self=this;a=this.preProcess(a,d);if(!(a instanceof Array)){a=[a]}$.each(a,function(c,b){if(self.dataType=="json"){b=$.extend({},j,b);b.sourceUrl=d;var object=f.originalResource||self.data.id[b.id];if(object){$.extend(true,object,b);object.init();object.formatted=false}else{object=new Unfuddle.Data[self.resourceType].Base(b)}g.push(object)}else{g.push(b)}});if(g.length||!a.length||k){this.write(g,d,f.apiParams)}};this.erase=function(){delete this.data;this.data={id:{},array:[],sources:{}};this.notifySubscribers("Cache cleared",true)};this.subscribe=function(c,b,a){if(!this.subscribers[c]){this.subscribers.pushUnique(c)}this.subscriptions[b]=this.subscriptions[b]||[];this.subscriptions[b].pushUnique(c);var a=$.extend({},{sourceUrl:b},a);return this.read(a)};this.unsubscribe=function(a){this.subscribers.remove(a);$.each(this.subscriptions,function(c,b){b.remove(a)})};this.notifySubscribers=function(a,d){var self=this;var f=$.extend(true,[],self.subscriptions[a]);if(f){$.each(f,function(c,b){if(!b){return true}b.eventNotification(a)})}else{if(d){$.each(this.subscribers,function(c,b){b.eventNotification(a)})}}}}};Unfuddle.Data.checkBasicDependencies=function(){return Globals.currentAccount&&Globals.currentPerson};Unfuddle.Data.getBasicDependencies=function(b){var a="";if(location.protocol=="http:"&&Config.ssl){a="https:";if(!Config.development&&location.protocol!=a){UI.Bookmarker.removeListener();location.href=location.href.replace(location.protocol,a);return}}Globals.currentAccount=Globals.currentPerson=null;Account.Cache.retrieve({sourceUrl:"/account",callback:function(c){Globals.currentAccount=Account.current();if(b&&Unfuddle.Data.checkBasicDependencies()){b()}}});Person.Cache.retrieve({sourceUrl:"/people/current",callback:function(c){Globals.currentPerson=Person.find(c.id)[0];if(b&&Unfuddle.Data.checkBasicDependencies()){b()}}});Project.Cache.retrieve({sourceUrl:"/projects",callback:function(c){Globals.allProjects=Project.find();if(b&&Unfuddle.Data.checkBasicDependencies()){b()}}})};

Unfuddle.Data.Resource=function(m){this.initialize=function(){};this.init=function(d){$.extend(this,d);if(this.created_at){this.created_at=Utilities.parseDate(this.created_at)}if(this.updated_at){this.updated_at=Utilities.parseDate(this.updated_at)}var self=this;if(this.resourceType&&Unfuddle.Data[this.resourceType].dateFields){$.each(Unfuddle.Data[this.resourceType].dateFields,function(a,c){if(self[c]){self[c]=Utilities.parseDate(self[c])}})}this.initialize()};this.objectID=Math.random();var self=this;var n=function(a){return a.replace("&","&amp;").replace("<","&lt;").replace(">","&gt;")};this.getRootNode=function(){return this.resourceType.toLowerCase()};this.validField=function(a){return Unfuddle.Data[self.resourceType].fields.indexOf(a)>=0||a=="_method"};this.customTag=function(a,c){return""};this.toXml=function(){return Utilities.jsonToXml(this,this.getRootNode(),this.validField,this.customTag)};this.afterSave=function(){};this.create=function(e){var f=this.toXml();var i=Unfuddle.Data[this.resourceType].Cache.urlPrefix;var h=Unfuddle.Data[this.resourceType].getSourceUrl($.extend({useID:true},this))+".json";if(h!=""){var self=this;var j=false;var k=$.ajax({url:i+h,type:"POST",data:f,contentType:"application/xml",dataType:"text",success:function(c,d){var b=k.getResponseHeader("Location");self.id=b.split("/").pop();var g=Unfuddle.Data[self.resourceType].getSourceUrl($.extend({useID:true},self));Unfuddle.Data[self.resourceType].Cache.retrieve({sourceUrl:g,callback:function(a){self.init(a);self.action_results={success:true,textStatus:d,action:"created"};self.afterSave();if(e){e(a)}}})},error:function(a,c,d){var b=[];try{b=JSON.parse(a.responseText)}catch(err){}if(b.length<=0){b=["An unexpected error occured. Please try again!"]}self.action_results={success:false,textStatus:c,errors:b,action:"created",errorThrown:d,xhr:XMLHttpRequest};if(e){e()}}})}};this.update=function(e,f){if(e instanceof Function){var f=e;var e=this}var self=this;var i=Utilities.jsonToXml(e,this.getRootNode(),this.validField,this.customTag);var h=Unfuddle.Data[this.resourceType].Cache.urlPrefix;var j=Unfuddle.Data[this.resourceType].getSourceUrl($.extend({useID:true},this))+".json";var k=false;var l=$.ajax({url:h+j,type:"POST",beforeSend:function(a){if(this.dataType!="script"&&UI.Helpers.checkSessionExpired()){return false}if(location.protocol=="https:"){a.setRequestHeader("X-Unfuddle-Ajax-Secure",1)}a.setRequestHeader("X-Unfuddle-Ajax-Client",1);a.setRequestHeader("X-HTTP-METHOD-OVERRIDE","PUT")},data:i,contentType:"application/xml",dataType:"text",success:function(c,d){var b=l.getResponseHeader("Location");if(b){self.id=b.split("/").pop()}$.extend(true,self,e);var g=Unfuddle.Data[self.resourceType].getSourceUrl($.extend({useID:true},self));if(!Config.development&&window.location.protocol=="http:"&&Config.ssl){self.action_results={success:true,textStatus:d,action:(b?"created":"updated")};self.afterSave();if(f){f(c)}}else{Unfuddle.Data[self.resourceType].Cache.unCache(self);Unfuddle.Data[self.resourceType].Cache.retrieve({sourceUrl:g,originalResource:self,callback:function(a){self.action_results={success:true,textStatus:d,action:(b?"created":"updated")};self.afterSave();if(f){f(a)}}})}},error:function(a,c,d){var b=[];try{b=JSON.parse(a.responseText)}catch(err){}if(b.length<=0){b=["An unexpected error occured. Please try again!"]}self.action_results={success:false,textStatus:c,errors:b,action:"updated",errorThrown:d,xhr:XMLHttpRequest};if(f){f()}}})};this.destroy=function(g){var e=Unfuddle.Data[this.resourceType].Cache.urlPrefix;var f=Unfuddle.Data[this.resourceType].getSourceUrl($.extend({useID:true},this))+".json";if(f!=""){var self=this;$.ajax({url:e+f,type:"POST",data:{_method:"DELETE"},dataType:"application/json",contentType:"application/x-www-form-urlencoded",success:function(a,c){var d=Unfuddle.Data[self.resourceType].getSourceUrl($.extend({useID:true},self));if(self.afterDestroy){self.afterDestroy()}else{Unfuddle.Data[self.resourceType].Cache.unCache(self)}self.action_results={success:true,textStatus:c,action:"deleted"};self.afterSave();if(g){g()}},error:function(a,c,d){var b=[];try{b=JSON.parse(a.responseText)}catch(err){}if(b.length<=0){b=["An unexpected error occured. Please try again!"]}self.action_results={success:false,textStatus:c,errors:b,action:"deleted",errorThrown:d,xhr:XMLHttpRequest};if(g){g()}}})}};this.save=function(a,c){if(a instanceof Function){var c=a;var a=null}if(this.id){return a?this.update(a,c):this.update(c)}else{return this.create(c)}}};

Unfuddle.Data.Account={fields:["default_ticket_report_id","default_time_zone","description","plan","text_markup","title","force_ssl","billing_first_name","billing_last_name","billing_company","billing_email","billing_street1","billing_street2","billing_city","billing_state","billing_postal_code","billing_country","billing_type","billing_cc_number","billing_cc_exp_month","billing_cc_exp_year","billing_cc_verification_code","from"],dateFields:["billing_error_date","billing_error_reminded_at","trial_enabled_on"],VALID_MARKUP:[{name:"markdown",displayName:"Markdown"},{name:"textile",displayName:"Textile"},{name:"plain",displayName:"Plain Text"}],FEATURES:["price_per_month","storage","max_projects","max_archived_projects","max_pages","attachments","time_tracking","ssl"],FEATURES_RENDERED:[{feature:"storage",value:"disk",title:"Storage"},{feature:"max_projects",value:"integer",title:"Active Projects"},{feature:"max_archived_projects",value:"integer",title:"Archived Projects"},{feature:"max_people",value:"integer",title:"People"},{feature:"max_pages",value:"integer",title:"Notebook Pages"},{feature:"",value:"integer",title:"Repositories<br/>Subversion &amp; Git"},{feature:"",value:"boolean",title:"Messages"},{feature:"",value:"boolean",title:"Milestones"},{feature:"",value:"boolean",title:"Bug Tracking"},{feature:"",value:"boolean",title:"RSS and iCal"},{feature:"ssl",value:"boolean",title:"SSL"},{feature:"attachments",value:"boolean",title:"File Attachments"},{feature:"time_tracking",value:"boolean",title:"Time Tracking"},{feature:"demographic",value:"text",title:"Demographic"}],VALID_PLANS:{"private":{plan:"private",price_per_month:0,storage:200,max_projects:1,max_archived_projects:0,max_people:2,max_pages:3,attachments:false,time_tracking:false,ssl:true,sort_order:2,promotional:false,beta:false,demographic:"Small, single developer projects"},micro:{plan:"micro",price_per_month:9,storage:512,max_projects:4,max_archived_projects:4,max_people:10,max_pages:99999,attachments:true,time_tracking:false,ssl:true,sort_order:3,promotional:false,beta:false,demographic:"Small teams of developers"},compact:{plan:"compact",price_per_month:24,storage:1024*2,max_projects:10,max_archived_projects:10,max_people:20,max_pages:99999,attachments:true,time_tracking:false,ssl:true,sort_order:4,promotional:false,beta:false,demographic:"Small teams requiring a secure connection"},corporate:{plan:"corporate",price_per_month:49,storage:1024*4,max_projects:20,max_archived_projects:20,max_people:1000,max_pages:99999,attachments:true,time_tracking:true,ssl:true,sort_order:5,promotional:false,beta:false,demographic:"Larger development teams"},enterprise:{plan:"enterprise",price_per_month:99,storage:1024*10,max_projects:50,max_archived_projects:50,max_people:1000,max_pages:99999,attachments:true,time_tracking:true,ssl:true,sort_order:6,promotional:false,beta:false,demographic:"Very large development teams"}},Cache:new Unfuddle.Data.Cache({resourceType:"Account",sendSslHeader:true}),Base:function(d){this.tmp=Unfuddle.Data.Resource;this.tmp(d);delete this.tmp;this.resourceType="Account";this.hasFeature=function(b){if(!b){return null}if(b!="price_per_month"&&((this.flagged_for_billing_error&&(!this.billing_error_date||(this.billing_error_date.justDate()<(new Date)._setDate((new Date).getDate()-14).justDate()))))){return Account.VALID_PLANS["private"][b]}else{if(this.features[b]!=null){return this.features[b]}else{return Account.VALID_PLANS[this.plan][b]}}};this.whatIs=this.hasFeature;this.peopleCollection=function(b){var a=(b&&b.adminsFirst)?b.adminsFirst:false;if(a){return Person.find({conditions:{is_removed:false},order:"is_administrator desc, object.displayName()"})}else{return Person.find({conditions:{is_removed:false},order:"object.displayName()"})}};this.people=this.peopleCollection;this.administrators=function(){return Person.find({conditions:{is_administrator:true,is_removed:false},order:["last_name","first_name","email"]})};this.invoices=function(){return Invoice.find({order:"billing_period desc"})};this.actuallyUsesAtAll=function(c){var e=false;$.each(Project.find(),function(b,a){if(a.actuallyUses(c)){e=true;return false}});return e};this.actual_default_ticket_report_id=function(){var self=this;if(self.default_ticket_report_id&&TicketReport.find(self.default_ticket_report_id)[0]){return self.default_ticket_report_id}var b=TicketReport.find({conditions:{parent_type:"Account",parent_id:self.id},order:["object.title asc"]});ret="dynamic";if(b.length>0){ret=b[0].id}return ret};this.textMarkups=function(){var self=this;return Account.VALID_MARKUP.filter(function(b){return self.text_markup.indexOf(b.name)>=0})};this.textMarkupDefault=function(){return this.textMarkupList()[0]};this.textMarkupList=function(){return this.text_markup.split(",").map(function(b){return b.toLowerCase()})};this.activeProjects=function(){return Project.find({conditions:{archived:false},order:["object.title.toLowerCase()","object.short_name.toLowerCase()"]})};this.archivedProjects=function(){return Project.find({conditions:{archived:true},order:["object.title.toLowerCase()","object.short_name.toLowerCase()"]})};this.billingInformationComplete=function(){return(this.whatIs("price_per_month")==0)||(!blank(this.billing_first_name)&&!blank(this.billing_last_name)&&!blank(this.billing_street1)&&!blank(this.billing_city)&&!blank(this.billing_postal_code)&&!blank(this.billing_country)&&!blank(this.billing_type)&&!blank(this.billing_cc_number_short)&&!blank(this.billing_email))};this.billingInformationMissing=function(){var c=[];var e=[["billing_first_name","First Name"],["billing_last_name","Last Name"],["billing_street1","Street"],["billing_city","City"],["billing_postal_code","Postal Code"],["billing_country","Country"],["billing_type","Card Type"],["billing_cc_number_short","Credit Card Number"],["billing_email","Email"]];var self=this;$.each(e,function(b,a){if(self[a[0]]==null||self[a[0]]==""){c.push(a)}});return c};this.isCompliant=function(){if(this.activeProjects().length>this.whatIs("max_projects")||this.archivedProjects().length>this.whatIs("max_archived_projects")||this.people().length>this.whatIs("max_people")){return false}return true};this.checkCompliance=function(b){var a=new Date;if(["account_settings","account_billing","account_confirm_delete","account_person_index","person_index","account_compliance"].indexOf(b)>=0){return true}if(this.whatIs("price_per_month")>0&&(!this.billingInformationComplete()||(this.flagged_for_billing_error&&(!this.billing_error_reminded_at||(this.billing_error_reminded_at&&(a-this.billing_error_reminded_at)>=nDays(1))))||(this.flagged_for_billing_error&&this.billing_error_date&&(a-this.billing_error_date)>=nDays(14)))){return"billing_error"}if(["project_index","project_settings"].indexOf(b)>=0){return true}if(!this.isCompliant()){return"compliance_error"}return true};this.newOrUpgrade=function(){var b=this.invoices()[0];return(this.whatIs("price_per_month")>0&&(b==null||(this.billing_frequency!="yearly"&&((new Date()-b.created_at)>nMonths(2)))||(this.billing_frequency=="yearly"&&((new Date()-b.created_at)>nMonths(13)))))};this.recentActivity=function(){return Activity.find({order:["object.created_at desc"]})};this.init(d)},current:function(){return Account.find()[0]},getSourceUrl:function(b,a){return"/account"},find:function(b){return this.Cache.read(b)}};Account=Unfuddle.Data.Account;Account.Cache.preProcess=function(e){if(e.id){return e}var d={};if(e.projects){$.each(e.projects,function(b,a){var c=Project.getSourceUrl();d[c]=d[c]||[];d[c].push(a);c=Component.getSourceUrl({project_id:a.id});if(!Component.Cache.data.sources[c]){Component.Cache.process([],c)}c=Severity.getSourceUrl({project_id:a.id});if(!Severity.Cache.data.sources[c]){Severity.Cache.process([],c)}c=Version.getSourceUrl({project_id:a.id});if(!Version.Cache.data.sources[c]){Version.Cache.process([],c)}c=Milestone.getSourceUrl({project_id:a.id});if(!Milestone.Cache.data.sources[c]){Milestone.Cache.process([],c)}c=CustomFieldValue.getSourceUrl({project_id:a.id});if(!CustomFieldValue.Cache.data.sources[c]){CustomFieldValue.Cache.process([],c)}})}$.each(d,function(b,a){Project.Cache.process(a,b)});d={};if(e.components){$.each(e.components,function(b,a){var c=Component.getSourceUrl({project_id:a.project_id});d[c]=d[c]||[];d[c].push(a)})}$.each(d,function(b,a){Component.Cache.process(a,b)});d={};if(e.severities){$.each(e.severities,function(b,a){var c=Severity.getSourceUrl({project_id:a.project_id});d[c]=d[c]||[];d[c].push(a)})}$.each(d,function(b,a){Severity.Cache.process(a,b)});d={};if(e.versions){$.each(e.versions,function(b,a){var c=Version.getSourceUrl({project_id:a.project_id});d[c]=d[c]||[];d[c].push(a)})}$.each(d,function(b,a){Version.Cache.process(a,b)});d={};if(e.milestones){$.each(e.milestones,function(b,a){var c=Milestone.getSourceUrl({project_id:a.project_id});d[c]=d[c]||[];d[c].push(a)})}$.each(d,function(b,a){Milestone.Cache.process(a,b)});d={};if(e.custom_field_values){$.each(e.custom_field_values,function(b,a){var c=CustomFieldValue.getSourceUrl({project_id:a.project_id});d[c]=d[c]||[];d[c].push(a)})}$.each(d,function(b,a){CustomFieldValue.Cache.process(a,b)});d={};if(e.categories){$.each(e.categories,function(b,a){var c=Category.getSourceUrl({project_id:a.project_id});d[c]=d[c]||[];d[c].push(a)})}$.each(d,function(b,a){Category.Cache.process(a,b)});d={};if(e.involvements){$.each(e.involvements,function(b,a){var c=Involvement.getSourceUrl({person_id:a.person_id});d[c]=d[c]||[];d[c].push(a)})}$.each(d,function(b,a){Involvement.Cache.process(a,b)});d={};if(e.people){$.each(e.people,function(b,a){var c=Person.getSourceUrl();d[c]=d[c]||[];d[c].push(a)})}$.each(d,function(b,a){Person.Cache.process(a,b)});d={};if(e.repositories){$.each(e.repositories,function(b,a){var c=Repository.getSourceUrl();d[c]=d[c]||[];d[c].push(a)})}$.each(d,function(b,a){Repository.Cache.process(a,b)});return e.account?e.account:[]};

Unfuddle.Data.Project={fields:["account_id","archived","assignee_on_resolve","backup_frequency","close_ticket_simultaneously_default","default_ticket_report_id","description","disk_usage","enable_time_tracking","project_repository_type","s3_access_key_id","s3_backup_enabled","s3_bucket_name","s3_secret_access_key","short_name","theme","ticket_field1_active","ticket_field1_disposition","ticket_field1_title","ticket_field2_active","ticket_field2_disposition","ticket_field2_title","ticket_field3_active","ticket_field3_disposition","ticket_field3_title","title"],Cache:new Unfuddle.Data.Cache({resourceType:"Project",sendSslHeader:true}),Base:function(g){this.tmp=Unfuddle.Data.Resource;this.tmp(g);delete this.tmp;this.resourceType="Project";this.messages=function(){return Message.find({conditions:{project_id:this.id}})};this.involvements=function(){if(!this.id){return{}}var c=Involvement.find({conditions:{project_id:this.id}});var result={};result.pending=c.pending;result.array=c;$.each(c,function(a,b){result[b.person_id]=b});return result};this.hasFeature=function(a){return Account.current().hasFeature(a)};this.upcomingMilestones=function(){return Milestone.find({conditions:{project_id:this.id,archived:false,completed:false,evaluate:"object.due_on.justDate() >= (new Date).justDate()"},order:"due_on, title"})};this.lateMilestones=function(){return Milestone.find({conditions:{project_id:this.id,archived:false,completed:false,evaluate:"object.due_on.justDate() < (new Date).justDate()"},order:"due_on, title"})};this.completeMilestones=function(){return Milestone.find({conditions:{project_id:this.id,archived:false,completed:true},order:"due_on, title"})};this.archivedMilestones=function(){return Milestone.find({conditions:{project_id:this.id,archived:true},order:"due_on, title"})};this.activeMilestones=function(){return Milestone.find({conditions:{project_id:this.id,archived:false},order:"due_on, title"})};this.involvedPeople=function(e){var d=(e&&e.adminsFirst)?e.adminsFirst:false;var f=[];$.each(this.involvements().array,function(a,b){var c=Person.find(b.person_id)[0];if(c&&!c.is_removed){f.push(c)}});if(d){return f.sortByExpression("is_administrator desc, object.involvements()["+this.id+"].is_administrator desc, object.displayName()")}else{return f.sortByExpression("object.displayName() asc")}};this.ticketReports=function(){return TicketReport.find({conditions:{project_id:this.id},order:["title"]})};this.backups=function(){return Backup.find({conditions:{project_id:this.id},order:["created_at"]})};this.backupsProcessed=function(){return Backup.find({conditions:{project_id:this.id,processed:true},order:["processed_at DESC"]})};this.actuallyUses=function(a){if(a=="time_tracking"){return Account.current().hasFeature(a)&&this.enable_time_tracking}else{return Account.current().hasFeature(a)}};this.severities=function(){return Severity.find({conditions:{project_id:this.id},order:["name"]})};this.components=function(){return Component.find({conditions:{project_id:this.id},order:["name"]})};this.versions=function(){return Version.find({conditions:{project_id:this.id},order:["name"]})};this.customFieldValues=function(a){return CustomFieldValue.find({conditions:{project_id:this.id,field_number:a},order:["value"]})};this.repositories=function(){return Repository.find({conditions:{evaluate:"object.projects.indexOf("+this.id+") >= 0"}})};this.actual_default_ticket_report_id=function(){var self=this;if(self.default_ticket_report_id&&TicketReport.find(self.default_ticket_report_id)[0]){return self.default_ticket_report_id}var a=TicketReport.find({conditions:{parent_type:"Project",parent_id:self.id},order:["object.title asc"]});ret="dynamic";if(a.length>0){ret=a[0].id}return ret};this.recentActivity=function(){return Activity.find({conditions:{project_id:this.id},order:["object.created_at desc"]})};this.permValueFor=function(a,b,c){var e;if(c){e=c[a.id]}else{e=this.involvements()[a.id]}if(e){return e[b]}else{return"none"}};this.init(g)},current:function(){if(Config.currentProjectID){return Project.find(Config.currentProjectID)[0]}return null},getSourceUrl:function(a,b){var c={};$.extend(c,a);var e="/projects";if(a&&a.useID&&a.id!=null){e+="/"+a.id;delete a.id}if(!b){$.extend(a,c)}return e},find:function(a){return this.Cache.read(a)},themesAvailable:function(){var a=[["green","rgb(1,  102,30 )"],["grey","rgb(63, 63, 63 )"],["orange","rgb(194,76, 2  )"],["purple","rgb(98, 29, 148)"],["teal","rgb(1,  91, 91 )"],["red","rgb(147,27, 29 )"],["blue","rgb(19, 72, 140)"]];return a}},Project=Unfuddle.Data.Project;Project.Cache.preProcess=function(e){if(e.id||e.length){return e}var d={};if(e.components){$.each(e.components,function(a,b){var c=Component.getSourceUrl({project_id:b.project_id});d[c]=d[c]||[];d[c].push(b)})}$.each(d,function(a,b){Component.Cache.process(b,a)});d={};if(e.severities){$.each(e.severities,function(a,b){var c=Severity.getSourceUrl({project_id:b.project_id});d[c]=d[c]||[];d[c].push(b)})}$.each(d,function(a,b){Severity.Cache.process(b,a)});d={};if(e.versions){$.each(e.versions,function(a,b){var c=Version.getSourceUrl({project_id:b.project_id});d[c]=d[c]||[];d[c].push(b)})}$.each(d,function(a,b){Version.Cache.process(b,a)});d={};if(e.milestones){$.each(e.milestones,function(a,b){var c=Milestone.getSourceUrl({project_id:b.project_id});d[c]=d[c]||[];d[c].push(b)})}$.each(d,function(a,b){Milestone.Cache.process(b,a)});d={};if(e.custom_field_values){$.each(e.custom_field_values,function(a,b){var c=CustomFieldValue.getSourceUrl({project_id:b.project_id});d[c]=d[c]||[];d[c].push(b)})}$.each(d,function(a,b){CustomFieldValue.Cache.process(b,a)});d={};if(e.categories){$.each(e.categories,function(a,b){var c=Category.getSourceUrl({project_id:b.project_id});d[c]=d[c]||[];d[c].push(b)})}$.each(d,function(a,b){Category.Cache.process(b,a)});d={};if(e.involvements){$.each(e.involvements,function(a,b){var c=Involvement.getSourceUrl({person_id:b.person_id});d[c]=d[c]||[];d[c].push(b)})}$.each(d,function(a,b){Involvement.Cache.process(b,a)});d={};if(e.people){$.each(e.people,function(a,b){var c=Person.getSourceUrl();d[c]=d[c]||[];d[c].push(b)})}$.each(d,function(a,b){Person.Cache.process(b,a)});d={};if(e.repositories){$.each(e.repositories,function(a,b){var c=Repository.getSourceUrl();d[c]=d[c]||[];d[c].push(b)})}$.each(d,function(a,b){Repository.Cache.process(b,a)});return e.project?e.project:[]};

Unfuddle.Data.Person={fields:["email","first_name","is_administrator","last_name","notification_frequency","notification_ignore_self","notification_scope_messages","notification_scope_milestones","notification_scope_source","notification_scope_tickets","notification_scope_notebooks","time_zone","username","show_help_messages","text_markup","password","password_confirmation","identity_url"],dateFields:["last_signed_in"],Cache:new Unfuddle.Data.Cache({resourceType:"Person",indices:["person_id"],sendSslHeader:true}),Base:function(e){this.tmp=Unfuddle.Data.Resource;this.tmp(e);delete this.tmp;var self=this;this.resourceType="Person";this.afterDestroy=function(){self.is_removed=true};this.displayName=function(a){a=a||false;var c=this.first_name||"";var b=this.last_name||"";if(!a&&b){b=b.slice(0,1)+"."}if(c&&b){return c+" "+b}else{if(c){return c}else{return this.email}}};this.involvements=function(){if(!this.id){return{}}var b=Involvement.find({conditions:{person_id:this.id}});var result={};result.array=b;$.each(b,function(a,c){result[c.project_id]=c});return result};this.removable=function(){if(this.is_removed||(this.is_administrator&&Globals.currentAccount.administrators().length==1)){return false}return true};this.permValueFor=function(a,c,b){var d;if(b){d=b[a.id]}else{d=this.involvements()[a.id]}if(d){return d[c]}else{return"none"}};this.seeIf=function(a,c){if(!a){return false}if(this.is_removed){return false}if(this.is_administrator&&c!="canCreateTicketsOnly"){return true}var b=null;var d=this.involvements();if(d&&d[a.id]){b=d[a.id]}else{return false}if(c=="canCreateTicketsOnly"&&b.is_administrator){return false}if(b.is_administrator){return true}switch(c){case"isAdministrator":return b.is_administrator;break;case"canReadMessages":return b.messages!="none";break;case"canCreateMessages":return["readcreate","manage"].indexOf(b.messages)>=0&&!a.archived;break;case"canManageMessages":return b.messages=="manage"&&!a.archived;break;case"canReadMilestones":return b.milestones!="none";break;case"canManageMilestones":return b.milestones=="manage"&&!a.archived;break;case"canReadNotebooks":return b.notebooks!="none";break;case"canCreateNotebooks":return["manage"].indexOf(b.notebooks)>=0&&!a.archived;break;case"canManageNotebooks":return b.notebooks=="manage"&&!a.archived;break;case"canReadTickets":return["read","readcreate","manage"].indexOf(b.tickets)>=0;break;case"canCreateTickets":return["create","readcreate","manage"].indexOf(b.tickets)>=0&&!a.archived;break;case"canCreateTicketsOnly":return["create"].indexOf(b.tickets)>=0&&["readcreate","manage"].indexOf(b.tickets)<0&&!a.archived;break;case"canManageReports":case"canManageTickets":return b.tickets=="manage";break;case"canReadTimeEntries":return["read","readcreate","manage"].indexOf(b.tickets)>=0&&["read","invite","manage"].indexOf(b.people)>=0;break;case"canReadSource":return b.source!="none";break;case"canCommitSource":return b.source=="commit"&&!a.archived;break;case"canReadPeople":return b.people!="none";break;case"canInvitePeople":return["invite","manage"].indexOf(b.people)>=0&&!a.archived;break;case"canManagePeople":return["manage"].indexOf(b.people)>=0&&!a.archived;break;default:return false;break}return false};this.seeIfAtAll=function(b){if(this.is_administrator){return true}var d=false;$.each(Project.find(),function(a,c){if(self.seeIf(c,b)){d=true;return false}});return d};this.projectsByPermission=function(d){var self=this;if(this.is_removed){return[]}var f=Project.find();if(f.length==0){return[]}if(this.is_administrator){return f}var g=this.involvements();if(isEmpty(g)){return[]}else{var result=[];$.each(g.array,function(a,c){var b=Project.Cache.read(c.project_id)[0];if(self.seeIf(b,d)){result.push(b)}});return result.sortByExpression("object.archived, object.title, object.short_name")}};this.seeIfByScope=function(a){if(Config.currentProjectID){return this.seeIf(Project.current(),a)}else{return!!this.projectsByPermission(a).length}};this.projectsDeliberate=function(){var b=[];$.each(this.involvements(),function(a,c){if(a!="array"){if(Project.find(a)&&Project.find(a)[0]){b.push(Project.find(a)[0])}}});return b.sortByExpression(["object.archived.toString()","object.title.toLowerCase()","object.short_name.toLowerCase()"])};this.activeProjects=function(){if(this.is_administrator){return Account.current().activeProjects()}else{return this.projectsDeliberate().filter(function(a){return!a.archived})}};this.archivedProjects=function(){if(this.is_administrator){return Account.current().archivedProjects()}else{return this.projectsDeliberate().filter(function(a){return a.archived})}};this.init(e)},current:function(){return Globals.currentPerson},getSourceUrl:function(a,c){var b=$.extend({},a);var d="";if(a&&a.useID&&a.id!=null){d+="/people/"+a.id;delete a.id;delete a.useID}else{if(a&&a.invite){d+="/people/invite";delete a.invite}}if(!c){$.extend(a,b)}return d},find:function(a){return this.Cache.read(a)}};Person=Unfuddle.Data.Person;

Unfuddle.Data.Involvement={fields:["is_administrator","messages","milestones","people","person_id","project_id","source","tickets","notebooks"],Cache:new Unfuddle.Data.Cache({resourceType:"Involvement",indices:["person_id","project_id"],sendSslHeader:true}),PERM_MAPPING:{messages:{none:{label:"None",sort:0},read:{label:"Read Only",sort:1},readcreate:{label:"Read and Create",sort:2},manage:{label:"Manage",sort:3}},milestones:{none:{label:"None",sort:0},read:{label:"Read Only",sort:1},manage:{label:"Manage",sort:2}},notebooks:{none:{label:"None",sort:0},read:{label:"Read Only",sort:1},manage:{label:"Manage",sort:2}},tickets:{none:{label:"None",sort:0},read:{label:"Read Only",sort:1},create:{label:"Create Only",sort:2},readcreate:{label:"Read and Create",sort:3},manage:{label:"Manage",sort:4}},source:{none:{label:"None",sort:0},read:{label:"Read Only",sort:1},commit:{label:"Commit",sort:2}},people:{none:{label:"None",sort:0},read:{label:"Read Only",sort:1},invite:{label:"Invite Others",sort:2},manage:{label:"Manage",sort:3}},api:{none:{label:"None",sort:0},access:{label:"Access",sort:1}}},Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="Involvement";this.init(a)},permSelectOptions:function(c){var b=[];$.each(Involvement.PERM_MAPPING[c],function(a,d){b.push([d.label,a])});return b},permSelectOptionsSubjective:function(c,b,e){var g=Involvement.PERM_MAPPING[c][e.permValueFor(b,c)]["sort"];var f=[];$.each(Involvement.PERM_MAPPING[c],function(a,d){if(d.sort<=g||e.seeIf(b,"isAdministrator")){f.push([d.label,a])}});return f},getSourceUrl:function(a,d){var c={};$.extend(c,a);var b="";if(a&&(a.project_id||a.person_id)){if(a.project_id){b="/projects/"+a.project_id+"/involvements";delete a.project_id}if(a.person_id){b="/people/"+a.person_id+"/involvements";delete a.person_id}if(a.useID&&a.id){b+="/"+a.id;delete a.id}}if(!d){$.extend(a,c)}return b},find:function(a){return this.Cache.read(a)}};Involvement=Unfuddle.Data.Involvement;

Unfuddle.Data.Category={fields:["name","project_id"],Cache:new Unfuddle.Data.Cache({resourceType:"Category",indices:["project_id"]}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="Category";this.init(a)},getSourceUrl:function(a,d){var c={};$.extend(c,a);var b="";if(a.project_id!=null){b="/projects/"+a.project_id+"/categories";delete a.project_id;if(a.id!=null){b+="/"+a.id;delete a.id}}if(!d){$.extend(a,c)}return b},find:function(a){return this.Cache.read(a)}};Category=Unfuddle.Data.Category;

Unfuddle.Data.Message={fields:["author_id","body","body_format","project_id","title","categories"],dateFields:["active_at"],formatAttributes:["body"],Cache:new Unfuddle.Data.Cache({resourceType:"Message",indices:["project_id","author_id"],specialIndices:{categories:"category_id"}}),Base:function(b){this.tmp=Unfuddle.Data.Resource;this.tmp(b);delete this.tmp;this.resourceType="Message";this.categoriesCollection=function(){ret=[];$.each(this.categories,function(a,d){ret=ret.concat(Unfuddle.Data.Category.Cache.read({conditions:{id:d}}))});return ret};this.commentsCollection=function(){return Comment.find({conditions:{project_id:this.project_id,message_id:this.id},order:["created_at"]})};this.attachmentsCollection=function(){return Attachment.Cache.read({conditions:{parent_type:"Message",parent_id:this.id}})};this.init(b)},getSourceUrl:function(a,d){var b={};$.extend(b,a);var c="";if(a.project_id!=null){c="/projects/"+a.project_id+"/messages";delete a.project_id;if(a.id!=null){c+="/"+a.id;delete a.id}}else{if(isEmpty(a)){c="/messages"}}if(!d){$.extend(a,b)}return c},find:function(a){return this.Cache.read(a)}};Message=Unfuddle.Data.Message;

Unfuddle.Data.Comment={fields:["author_id","body","body_format","parent_id","parent_type"],formatAttributes:["body"],Cache:new Unfuddle.Data.Cache({resourceType:"Comment",indices:["message_id","ticket_id","author_id","project_id","parent_type","parent_id"]}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="Comment";this.message=function(){return Message.Cache.read({conditions:{id:this.message_id}})[0]};this.attachmentsCollection=function(){return Attachment.Cache.read({conditions:{parent_type:this.parent_type,comment_id:this.id}})};this.init(a)},getSourceUrl:function(a,b){var d={};$.extend(d,a);var c="";if(a&&a.project_id!=null&&a.parent_id!=null){c="/projects/"+a.project_id;delete a.project_id;if(a.parent_type=="Message"){c+="/messages/"+a.parent_id;delete a.message_id}else{c+="/tickets/"+a.parent_id;delete a.ticket_id}c+="/comments";if(a.id!=null){c+="/"+a.id;delete a.id}}if(!b){$.extend(a,d)}return c},find:function(a){return this.Cache.read(a)}};Comment=Unfuddle.Data.Comment;Comment.Cache.preProcess=function(d,c){if(typeOf(d)!="array"){d=[d]}var e=null;if(c.indexOf("/projects/")>=0){e=parseInt(c.split("/")[2])||null}$.each(d,function(a,b){b.project_id=e||(Unfuddle.Data[b.parent_type].find({conditions:{id:b.parent_id}})[0]?Unfuddle.Data[b.parent_type].find({conditions:{id:b.parent_id}})[0].project_id:null);switch(b.parent_type){case"Message":b.message_id=b.parent_id;break;case"Ticket":b.ticket_id=b.parent_id;break}});return d};

Unfuddle.Data.Attachment={fields:["content_type","filename","parent_id","parent_type","upload_key","content_type"],Cache:new Unfuddle.Data.Cache({resourceType:"Attachment",indices:["message_id","ticket_id","parent_id","author_id","parent_type","project_id"]}),Base:function(g){this.tmp=Unfuddle.Data.Resource;this.tmp(g);delete this.tmp;this.resourceType="Attachment";this.message=function(){return Message.find(this.message_id)[0]};this.notebook=function(){return Notebook.find(this.parent_id)[0]};this.upload=function(e){var f=this.toXml();var i=Unfuddle.Data[this.resourceType].Cache.urlPrefix;var h=Unfuddle.Data[this.resourceType].getSourceUrl(this)+"/upload";var self=this;if(h!=""){$.ajaxFileUpload({url:i+h,fileElementId:self.fileElementId,success:function(a,b){if(!self.upload_key){self.upload_key=$(a).find("key").text()}if(!self.content_type){self.content_type=$(a).find("content-type,contenttype").text()}self.action_results={success:true,textStatus:b,action:"uploaded"};if(e){e(a)}},error:function(a,b,d){var c=[];$(a.responseXML).find("errors").find("error").each(function(){c.push($(this).text())});self.action_results={success:false,textStatus:b,errors:c,action:"uploaded",errorThrown:d,xhr:a};if(e){e()}}})}};this.customTag=function(a,b){if(a=="upload_key"){return"  <upload><key>"+b+"</key></upload>\n"}else{return""}};this.init(g)},getSourceUrl:function(a,b){var d={};$.extend(d,a);var c="";if(a&&a.project_id!=null&&(a.message_id!=null||a.ticket_id!=null||a.notebook_id!=null||a.comment_id!=null)){c="/projects/"+a.project_id;delete a.project_id;if(a.message_id!=null){c+="/messages/"+a.message_id;delete a.message_id}else{if(a.ticket_id!=null){c+="/tickets/"+a.ticket_id;delete a.ticket_id}else{if(a.notebook_id!=null){c+="/notebooks/"+a.notebook_id;delete a.notebook_id}}}if((d.message_id!=null||d.ticket_id!=null)&&(a.parent_id!=null&&a.parent_type=="Comment")){c+="/comments/"+a.parent_id;delete a.parent_id}}c+="/attachments";if(a&&a.id!=null){c+="/"+a.id;delete a.id}if(!b){$.extend(a,d)}return c},find:function(a){return this.Cache.read(a)}};Attachment=Unfuddle.Data.Attachment;Attachment.Cache.preProcess=function(c,e){if(typeOf(c)!="array"){c=[c]}var f=null;if(e.indexOf("/projects/")>=0){f=parseInt(e.split("/")[2])||null}$.each(c,function(a,b){var d=Unfuddle.Data[b.parent_type].Cache.read({conditions:{id:b.parent_id}});b.project_id=b.project_id?b.project_id:f?f:d?d[0].project_id:null;switch(b.parent_type){case"Message":b.message_id=b.parent_id;break;case"Ticket":b.ticket_id=b.parent_id;break;case"Notebook":b.notebook_id=b.parent_id;break;case"Comment":b.comment_id=b.parent_id;break}});return c};

Unfuddle.Data.Severity={fields:["name","project_id"],Cache:new Unfuddle.Data.Cache({resourceType:"Severity",indices:["project_id"]}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="Severity";this.project=function(){return Project.find(this.project_id)[0]};this.init(a)},getSourceUrl:function(a,d){var c={};$.extend(c,a);var b="";if(a.project_id!=null){b="/projects/"+a.project_id+"/severities";delete a.project_id;if(a.id!=null){b+="/"+a.id;delete a.id}}if(!d){$.extend(a,c)}return b},find:function(a){return this.Cache.read(a)}};Severity=Unfuddle.Data.Severity;

Unfuddle.Data.Version={fields:["name","project_id"],Cache:new Unfuddle.Data.Cache({resourceType:"Version",indices:["project_id"]}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="Version";this.project=function(){return Project.find(this.project_id)[0]};this.init(a)},getSourceUrl:function(a,d){var c={};$.extend(c,a);var b="";if(a.project_id!=null){b="/projects/"+a.project_id+"/versions";delete a.project_id;if(a.id!=null){b+="/"+a.id;delete a.id}}if(!d){$.extend(a,c)}return b},find:function(a){return this.Cache.read(a)}};Version=Unfuddle.Data.Version;

Unfuddle.Data.Component={fields:["name","project_id"],Cache:new Unfuddle.Data.Cache({resourceType:"Component",indices:["project_id"]}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="Component";this.project=function(){return Project.find(this.project_id)[0]};this.init(a)},getSourceUrl:function(a,d){var c={};$.extend(c,a);var b="";if(a.project_id!=null){b="/projects/"+a.project_id+"/components";delete a.project_id;if(a.id!=null){b+="/"+a.id;delete a.id}}if(!d){$.extend(a,c)}return b},find:function(a){return this.Cache.read(a)}};Component=Unfuddle.Data.Component;

if(typeof Unfuddle=="undefined"){var Unfuddle={}}if(typeof Unfuddle.Data=="undefined"){Unfuddle.Data={}}Unfuddle.Data.Milestone={fields:["archived","completed","due_on","person_responsible_id","project_id","title","shift_subsequent","description","description_format"],dateFields:["due_on"],formatAttributes:["description"],Cache:new Unfuddle.Data.Cache({resourceType:"Milestone",indices:["project_id","archived","completed","person_responsible_id"]}),Base:function(b){this.tmp=Unfuddle.Data.Resource;this.tmp(b);delete this.tmp;this.personResponsible=function(){if(!this.person_responsible_id){return null}var a=Person.find(this.person_responsible_id);return a.pending?null:a[0]};this.resourceType="Milestone";this.init(b)},getSourceUrl:function(a,b){var d={};$.extend(d,a);var c="/milestones";if(a.project_id!=null){c="/projects/"+a.project_id+"/milestones";delete a.project_id;if(a.id!=null&&a.useID){c+="/"+a.id;delete a.id}}if(!b){$.extend(a,d)}return c},find:function(a){return this.Cache.read(a)}};Milestone=Unfuddle.Data.Milestone;

Unfuddle.Data.TicketReport={_fields:["group_by","fields_string","title","sort_by","parent_type","conditions_string","parent_id","sort_direction"],ALL_FIELDS:"project number summary priority component version severity milestone due_on reporter assignee status resolution comments associations hours_estimate_initial hours_estimate_current hours_actual percentage_complete created_at updated_at last_comment_at closed_on field_1 field_2 field_3".split(" "),GROUP_BY_FIELDS:"project priority component version severity milestone due_on reporter assignee status resolution field_1 field_2 field_3".split(" "),SORT_BY_FIELDS:"number project reporter summary priority milestone component version severity assignee status resolution comments associations due_on hours_estimate_initial hours_estimate_current hours_actual percentage_complete created_at updated_at last_comment_at closed_on field_1 field_2 field_3".split(" "),Cache:new Unfuddle.Data.Cache({resourceType:"TicketReport"}),Base:function(n){this.tmp=Unfuddle.Data.Resource;this.tmp(n);delete this.tmp;this.resourceType="TicketReport";var self=this;this.validField=function(c){return TicketReport._fields.indexOf(c)>=0};this.dynamicParams=function(){p={};if(self.id){p.custom_id=self.id}if(self.parent_type){p.parent_type=self.parent_type}p.title=self.title;if(self.group_by){p.group_by=self.group_by}if(self.sort_by){p.sort_by=self.sort_by}if(self.sort_direction){p.sort_direction=self.sort_direction}if(self.fields_string){p.fields_string=self.fields_string}if(self.conditions_string){p.conditions_string=self.conditions_string}return p};this.getRootNode=function(){return"ticket-report"};switch(this.parent_type){case"Account":this.account_id=this.parent_id;break;case"Project":this.project_id=this.parent_id;break}this.fieldWidthTotal=function(a,f){var h=0;$.each(a,function(c,b){h=h+Ticket.fieldHeading(b,f).width_weight});return h};this.totalTickets=function(){var a=0;if(this.groups){$.each(this.groups,function(c,b){a=a+b.tickets.length})}return a};this.ofProject=function(){return this.parent_type=="Project"};this.ofAccount=function(){return this.parent_type=="Account"};this.parent=function(){if(this.ofProject()){return Project.find(this.parent_id)[0]}else{return Account.current()}};this.validGroupByList=function(){var b=TicketReport.GROUP_BY_FIELDS.slice().map(function(c){return c.toLowerCase()});if(this.ofProject()){var a=Project.find(this.parent_id)[0];if(!a.ticket_field1_active){b.remove("field_1")}if(!a.ticket_field2_active){b.remove("field_2")}if(!a.ticket_field3_active){b.remove("field_3")}b.remove("project")}return b};this.validSortByList=function(){var b=TicketReport.SORT_BY_FIELDS.slice().map(function(c){return c.toLowerCase()});if(!this.parent().hasFeature("time_tracking")||(this.ofAccount()&&!this.parent().actuallyUsesAtAll("time_tracking"))||(this.ofProject()&&!this.parent().actuallyUses("time_tracking"))){b.remove("hours_estimate_initial");b.remove("hours_estimate_current");b.remove("hours_actual");b.remove("percentage_complete")}if(this.ofProject()){var a=this.parent();if(!a.ticket_field1_active){b.remove("field_1")}if(!a.ticket_field2_active){b.remove("field_2")}if(!a.ticket_field3_active){b.remove("field_3")}b.remove("project")}return b};this.conditions=function(){if(!this.conditions_string||this.conditions_string==""){return[]}return this.conditions_string.split(",").filter(function(c){return c.split("-")[2]&&c.split("-")[2]!="any"}).map(function(c){return c.split("-")})};this.conditionFor=function(a){var f={expression:"eq",value:"any"};$.each(this.conditions(),function(c,b){if(b[0]==a){f.expression=TicketReport.forceSqlExpression(b[1],true);f.value=b[2];return false}});return f};this.processData=function(){var self=this;this.fieldsAll=$.merge(["selector"],TicketReport.ALL_FIELDS);this.fields=(this.fields_string==null||!this.fields_string.replace(/\s+/g,""))?["selector","project","number","summary","priority","milestone","assignee","status"]:("selector,"+this.fields_string).replace(/\s+/g,"").split(",").remove("").remove(null);var h=this.fields.slice();this.fields=[];this.fieldsAll.forEach(function(c){if(h.indexOf(c)>=0){self.fields.push(c)}});if(this.ofProject()){this.fields.remove("project");this.fieldsAll.remove("project");if(!this.parent().ticket_field1_active){this.fields.remove("field_1");this.fieldsAll.remove("field_1")}if(!this.parent().ticket_field2_active){this.fields.remove("field_2");this.fieldsAll.remove("field_2")}if(!this.parent().ticket_field3_active){this.fields.remove("field_3");this.fieldsAll.remove("field_3")}}if(Person.current()&&(this.ofProject()&&!Person.current().seeIf(this.parent(),"canManageTickets"))||(this.ofAccount()&&!Person.current().seeIfAtAll("canManageTickets"))){this.fieldsAll.remove("selector");this.fields.remove("selector")}if(Person.current()&&(this.ofProject()&&!Person.current().seeIf(this.parent(),"canReadMilestones"))||(this.ofAccount()&&!Person.current().seeIfAtAll("canReadMilestones"))){this.fieldsAll.remove("milestone");this.fields.remove("milestone")}if(!(Person.current()&&(this.ofProject()&&Person.current().seeIf(this.parent(),"canReadPeople"))||(this.ofAccount()&&Person.current().seeIfAtAll("canReadPeople")))){this.fieldsAll.remove("reporter");this.fieldsAll.remove("assignee");this.fields.remove("reporter");this.fields.remove("assignee")}if(!((this.ofProject()&&this.parent().actuallyUses("time_tracking")&&(!Person.current()||Person.current().seeIf(this.parent(),"canReadTimeEntries")))||(this.ofAccount()&&this.parent().actuallyUsesAtAll("time_tracking")&&(!Person.current()||Person.current().seeIf(this.parent(),"canReadTimeEntries"))))){this.fieldsAll.remove("hours_estimate_initial");this.fieldsAll.remove("hours_estimate_current");this.fieldsAll.remove("hours_actual");this.fieldsAll.remove("percentage_complete");this.fields.remove("hours_estimate_initial");this.fields.remove("hours_estimate_current");this.fields.remove("hours_actual");this.fields.remove("percentage_complete")}if(this.groups){$.each(self.groups,function(a,f){$.each(f.tickets,function(c,b){if(b.resourceType!="Ticket"){self.groups[a].tickets[c]=new Ticket.Base(b)}})})}};this.generate=function(){this.processData();var self=this;var m;var i=this.conditions_string.replace(/\s/g,"").split(",").map(function(c){return c.split("-")}).filter(function(c){return c[2]});var e=this.ofProject()?{project_id:this.parent_id}:{};var d="true";var j={},k,r,s,g,l;$.each(i,function(b,a){a[1]=TicketReport.forceSqlExpression(a[1]);switch(a[0]){case"number":if(a[1]=="="){e[a[0]]=a[2]}else{d+=(" && object."+a[0]+"!="+a[2])}break;case"summary":if(a[1]=="="){e[a[0]]=a[2]}else{d+=(" && object."+a[0]+"!='"+a[2]+"'")}break;case"priority":if(a[1]=="="){e[a[0]]=a[2]}else{d+=(" && object."+a[0]+a[1]+a[2])}break;case"status":if(a[1]=="="){e[a[0]]=a[2]}else{d+=(" && object."+a[0]+"!='"+a[2]+"'")}break;case"component":if(a[2]==0){if(a[1]=="="){e.component_id=null}else{d+=(" && object.component_id!=null")}}else{if(a[1]=="="){e.component_id=a[2]}else{d+=(" && object.component_id"+a[1]+a[2])}}break;case"version":if(a[2]==0){if(a[1]=="="){e.version_id=null}else{d+=(" && object.version_id!=null")}}else{if(a[1]=="="){e.version_id=a[2]}else{d+=(" && object.version_id"+a[1]+a[2])}}break;case"severity":if(a[2]==0){if(a[1]=="="){e.severity_id=null}else{d+=(" && object.severity_id!=null")}}else{if(a[1]=="="){e.severity_id=a[2]}else{d+=(" && object.severity_id"+a[1]+a[2])}}break;case"field_1":if(a[2]==0){if(a[1]=="="){e.field1_value_id=null}else{d+=(" && object.field1_value_id!=null")}}else{if(a[1]=="="){e.field1_value_id=a[2]}else{d+=(" && object.field1_value_id"+a[1]+a[2])}}break;case"field_2":if(a[2]==0){if(a[1]=="="){e.field2_value_id=null}else{d+=(" && object.field2_value_id!=null")}}else{if(a[1]=="="){e.field2_value_id=a[2]}else{d+=(" && object.field2_value_id"+a[1]+a[2])}}break;case"field_3":if(a[2]==0){if(a[1]=="="){e.field3_value_id=null}else{d+=(" && object.field3_value_id!=null")}}else{if(a[1]=="="){e.field3_value_id=a[2]}else{d+=(" && object.field3_value_id"+a[1]+a[2])}}break;case"resolution":if(Ticket.VALID_RESOLUTIONS.indexOf(a[2])>=0){if(a[1]=="="){e.resolution=a[2]}else{d+=(" && object.resolution!='"+a[2]+"'")}}else{if(a[1]=="!="){d+=(" && object.resolution!=null && object.resolution!=''")}else{d+=(" && (object.resolution==null || object.resolution=='')")}}break;case"milestone":var f=a[2];if(f=="next_upcoming"){if(self.ofAccount()){var h=Project.find().map(function(c){c.upcomingMilestones[0]}).filter(function(c){return c!=null}).sortByExpression(["due_on"])[0]}else{h=self.parent().upcomingMilestones[0]}f=h?h.id:0}if(f==0){if(a[1]=="="){e.milestone_id=null}else{d+=(" && object.milestone_id!=null")}}else{if(a[1]=="="){e.milestone_id=a[2]}else{d+=(" && object.milestone_id"+a[1]+f)}}break;case"reporter":if(a[2]=="current"){if(a[1]=="="){e.reporter_id=Person.current().id}else{d+=(" && object.reporter_id!="+Person.current().id+"'")}}else{if(a[2]==0&&a[1]=="="){d+=(" && (object.reporter_id==null || object.reporter_id==0)")}else{if(a[2]==0&&a[1]=="!="){d+=(" && object.reporter_id!=null && object.reporter_id!=0")}else{if(a[1]=="="){e.reporter_id=a[2]}else{d+=(" && object.reporter_id!="+a[2])}}}}break;case"assignee":if(a[2]=="current"){if(a[1]=="="){e.assignee_id=Person.current().id}else{d+=(" && object.assignee_id!="+Person.current().id+"'")}}else{if(a[2]==0&&a[1]=="="){d+=(" && (object.assignee_id==null || object.assignee_id==0)")}else{if(a[2]==0&&a[1]=="!="){d+=(" && object.assignee_id!=null && object.assignee_id!=0")}else{if(a[1]=="="){e.assignee_id=a[2]}else{d+=(" && object.assignee_id!="+a[2])}}}}break;case"due_on":switch(a[2]){case"before_today":d+=(" && object.due_on && object.due_on.justDate() < (new Date).justDate()");break;case"after_today":d+=(" && object.due_on && object.due_on.justDate() > (new Date).justDate()");break;case"next_7_days":d+=(" && object.due_on && object.due_on.justDate().getTime() >= (new Date).justDate().getTime() && object.due_on.justDate() < (new Date)._setDate((new Date).getDate()+7).justDate()");break;case"next_30_days":d+=(" && object.due_on && object.due_on.justDate().getTime() >= (new Date).justDate().getTime() && object.due_on.justDate() < (new Date)._setDate((new Date).getDate()+30).justDate()");break;case"last_7_days":d+=(" && object.due_on && object.due_on.justDate().getTime() <= (new Date).justDate().getTime() && object.due_on.justDate() > (new Date)._setDate((new Date).getDate()-7).justDate()");break;case"last_30_days":d+=(" && object.due_on && object.due_on.justDate().getTime() <= (new Date).justDate().getTime() && object.due_on.justDate() > (new Date)._setDate((new Date).getDate()-30).justDate()");break;default:if(a[2]==0){if(a[1]=="="){e.due_on=null}else{d+=(" && object.due_on!=null")}}}}});if(d!="true"){e.evaluate=d}this.generatedTickets=null;this.generatedTickets=isEmpty(e)?Ticket.find({apiParams:{comments:true}}):Ticket.find({conditions:e,apiParams:{comments:true}});m=Ticket.sort(this.generatedTickets,this.sort_by,this.sort_direction);var o=self.fieldsAll.indexOf("hours_estimate_initial")>=0||self.fieldsAll.indexOf("hours_estimate_current")>=0||self.fieldsAll.indexOf("hours_actual")>=0;var q={project:"project_id",field_3:"field3_value_id",priority:"priority",milestone:"milestone_id",component:"component_id",due_on:"due_on",version:"version_id",reporter:"reporter_id",severity:"severity_id",assignee:"assignee_id",field_1:"field1_value_id",status:"status",field_2:"field2_value_id",resolution:"resolution"};$.each(m,function(c,b){k=b[q[self.group_by]]||null;if(!j[k]){switch(self.group_by){case"project":g=b.prettyField("project");break;case"priority":g=b.prettyField("priority");break;case"component":g=b.prettyField("component");break;case"version":g=b.prettyField("version");break;case"severity":g=b.prettyField("severity");break;case"field_1":g=(self.ofAccount()?(b.field1_value_id?b.prettyField("project")+": ":""):"")+b.prettyField("field_1");break;case"field_2":g=(self.ofAccount()?(b.field2_value_id?b.prettyField("project")+": ":""):"")+b.prettyField("field_2");break;case"field_3":g=(self.ofAccount()?(b.field3_value_id?b.prettyField("project")+": ":""):"")+b.prettyField("field_3");break;case"milestone":g=(self.ofAccount()?(b.milestone_id?b.prettyField("project")+": ":""):"")+b.prettyField("milestone")+(b.milestone_id?" ("+Utilities.formatDate(b.milestone().due_on,{format:"short"})+")":"");break;case"due_on":g=b.prettyField("due_on");break;case"reporter":g=b.prettyField("reporter");break;case"assignee":g=b.prettyField("assignee");break;case"status":g=b.prettyField("status");break;case"resolution":g=b.prettyField("resolution");break;default:g=null}j[k]={title:g,tickets:[],running_totals:{}}}j[k]["tickets"].push(b);if(o){j[k]["running_totals"]["hours_estimate_initial"]=j[k]["running_totals"]["hours_estimate_initial"]||0;j[k]["running_totals"]["hours_estimate_initial"]+=b.hours_estimate_initial;j[k]["running_totals"]["hours_estimate_current"]=j[k]["running_totals"]["hours_estimate_current"]||0;j[k]["running_totals"]["hours_estimate_current"]+=b.hours_estimate_current;j[k]["running_totals"]["hours_actual"]=j[k]["running_totals"]["hours_actual"]||0;j[k]["running_totals"]["hours_actual"]+=b.hoursActual()}});self.groups=[];$.each(j,function(c,b){self.groups.push(b)});switch(self.group_by){case"priority":l="0 - parseInt(object.tickets[0].priority)";break;case"due_on":l="object.tickets[0].due_on ? object.tickets[0].due_on.getTime() : (new Date)._setFullYear((new Date).getFullYear()+10).justDate().getTime()";break;case"milestone":l="object.tickets[0].milestone() ? object.tickets[0].milestone().due_on.getTime() : (new Date)._setFullYear((new Date).getFullYear()+10).justDate().getTime()";break;case"status":l="Ticket.VALID_STATUS.indexOf(object.tickets[0].status)";break;default:l="object.title ? object.title.toLowerCase() : object.title"}self.groups=self.groups.sortByExpression(l);if(self.group_by==self.sort_by&&self.sort_direction=="DESC"){self.groups=self.groups.reverse()}return this};this.init(n)},forceSqlExpression:function(c,b){switch(c.toLowerCase()){case"=":case"eq":return b?"eq":"=";case"!=":case"neq":return b?"neq":"!=";case">":case"gt":return b?"gt":">";case"<":case"lt":return b?"lt":"<";case">=":case"gteq":return b?"gteq":">=";case"<=":case"lteq":return b?"lteq":"<=";default:return b?"eq":"="}},generate:function(i,e){e=$.extend({local:true,pretty:null,exclude_description:null},e);if(e.local){i.generate()}else{if(e.callback){var d;if(i.parent_type=="Project"&&i.parent_id){d=Unfuddle.Config.baseApiUrl+"/projects/"+i.parent_id+"/ticket_reports/dynamic.json"}else{if(i.project_id){d=Unfuddle.Config.baseApiUrl+"/projects/"+i.project_id+"/ticket_reports/dynamic.json"}else{if(e.project){d=Unfuddle.Config.baseApiUrl+"/projects/"+e.project.id+"/ticket_reports/dynamic.json"}else{d=Unfuddle.Config.baseApiUrl+"/ticket_reports/dynamic.json"}}}$.ajax({type:"GET",data:{conditions_string:i.conditions_string,title:i.title,group_by:i.group_by,sort_by:i.sort_by,sort_direction:i.sort_direction,fields_string:i.fields_string,pretty:e.pretty,exclude_description:e.exclude_description},dataType:"json",url:d,success:function(h,m){if(h==null){h=[]}$.each(h.groups,function(a,f){$.each(f.tickets,function(c,b){h.groups[a].tickets[c]=new Ticket.Base(b)})});e.callback(h)},error:function(c,b,a){var f=[];f.error=true;e.callback(f)}})}}},getDynamicUrl:function(c){var b;if(c.parent_type=="Project"&&c.parent_id){b="#/projects/"+c.parent_id+"/ticket_reports/dynamic"}else{if(c.project_id){b="#/projects/"+c.project_id+"/ticket_reports/dynamic"}else{b="#/ticket_reports/dynamic"}}var a={conditions_string:c.conditions_string,title:c.title,group_by:c.group_by,sort_by:c.sort_by,sort_direction:c.sort_direction,fields_string:c.fields_string};return b+"?"+$.param(a)},getSourceUrl:function(c,b){var a={};$.extend(a,c);var f="";if(c&&c.project_id!=null){f="/projects/"+c.project_id;delete c.project_id}f+="/ticket_reports";if(c&&c.id!=null){f+="/"+c.id;delete c.id}if(!b){$.extend(c,a)}return f},find:function(c){return this.Cache.read(c)}};TicketReport=Unfuddle.Data.TicketReport;

Unfuddle.Data.Ticket={fields:["assignee_id","component_id","description","description_format","due_on","field1_value_id","field2_value_id","field3_value_id","hours_estimate_current","hours_estimate_initial","milestone_id","number","priority","project_id","resolution","resolution_description","resolution_description_format","reporter_id","status","summary","severity_id","version_id","field1_value","field2_value","field3_value","time_tracking_hours","time_tracking_description"],dateFields:["closed_on","due_on","last_comment_at"],formatAttributes:["description","resolution_description"],VALID_STATUS:"new unaccepted reassigned reopened accepted resolved closed".split(" "),VALID_RESOLUTIONS:"fixed works_for_me postponed duplicate will_not_fix invalid".split(" "),Cache:new Unfuddle.Data.Cache({resourceType:"Ticket",indices:["project_id","number","priority","milestone_id","assignee_id","reporter_id","status","resolution","component_id","version_id","severity_id","field1_value_id","field2_value_id","field3_value_id"]}),Base:function(h){this.tmp=Unfuddle.Data.Resource;this.tmp(h);delete this.tmp;this.resourceType="Ticket";this.afterSave=function(){OverallProgress.Cache.erase()};this.priorityName=function(){return Ticket.nameForPriority(this.priority)};this.percentageComplete=function(){if(this.__percentageComplete){return this.__percentageComplete}if(Project.find(this.project_id)[0].actuallyUses("time_tracking")&&this.hours_estimate_current>0){return Math.round(this.hoursActual()/this.hours_estimate_current*100)}else{return(this.status=="closed")?100:0}};this.hoursActual=function(){if(this.__hoursActual){return this.__hoursActual}else{var c=0;var b=this._timeEntries||TimeEntry.find({conditions:{ticket_id:this.id}});$.each(b,function(d,e){c+=e.hours});return c}};this.childTickets=function(){var c=[];var self=this;$.each(TicketAssociation.find(),function(d,e){if(e.ticket1_id==self.id&&e.relationship=="parent"){c.push(e.ticket2())}});return c};this.ticketAssociations=function(){$.each(TicketAssociation.find(),function(d,e){});return this._associatedTickets?this._associatedTickets:[]};this.associatedTickets=function(){if(this.associations){return this.associations.map(function(a){return{relationship:a.relationship,ticket:new Ticket.Base(a.ticket)}})}var b=[];var f=[];var self=this;$.each(TicketAssociation.find(),function(e,c){if(c.ticket1_id==self.id){if(c.relationship=="parent"){b.push({relationship:"parent",ticket:c.ticket2()})}else{if(c.relationship=="duplicate"){b.push({relationship:"duplicate",ticket:c.ticket2()})}else{if(c.relationship=="related"){b.push({relationship:"related",ticket:c.ticket2()})}}}}else{if(c.ticket2_id==self.id){if(c.relationship=="parent"){b.push({relationship:"child",ticket:c.ticket1()});c.ticket1().childTickets().forEach(function(d){if(d.id!=self.id){f.pushUniqueId(d)}})}else{if(c.relationship=="duplicate"){b.push({relationship:"duplicate",ticket:c.ticket1()})}else{if(c.relationship=="related"){b.push({relationship:"related",ticket:c.ticket1()})}}}}}});f.sortByExpression(["0-parseInt(object.priority)","number"]).forEach(function(d){b.push({relationship:"sibling",ticket:d})});return b};this.milestone=function(){return Milestone.find({conditions:{project:this.project_id,id:this.milestone_id}})[0]};this.commentsCollection=function(){return Comment.find({sourceUrl:"/projects/"+this.project_id+"/tickets/"+this.id+"/comments",order:["created_at"]})};this.prettyField=function(d,e){if("created_at updated_at due_on closed_on last_comment_at".split(" ").indexOf(d)>=0){return this.prettyFieldNotEscaped(d,e)}else{return this[d+"_pretty"]?soy.$$escapeHtml(this[d+"_pretty"]):soy.$$escapeHtml(this.prettyFieldNotEscaped(d,e))}};this.prettyFieldNotEscaped=function(e,c){c=$.extend({},{force_reload:false,use_value:false,value:null},c);var b=c.value,f=c.force_reload;switch(e){case"number":if(!c.use_value){b=this.number}return b;case"project":case"project_id":if(!c.use_value){b=Project.find(this.project_id)[0]}else{if((parseFloat(b)==parseInt(b))&&!isNaN(parseInt(b))){b=Project.find(b)[0]}}return b.title||"";case"reporter":case"reporter_id":if(!c.use_value){b=Person.find(this.reporter_id)[0]}else{if((parseFloat(b)==parseInt(b))&&!isNaN(parseInt(b))){b=Person.find(b)[0]}}return b?b.displayName():"<none>";case"summary":if(!c.use_value){b=this.summary}return b;case"priority":if(!c.use_value){b=this.priorityName()}else{if(parseInt(b).toString()==b.toString()){b=Ticket.nameForPriority(b)}}return b;case"milestone":case"milestone_id":if(!c.use_value&&this.milestone_id){b=Milestone.find(this.milestone_id)[0]}else{if((parseFloat(b)==parseInt(b))&&!isNaN(parseInt(b))){b=Milestone.find(b)[0]}}return b?b.title:"<none>";case"component":case"component_id":if(!c.use_value&&this.component_id){b=Component.find(this.component_id)[0]}else{if((parseFloat(b)==parseInt(b))&&!isNaN(parseInt(b))){b=Component.find(b)[0]}}return b?b.name:"<none>";case"version":case"version_id":if(!c.use_value&&this.version_id){b=Version.find(this.version_id)[0]}else{if((parseFloat(b)==parseInt(b))&&!isNaN(parseInt(b))){b=Version.find(b)[0]}}return b?b.name:"<none>";case"severity":case"severity_id":if(!c.use_value&&this.severity_id){b=Severity.find(this.severity_id)[0]}else{if((parseFloat(b)==parseInt(b))&&!isNaN(parseInt(b))){b=Severity.find(b)[0]}}return b?b.name:"<none>";case"field_1":case"field1_value_id":if(!c.use_value&&this.field1_value_id){b=CustomFieldValue.find(this.field1_value_id)[0]}else{if((parseFloat(b)==parseInt(b))&&!isNaN(parseInt(b))){b=CustomFieldValue.find(b)[0]}}return b?b.value:"<none>";case"field_2":case"field2_value_id":if(!c.use_value&&this.field2_value_id){b=CustomFieldValue.find(this.field2_value_id)[0]}else{if((parseFloat(b)==parseInt(b))&&!isNaN(parseInt(b))){b=CustomFieldValue.find(b)[0]}}return b?b.value:"<none>";case"field_3":case"field3_value_id":if(!c.use_value&&this.field3_value_id){b=CustomFieldValue.find(this.field3_value_id)[0]}else{if((parseFloat(b)==parseInt(b))&&!isNaN(parseInt(b))){b=CustomFieldValue.find(b)[0]}}return b?b.value:"<none>";case"assignee":case"assignee_id":if(!c.use_value&&this.assignee_id){b=Person.find(this.assignee_id)[0]}else{if((parseFloat(b)==parseInt(b))&&!isNaN(parseInt(b))){b=Person.find(b)[0]}}return b?b.displayName():"<none>";case"status":if(!c.use_value){b=this.status}return(b?b.humanize():"<none>");case"resolution":if(!c.use_value){b=this.resolution}return(b?b.humanize():"<none>");case"associations":if(!c.use_value){b=this.associatedTickets()}if(!b){"<none>"}else{return b.map(function(d){return(d.relationship.capitalize().slice(0,1)+d.ticket.number)}).join(" ")}case"due_on":if(!c.use_value&&this.due_on){b=this.due_on}return(b?Utilities.formatDate(b,{format:"short"}):"&lt;none&gt;");case"hours_estimate_initial":if(!c.use_value){b=this.hours_estimate_initial}return b.toFixed(2);case"hours_estimate_current":if(!c.use_value){b=this.hours_estimate_current}return b.toFixed(2);case"hours_actual":if(!c.use_value){b=this.hoursActual()}return b.toFixed(2);case"percentage_complete":if(!c.use_value){b=this.percentageComplete()}return b;case"last_comment_at":if(!c.use_value){if(typeof this.last_comment_at!="undefined"){b=this.last_comment_at}else{b=this.commentsCollection()[this.commentsCollection().length-1]?this.commentsCollection()[this.commentsCollection().length-1].created_at:null}}return b?Utilities.formatDate(b,{format:"auto"}):"&lt;none&gt;";case"comments":if(!c.use_value){if(this.comments!=null){b=this.comments}else{b=this.commentsCollection().length}}return b;case"created_at":if(!c.use_value){b=this.created_at}return Utilities.formatDate(b,{format:"auto"});case"updated_at":if(!c.use_value){b=this.updated_at}return Utilities.formatDate(b,{format:"auto"});case"closed_on":if(!c.use_value){b=this.closed_on}return(b?Utilities.formatDate(b,{format:"auto"}):"&lt;none&gt;");default:return""}};this.project=function(){return Project.find(this.project_id)[0]};var self=this;this.removeAssociationTicketCache=function(c){$.each(Ticket.Cache.data.array,function(e){t=Ticket.Cache.data.array[e];if(t.id==self.id&&t._associatedTickets){$.each(t._associatedTickets,function(d){at=t._associatedTickets[d];if(at&&at.associatedTicket&&at.associatedTicket.id==c.associatedTicket.id&&at.relationship==(c.relationship=="child"?"parent":(c.relationship=="parent"?"child":c.relationship))){t._associatedTickets.remove(c);return true}})}})};this.removeFromAssociatedTicketCache=function(c){$.each(Ticket.Cache.data.array,function(e){t=Ticket.Cache.data.array[e];if(t.id==c.associatedTicket.id&&t._associatedTickets){$.each(t._associatedTickets,function(d){at=t._associatedTickets[d];if(at&&at.associatedTicket&&at.associatedTicket.id==self.id&&at.relationship==(c.relationship=="child"?"parent":(c.relationship=="parent"?"child":c.relationship))){t._associatedTickets.remove(at);return true}})}})};this.removeAssociationCache=function(d){this.removeAssociationTicketCache(d);this.removeFromAssociatedTicketCache(d)};this.associateToRemoteTicketCache=function(c){$.each(Ticket.Cache.data.array,function(e){t=Ticket.Cache.data.array[e];if(t.id==c.associatedTicket.id){t._associatedTickets=t._associatedTickets||[];$.each(t._associatedTickets,function(d){at=t._associatedTickets[d];if(at&&at.associatedTicket&&at.associatedTicket.id==self.id){return false}});t._associatedTickets.push(self.getSelfAssociation(c));return true}})};this.getSelfAssociation=function(d){var e=Config.baseUrl+"/projects/"+self.project_id+"/tickets/"+self.id+"/ticket_associations/associate.json";var c=d.relationship=="child"?"parent":(d.relationship=="parent"?"child":d.relationship);var a={relationship:c,associatedTicket:new Ticket.Base(self),random:Math.random().toString().slice(2,9),parent_id:d.associatedTicket.id?d.associatedTicket.id:null};return a};this.associate=function(f){var self=this;$.ajax({url:Config.baseUrl+"/projects/"+this.project_id+"/tickets/"+this.id+"/ticket_associations/associate.json",type:"POST",dataType:"json",data:{Ticket:{search:f.ticketSearch},relationship:f.relationship},success:function(b){self._associatedTickets=self._associatedTickets||[];$.each(b,function(d,e){var c={relationship:e.relationship,associatedTicket:new Ticket.Base(e.ticket),random:Math.random().toString().slice(2,9),parent_id:e.parent_id?e.parent_id:null};self._associatedTickets.push(c);self.associateToRemoteTicketCache(c)});if(f.success){f.success()}},error:function(d,e,c){var b=[];try{b=JSON.parse(d.responseText)}catch(err){}if(b.length<=0){b=["An unexpected error occured. Please try again!"]}if(f.error){f.error(b)}}})};this.disassociate=function(d,e){var c=Config.baseUrl+"/projects/"+this.project_id+"/tickets/"+this.id+"/ticket_associations/disassociate";var b=d.relationship=="child"?"parent":(d.relationship=="parent"?"child":d.relationship);$.ajax({url:c,type:"POST",dataType:"json",data:{_method:"delete",ticket2_id:d.associatedTicket.id,relationship:b},success:e()})};this.associateChangeset=function(e,c,b,f){$.ajax({url:Config.baseUrl+"/projects/"+this.project_id+"/tickets/"+this.id+"/associate_changeset.json",type:"POST",beforeSend:function(d){if(this.dataType!="script"&&UI.Helpers.checkSessionExpired()){return false}if(location.protocol=="https:"){d.setRequestHeader("X-Unfuddle-Ajax-Secure",1)}d.setRequestHeader("X-Unfuddle-Ajax-Client",1);d.setRequestHeader("X-HTTP-METHOD-OVERRIDE","PUT")},dataType:"text",data:{repository_id:e,revision:c},success:b,error:f})};this.disassociateChangeset=function(e,c){$.ajax({url:Config.baseUrl+"/projects/"+this.project_id+"/tickets/"+this.id+"/disassociate_changeset.json",type:"POST",beforeSend:function(d){if(this.dataType!="script"&&UI.Helpers.checkSessionExpired()){return false}if(location.protocol=="https:"){d.setRequestHeader("X-Unfuddle-Ajax-Secure",1)}d.setRequestHeader("X-Unfuddle-Ajax-Client",1);d.setRequestHeader("X-HTTP-METHOD-OVERRIDE","PUT")},dataType:"text",data:{changeset_id:e},success:c})};this.attachmentsCollection=function(){return Attachment.Cache.read({conditions:{project_id:this.project_id,ticket_id:this.id}})};this.auditMostRecent=function(){return Audit.find({conditions:{record_type:"Ticket",record_id:this.id},order:["created_at desc"]})};this.init(h)},validPriorityList:[["Highest","5"],["High","4"],["Normal","3"],["Low","2"],["Lowest","1"]],validStatusList:function(){return Ticket.VALID_STATUS.map(function(d){return[d.humanize(),d]})},validResolutionList:function(){return Ticket.VALID_RESOLUTIONS.map(function(d){return[d.humanize(),d]})},nameForPriority:function(c){var b=null;$.each(Ticket.validPriorityList,function(d,e){if(e[1]==c){b=e[0];return}});return(b?b:"<none>")},fieldHeading:function(d,e){switch(d){case"selector":return{name:"",width_weight:1};case"number":return{name:"#",width_weight:1.5};case"project":return{name:"Project",width_weight:4};case"reporter":case"reporter_id":return{name:"Reporter",width_weight:3};case"summary":return{name:"Summary",width_weight:8};case"priority":return{name:"Priority",width_weight:3};case"milestone":case"milestone_id":return{name:"Milestone",width_weight:3};case"component":case"component_id":return{name:"Component",width_weight:3};case"version":case"version_id":return{name:"Version",width_weight:3};case"severity":case"severity_id":return{name:"Severity",width_weight:3};case"field_1":case"field1_value_id":if(!e){return{name:"Field 1",width_weight:3}}else{var c=e.ticket_field1_title;return{name:(!c||c==""?"Field 1":soy.$$escapeHtml(c)),width_weight:(!c||c==""?3:Math.ceil(Math.max(c.length,6)/3))}}case"field_2":case"field2_value_id":if(!e){return{name:"Field 2",width_weight:3}}else{var c=e.ticket_field2_title;return{name:(!c||c==""?"Field 2":soy.$$escapeHtml(c)),width_weight:(!c||c==""?3:Math.ceil(Math.max(c.length,6)/3))}}case"field_3":case"field3_value_id":if(!e){return{name:"Field 3",width_weight:3}}else{var c=e.ticket_field3_title;return{name:(!c||c==""?"Field 3":soy.$$escapeHtml(c)),width_weight:(!c||c==""?3:Math.ceil(Math.max(c.length,6)/3))}}case"assignee":case"assignee_id":return{name:"Assignee",width_weight:3};case"status":return{name:"Status",width_weight:3};case"resolution":return{name:"Resolution",width_weight:3};case"last_comment_at":return{name:"Last Comment",width_weight:4};case"comments":return{name:"Comments",width_weight:3};case"associations":return{name:"Associations",width_weight:5};case"due_on":return{name:"Due On",width_weight:3};case"hours_estimate_initial":return{name:"Initial Est.",width_weight:2};case"hours_estimate_current":return{name:"Current Est.",width_weight:2};case"hours_actual":return{name:"Hours",width_weight:2};case"percentage_complete":return{name:"% Complete",width_weight:3};case"created_at":return{name:"Created",width_weight:3};case"updated_at":return{name:"Updated",width_weight:3};case"closed_on":return{name:"Closed",width_weight:3};default:return{name:"Field",width_weight:3}}},sort:function(d,e,c){if(!d){return false}if(!e||e==""){return d}c=c||"ASC";var b,f;switch(e){case"number":b="number, priority";break;case"project":b="object.project().title, priority";break;case"reporter":b="object.prettyField('reporter'), priority, number";break;case"summary":b="summary, priority, number";break;case"priority":b="priority, number";break;case"milestone":b="object.milestone_id ? object.prettyField('milestone') : 'ZZZ', priority, number";break;case"component":b="object.component_id ? object.prettyField('component') : 'ZZZ', priority, number";break;case"version":b="object.version_id ? object.prettyField('version') : 'ZZZ', priority, number";break;case"severity":b="object.severity_id ? object.prettyField('severity') : 'ZZZ', priority, number";break;case"field_1":b="object.field1_value_id ? object.prettyField('field_1') : 'ZZZ', priority, number";break;case"field_2":b="object.field2_value_id ? object.prettyField('field_2') : 'ZZZ', priority, number";break;case"field_3":b="object.field3_value_id ? object.prettyField('field_3') : 'ZZZ', priority, number";break;case"assignee":b="object.assignee_id ? object.prettyField('assignee') : 'ZZZ', priority, number";break;case"status":b="object.prettyField('status'), priority, number";break;case"resolution":b="object.resolution && object.resolution ? object.prettyField('resolution') : 'ZZZ', priority, number";break;case"comments":b="(object.comments != null ? 0-object.comments : 0-object.commentsCollection().length), priority, number";break;case"last_comment_at":b="((typeof object.last_comment_at != 'undefined' ? object.last_comment_at : object.commentsCollection()[object.commentsCollection().length-1] && object.commentsCollection()[object.commentsCollection().length-1].created_at) || (new Date)._setFullYear((new Date).getFullYear()-10).justDate()), 0-parseInt(object.priority), number";break;case"associations":b="0-object.associatedTickets().length, priority, number";break;case"due_on":b="object.due_on ? object.due_on : (new Date)._setDate((new Date).getDate()+("+(c=="ASC"?1:-1)*10*365+")), 0-parseInt(object.priority), number";break;case"hours_estimate_initial":b="hours_estimate_initial, priority, number";break;case"hours_estimate_current":b="hours_estimate_current, priority, number";break;case"hours_actual":b="object.hoursActual(), priority, number";break;case"percentage_complete":b="object.percentageComplete(), priority, number";break;case"created_at":b="created_at, 0-parseInt(object.priority), number";break;case"updated_at":b="updated_at, 0-parseInt(object.priority), number";break;case"closed_on":b="object.closed_on ? object.closed_on : (new Date)._setDate((new Date).getDate()+("+(c=="ASC"?1:-1)*10*365+")), 0-parseInt(object.priority), number";break;default:b=e}f=d.sortByExpression(b);return c.toUpperCase()=="DESC"?f.reverse():f},upcomingAfter:{},upcomingBefore:{},getUpcoming:function(b,f){f=f||{};var h=f.project?{parent_type:"Project",parent_id:f.project.id}:{};var i=new TicketReport.Base($.extend({conditions_string:"status-neq-closed,due_on-eq-last_30_days",sort_by:"due_on"},h));var j=new TicketReport.Base($.extend({conditions_string:"status-neq-closed,due_on-eq-next_7_days",sort_by:"due_on"},h));var g="req_"+Math.floor(Math.random()*1000000000000);TicketReport.generate(i,{local:false,callback:function(d){if(Ticket.upcomingAfter[g]){var e=Ticket.upcomingAfter[g].groups[0]?Ticket.upcomingAfter[g].groups[0].tickets:[];var c=d.groups[0]?d.groups[0].tickets:[];delete(Ticket.upcomingAfter[g]);b(c.concat(e))}else{Ticket.upcomingBefore[g]=d}}});TicketReport.generate(j,{local:false,callback:function(d){if(Ticket.upcomingBefore[g]){var e=Ticket.upcomingBefore[g].groups[0]?Ticket.upcomingBefore[g].groups[0].tickets:[];var c=d.groups[0]?d.groups[0].tickets:[];delete(Ticket.upcomingBefore[g]);b(e.concat(c))}else{Ticket.upcomingAfter[g]=d}}})},getSourceUrl:function(d,e){var c={};$.extend(c,d);var b="";if(d&&d.project_id!=null){b="/projects/"+d.project_id+"/tickets";delete d.project_id;if(d.id!=null){b+="/"+d.id;delete d.id}else{if(d.number!=null){b+="/by_number/"+d.number;delete d.number}}}if(!e){$.extend(d,c)}return b},find:function(d){return this.Cache.read(d)}};Ticket=Unfuddle.Data.Ticket;Ticket.Cache.preProcess=function(f){if(typeOf(f)!="array"){f=[f]}var h={};var i={};$.each(f,function(c,b){if(b.comments){b._comments=b.comments.map(function(d){return new Comment.Base(d)});b._comments.forEach(function(d){if(d.attachments){d._attachments=d.attachments.map(function(a){return new Attachment.Base(a)})}})}if(b.time_entries){b._timeEntries=b.time_entries.map(function(d){return new TimeEntry.Base(d)})}if(b.attachments){b._attachments=b.attachments.map(function(d){return new Attachment.Base(d)})}if(b.associated_tickets){b._associatedTickets=b.associated_tickets.map(function(d){var e={};e.associatedTicket=new Ticket.Base(d.ticket);e.relationship=d.relationship;e.random=Math.random().toString().slice(2,9);if(d.relationship=="sibling"&&d.parent_id){e.parent_id=d.parent_id}return e})}if(b.changesets){b._changesets=b.changesets.map(function(d){return new Changeset.Base(d)})}if(b.subscriptions){b._subscriptions={};$.each(b.subscriptions,function(d,e){b._subscriptions[e.person_id]=new Subscription.Base(e)})}});return f};

Unfuddle.Data.CustomFieldValue={fields:["project_id","field_number","value"],Cache:new Unfuddle.Data.Cache({resourceType:"CustomFieldValue",indices:["project_id","field_number"]}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="CustomFieldValue";this.project=function(){return Project.find(this.project_id)[0]};this.getRootNode=function(){return"custom-field-value"};this.init(a)},getSourceUrl:function(a,d){var c={};$.extend(c,a);var b="";if(a.project_id!=null){b="/projects/"+a.project_id+"/custom_field_values";delete a.project_id;if(a.id!=null){b+="/"+a.id;delete a.id}}if(!d){$.extend(a,c)}return b},find:function(a){return this.Cache.read(a)}};CustomFieldValue=Unfuddle.Data.CustomFieldValue;

Unfuddle.Data.TicketAssociation={fields:["relationship","ticket1_id","ticket2_id"],Cache:new Unfuddle.Data.Cache({resourceType:"TicketAssociation",indices:["ticket1_id","ticket2_id"]}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="TicketAssociation";this.getRootNode=function(){return"ticket-association"};this.ticket1=function(){return Ticket.find({conditions:{id:this.ticket1_id}})[0]};this.ticket2=function(){return Ticket.find({conditions:{id:this.ticket2_id}})[0]};this.init(a)},getSourceUrl:function(a,d){var c={};$.extend(c,a);var b="";if(a&&a.project_id!=null&&a.ticket1_id!=null){b="/projects/"+a.project_id+"/tickets/"+a.ticket1_id+"/ticket_associations";delete a.project_id;delete a.ticket1_id;if(a.id!=null){b+="/"+a.id;delete a.id}}if(!d){$.extend(a,c)}return b},find:function(a){return this.Cache.read(a)}};TicketAssociation=Unfuddle.Data.TicketAssociation;

Unfuddle.Data.Backup={fields:["project_id","requester_id"],dateFields:["processed_at"],Cache:new Unfuddle.Data.Cache({resourceType:"Backup",indices:["project_id","requester_id"]}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="Backup";this.init(a)},getSourceUrl:function(a,d){var c={};$.extend(c,a);var b="";if(a&&a.project_id!=null){b="/projects/"+a.project_id+"/backups";delete a.project_id;if(a.id!=null){b+="/"+a.id;delete a.id}}else{if(isEmpty(a)){b="/backups"}}if(!d){$.extend(a,c)}return b},find:function(a){return this.Cache.read(a)}};Backup=Unfuddle.Data.Backup;

Unfuddle.Data.Notebook={fields:["project_id","title","default_page_number"],Cache:new Unfuddle.Data.Cache({resourceType:"Notebook",indices:["project_id"]}),Base:function(f){this.tmp=Unfuddle.Data.Resource;this.tmp(f);delete this.tmp;this.resourceType="Notebook";this.pagesCollection=function(){return Page.find({conditions:{notebook_id:this.id}})};this.attachmentsCollection=function(){return Attachment.find({conditions:{parent_id:this.id,parent_type:"Notebook"}})};this.defaultPage=function(){return Page.find({conditions:{notebook_id:this.id,number:this.default_page_number},order:["id DESC"]})[0]};this.mostRecent=function(){return Page.find({conditions:{notebook_id:this.id},order:["created_at DESC"]})[0]};this.fileSize=function(){var b=0;var self=this;$.each(self.attachmentsCollection(),function(c,a){b+=a.size});return Utilities.formatBytes(b)};this.uniquePages=function(){var e=[];var d={};$.each(this.pagesCollection(),function(c,b){if(d[b.number]!=null){if(d[b.number].version<b.version){d[b.number]=b}}else{d[b.number]=b}});var g=[];$.each(d,function(c,b){g.push(b)});return g.sortByExpression("title")};this.init(f)},getSourceUrl:function(c,b){var e={};$.extend(e,c);var d="";if(c.project_id!=null){d="/projects/"+c.project_id+"/notebooks";delete c.project_id;if(c.id!=null){d+="/"+c.id;delete c.id}}if(!b){$.extend(c,e)}return d},find:function(c){return this.Cache.read(c)}};Notebook=Unfuddle.Data.Notebook;

Unfuddle.Data.Page={fields:["notebook_id","number","title","version","body","body_format","message","message_format","author_id","minor"],formatAttributes:["body","message"],Cache:new Unfuddle.Data.Cache({resourceType:"Page",indices:["notebook_id","number"]}),Base:function(c){this.tmp=Unfuddle.Data.Resource;this.tmp(c);delete this.tmp;this.resourceType="Page";this.initialize=function(){delete this.minor};this.notebook=function(){return Notebook.Cache.read({conditions:{id:this.notebook_id}})[0]};this.rootPage=function(){return Page.find({conditions:{notebook_id:this.notebook_id,number:this.number,evaluate:"object.version==1"}})[0]};this.headPage=function(){return Page.find({conditions:{notebook_id:this.notebook_id,number:this.number},order:["version desc"]})[0]};this.versions=function(a){a=$.extend({},{limit:null},a);return Page.find({conditions:{notebook_id:this.notebook_id,number:this.number},limit:(a.limit?a.limit:null),order:["version desc"]})};this.previousVersion=function(){if(this.version==1){return null}return Page.find({conditions:{notebook_id:this.notebook_id,number:this.number,evaluate:"object.version=="+(this.version-1)}})[0]};this.nextVersion=function(){if(this.version==this.headPage().version){return null}return Page.find({conditions:{notebook_id:this.notebook_id,number:this.number,evaluate:"object.version=="+(this.version+1)}})[0]};this.init(c)},getSourceUrl:function(a,c){var d={};$.extend(d,a);var b="";if(a&&a.project_id!=null&&a.notebook_id!=null){b="/projects/"+a.project_id;delete a.project_id;b+="/notebooks/"+a.notebook_id;delete a.notebook_id;b+="/pages";if(a.id!=null){b+="/"+a.id;delete a.id}}if(!c){$.extend(a,d)}return b},find:function(a){return this.Cache.read(a)}};Page=Unfuddle.Data.Page;

Unfuddle.Data.Repository={fields:["abbreviation","account_id","description","id","system","title","projects","changesets_managed_manually","powerful_commit_messages","callback_url"],Cache:new Unfuddle.Data.Cache({resourceType:"Repository",indices:["abbreviation"],specialIndices:{projects:"project_id"}}),Base:function(f){this.tmp=Unfuddle.Data.Resource;this.tmp(f);delete this.tmp;this.resourceType="Repository";this.associatedProjects=function(){return this.projects.map(function(a){return Project.find(a)[0]})};this.seeIf=function(b,d){if(b.is_removed){return false}if((b.account_id==this.account_id)&&b.is_administrator){return true}var c=false;$.each(this.associatedProjects(),function(a,e){if(b.seeIf(e,d)){c=true;return false}});return c};this.url=function(){var a="";if(this.system=="git"){a="git@"+document.domain+":"+Globals.currentAccount.subdomain+"/"+this.abbreviation+".git"}else{if(this.system=="svn"){a="http"+(Globals.currentAccount.hasFeature("ssl")?"s":"")+"://"+document.domain+"/svn/"+Globals.currentAccount.subdomain+"_"+this.abbreviation+"/"}}return a};this.headChangeset=function(){return Changeset.find({conditions:{repository_id:this.id},order:["created_at desc"]})[0]};this.activityGraph=function(){var b=(new Date).justDate();b.setDate(b.getDate()-30);var self=this;var d=ActivityGraph.find({conditions:{repository_id:self.id}})[0];if(!d){return[]}var c=new Array(31);c.max=0;var g=this;$.each(c,function(a){var e=Utilities.formatDate(b,{hover:false,format:"dashStyle"});c[a]={commits:d.commits_count[e]?d.commits_count[e]:0};c[a].formattedDate=Utilities.formatDate(b,{hover:false,format:"default"});if(c.max<c[a].commits){c.max=c[a].commits}b.setDate(b.getDate()+1)});return c};this.latestChangesetInfo=function(){var a=this.headChangeset();var e=a?Utilities.formatDate(a.committer_date,{prefix:false}):Utilities.formatDate(this.created_at,{prefix:false});var b=a?" by "+a.displayName():"";return e+b};this.init(f)},getSourceUrl:function(a,e){var b={};$.extend(b,a);var d="/repositories";if(a&&a.id!=null){d+="/"+a.id;delete a.id}if(!e){$.extend(a,b)}return d},find:function(a){return this.Cache.read(a)}};Repository=Unfuddle.Data.Repository;

Unfuddle.Data.RepositoryTree={fields:["path","nodes","commit"],Cache:new Unfuddle.Data.Cache({resourceType:"RepositoryTree",indices:["path","commit"]}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="RepositoryTree";this.init(a)},getSourceUrl:function(a,c){var e={};$.extend(e,a);var d="";if(a.repository_id!=null){d="/repositories/"+a.repository_id+"/tree";delete a.repository_id}if(!c){$.extend(a,e)}return d},find:function(a){return this.Cache.read(a)}};RepositoryTree=Unfuddle.Data.RepositoryTree;RepositoryTree.Cache.preProcess=function(b,f){if(b==null||b==[]){return[]}b.id=b.path+"@"+b.commit;if(typeOf(b)!="array"){b=[b]}$.each(b,function(e,d){if(d.nodes==null){return true}$.each(d.nodes,function(a,c){if(c.changeset){c.changeset=new Changeset.Base(c.changeset)}})});return b};

Unfuddle.Data.RepositoryFile={fields:["path","lines","content","name","commit"],Cache:new Unfuddle.Data.Cache({resourceType:"RepositoryFile",indices:["path","commit"]}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="RepositoryFile";this.init(a)},getSourceUrl:function(a,d){var b={};$.extend(b,a);var c="";if(a.repository_id!=null){c="/repositories/"+a.repository_id+"/file";delete a.repository_id}if(!d){$.extend(a,b)}return c},find:function(a){return this.Cache.read(a)}};RepositoryFile=Unfuddle.Data.RepositoryFile;

Unfuddle.Data.RepositoryHistory={fields:["branch","tag","changeset","parents"],Cache:new Unfuddle.Data.Cache({resourceType:"RepositoryHistory",indices:["branch","repository_id","commit"]}),Base:function(e){this.tmp=Unfuddle.Data.Resource;this.tmp(e);delete this.tmp;this.resourceType="RepositoryHistory";this.displayName=function(c){var c=c||"author";var a=null,b=null;var d=(c=="author"?this.author_id:this.committer_id);if(d){b=Person.find(d)[0]}if(b){a=b.displayName()}if(!a){a=(c=="author"?this.author:this.committer);b=a?Person.find({conditions:{evaluate:"object.username=="+a.split("_").last}})[0]:null;if(b){a=b.displayName()}}if(!a){a=(c=="author"?this.author_email:this.committer_email)}return a?a.trim():"Unknown"};this.init(e)},getSourceUrl:function(c,a){var b={};$.extend(b,c);var d="";if(c&&c.repository_id!=null){d="/repositories/"+c.repository_id+"/history";delete c.repository_id}if(!a){$.extend(c,b)}return d},find:function(c){return this.Cache.read(c)}};RepositoryHistory=Unfuddle.Data.RepositoryHistory;RepositoryHistory.Cache.preProcess=function(b,d){if(b==null||b==[]){return[]}if(typeOf(b)!="array"){b=[b]}$.each(b,function(c,a){a.id=a.commit;a._commitDateFormatted=Utilities.formatDate(a.committer_date,{prefix:true,format:"withTime"})});return b};

Unfuddle.Data.RepositoryBranch={fields:["type","commit","name"],Cache:new Unfuddle.Data.Cache({resourceType:"RepositoryBranch",indices:["commit","name"]}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="RepositoryBranch";this.init(a)},getSourceUrl:function(a,d){var b={};$.extend(b,a);var c="";if(a.repository_id!=null){c="/repositories/"+a.repository_id+"/branches";delete a.repository_id}if(!d){$.extend(a,b)}return c},find:function(a){return this.Cache.read(a)}};RepositoryBranch=Unfuddle.Data.RepositoryBranch;

Unfuddle.Data.ActivityGraph={Cache:new Unfuddle.Data.Cache({resourceType:"ActivityGraph",indices:["repository_id"]}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="ActivityGraph";this.init(a)},getSourceUrl:function(a,b){var c={};$.extend(c,a);var d="";if(!isEmpty(a)&&a.repository_id!=null){d="/repositories/"+a.repository_id+"/activity_graph";delete a.repository_id}if(!b){$.extend(a,c)}return d},find:function(a){return this.Cache.read(a)}};ActivityGraph=Unfuddle.Data.ActivityGraph;ActivityGraph.Cache.preProcess=function(a,b){if(a==null||a==[]){return[]}if(typeOf(a)!="array"){a=[a]}a.id=b;return a};

Unfuddle.Data.Subscription={fields:["parent_id","parent_type","person_id"],Cache:new Unfuddle.Data.Cache({resourceType:"Subscription",indices:["ticket_id","person_id"]}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="Subscription";if(this.parent_type=="Ticket"&&this.parent_id!=null){this.ticket_id=this.parent_id}this.ticket=function(){return Ticket.find({conditions:{id:this.ticket_id}})[0]};this.init(a)},getSourceUrl:function(a,d){var c={};$.extend(c,a);var b="";if(a&&a.project_id!=null&&a.ticket_id!=null){b="/projects/"+a.project_id+"/tickets/"+a.ticket_id+"/subscriptions";delete a.project_id;delete a.ticket_id;if(a.id!=null){b+="/"+a.id;delete a.id}}if(!d){$.extend(a,c)}return b},find:function(a){return this.Cache.read(a)}};Subscription=Unfuddle.Data.Subscription;

Unfuddle.Data.PublicKey={fields:["title","value","person_id"],Cache:new Unfuddle.Data.Cache({resourceType:"PublicKey",sendSslHeader:true}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;var self=this;this.resourceType="PublicKey";this.getRootNode=function(){return"public-key"};this.init(a)},getSourceUrl:function(a,d){var c={};$.extend(c,a);var b="";if(a.person_id!=null){b+="/people/"+a.person_id+"/public_keys";delete a.person_id;if(a.useID&&a.id!=null){b+="/"+a.id}delete a.id}if(!d){$.extend(a,c)}return b},find:function(a){return this.Cache.read(a)}};PublicKey=Unfuddle.Data.PublicKey;

Unfuddle.Data.TimeEntry={fields:["date","description","hours","person_id","ticket_id"],Cache:new Unfuddle.Data.Cache({resourceType:"TimeEntry",indices:["ticket_id","person_id"]}),Base:function(d){this.tmp=Unfuddle.Data.Resource;this.tmp(d);delete this.tmp;var self=this;this.resourceType="TimeEntry";this.getRootNode=function(){return"time-entry"};this.afterSave=function(){OverallProgress.Cache.erase()};this.ticket=function(){if(self.__ticket){return self.__ticket}else{return Ticket.find({conditions:{id:this.ticket_id}})[0]}};this.prettyField=function(b){switch(b){case"date":return this.date;case"project":return soy.$$escapeHtml(self.ticket().project().title);case"ticket":return"#"+self.ticket().number+" "+soy.$$escapeHtml(self.ticket().summary);case"milestone":return self.ticket().prettyField("milestone");case"person":return soy.$$escapeHtml(Person.find(self.person_id)[0]?Person.find(self.person_id)[0].displayName():"");case"description":return soy.$$escapeHtml(self.description);case"hours":return self.hours.toFixed(2);case"hours_estimate_initial":return self.ticket().prettyField("hours_estimate_initial");case"hours_estimate_current":return self.ticket().prettyField("hours_estimate_current");default:return""}};this.init(d)},getSourceUrl:function(b,d){var f={};$.extend(f,b);var c="";if(b&&b.project_id!=null&&b.ticket_id!=null){c="/projects/"+b.project_id+"/tickets/"+b.ticket_id+"/time_entries";delete b.project_id;delete b.ticket_id;if(b.id!=null){c+="/"+b.id;delete b.id}}if(!d){$.extend(b,f)}return c},fieldHeading:function(b){switch(b){case"date":return{name:"Date",width_weight:3};case"project":return{name:"Project",width_weight:5};case"ticket":return{name:"Ticket",width_weight:6};case"milestone":return{name:"Milestone",width_weight:3};case"person":return{name:"Person",width_weight:3};case"description":return{name:"Task Performed",width_weight:6};case"hours":return{name:"Hours",width_weight:2};case"hours_estimate_initial":return{name:"Initial Est.",width_weight:2};case"hours_estimate_current":return{name:"Current Est.",width_weight:2};default:return{name:"Field",width_weight:3}}},reportSort:function(d,f,c){f=f||d.sort_by;c=c||d.sort_direction;var g;switch(f){case"date":g="date";break;case"project":g="object.ticket().project().title, date";break;case"ticket":g="object.ticket().number, date";break;case"milestone":g="object.ticket().prettyField('milestone'), date";break;case"person":g="object.prettyField('person'), date";break;case"description":g="object.description.toLowerCase(), date";break;case"hours":g="parseFloat(object.hours), date";break;case"hours_estimate_initial":g="parseFloat(object.hours_estimate_initial), date";break;case"hours_estimate_current":g="parseFloat(object.hours_estimate_current), date";break;default:g=f}d.groups.forEach(function(b){b.time_entries=b.time_entries.sortByExpression(g);b.time_entries=c.toUpperCase()=="DESC"?b.time_entries.reverse():b.time_entries});return d},find:function(b){return this.Cache.read(b)}};TimeEntry=Unfuddle.Data.TimeEntry;Unfuddle.Data.OverallProgress={Cache:new Unfuddle.Data.Cache({resourceType:"OverallProgress",indices:["project_id"]}),Base:function(b){this.tmp=Unfuddle.Data.Resource;this.tmp(b);delete this.tmp;this.resourceType="OverallProgress";this.init(b)},reportSort:function(d,f,c){f=f||d.sort_by;c=c||d.sort_direction;d.milestones.forEach(function(b){if(b.milestone_id){b.tickets=Ticket.sort(b.tickets,f,c)}});return d},getSourceUrl:function(b,d){var f={};$.extend(f,b);var c="/overall_progress";if(b&&b.project_id!=null){c="/projects/"+b.project_id+"/overall_progress";delete b.project_id}if(!d){$.extend(b,f)}return c},find:function(b){return this.Cache.read(b)}};OverallProgress=Unfuddle.Data.OverallProgress;OverallProgress.Cache.preProcess=function(i,j){if(i==null||i==[]){return[]}if(typeOf(i)!="array"){i.project_id=parseInt(j.split("/")[2]);i=[i]}$.each(i,function(k,h){h.id=h.project_id;h.milestones_by_id={};$.each($.merge(h.milestones,[h.entire_project]),function(f,c,a){try{if(!Project.find(h.project_id)[0].actuallyUses("time_tracking")||c.hours_estimate_current==0){c.percentage=Math.floor(c.tickets_closed/(c.tickets_active+c.tickets_closed)*100)}else{var g=c.hours_actual_closed/c.hours_estimate_current*100;c.percentage=g>99.51?Math.ceil(g):Math.floor(g)}}catch(e){c.percentage=0}c.percentage=c.percentage||0;if(c.percentage>100){c.percentage=100}$.each(["hours_estimate_initial_active","hours_estimate_initial","hours_estimate_current_active","hours_estimate_current","hours_actual","hours_actual_active","hours_actual_closed"],function(b,d){try{if(c[d]!=null){c[d]=c[d].toFixed(2)}}catch(e){}});if(c.milestone_id){h.milestones_by_id[c.milestone_id]=c}h.milestones_by_id.entire_project=h.entire_project})});return i};

Unfuddle.Data.Changeset={fields:["author_id","author_name","author_email","author_date","committer_id","committer_name","committer_email","committer_date","created_at","message","repository_id","revision"],dateFields:["author_date","committer_date"],Cache:new Unfuddle.Data.Cache({resourceType:"Changeset",indices:["repository_id","author_id"]}),Base:function(e){this.resourceType="Changeset";this.tmp=Unfuddle.Data.Resource;this.tmp(e);delete this.tmp;var self=this;this.displayName=function(a,d){var b=null,c=null;var f=(d=="author"?self.author_id:self.committer_id);if(f){c=Person.find(f)[0]}if(c){b=c.displayName()}if(!b){b=(d=="author"?self.author_name:self.committer_name);c=!b?null:Person.find({conditions:{evaluate:"object.username=="+b.split("_").last}})[0];if(c){b=c.displayName()}}if(!b){b=(d=="author"?self.author_email:self.committer_email)}return b?b.trim():"Unknown"};this.init(e)},getSourceUrl:function(a,d){var b={};$.extend(b,a);var c="";if(!isEmpty(a)){if(a.repository_id!=null){c="/repositories/"+a.repository_id+"/changesets";delete a.repository_id}else{if(a.project_id!=null&&a.ticket_id!=null){c="/projects/"+a.project_id+"/tickets/"+a.ticket_id+"/associated_changesets";delete a.project_id;delete a.ticket_id}}if(a.latest){c+="/latest";delete a.latest}else{if(a.id!=null){c+="/"+a.id;delete a.id}}}if(!d){$.extend(a,b)}return c},find:function(a){return this.Cache.read(a)}};Changeset=Unfuddle.Data.Changeset;

Unfuddle.Data.Commit={fields:["committer","author","branch","message","author-email","files","commit","tag","author-date","tree","committer-email","diffs","committer-date","parents","latest","commit_comments"],Cache:new Unfuddle.Data.Cache({resourceType:"Commit",indices:["commit"]}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="Commit";this.init(a)},getSourceUrl:function(a,d){var e={};$.extend(e,a);var b="";if(a.repository_id!=null){b="/repositories/"+a.repository_id+"/commit";delete a.repository_id}if(!d){$.extend(a,e)}return b},find:function(a){return this.Cache.read(a)}};Commit=Unfuddle.Data.Commit;Commit.Cache.preProcess=function(c){if(typeOf(c)!="array"){c=[c]}$.each(c,function(e,b){if(b.commit_comments){$.each(b.commit_comments,function(a,d){CommitComment.Cache.process(d.commit_comment,CommitComment.getSourceUrl(d.commit_comment))})}});return c};

Unfuddle.Data.Invoice={fields:["account_id","transaction_id"],Cache:new Unfuddle.Data.Cache({resourceType:"Invoice",indices:["account_id","transaction_id"],sendSslHeader:true}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="Invoice";this.init(a)},getSourceUrl:function(a,d){var b={};$.extend(b,a);var c="/invoices";return c},find:function(a){return this.Cache.read(a)}};Invoice=Unfuddle.Data.Invoice;

Unfuddle.Data.Search={fields:["query"],Cache:new Unfuddle.Data.Cache({resourceType:"Search",indices:["project_id"]}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="Search";this.project=function(){return Project.find(this.project_id)[0]};this.init(a)},getSourceUrl:function(a,d){var c={};$.extend(c,a);var b="";if(a.project_id!=null){b="/projects/"+a.project_id+"/search";delete a.project_id}else{b="/account/search"}if(!d){$.extend(a,c)}return b},find:function(a){return this.Cache.read(a)}};Search=Unfuddle.Data.Search;

Unfuddle.Data.Activity={fields:["summary","event","record_id","record_type","person_id","description","project_id"],Cache:new Unfuddle.Data.Cache({resourceType:"Activity",indices:["project_id"]}),Base:function(c){this.tmp=Unfuddle.Data.Resource;this.tmp(c);delete this.tmp;this.resourceType="Activity";this.pastTense=function(b){switch(b){case"unaccept":return"Unccepted";case"resolve":return"Resolved";case"accept":return"Accepted";case"commit":return"Committed";case"close":return"Closed";case"create":return"Created";case"delete":return"Deleted";case"reopen":return"Reopened";case"reassign":return"Reassigned";case"status_update":return"Status updated";case"updated":return"Updated";default:return"Unknown Action"}};this.init(c)},retrieve:function(g,e,h){params={};params.limit=e.limit;params.offset=e.offset;if(e.endDate){params.end_date=Utilities.formatDate(e.endDate,{format:"utcString",hover:false})}$.ajax({type:"GET",dataType:"json",data:params,url:Unfuddle.Config.baseApiUrl+g+(g.endsWith(".json")?"":".json"),success:function(c,f){if(c==null){c=[]}$.each(c,function(b,a){c[b]=new Activity.Base(a)});h(c)},error:function(b,c,f){var d=[];d.error=true;h(d)}})},getSourceUrl:function(b,c){var f={};$.extend(f,b);var d="";if(b.project_id!=null){d="/projects/"+b.project_id+"/activity";delete b.project_id}else{d="/activity"}if(!c){$.extend(b,f)}return d},find:function(b){return this.Cache.read(b)}};Activity=Unfuddle.Data.Activity;

Unfuddle.Data.Audit={fields:["id","summary","event","project_id","record_id","record_type","person_id","description"],Cache:new Unfuddle.Data.Cache({resourceType:"Audit",indices:["record_type","record_id"]}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="Audit";this.init(a)},getSourceUrl:function(a,d){var b={};$.extend(b,a);var c="";if(!isEmpty(a)){if(a.project_id!=null&&a.ticket_id!=null){c="/projects/"+a.project_id+"/tickets/"+a.ticket_id+"/audit_trail";delete a.project_id;delete a.ticket_id}}if(!d){$.extend(a,b)}return c},find:function(a){return this.Cache.read(a)}};Audit=Unfuddle.Data.Audit;

Unfuddle.Data.CommitComment={fields:["author_id","body","body_format","repository_id","commit","file","line_number","file_version"],formatAttributes:["body"],Cache:new Unfuddle.Data.Cache({resourceType:"CommitComment",indices:["author_id","repository_id","commit"]}),Base:function(a){this.tmp=Unfuddle.Data.Resource;this.tmp(a);delete this.tmp;this.resourceType="CommitComment";this.getRootNode=function(){return"commit-comment"};this.init(a)},getSourceUrl:function(a,c){var d={};$.extend(d,a);var b="";b="/repositories/"+a.repository_id+"/commit_comments";if(a.id!=null){b+="/"+a.id;delete a.id}if(!c){$.extend(a,d)}return b},find:function(a){return this.Cache.read(a)}};CommitComment=Unfuddle.Data.CommitComment;CommitComment.Cache.preProcess=function(a,c){if(typeOf(a)!="array"){a=[a]}return a};

Unfuddle.Globals=Unfuddle.Globals||{};Globals=Unfuddle.Globals;Globals.scripts=[];Globals.session=Globals.session||{};Globals.session.ticket=Globals.session.ticket||{};Unfuddle.UI={};UI=Unfuddle.UI;UI.Renderer=function(d,g){var self=this;this.objectID="Renderer_"+Math.random().toString().slice(2,15);this.domID="";this.containerID="";this.options=d||{};this.visible=g||true;this.active=true;this.subscriptions={};this.locals=d.locals||{};d.locals=this.locals;this.rendering=false;this.shouldRender=false;this.dependsOn=function(a,b,c){c=$.extend({essential:false},c);if(!this.subscriptions[b]){this.subscriptions[b]={};this.subscriptions[b].options=c;this.subscriptions[b].resourceType=a}if(c.trigger||this._checkBeforeRender()){Unfuddle.Data[a].Cache.subscribe(this,b,c.findParams);c.triggered=true}};this.dependsOn("Person","/people",{trigger:true,findParams:{apiParams:{removed:true}}});this.dependsOn("Person","/people/current",{trigger:true});this.dependsOn("Account","/account",{trigger:true});this.dependsOn("Project","/projects",{trigger:true});this.dependsOn("Involvement","/people/"+Globals.currentPerson.id+"/involvements",{trigger:true});this.checkBeforeRender=function(){return true};this.verifyPermissions=function(){return true};this._checkBeforeRender=function(){if(!Account.current()||!Person.current()||Person.find({sourceUrl:"/people",apiParams:{removed:true}}).pending||Project.find().pending||Involvement.find({conditions:{person_id:Globals.currentPerson.id}}).pending){return false}this._setGlobals();if(Person.current().is_administrator){var f=Account.current().checkCompliance(d.route);if(f=="billing_error"){Bookmarker.redirectTo(Bookmarker.bookmarkFor("account_billing"),{force:true});return false}else{if(f=="compliance_error"){Bookmarker.redirectTo(Bookmarker.bookmarkFor("account_compliance"),{force:true});return false}}}var e=true;$.each(this.subscriptions,function(a,b){if(!b.triggered){Unfuddle.Data[b.resourceType].Cache.subscribe(self,a,b.options.findParams);b.triggered=true}var c=$.extend({sourceUrl:a},b.options.findParams);b.options.result=Unfuddle.Data[b.resourceType].find(c);if(b.options.essential&&b.options.result.pending){e=false}});return e};this._checkForResources=function(){return true;if(!d._mainRenderer||!d.route){return true}var e=[];var h=Bookmarker.routes[d.route][0];$.each(this.options,function(a,b){if(!a.endsWith("_id")||h.indexOf(a)<0){return true}if(self.containerID!="#content"&&a!="project_id"){return true}var c=a.split("_id")[0].camelize();var f=a.split("_id")[0].humanize();var result=Unfuddle.Data[c].find(b);if(!result.length){e.push("Can't find a "+f+" with the id "+b+".")}});if(e.length){self.notifyUser("error",e,{message:" "});return false}return true};this._setGlobals=function(){Unfuddle.Globals.currentAccount=Account.current();Unfuddle.Globals.currentProject=Project.current();Unfuddle.Globals.allProjects=Project.find();Unfuddle.Globals.currentPerson=Person.current();Unfuddle.Globals.people=Person.find({order:"object.displayName()"})};this.renderMainLocked=false;this.render=function(a){if(!this.active){return}if(!this.rendering){this.rendering=true;this.forceRendering=false;if(this._checkBeforeRender()&&this.checkBeforeRender()&&this._checkForResources()){if(!this.verifyPermissions()){Bookmarker.redirectTo(UI.Bookmarker.bookmarkFor("account"));return false}if(this.spinner){this.spinner.remove()}if(this.visible){if(!this.renderMainLocked){this.removeFromDOM();this.renderMain(a)}}else{this.removeFromDOM()}if(Account.current().flagged_for_billing_error&&Person.current().is_administrator){if(self.options.route!="account_billing"){$("#billing_error_alert").show()}else{$("#billing_error_alert").hide()}}}else{if(!this.spinner){this.spinner=$(ajaxProgressSmall()).appendTo(this.containerID)}}this.rendering=false;if(this.shouldRender){this.shouldRender=false;this.render()}}else{this.shouldRender=true}};this.renderMain=function(){};this.notify=function(a){};this.forceRendering=false;this.eventNotification=function(a){if(!this.active){return}if(!this.subscriptions[a]){return this.notify(a)}this.subscriptions[a].options.done=true;var b=this.subscriptions[a].options.callback;if(b){b(a)}else{if(this.subscriptions[a].options.essential){this.render(a)}else{if(a=="/account"||a=="/people"||a=="/people/current"||a=="/projects"||a=="/people/"+Globals.currentPerson.id+"/involvements"){this.forceRendering=true}this.notify(a);if(this.forceRendering){this.render(a)}}}};this.addJsTemplate=function(a){Helpers.addJsTemplate(a)},this.clearDependencies=function(){var self=this;$.each(this.subscriptions,function(a,b){Unfuddle.Data[b.resourceType].Cache.unsubscribe(self)});this.subscriptions={}};this.clearContent=function(){if(this.domID.length){$(this.domID).html("")}};this.removeFromDOM=function(){if(this.spinner){this.spinner.remove()}if(this.domID.length){$(this.domID).remove()}if(this.content){this.content.remove()}};this.hide=function(){this.visible=false;this.removeFromDOM()};this.show=function(){if(UI.activeRenderers.indexOf(this)<0){UI.activeRenderers.push(this)}this.visible=true;this.render()};this.close=function(){this.clearDependencies();Unfuddle.UI.activeRenderers.remove(this);this.hide();this.active=false};this.refresh=function(){if(!this.visible){return}this.hide();$("."+this.objectID).remove();this.renderMainLocked=false;this.show()};this.notifyUser=function(a,b,c){if(!this.active||!this.visible){return}$("."+this.objectID).remove();var c=$.extend({rendererClass:self.objectID},c);Helpers.flashNoticeNow(a,b,c)}};UI.Project={bookmark:function(a){if(!a){a="index"}return Unfuddle.UI.Bookmarker.bookmarkFor("project_"+a)}};UI.Person={bookmark:function(a){if(!a){a="index"}return Unfuddle.UI.Bookmarker.bookmarkFor("person_"+a)}};UI.Category={bookmark:function(a){if(!a){a="index"}return Unfuddle.UI.Bookmarker.bookmarkFor("category_"+a)}};UI.Message={bookmark:function(a,b){if(Config.currentProjectID!=0){b=$.extend({project_id:Config.currentProjectID},b)}if(!a){a="index"}var c=b&&b.project_id?Unfuddle.UI.Bookmarker.bookmarkFor("message_"+a,{project_id:b.project_id}):Unfuddle.UI.Bookmarker.bookmarkFor("account_message_"+a);return c+UI.addBookmarkArgs(b)}};UI.Milestone={bookmark:function(a,b){if(Config.currentProjectID!=0){b=$.extend({project_id:Config.currentProjectID},b)}if(!a){a="index"}var c=b&&b.project_id?Unfuddle.UI.Bookmarker.bookmarkFor("milestone_"+a,{project_id:b.project_id}):Unfuddle.UI.Bookmarker.bookmarkFor("account_milestone_"+a);return c+UI.addBookmarkArgs(b)}};UI.Comment={bookmark:function(a){if(!a){a="index"}return Unfuddle.UI.Bookmarker.bookmarkFor("comment_"+a)}};UI.Attachment={bookmark:function(a){if(!a){a="index"}return Unfuddle.UI.Bookmarker.bookmarkFor("attachment_"+a)}};UI.Severity={bookmark:function(a){if(!a){a="index"}return Unfuddle.UI.Bookmarker.bookmarkFor("severity_"+a)}};UI.Version={bookmark:function(a){if(!a){a="index"}return Unfuddle.UI.Bookmarker.bookmarkFor("version_"+a)}};UI.Component={bookmark:function(a){if(!a){a="index"}return Unfuddle.UI.Bookmarker.bookmarkFor("component_"+a)}};UI.Notebook={bookmark:function(a){if(!a){a="index"}return Unfuddle.UI.Bookmarker.bookmarkFor("notebook_"+a)}};UI.bookmarkForResource=function(a,b){if(!b){b="show"}var c={};c[a.resourceType.toLowerCase()+"_id"]=a.id;c.resource=a;return Unfuddle.UI.Bookmarker.bookmarkFor(a.resourceType.toLowerCase()+"_"+b,c)};UI.addBookmarkArgs=function(c){var result="";if(c&&c.args){result+="?";$.each(c.args,function(a,b){result+=a+"="+b+"&"});result=result.substr(0,result.length-1)}return result};UI.activeRenderers=[];UI.disabledButtons=[];UI.flashNoticeWaiting={message:[],type:"",options:{}};

Unfuddle.UI.Helpers={alertBox:function(){var c=new Array;if(arguments.length>0){if(arguments[0]instanceof Array){for(i=0;i<arguments[0].length;i++){c.push(arguments[0][i])}}else{for(i=0;i<arguments.length;i++){c.push(arguments[i])}}}else{c=["<span style='color:#ff8800'> --</span>nothing sent"]}ndata="<span style='color:#ff8800'>&gt; </span>";for(i=0;i<c.length;i++){if(c[i]==null){c[i]="<span style='color:#ff8800'>--</span>null"}if(c[i]==""){c[i]="<span style='color:#ff8800'>--</span>empty string"}if(i>0){ndata+="<br/> "}ndata+=c[i]+" "}c=ndata;if(!$("#dev_alert_box").length>0){s="border-color:#888;border-style:solid;border-width:1px;color:#bbb;position:fixed; left:526px; background-color:#005500; bottom:10px; font-size:1.3em;font-weight:bold;padding-bottom:0;padding-left:3px;padding-right:3px;padding-top:0;line-height:0.8em;text-decoration:none;";a=$("<div/>").attr("id","dev_alert_box").attr("style","position:fixed; opacity:0.93; max-height:200px; overflow:auto; bottom:10px; left:10px; min-height:100px; z-index:1000; width:500px; padding:8px; background:#005500; color: #f5f5f5");b=$("<a/>").attr("style",s).attr("href","#").text("x").bind("click",function(){$("#dev_alert_box").remove();return false}).appendTo(a);$("<span/>").html(c).appendTo(a);a.fadeIn().appendTo("body")}else{$("#dev_alert_box").append("<br /><span>"+c+"</span>")}},calendarHelper:function(g){var f=new Date;if(!g){g={}}if(!g.daysMarked){g.daysMarked={}}g=$.extend({},{year:f.getFullYear(),month:f.getMonth(),daysMarked:{}},g);var h=new Date(g.year,g.month,1);var j=new Date(g.year,g.month+1,0);var n=new Date(g.year,g.month,1);var q=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];var k=[1,2,3,4,5,6,0];var l=0;var r=(h.getMonth()==f.getMonth())&&(h.getFullYear()==f.getFullYear());var m="<table class='calendar_mini'>";m+="  <thead>";m+="    <tr class='month_name'>";m+="      <th colspan='7'>"+h.getMonthName()+(h.getFullYear()!=f.getFullYear()?(" "+h.getFullYear()):"")+"</th>";m+="    </tr>";m+="    <tr class='day_name'>";$.each(q,function(c,d){m+="      <th>"+d.slice(0,3)+"</th>"});m+="    </tr>";m+="  </thead>";m+="  <tbody>";m+="    <tr>";if(k[h.getDay()]!=1){var t=k[h.getDay()];if(t==0){t=7}for(l=1;l<t;l++){m+="      <td class='other_month'></td>"}}for(l=h.getDate();l<=j.getDate();l++){m+="      <td class="+((r&&f.getDate()==l)?"today":(g.daysMarked[l]||"day"))+">"+l+"</td>";n.setDate(l);if(k[n.getDay()]==0){if(l!=j.getDate()){m+=" </tr>\n<tr>"}else{m+=" </tr>\n"}}}if(k[j.getDay()]!=0){for(l=k[j.getDay()];l<=6;l++){m+="      <td class='other_month'></td>"}}if(k[j.getDay()]==0){m+="  </tbody>\n</table>"}else{m+="    </tr>\n</tbody>\n</table>"}return m},getCalendarsForMilestones:function(f,h){if(h==null){h=2}var j=[];var n=new Date;var q=n.getFullYear();var k=n.getMonth();var l=[],r=[],m=[],t=[];$.each(f,function(c,d){if(!d.archived){if(d.completed){t.push(d)}if(d.due_on>=n){m.push(d)}if(d.due_on<n&&!d.completed){l.push(d)}else{if(d.due_on>=n&&!d.completed){r.push(d)}}}});var o={};$.each(l,function(c,d){o[d.due_on.getFullYear()]=o[d.due_on.getFullYear()]||{};o[d.due_on.getFullYear()][d.due_on.getMonth()]=o[d.due_on.getFullYear()][d.due_on.getMonth()]||{};o[d.due_on.getFullYear()][d.due_on.getMonth()][d.due_on.getDate()]="late"});$.each(r,function(c,d){o[d.due_on.getFullYear()]=o[d.due_on.getFullYear()]||{};o[d.due_on.getFullYear()][d.due_on.getMonth()]=o[d.due_on.getFullYear()][d.due_on.getMonth()]||{};o[d.due_on.getFullYear()][d.due_on.getMonth()][d.due_on.getDate()]="upcoming"});$.each(t,function(c,d){o[d.due_on.getFullYear()]=o[d.due_on.getFullYear()]||{};o[d.due_on.getFullYear()][d.due_on.getMonth()]=o[d.due_on.getFullYear()][d.due_on.getMonth()]||{};o[d.due_on.getFullYear()][d.due_on.getMonth()][d.due_on.getDate()]="complete"});var p=0;var u=[],w=[];for(var v=q;v<=(m.length>0?m[m.length-1].due_on.getFullYear():q);v++){u.push(v)}$.each(u,function(c,d){for(var g=(d==q?k:0);g<=11;g++){if(p<h&&((o[d]&&o[d][g])||(q==d&&k==g))){p+=1;j.push(Helpers.calendarHelper({year:d,month:g,daysMarked:((o[d]&&o[d][g])?o[d][g]:null)}))}}});return j},flashNotice:function(c,d,g){var g=$.extend({wait_url_change:true},g);if(!(d instanceof Array)){d=[d]}if(!g.wait_url_change){Unfuddle.UI.Helpers.flashNoticeNow(c,d,g)}else{Unfuddle.UI.flashNoticeWaiting={message:d,type:c,options:g}}},flashNoticeNow:function(g,f,h){var h=h||{};if(h.error_title==undefined){h.error_title=true}var j=h.rendererClass||"";if(!(f instanceof Array)){f=[f]}if(f.length>0){if(g=="error"){$("#error_explanation").remove();var n=$("<div id='error_explanation' class='error_explanation flash_renderer "+j+"' />").appendTo(h.container?$(h.container):($("#error_message_container")[0]?$("#error_message_container"):$("#notice_container")));var q="";q+='<div class="info_wrapper"><h2>';if(h.error_title){q+=f.length+" error"+(f.length>1?"s ":" ")+(h.message?h.message:"prohibited this object from being saved")}q+="</h2><ul>";$.each(f,function(c,d){q+="<li>"+d+"</li>"});q+="</ul></div>";n.html(q)}else{$("#notice").remove();var n=$("<div id='notice' class='flash_renderer "+j+"' />").prependTo(h.container?$(h.container):$("#notice_container"));var k=$("<div/>").addClass("info_wrapper");$.each(f,function(c,d){$("<div/>").html(d).appendTo(k)});n.html(k)}}},ajaxProgressSmall:function(){return'<div class="ajax_progress_small"></div>';return'<img class="ajax_progress_small" src="/images/ajax.16.black.gif" />'},scrollPageTo:function(c,d){var d=d||1;if(c){if($("#"+c)[0]||$('a[name="'+c+'"]')[0]){var g=($("a[name="+c+"]")[0]?$('a[name="'+c+'"]').offset().top:$("#"+c).offset().top)-25;$("html:not(:animated),body:not(:animated)").animate({scrollTop:g},300)}else{if(d<=10){setTimeout("Unfuddle.UI.Helpers.scrollPageTo('"+c+"',"+(d+1)+")",300)}}}},actionCallback:function(c,d){if(!d){d={}}if(d.submit_bttn){Unfuddle.UI.Helpers.toggleAjaxBttn(d.submit_bttn,false)}if(c.action_results.success){if(d.successCallback){d.successCallback()}else{if(d.returnUrl){Unfuddle.UI.Helpers.flashNotice("success",c.resourceType+" successfully "+c.action_results.action);Unfuddle.UI.Bookmarker.redirectTo(d.returnUrl,true)}else{if(c.action_results.action=="created"||c.action_results.action=="updated"){Unfuddle.UI.Helpers.flashNotice("success",c.resourceType+" successfully "+c.action_results.action);Unfuddle.UI.Bookmarker.redirectTo(Unfuddle.UI.bookmarkForResource(c),true)}else{Unfuddle.UI.Helpers.flashNotice("success",c.resourceType+" successfully "+c.action_results.action);Unfuddle.UI.Bookmarker.redirectTo(Unfuddle.UI[c.resourceType].bookmark(),true)}}}}else{if(d.errorCallback){d.errorCallback()}else{if(c.action_results.errors.length!=0){Unfuddle.UI.Helpers.flashNotice("error",c.action_results.errors,{container:d.flash_container||false,wait_url_change:false})}else{Unfuddle.UI.Helpers.flashNotice("error",c.resourceType+" could not be "+c.action_results.action,{container:d.flash_container||false,wait_url_change:false})}}}},markupContainer:function(g,f){var f=$.extend({},{markup:Unfuddle.Utilities.getDefaultMarkup(),collapsed:false,attachments:false,domID:(Math.floor(Math.random()*100000))+"_mkv",unfParams:{}},f);var h=f.domID;var j=$("<textarea/>");if($("#"+h)[0]){if($("textarea#"+h)[0]){j=$("textarea#"+h)}$("#"+h).remove()}markupWrapper=$("<div />").appendTo(g);if(f.attachments){var n=$("<div/>").attr("style","padding:0px 0px 0px 10px").addClass("attachments_container");n.html("<strong>Attachments</strong>").append($("<span style='padding-left:10px' />").html($("<a/>").html("Add new file...").attr("href","#").bind("click",function(){Unfuddle.UI.Helpers.add_file_input("#"+h+"_add_attachment");return false})));n.append($("<ul/>").addClass("file_attachment_input nobullet nopadding").attr("id",h+"_add_attachment"));var q=$("<div/>").addClass("comment_add_attchs_container").html(n).appendTo(markupWrapper);if(f.collapsed){q.hide()}}var k=$("<div class='comment_add_main_container' />").attr("id",h+"_main");if(f.collapsed){k.addClass("comment_add_main_container_small")}var l="";l+='<div class="markup_selector '+h+'_markup_selector" style="margin-bottom: -32px;'+(f.collapsed?"display:none;":"")+'">';l+='<select id="'+h+'_markup" style="width: 90px; margin-right:0.3em">';$.each(Account.VALID_MARKUP,function(c,d){if(Globals.currentAccount.textMarkupList().include(d.name)){l+="<option "+(f.markup==d.name?'selected="selected"':"")+' value="'+d.name+'">'+d.displayName+"</option>"}});l+="</select></div>";l+="<div>";l+="<textarea id ='"+h+"' class='markup_textarea "+j[0].className+"' name='"+j[0].name+"' style='width:100%'"+(j.attr("tabindex")?" tabindex='"+j.attr("tabindex")+"'":"")+">"+j.val()+"</textarea>";l+="<div style='clear:left;'></div></div>";l+="<div id='"+h+"_preview' style='display: none' class='formatted_text_preview'></div>";l+="<div id='"+h+"_preview_path' style='display: none'>"+Config.baseApiUrl+Unfuddle.Data.Project.getSourceUrl({id:Unfuddle.Config.currentProjectID})+"/preview_text</div>";l+="<div id='"+h+"_help_path_base' style='display: none'>http://unfuddle.com/docs/topics/</div>";k.html(l).appendTo(markupWrapper);$("#"+h+"_markup").change(function(){Utilities.changeTextareaInputFormat(h,this.value,true,{unfParams:f.unfParams})});Utilities.changeTextareaInputFormat(h,f.markup,false,{unfParams:f.unfParams});var r=$("<div style='text-align:right' />");if(f.collapsed){markupWrapper.find(".markItUpHeader").hide()}if(f.collapsed){r.append($("<a href='#' />").html("More options&dArr;").css({display:"block",margin:"0 .8em -0.2em 0","font-size":"12px"}).attr("title","More options ...").bind("click",function(){r.html("");markupWrapper.css("margin-top","10px");markupWrapper.find(".markup_selector").show();markupWrapper.find(".markItUpHeader").show();markupWrapper.find(".comment_add_attchs_container").show();markupWrapper.find("textarea").css("height","50px");if(f.attachments){markupWrapper.find(".comment_add_main_container").removeClass("comment_add_main_container_small")}markupWrapper.find("textarea").focus();return false})).prependTo(markupWrapper)}if(!f.attachments){markupWrapper.find(".comment_add_main_container").addClass("comment_add_main_container_small")}markupWrapper.prepend(r);return markupWrapper},removeMarkup:function(c,d){if(!c){return false}d=$.extend({},{textarea:$(c+" textarea"),remove:false},d);var g=$(d.textarea);var f=g.attr("id");var h=g.val();g.markItUpRemove();var j=d.remove?"":$("<textarea />").attr("id",f).val(h);$(c).html(j)},add_file_input:function(c){var d=Math.floor(Math.random()*100000);var g=$("<li/>").html("<input type='file' class='file_input' id='file_input_"+d+"' name='file_input_"+d+"' />");$(c).append(g)},toggleAjaxBttn:function(c,d){var c=$(c);if(d){$(c).before(Unfuddle.UI.Helpers.ajaxProgressSmall());$(c).attr("disabled",true);UI.disabledButtons.pushUnique(c)}else{$(c).parent().find(".ajax_progress_small").remove();$(c).removeAttr("disabled");UI.disabledButtons.remove(c)}},buildPageLinks:function(g,f,h){if(h<=f){return}var j=$("div.paginator_pages_mini");if(!j){return}var n=window.location.href.split("?")[0];var q=(window.location.href.indexOf("page_items=")>=0)?"&page_items="+f:"";var k=window.location.href.split("?")[1]?window.location.href.split("?")[1].split("&"):"";var l="";$.each(k,function(c,d){if(d.indexOf("page_items")<0&&d.indexOf("page=")<0){l+="&"+d}});var r=n+"?page="+(g-1)+q+l;var m='<img title="Previous" src="/images/previous.png" alt="Previous"/> ';if(g==1){$("<span/>").addClass("disabled").addClass("prev_page").html(m).appendTo(j)}else{$("<a/>").attr("href",r).html(m).appendTo(j)}var t=Math.ceil(h/f);if(t<=1){return""}var o=false;for(var p=1;p<=t;p++){if(p==1||p==t||(g<=5&&p<=5)||(g>=t-4&&p>=t-4)||Math.abs(p-g)<=2){o=false;if(p==g){$("<span class='current' />").html(p).appendTo(j)}else{r=n+"?page="+p+q+l;$("<a/>").attr("href",r).html(p).appendTo(j)}j.append(" ")}else{if(!o){j.append(" ... ");o=true}}}var r=n+"?page="+(parseInt(g)+1)+q+l;var u='<img title="Next" src="/images/next.png" alt="Next"/>';if(g==t){$("<span/>").addClass("disabled").addClass("next_page").html(u).appendTo(j)}else{$("<a/>").attr("href",r).html(u).appendTo(j)}},buildRecordCounter:function(c,d,g,f){var h=$("#results_counter");if(!h){return}var j=(c-1)*d+1;var n=j+d-1;if(n>g){n=g}if(f){h.append(f+" ")}h.append("<strong>"+j+"</strong> - <strong>"+n+"</strong> of <strong>"+g+"</strong>")},hideNewbieLink:function(){$("#hide_new_bie_info").click(function(){Unfuddle.UI.Helpers.hideNewbie()})},hideNewbie:function(){Helpers.toggle_ajax_working(true);var c=Globals.currentPerson;c.save({show_help_messages:false},function(){if(c.action_results.success){$("#newbie_info").hide()}});return false},ajaxLogin:function(){if(!Globals.currentPerson){if(!location.href.include("session/new")&&!location.href.include("password_reset")){UI.Bookmarker.redirectTo(UI.Bookmarker.bookmarkFor("session_new")+"?reference="+Url.encode(location.href))}return}if($("#ajax_login")[0]&&$("#ajax_login").dialog("isOpen")){return}$("#ajax_login").dialog("destroy");$("#ajax_login").remove();$("body").prepend('<div id="ajax_login"/>');$(Unfuddle.Template.General.oldLogin()).appendTo("#ajax_login");$("#login_page").show();$("#ajax_login").dialog({bgiframe:true,closeOnEscape:false,resizable:false,draggable:false,width:700,dialogClass:"ajax_login_dialog",modal:true,position:["",$(window).height()*0.2],title:'<img src="/images/logo_sm_white.png" alt="git hosting and subversion hosting at unfuddle" />',zIndex:10000,close:function(){UI.disabledButtons.forEach(function(b){Unfuddle.UI.Helpers.toggleAjaxBttn(b,false)});UI.disabledButtons=[];if(!Globals.currentPerson){window.location.reload()}}});$("#password_reminder a").attr("target","_blank");$(".signin_type_select").remove();$("#ajax_username").focus();$("#submit_credentials").click(function(){var j=this;Helpers.toggleAjaxBttn(j,true);$.ajax({beforeSend:function(c){c.setRequestHeader("X-Unfuddle-Ajax-Client",1)},type:"POST",url:Config.baseApiUrl+"/session.json",dataType:"application/json",data:{username:$("#ajax_username").val(),password:$("#ajax_password").val(),remember_me:$("#ajax_remember_me").is(":checked")?1:0},success:function(d,g){Person.Cache.retrieve({sourceUrl:"/people/current",callback:function(c){UI.Helpers.hideAjaxLogin()}})},error:function(c,d,g){var f=[];try{var h=[];h=JSON.parse(c.responseText).errors;f=h}catch(e){}if(f.length<=0){f=["Your username or password are incorrect. Please try again."]}Helpers.flashNoticeNow("error",f.join("<br />"),{error_title:false});$("#ajax_username")[0].focus();Helpers.toggleAjaxBttn(j,false)}})})},showExternalLayout:function(c,d){if(Unfuddle.UI.domContent){return false}Unfuddle.UI.domContent={};Unfuddle.UI.domContent.css=$("link[href*=account.css],link[href*=account_ie7.css],link[href*=ajaxui/general.css],link[href*=account.gz.css],link[href*=account_ie7.gz.css],link[href*=ajaxui/general.gz.css],link[href*=common.css],link[href*=common.gz.css]");Unfuddle.UI.domContent.bodyContent=$("#account_header,#wrapper,#footer,iframe");Unfuddle.UI.domContent.bodyContent.hide();Unfuddle.UI.domContent.css.attr("disabled","disabled");$("link[href*=page.css],link[href*=page.gz.css]").removeAttr("disabled");var g=$(Unfuddle.Template.Layout.pageLayout({currentYear:(new Date()).getFullYear()}));if(c){g.find("#main").html(c)}document.body.className=document.body.className;var f=function(){$("body").prepend(g);if(d){d()}};setTimeout(f,200)},hideExternalLayout:function(){$("link[href*=page_ie7.css],link[href*=page.css],link[href*=page_ie7.gz.css],link[href*=page.gz.css]").attr("disabled","disabled");if(!Unfuddle.UI.domContent){return false}$("#wrap,footer").remove();Unfuddle.UI.domContent.css.removeAttr("disabled");Unfuddle.UI.domContent.bodyContent.show();document.body.className=document.body.className;delete Unfuddle.UI.domContent},hideAjaxLogin:function(c){$("#ajax_login").dialog("close");$("#ajax_login").dialog("destroy");$("#ajax_login").remove()},checkSessionExpired:function(){if(!Utilities.isAuthenticated()){UI.Helpers.ajaxLogin();return true}else{return false}},fdisable:function(c){if(c.length>0){for(var d=0;d<c.length;d++){if(undefined!=$(c[d])[0]&&$(c[d])[0]!=null){$(c[d]).attr("disabled",true)}}}},fenable:function(c){if(c.length>0){for(var d=0;d<c.length;d++){c[d].removeAttr("disabled")}}},update_plan_selection:function(g){$.each($(".plan_select_button"),function(c,d){d.value="Select"});$(".plan_select_button").removeAttr("disabled");$(".selected_column").removeClass("selected_column");$("."+g+"_column").addClass("selected_column");$("#plan_select_"+g)[0].value="Selected";$("#plan_select_"+g)[0].disabled="disabled";$("#account_plan")[0].value=g},invite_person_cancel:function(c){$(c).hide();if($(c+"_form")[0]){$(c+"_form")[0].reset()}},invite_person_submit:function(d,g){var f={};$(d).serializeArray().forEach(function(c){f[c.name]=c.value});var h=Globals.currentProject?Globals.currentProject.id:$("#invite_person_proj").val();var j=[];if(f.person_username==""){j.push("Username can't be blank")}if(!f.person_username.match(/^[a-z]+[a-z0-9]*$/)){j.push("Username may only contain lowercase letters [a-z] and no spaces or special characters")}if(f.person_username.length<3||f.person_username.length>20){j.push("Username should be between 3 and 20 characters")}if(f.person_email==""){j.push("Email can't be blank")}if(!f.person_email.match(/([a-zA-Z0-9_\-])+(\.([a-zA-Z0-9_\-])+)*@((\[(((([0-1])?([0-9])?[0-9])|(2[0-4][0-9])|(2[0-5][0-5])))\.(((([0-1])?([0-9])?[0-9])|(2[0-4][0-9])|(2[0-5][0-5])))\.(((([0-1])?([0-9])?[0-9])|(2[0-4][0-9])|(2[0-5][0-5])))\.(((([0-1])?([0-9])?[0-9])|(2[0-4][0-9])|(2[0-5][0-5]))\]))|((([a-zA-Z0-9])+(([\-])+([a-zA-Z0-9])+)*\.)+([a-zA-Z])+(([\-])+([a-zA-Z0-9])+)*))/)){j.push("Email is invalid")}if(j.length){alert(j.join("\n"));return false}var n={person:{username:f.person_username,last_name:f.person_last_name,first_name:f.person_first_name,email:f.person_email},message:f.message,involvement:{project_id:h}};n["involvement_"+h]={is_administrator:(f["involvement_"+h+"_is_administrator"]=="1"?true:false)};UI.PermissionUtilities.resourcesLines.forEach(function(c){n["involvement_"+h][c]=f["involvement_"+h+"_"+c]});Utilities.sendPersonInvitation(n,g);return false},message_validate:function(c,d){var g=c?c+"_title":"title",f=c?c+"_body":"body",h=c?c+"_body_markup":"body_markup";errors=new Array();if($(g)[0].value==""){errors.push("Message title cannot be empty.")}if(($(h)[0].value!="html"&&$(f)[0].value=="")){errors.push("Message body cannot be empty.")}if(errors.length==0){return true}else{alert("There was an error "+(d?"updating":"creating")+" your message:\n\n"+errors.join("\n"));return false}},show_message_edit_cancel:function(){$("#show_message_edit").hide();$("#show_message_edit_form")[0].reset();$("#show_message_render").show()},show_message_comment_edit_cancel:function(c){$(c+"_edit").hide();$(c+"_edit_form")[0].reset();$(c+"_render").show();$(c+"_actions").show()},resize_attachment_form:function(c){if(c.include("comment")){Unfuddle.UI.Helpers.resize_comment_attachment_form(c)}else{if(c=="#message"){Unfuddle.UI.Helpers.resize_message_attachment_form()}else{if(c=="#ticket"){Unfuddle.UI.Helpers.resize_ticket_attachment_form()}}}},resize_comment_attachment_form:function(c){if(!$(c+"_show_attach")[0]){return}$(c+"_show_attach")[0].style.height=null;$(c+"_show_attach")[0].style.height=(Math.max($(c+"_inside").height(),$(c+"_show_attach_inside").height()+20))+"px";$(c+"_show_attach")[0].style.height=(Math.max($(c+"_inside").height(),$(c+"_show_attach_inside").height()+20))+"px";$(c+"_show_attach")[0].style.height=(Math.max($(c+"_inside").height(),$(c+"_show_attach_inside").height()+20))+"px"},resize_message_attachment_form:function(){if($("#message_show_attach")[0]){$("#message_show_attach")[0].style.height=(Math.max($("#message_show_attachments_inside").height()+10,$("#message_show_attach_inside").height()+20))+"px"}},resize_ticket_attachment_form:function(){if($("#ticket_show_attach")[0]){$("#ticket_show_attach")[0].style.height=(Math.max($("#ticket_show_attachments_inside").height()+10,$("#ticket_show_attach_inside").height()+21-1))+"px"}},close_attachment_upload_form:function(c){if($(c+"_show_attach")[0]&&$(c+"_show_attach").is(":visible")){$(c+"_show_attach").hide();if($(c+"_attachments_list")[0]){$(c+"_attachments_list").css({"margin-right":"0px"})}if(c=="#ticket"){$("#ticket_attachment_actions").show()}else{if(c=="#message"){$("#message_attachment_actions").show()}else{$(c+"_actions").show()}}$("#show_"+c.slice(1)+"_attachment_upload_form li").remove();$("#show_"+c.slice(1)+"_attachment_upload_form")[0].reset();$(c+"_show_attach_submit_button").removeAttr("disabled");Unfuddle.UI.Helpers.resize_attachment_form(c)}},open_attachment_upload_form:function(c){if(c=="#ticket"){$("#ticket_attachment_actions").hide()}else{if(c=="#message"){$("#message_attachment_actions").hide()}else{$(c+"_show_attach_action").hide()}}$(c+"_show_attach")[0].style.height=$(c+"_show_attachments").height()+"px";$(c+"_show_attach").show()},toggle_ajax_working:function(c){return true;if(c){$("#ajax_working").show()}else{$("#ajax_working").hide()}},comment_validate:function(c,d){errors=new Array();if($(c+"_body_markup")[0].value!="html"&&$(c+"_body")[0].value==""){errors.push("Comment cannot be empty.")}if(errors.length==0){return true}else{alert("There was an error "+(d?"updating":"creating")+" your comment:\n\n"+errors.join("\n"));return false}},new_notebook_cancel:function(c){$(c).hide();$(c+"_form")[0].reset()},new_notebook_validate:function(c){errors=new Array();if($(c+"_title").value==""){errors.push("Notebook title cannot be empty.")}if(errors.length==0){return true}else{alert("There was an error creating your notebook:\n\n"+errors.join("\n"));return false}},notebook_edit:function(c){$("#list_notebook_show_"+c).hide();$("#list_notebook_edit_"+c).show();$("#notebook_title_"+c).focus()},notebook_edit_cancel:function(c){$("#list_notebook_edit_"+c).hide();$("#list_notebook_show_"+c).show();$("#show_notebook_edit_form_"+c)[0].reset()},new_page_cancel:function(c){$("#"+c+"_page").hide();if($("#"+c+"_page_form")[0]){$("#"+c+"_page_form")[0].reset()}},new_page_validate:function(c){errors=new Array();if($(c+"_title").value==""){errors.push("Page title cannot be empty.")}if(errors.length==0){return true}else{alert("There was an error creating your page:\n\n"+errors.join("\n"));return false}},notebook_navigate_to_page:function(c,d,g){window.location=window.location.href.replace(window.location.hash,"#/projects/"+c+"/notebooks/"+d+"/pages/"+g+"/latest")},notebook_show_page:function(){if($("#show_page_edit")[0]){$("#show_page_edit").hide()}if($("#show_page_edit_form")[0]){$("#show_page_edit_form")[0].reset()}if($("#show_page_compare")[0]){$("#show_page_compare").hide()}if($("#show_page_edit_preview")[0]){$("#show_page_edit_preview").hide()}$("#show_page_history").hide();$("#show_page_title_prefix")[0].innerHTML="";$("#show_page_render").show();if($("#menu_edit_page")[0]){$("#menu_edit_page").removeClass("active")}if($("#menu_history_page")[0]){$("#menu_history_page").removeClass("active")}$("#menu_view_page").addClass("active")},notebook_edit_page:function(){$("#show_page_render").hide();$("#show_page_history").hide();$("#show_page_edit").show();if($("#show_page_compare")[0]){$("#show_page_compare").hide()}if($("#show_page_edit_preview")[0]){$("#show_page_edit_preview").hide()}$("#show_page_title_prefix")[0].innerHTML="Edit: ";if($("#menu_history_page")[0]){$("#menu_history_page").removeClass("active")}$("#menu_view_page").removeClass("active");$("#menu_edit_page").addClass("active")},notebook_history_page:function(){$("#show_page_render").hide();if($("#show_page_edit")[0]){$("#show_page_edit").hide()}if($("#show_page_compare")[0]){$("#show_page_compare").hide()}if($("#show_page_edit_preview")[0]){$("#show_page_edit_preview").hide()}$("#show_page_history").show();$("#show_page_title_prefix")[0].innerHTML="History: ";if($("#menu_edit_page")[0]){$("#menu_edit_page").removeClass("active")}$("#menu_view_page").removeClass("active");if($("#menu_history_page")[0]){$("#menu_history_page").addClass("active")}},set_compare_page_version:function(c,d,g){var f=g.length;while(f>c){$("#version_b_"+f).show();f-=1}if(d<=c){var h=Number(c)+1;$("#version_b_"+h)[0].checked=true;$("#version_b_checked")[0].value=h}var f=c;while(f>1){$("#version_b_"+f).hide();f-=1}},check_versions:function(c,d){if(c>=d){return false}else{return true}},new_ticket_cancel:function(c){$(c).hide();if($(c+"_form")[0]){$(c+"_form")[0].reset()}},ticket_validate:function(c,d,g){var f=new Array();if($(c).val()==""){f.push("Ticket summary cannot be empty.")}if($(c).val().length>255){f.push("Ticket summary may not be longer than 255 characters.")}if(f.length==0){return true}else{alert("There was an error "+(g?"updating":"creating")+" your ticket:\n\n"+f.join("\n"));return false}},show_ticket_edit_cancel:function(){$("#show_ticket_edit").hide();if($("#show_ticket_edit_form")[0]){$("#show_ticket_edit_form")[0].reset()}$("#show_ticket_render").show()},ticket_associations_add_cancel:function(){$("#ticket_associations_add").hide();$("#ticket_associations_actions").show();$("#Ticket_search").val("")},show_ticket_comment_edit_cancel:function(c){$(c+"_edit").hide();if($(c+"_edit_form")[0]){$(c+"_edit_form")[0].reset()}$(c+"_render").show();$(c+"_actions").show()},close_all_ticket_report_dialogs:function(){$("#report_options_dialog").hide();$("#tickets_update_dialog").hide();$("#tickets_update_dialog_change_attributes").hide();$("#tickets_update_dialog_resolve").hide();$("#tickets_update_dialog_change_attributes_heading").hide();$("#tickets_update_dialog_resolve_heading").hide();if($("#tickets_update_form")[0]){$("#tickets_update_form")[0].reset()}},tickets_update_populate_selected_tickets:function(){var c=new Array();$("#tickets_report_table .ticket_select").each(function(){if(this.checked){c.push(this.id.split("_")[2])}});$("#tickets_update_selected_tickets").val("");$("#tickets_update_selected_tickets").val(c.join(","))},textareaMangleSelection:function(c,d,g,f,h,j,n,q){if(f==""||f==null){f=false}if(n==""||n==null){n=false}if(h==""||h==null){h=false}if(q==""||q==null){q=false}if(j==""||j==null){j=false}var k=$("#"+c)[0];if(!k){return false}k.focus();var l,r,m,t,o,p,u;if(typeof(document.selection)!="undefined"){m=document.selection.createRange().text;p=k.value.substring(0,k.caretPos);u=(k.caretPos<k.value.length?k.value.substring(k.caretPos+1,k.value.length):"")}else{if(typeof(k.setSelectionRange)!="undefined"){l=k.selectionStart;r=k.selectionEnd;t=k.scrollTop;m=k.value.substring(l,r);p=k.value.substring(0,k.selectionStart);u=(k.selectionEnd<k.value.length?k.value.substring(k.selectionEnd+1,k.value.length):"")}}if(m.match(/ $/)){m=m.substring(0,m.length-1);g=g+" "}p=("\n\n"+p);p=p.substring(p.length-2,p.length);u=u+"\n\n";u=u.substring(0,2);if(h&&p!="\n\n"){if(p.substring(1,2)=="\n"){d="\n"+d}else{d="\n\n"+d}}if(n&&p.substring(1,2)!="\n"){d="\n"+d}if(j&&u!="\n\n"){if(u.substring(0,1)=="\n"){g=g+"\n"}else{g=g+"\n\n"}}if(q&&u.substring(0,1)!="\n"){g=g+"\n"}o=d+(f?"":m)+g;if(typeof(document.selection)!="undefined"){var w=document.selection.createRange().text=o;k.caretPos-=g.length}else{if(typeof(k.setSelectionRange)!="undefined"){k.value=k.value.substring(0,l)+o+k.value.substring(r);if(m){k.setSelectionRange(l+o.length,l+o.length)}else{k.setSelectionRange(l+d.length,l+d.length)}k.scrollTop=t}}},getTextareaSelection:function(c){var d=$("#"+c)[0];if(!d){return false}d.focus();if(typeof(document.selection)!="undefined"){sel=document.selection.createRange().text}else{if(typeof(d.setSelectionRange)!="undefined"){sel=d.value.substring(d.selectionStart,d.selectionEnd)}}if(sel.match(/ $/)){sel=sel.substring(0,sel.length-1)}return sel},event_override:function(c,d){if(d!=true&&d!=1){if(!c){var c=window.event}c.cancelBubble=true;if(c.stopPropagation){c.stopPropagation()}}},htmlTag:function(g,f,h){var j=$(g).html(h);$.each(f,function(c,d){j.attr(c,d)});return $("<div>").append(j).html()},ticket_status_show_project:function(g,f){var h='<option value="entire_project">Entire Project</option>';$.each(Project.find(f)[0].activeMilestones(),function(c,d){h+='<option value="'+d.id+'">'+d.title+"</option>"});$("#"+g+"_ticket_status_milestone_selector_select").html(h);Unfuddle.UI.Helpers.ticket_status_show_milestone(g,f,"entire_project")},ticket_status_show_milestone:function(c,d,g){var f=Project.find(d)[0];var h=OverallProgress.find(d,{apiParams:{archived:false}})[0]["milestones_by_id"][g]||{tickets_active:0,hours_estimate_current:"0.00",hours_estimate_current_active:"0.00",tickets_closed:0,hours_actual:"0.00",hours_actual_active:"0.00",milestone_id:0,hours_actual_closed:"0.00",hours_estimate_initial:"0.00",hours_estimate_initial_active:"0.00",percentage:0};var j=f.actuallyUses("time_tracking")&&Person.current().seeIf(f,"canReadPeople")&&h.hours_estimate_current!=0;$("#"+c+"_ticket_status_bar").attr("class","theme_"+f.theme);$("#"+c+"_ticket_status_bar_progress_div").css("width",h.percentage+"%");$("#"+c+"_ticket_status_bar_percent").html(h.percentage+"%");$("#"+c+"_ticket_status_bar_closed_url").html(h.tickets_closed).attr("href","#/projects/"+d+"/ticket_reports/dynamic?title=Closed+Tickets&conditions_string=status-eq-closed"+(g=="entire_project"?"":",milestone-eq-"+g));$("#"+c+"_ticket_status_bar_active_url").html(h.tickets_active).attr("href","#/projects/"+d+"/ticket_reports/dynamic?title=Active+Tickets&conditions_string=status-neq-closed"+(g=="entire_project"?"":",milestone-eq-"+g));if(j){$("#"+c+"_ticket_status_bar_actual_hours").html(h.hours_actual_closed);$("#"+c+"_ticket_status_bar_estimated_hours").html(h.hours_estimate_current);$("#"+c+"_ticket_status_bar_actual_hours_div").show();$("#"+c+"_ticket_status_bar_estimated_hours_div").show()}else{$("#"+c+"_ticket_status_bar_actual_hours_div").hide();$("#"+c+"_ticket_status_bar_estimated_hours_div").hide()}},addJsTemplate:function(c){if(Globals.scripts.indexOf(c)<0){var d="/javascripts/ajax_ui/templates/"+c+".js?"+(Config.assets_random);$.ajax({url:d,dataType:"script",async:false});Globals.scripts.push(c)}},getFormValues:function(f){var f=f||{};f.containerId=f.containerId?"#"+f.containerId+" ":"";f.prefix=f.prefix||(f.model?f.model.toLowerCase()+"_":"");f.fields=f.fields||Unfuddle.Data[f.model].fields;var h={};$.each(f.fields,function(c,d){var g=$(f.containerId+"#"+f.prefix+d);if(!g[0]){return true}h[d]=g[0].type=="checkbox"?g.attr("checked"):g.val()});return h},highlightSyntax:function(c,d){var g="";if(d){if(d.endsWith(".erb")||d.endsWith(".soy")){g="html"}else{if(d.endsWith(".phtml")){g="php"}else{g=d.split("/").last().split(".").last()}}}SyntaxHighlighter.brushes.Unknown=function(){this.regexList=[]};SyntaxHighlighter.brushes.Unknown.prototype=new SyntaxHighlighter.Highlighter();SyntaxHighlighter.brushes.Unknown.aliases=["unknown"];if(!g||!SyntaxHighlighter.utils.findBrush(g,false)){g="unknown"}SyntaxHighlighter.highlight({brush:g,light:true},c)},isMobilePath:function(c){var d=["project","ticket","ticket_reports","account","session/new"];var g=["settings","milestones","messages","notebooks","repositories","people"];for(var f=0;f<g.length;f++){if(c.match(g[f])){return false}}for(var f=0;f<d.length;f++){if(c.match(d[f])){return true}}return false},getMobilePath:function(c){c=c.toString();if(!c.match("#")){return null}c=c.split("#")[1];if(c.match("\\?")){c=c.split("?")[0]}path=c;if(path!=null&&this.isMobilePath(path)){if(path.match("account")||path.match("session/new")){return Config.mobileUrlPrefix}else{return Config.mobileUrlPrefix+path}}else{return null}},mobileSwitchLink:function(){return;link="&nbsp;";if(Config.switchToMobile&&$("#switch_to_mobile")){if(this.getMobilePath(window.location)){link="<a href='"+this.getMobilePath(window.location)+"'>Mobile version</a>"}$("#switch_to_mobile").html(link)}return link}};Helpers=Unfuddle.UI.Helpers;flashNotice=Unfuddle.UI.Helpers.flashNotice;ajaxProgressSmall=Unfuddle.UI.Helpers.ajaxProgressSmall;alertBox=Unfuddle.UI.Helpers.alertBox;Helpers.TIME_ZONES_AVAILABLE=[["International Date Line West","(GMT-11:00) International Date Line West"],["Midway Island","(GMT-11:00) Midway Island"],["Samoa","(GMT-11:00) Samoa"],["Hawaii","(GMT-10:00) Hawaii"],["Alaska","(GMT-09:00) Alaska"],["Pacific Time (US & Canada)","(GMT-08:00) Pacific Time (US & Canada)"],["Tijuana","(GMT-08:00) Tijuana"],["Arizona","(GMT-07:00) Arizona"],["Chihuahua","(GMT-07:00) Chihuahua"],["Mazatlan","(GMT-07:00) Mazatlan"],["Mountain Time (US & Canada)","(GMT-07:00) Mountain Time (US & Canada)"],["Central America","(GMT-06:00) Central America"],["Central Time (US & Canada)","(GMT-06:00) Central Time (US & Canada)"],["Guadalajara","(GMT-06:00) Guadalajara"],["Mexico City","(GMT-06:00) Mexico City"],["Monterrey","(GMT-06:00) Monterrey"],["Saskatchewan","(GMT-06:00) Saskatchewan"],["Bogota","(GMT-05:00) Bogota"],["Eastern Time (US & Canada)","(GMT-05:00) Eastern Time (US & Canada)"],["Indiana (East)","(GMT-05:00) Indiana (East)"],["Lima","(GMT-05:00) Lima"],["Quito","(GMT-05:00) Quito"],["Caracas","(GMT-04:30) Caracas"],["Atlantic Time (Canada)","(GMT-04:00) Atlantic Time (Canada)"],["La Paz","(GMT-04:00) La Paz"],["Santiago","(GMT-04:00) Santiago"],["Newfoundland","(GMT-03:30) Newfoundland"],["Brasilia","(GMT-03:00) Brasilia"],["Buenos Aires","(GMT-03:00) Buenos Aires"],["Georgetown","(GMT-03:00) Georgetown"],["Greenland","(GMT-03:00) Greenland"],["Mid-Atlantic","(GMT-02:00) Mid-Atlantic"],["Azores","(GMT-01:00) Azores"],["Cape Verde Is.","(GMT-01:00) Cape Verde Is."],["Casablanca","(GMT+00:00) Casablanca"],["Dublin","(GMT+00:00) Dublin"],["Edinburgh","(GMT+00:00) Edinburgh"],["Lisbon","(GMT+00:00) Lisbon"],["London","(GMT+00:00) London"],["Monrovia","(GMT+00:00) Monrovia"],["UTC","(GMT+00:00) UTC"],["Amsterdam","(GMT+01:00) Amsterdam"],["Belgrade","(GMT+01:00) Belgrade"],["Berlin","(GMT+01:00) Berlin"],["Bern","(GMT+01:00) Bern"],["Bratislava","(GMT+01:00) Bratislava"],["Brussels","(GMT+01:00) Brussels"],["Budapest","(GMT+01:00) Budapest"],["Copenhagen","(GMT+01:00) Copenhagen"],["Ljubljana","(GMT+01:00) Ljubljana"],["Madrid","(GMT+01:00) Madrid"],["Paris","(GMT+01:00) Paris"],["Prague","(GMT+01:00) Prague"],["Rome","(GMT+01:00) Rome"],["Sarajevo","(GMT+01:00) Sarajevo"],["Skopje","(GMT+01:00) Skopje"],["Stockholm","(GMT+01:00) Stockholm"],["Vienna","(GMT+01:00) Vienna"],["Warsaw","(GMT+01:00) Warsaw"],["West Central Africa","(GMT+01:00) West Central Africa"],["Zagreb","(GMT+01:00) Zagreb"],["Athens","(GMT+02:00) Athens"],["Bucharest","(GMT+02:00) Bucharest"],["Cairo","(GMT+02:00) Cairo"],["Harare","(GMT+02:00) Harare"],["Helsinki","(GMT+02:00) Helsinki"],["Istanbul","(GMT+02:00) Istanbul"],["Jerusalem","(GMT+02:00) Jerusalem"],["Kyev","(GMT+02:00) Kyev"],["Minsk","(GMT+02:00) Minsk"],["Pretoria","(GMT+02:00) Pretoria"],["Riga","(GMT+02:00) Riga"],["Sofia","(GMT+02:00) Sofia"],["Tallinn","(GMT+02:00) Tallinn"],["Vilnius","(GMT+02:00) Vilnius"],["Baghdad","(GMT+03:00) Baghdad"],["Kuwait","(GMT+03:00) Kuwait"],["Nairobi","(GMT+03:00) Nairobi"],["Riyadh","(GMT+03:00) Riyadh"],["St. Petersburg","(GMT+03:00) St. Petersburg"],["Volgograd","(GMT+03:00) Volgograd"],["Tehran","(GMT+03:30) Tehran"],["Abu Dhabi","(GMT+04:00) Abu Dhabi"],["Baku","(GMT+04:00) Baku"],["Moscow","(GMT+04:00) Moscow"],["Muscat","(GMT+04:00) Muscat"],["Tbilisi","(GMT+04:00) Tbilisi"],["Yerevan","(GMT+04:00) Yerevan"],["Kabul","(GMT+04:30) Kabul"],["Ekaterinburg","(GMT+05:00) Ekaterinburg"],["Islamabad","(GMT+05:00) Islamabad"],["Karachi","(GMT+05:00) Karachi"],["Tashkent","(GMT+05:00) Tashkent"],["Chennai","(GMT+05:30) Chennai"],["Kolkata","(GMT+05:30) Kolkata"],["Mumbai","(GMT+05:30) Mumbai"],["New Delhi","(GMT+05:30) New Delhi"],["Sri Jayawardenepura","(GMT+05:30) Sri Jayawardenepura"],["Kathmandu","(GMT+05:45) Kathmandu"],["Almaty","(GMT+06:00) Almaty"],["Astana","(GMT+06:00) Astana"],["Dhaka","(GMT+06:00) Dhaka"],["Novosibirsk","(GMT+06:00) Novosibirsk"],["Rangoon","(GMT+06:30) Rangoon"],["Bangkok","(GMT+07:00) Bangkok"],["Hanoi","(GMT+07:00) Hanoi"],["Jakarta","(GMT+07:00) Jakarta"],["Krasnoyarsk","(GMT+07:00) Krasnoyarsk"],["Beijing","(GMT+08:00) Beijing"],["Chongqing","(GMT+08:00) Chongqing"],["Hong Kong","(GMT+08:00) Hong Kong"],["Irkutsk","(GMT+08:00) Irkutsk"],["Kuala Lumpur","(GMT+08:00) Kuala Lumpur"],["Perth","(GMT+08:00) Perth"],["Singapore","(GMT+08:00) Singapore"],["Taipei","(GMT+08:00) Taipei"],["Ulaan Bataar","(GMT+08:00) Ulaan Bataar"],["Urumqi","(GMT+08:00) Urumqi"],["Osaka","(GMT+09:00) Osaka"],["Sapporo","(GMT+09:00) Sapporo"],["Seoul","(GMT+09:00) Seoul"],["Tokyo","(GMT+09:00) Tokyo"],["Yakutsk","(GMT+09:00) Yakutsk"],["Adelaide","(GMT+09:30) Adelaide"],["Darwin","(GMT+09:30) Darwin"],["Brisbane","(GMT+10:00) Brisbane"],["Canberra","(GMT+10:00) Canberra"],["Guam","(GMT+10:00) Guam"],["Hobart","(GMT+10:00) Hobart"],["Melbourne","(GMT+10:00) Melbourne"],["Port Moresby","(GMT+10:00) Port Moresby"],["Sydney","(GMT+10:00) Sydney"],["Vladivostok","(GMT+10:00) Vladivostok"],["Magadan","(GMT+11:00) Magadan"],["New Caledonia","(GMT+11:00) New Caledonia"],["Solomon Is.","(GMT+11:00) Solomon Is."],["Auckland","(GMT+12:00) Auckland"],["Fiji","(GMT+12:00) Fiji"],["Kamchatka","(GMT+12:00) Kamchatka"],["Marshall Is.","(GMT+12:00) Marshall Is."],["Wellington","(GMT+12:00) Wellington"],["Nuku'alofa","(GMT+13:00) Nuku'alofa"]];Helpers.COUNTRIES=[["United States of America","United States of America"],["","-------------","disabled"],["Afghanistan","Afghanistan"],["Åland","Åland"],["Albania","Albania"],["Algeria","Algeria"],["American Samoa","American Samoa"],["Andorra","Andorra"],["Angola","Angola"],["Anguilla","Anguilla"],["Antarctica","Antarctica"],["Antigua and Barbuda","Antigua and Barbuda"],["Argentina","Argentina"],["Armenia","Armenia"],["Aruba","Aruba"],["Australia","Australia"],["Austria","Austria"],["Azerbaijan","Azerbaijan"],["Bahamas","Bahamas"],["Bahrain","Bahrain"],["Bangladesh","Bangladesh"],["Barbados","Barbados"],["Belarus","Belarus"],["Belgium","Belgium"],["Belize","Belize"],["Benin","Benin"],["Bermuda","Bermuda"],["Bhutan","Bhutan"],["Bolivia","Bolivia"],["Bosnia and Herzegovina","Bosnia and Herzegovina"],["Botswana","Botswana"],["Bouvet Island","Bouvet Island"],["Brazil","Brazil"],["British Indian Ocean Territory","British Indian Ocean Territory"],["Brunei Darussalam","Brunei Darussalam"],["Bulgaria","Bulgaria"],["Burkina Faso","Burkina Faso"],["Burundi","Burundi"],["Cambodia","Cambodia"],["Cameroon","Cameroon"],["Canada","Canada"],["Cape Verde","Cape Verde"],["Cayman Islands","Cayman Islands"],["Central African Republic","Central African Republic"],["Chad","Chad"],["Chile","Chile"],["China","China"],["Christmas Island","Christmas Island"],["Cocos (Keeling) Islands","Cocos (Keeling) Islands"],["Colombia","Colombia"],["Comoros","Comoros"],["Congo (Brazzaville)","Congo (Brazzaville)"],["Congo (Kinshasa)","Congo (Kinshasa)"],["Cook Islands","Cook Islands"],["Costa Rica","Costa Rica"],["Côte d'Ivoire","Côte d'Ivoire"],["Croatia","Croatia"],["Cuba","Cuba"],["Cyprus","Cyprus"],["Czech Republic","Czech Republic"],["Denmark","Denmark"],["Djibouti","Djibouti"],["Dominica","Dominica"],["Dominican Republic","Dominican Republic"],["Ecuador","Ecuador"],["Egypt","Egypt"],["El Salvador","El Salvador"],["Equatorial Guinea","Equatorial Guinea"],["Eritrea","Eritrea"],["Estonia","Estonia"],["Ethiopia","Ethiopia"],["Falkland Islands","Falkland Islands"],["Faroe Islands","Faroe Islands"],["Fiji","Fiji"],["Finland","Finland"],["France","France"],["French Guiana","French Guiana"],["French Polynesia","French Polynesia"],["French Southern Lands","French Southern Lands"],["Gabon","Gabon"],["Gambia","Gambia"],["Georgia","Georgia"],["Germany","Germany"],["Ghana","Ghana"],["Gibraltar","Gibraltar"],["Greece","Greece"],["Greenland","Greenland"],["Grenada","Grenada"],["Guadeloupe","Guadeloupe"],["Guam","Guam"],["Guatemala","Guatemala"],["Guernsey","Guernsey"],["Guinea","Guinea"],["Guinea-Bissau","Guinea-Bissau"],["Guyana","Guyana"],["Haiti","Haiti"],["Heard and McDonald Islands","Heard and McDonald Islands"],["Honduras","Honduras"],["Hong Kong","Hong Kong"],["Hungary","Hungary"],["Iceland","Iceland"],["India","India"],["Indonesia","Indonesia"],["Iran","Iran"],["Iraq","Iraq"],["Ireland","Ireland"],["Isle of Man","Isle of Man"],["Israel","Israel"],["Italy","Italy"],["Jamaica","Jamaica"],["Japan","Japan"],["Jersey","Jersey"],["Jordan","Jordan"],["Kazakhstan","Kazakhstan"],["Kenya","Kenya"],["Kiribati","Kiribati"],["Korea, North","Korea, North"],["Korea, South","Korea, South"],["Kuwait","Kuwait"],["Kyrgyzstan","Kyrgyzstan"],["Laos","Laos"],["Latvia","Latvia"],["Lebanon","Lebanon"],["Lesotho","Lesotho"],["Liberia","Liberia"],["Libya","Libya"],["Liechtenstein","Liechtenstein"],["Lithuania","Lithuania"],["Luxembourg","Luxembourg"],["Macau","Macau"],["Macedonia","Macedonia"],["Madagascar","Madagascar"],["Malawi","Malawi"],["Malaysia","Malaysia"],["Maldives","Maldives"],["Mali","Mali"],["Malta","Malta"],["Marshall Islands","Marshall Islands"],["Martinique","Martinique"],["Mauritania","Mauritania"],["Mauritius","Mauritius"],["Mayotte","Mayotte"],["Mexico","Mexico"],["Micronesia","Micronesia"],["Moldova","Moldova"],["Monaco","Monaco"],["Mongolia","Mongolia"],["Montenegro","Montenegro"],["Montserrat","Montserrat"],["Morocco","Morocco"],["Mozambique","Mozambique"],["Myanmar","Myanmar"],["Namibia","Namibia"],["Nauru","Nauru"],["Nepal","Nepal"],["Netherlands","Netherlands"],["Netherlands Antilles","Netherlands Antilles"],["New Caledonia","New Caledonia"],["New Zealand","New Zealand"],["Nicaragua","Nicaragua"],["Niger","Niger"],["Nigeria","Nigeria"],["Niue","Niue"],["Norfolk Island","Norfolk Island"],["Northern Mariana Islands","Northern Mariana Islands"],["Norway","Norway"],["Oman","Oman"],["Pakistan","Pakistan"],["Palau","Palau"],["Palestine","Palestine"],["Panama","Panama"],["Papua New Guinea","Papua New Guinea"],["Paraguay","Paraguay"],["Peru","Peru"],["Philippines","Philippines"],["Pitcairn","Pitcairn"],["Poland","Poland"],["Portugal","Portugal"],["Puerto Rico","Puerto Rico"],["Qatar","Qatar"],["Reunion","Reunion"],["Romania","Romania"],["Russian Federation","Russian Federation"],["Rwanda","Rwanda"],["Saint Barthélemy","Saint Barthélemy"],["Saint Helena","Saint Helena"],["Saint Kitts and Nevis","Saint Kitts and Nevis"],["Saint Lucia","Saint Lucia"],["Saint Martin (French part)","Saint Martin (French part)"],["Saint Pierre and Miquelon","Saint Pierre and Miquelon"],["Saint Vincent and the Grenadines","Saint Vincent and the Grenadines"],["Samoa","Samoa"],["San Marino","San Marino"],["Sao Tome and Principe","Sao Tome and Principe"],["Saudi Arabia","Saudi Arabia"],["Senegal","Senegal"],["Serbia","Serbia"],["Seychelles","Seychelles"],["Sierra Leone","Sierra Leone"],["Singapore","Singapore"],["Slovakia","Slovakia"],["Slovenia","Slovenia"],["Solomon Islands","Solomon Islands"],["Somalia","Somalia"],["South Africa","South Africa"],["South Georgia and South Sandwich Islands","South Georgia and South Sandwich Islands"],["Spain","Spain"],["Sri Lanka","Sri Lanka"],["Sudan","Sudan"],["Suriname","Suriname"],["Svalbard and Jan Mayen Islands","Svalbard and Jan Mayen Islands"],["Swaziland","Swaziland"],["Sweden","Sweden"],["Switzerland","Switzerland"],["Syria","Syria"],["Taiwan","Taiwan"],["Tajikistan","Tajikistan"],["Tanzania","Tanzania"],["Thailand","Thailand"],["Timor-Leste","Timor-Leste"],["Togo","Togo"],["Tokelau","Tokelau"],["Tonga","Tonga"],["Trinidad and Tobago","Trinidad and Tobago"],["Tunisia","Tunisia"],["Turkey","Turkey"],["Turkmenistan","Turkmenistan"],["Turks and Caicos Islands","Turks and Caicos Islands"],["Tuvalu","Tuvalu"],["Uganda","Uganda"],["Ukraine","Ukraine"],["United Arab Emirates","United Arab Emirates"],["United Kingdom","United Kingdom"],["United States Minor Outlying Islands","United States Minor Outlying Islands"],["United States of America","United States of America"],["Uruguay","Uruguay"],["Uzbekistan","Uzbekistan"],["Vanuatu","Vanuatu"],["Vatican City","Vatican City"],["Venezuela","Venezuela"],["Vietnam","Vietnam"],["Virgin Islands, British","Virgin Islands, British"],["Virgin Islands, U.S.","Virgin Islands, U.S."],["Wallis and Futuna Islands","Wallis and Futuna Islands"],["Western Sahara","Western Sahara"],["Yemen","Yemen"],["Zambia","Zambia"],["Zimbabwe","Zimbabwe"]];Helpers.BILLING_MONTHS=[["",""],["1","1 - Jan"],["2","2 - Feb"],["3","3 - Mar"],["4","4 - Apr"],["5","5 - May"],["6","6 - Jun"],["7","7 - Jul"],["8","8 - Aug"],["9","9 - Sep"],["10","10 - Oct"],["11","11 - Nov"],["12","12 - Dec"]];Helpers.BILLING_YEARS=[["",""],["2010","2010"],["2011","2011"],["2012","2012"],["2013","2013"],["2014","2014"],["2015","2015"],["2016","2016"],["2017","2017"],["2018","2018"],["2019","2019"],["2020","2020"],["2021","2021"],["2022","2022"],["2023","2023"],["2024","2024"],["2025","2025"]];

Unfuddle.UI.Bookmarker={listener:null,interval:200,currentBookmark:{url:null,path:null,anchor:null},changeIEframeHistory:true,params:{},routes:{},absolutePaths:{message_attachment:["/projects/:project_id/messages/:message_id/attachments/:attachment_id/download"],message_comment_attachment:["/projects/:project_id/messages/:message_id/comments/:comment_id/attachments/:attachment_id/download"],ticket_attachment:["/projects/:project_id/tickets/:ticket_id/attachments/:attachment_id/download"],ticket_comment_attachment:["/projects/:project_id/tickets/:ticket_id/comments/:comment_id/attachments/:attachment_id/download"],notebook_attachment:["/projects/:project_id/notebooks/:notebook_id/attachments/:attachment_id/download"],project_backup:["/projects/:project_id/backups/:backup_id/download"]},addListener:function(){if(Unfuddle.UI.Bookmarker.listener==null){Unfuddle.UI.Bookmarker.listener=setInterval("Unfuddle.UI.Bookmarker.checkBookmarkChange()",Unfuddle.UI.Bookmarker.interval)}},removeListener:function(){if(Unfuddle.UI.Bookmarker.listener!=null){clearInterval(Unfuddle.UI.Bookmarker.listener);Unfuddle.UI.Bookmarker.listener=null}},checkBookmarkChange:function(){if(window.location.href!=Unfuddle.UI.Bookmarker.currentBookmark.url){if(Unfuddle.UI.Bookmarker.currentBookmark.url){Unfuddle.UI.Bookmarker.previousBookmark=$.extend({},Unfuddle.UI.Bookmarker.currentBookmark)}var b=window.location.href.split("#")[1]||"/";var f=b.substring(b.length-3);var e=(f=="%5D")||(f[f.length-1]=="]");if(e){var d=b.split((b.indexOf("[")>0)?"[":"%5B")[0];var c=b.split((b.indexOf("[")>0)?"[":"%5B")[1]||null}else{var d=b;var c=null}Unfuddle.UI.Bookmarker.currentBookmark.url=window.location.href;if(d[d.length-1]=="/"){d=d.slice(0,d.length-1)}if(c&&c[c.length-1]=="]"){c=c.slice(0,c.length-1)}else{if(c&&c.slice(-3)=="%5D"){c=c.split("%5D")[0]}}if(c!=Unfuddle.UI.Bookmarker.currentBookmark.anchor){Unfuddle.UI.Bookmarker.currentBookmark.anchor=c}if(d!=Unfuddle.UI.Bookmarker.currentBookmark.path){var g=$("#IEhistoryFrame")[0];if(g&&Unfuddle.UI.Bookmarker.changeIEframeHistory&&b!="/"){g=g.contentWindow.document;g.open("javascript:'<html></html>'");g.write('<html><head><script type="text/javascript">parent.Unfuddle.UI.Bookmarker.changeIEframeHistory = false;parent.Unfuddle.UI.Bookmarker.redirectTo(\''+window.location.href+"');<\/script></head><body></body></html>");g.close()}Unfuddle.UI.Bookmarker.currentBookmark.path=d;Unfuddle.UI.Bookmarker.changeIEframeHistory=true;Unfuddle.UI.Bookmarker.navigateTo(window.location.href)}if(c){Unfuddle.UI.Helpers.scrollPageTo(c)}UI.Helpers.mobileSwitchLink()}},navigateTo:function(i){var h=i.split("#")[1];if(!h){h="/"}var k=h.substring(h.length-3);var t=(k=="%5D")||(k[k.length-1]=="]");var p=h;if(t){p=h.split(h.indexOf("[")>0?"[":"%5B")[0]}var a=p.split("?");var m=a[0];var o={};if(a[1]){var u=a[1].split("&");$.each(u,function(b,f){var e=f.split("=");o[e[0]]=e[1]})}if(m[m.length-1]=="/"){m=m.slice(0,m.length-1)}var q=[];var n=null;var l=null;var params={};Unfuddle.UI.Bookmarker.params={};$.each(Unfuddle.UI.Bookmarker.routes,function(b,f){var e=f[0];var d=0;var c=RegExp(/:\w+/g);var g="";while(g=c.exec(e)){q[d]=g[0].slice(1);d++}e="^"+e.replace(/:\w+/g,"(\\w+)")+"$";if(g=m.match(e)){for(j=0;j<g.length-1;j++){params[q[j]]=g[j+1]}n=f;l=b;return false}});if(!Utilities.isAuthenticated()){if(l!="session_new"&&l!="password_reset"){UI.Bookmarker.redirectTo(UI.Bookmarker.bookmarkFor("session_new")+"?reference="+Url.encode(location.href));return}}else{if(!Unfuddle.Data.checkBasicDependencies()){return}if(!n||l=="session_new"||l=="password_reset"){if(o.reference){Unfuddle.UI.Bookmarker.redirectTo(Url.decode(o.reference),{force:true});return}if(Person.current().projectsByPermission().length==1){Unfuddle.UI.Bookmarker.redirectTo(Config.baseUrl+"/a#/projects/"+Person.current().projectsByPermission()[0].id,{force:true});return}Unfuddle.UI.Bookmarker.redirectTo(Config.baseUrl+"/a#/account",{force:true});return}if(Account.current().flagged_for_billing_error&&Person.current().is_administrator&&l!="account_billing"){$("billing_error_alert").show()}else{$("billing_error_alert").hide()}}if(n[3]=="not implemented"){UI.Bookmarker.removeListener();UI.Bookmarker.redirectTo(Config.baseUrl+p);return}var r=(n[2]=="force ssl"||Config.ssl)?"https:":"http:";if(!Config.development&&location.protocol!=r){UI.Bookmarker.removeListener();location.href=location.href.replace(location.protocol,r);return}if(params.project_id){Unfuddle.Config.currentProjectID=params.project_id}else{Unfuddle.Config.currentProjectID=0}$(".one_page_renderer").remove();$(".container").html("");$(".flash_renderer").remove();Helpers.hideExternalLayout();var s=Unfuddle.UI.activeRenderers.slice();$.each(Unfuddle.UI.activeRenderers,function(b){s[b].close()});s=null;UI.disabledButtons=[];$.extend(params,o,{route:l});$("#loading").remove();$("body").attr("style","");var layouts_sidebar=[];if(Utilities.isAuthenticated()&&!UI.domContent){document.title=Account.current().title+" - Unfuddle";$("#account_header,#wrapper,#footer").show();new Unfuddle.UI.ProjectJump(params);new Unfuddle.UI.Header(params)}start_load=new Date;Unfuddle.UI.Bookmarker.params=$.extend({_mainRenderer:true},params);eval(n[1]);Unfuddle.UI.Bookmarker.params={};if(Utilities.isAuthenticated()&&!UI.domContent){new UI.SidebarShow($.extend({},params,{layouts:layouts_sidebar}));setTimeout(function(){if(typeof pageTracker!=="undefined"){pageTracker._trackPageview(Unfuddle.UI.Bookmarker.currentBookmark.path)}},100)}Unfuddle.UI.Helpers.flashNoticeNow(Unfuddle.UI.flashNoticeWaiting.type,Unfuddle.UI.flashNoticeWaiting.message,Unfuddle.UI.flashNoticeWaiting.options);Unfuddle.UI.flashNoticeWaiting={message:[],type:"",options:{}}},redirectTo:function(b,f){if(!location.hash){location.hash="#/"}if(b==""){b="/"}if(!b){f=true}if(f){Unfuddle.UI.Bookmarker.previousBookmark=$.extend({},Unfuddle.UI.Bookmarker.currentBookmark);Unfuddle.UI.Bookmarker.currentBookmark={url:null,path:null,anchor:null}}window.location.href=b||window.location.href},bookmarkFor:function(e,d){if(!e||(!Unfuddle.UI.Bookmarker.routes[e]&&!Unfuddle.UI.Bookmarker.absolutePaths[e])){return"#"}d=$.extend({ajaxLinks:true,resource:null,project_id:Unfuddle.Config.currentProjectID},d);var c=!!Unfuddle.UI.Bookmarker.absolutePaths[e];var g=Unfuddle.UI.Bookmarker.absolutePaths[e]||Unfuddle.UI.Bookmarker.routes[e];var i=g[0];if(!d.resource){$.each(d,function(b,f){i=i.replace((":"+b),f)})}else{var h=d.resource;i=i.replace((":"+h.resourceType.toLowerCase()+"_id"),h.id);var k=i.split("/");k.forEach(function(b,f){if(b.indexOf(":")==0){k[f]=h[b.substr(1)]||b}});i=k.join("/")}if(!d.ajaxLinks){return Unfuddle.Config.baseUrl+i}return(c?Unfuddle.Config.baseUrl:"#")+i}};Bookmarker=Unfuddle.UI.Bookmarker;

Unfuddle.UI.Bookmarker.routes={account:["/account","params.title='Account Dashboard'; new Unfuddle.UI.Activity(params); layouts_sidebar=['Ticket.sidebarStatus', 'Milestone.sidebarCalendar', 'Account.sidebarSyndication']","non ssl","implemented"],account_settings:["/account/settings","params.title = 'Account Settings'; new Unfuddle.UI.AccountSettings(Unfuddle.UI.Bookmarker.params); layouts_sidebar=['Account.sidebarAccountSettings']","non ssl","implemented"],account_billing:["/account/billing","params.title = 'Billing'; new Unfuddle.UI.Billing(Unfuddle.UI.Bookmarker.params); layouts_sidebar=['Account.sidebarAccountSettings']","force ssl","implemented"],account_confirm_delete:["/account/confirm_delete","params.title = 'Confirm Delete'; new Unfuddle.UI.ConfirmDelete(Unfuddle.UI.Bookmarker.params);layouts_sidebar=[]","non ssl","implemented"],account_compliance:["/account/compliance","params.title = 'Compliance'; new Unfuddle.UI.Compliance(params); layouts_sidebar=[]","non ssl","implemented"],account_message_new:["/messages/new","params.title='Message New'; new Unfuddle.UI.MessageNew(Unfuddle.UI.Bookmarker.params)","non ssl","implemented"],category_message_index:["/projects/:project_id/categories/:category_id/messages","params.title='Messages'; new Unfuddle.UI.MessageIndex(Unfuddle.UI.Bookmarker.params); layouts_sidebar=['Message.sidebarCategories', 'Message.sidebarSyndication']","non ssl","implemented"],message_index:["/projects/:project_id/messages","params.title='Messages'; new Unfuddle.UI.MessageIndex(Unfuddle.UI.Bookmarker.params); layouts_sidebar=['Message.sidebarCategories', 'Message.sidebarSyndication']","non ssl","implemented"],message_show:["/projects/:project_id/messages/:message_id","params.title='Message Show'; new Unfuddle.UI.MessageShow(Unfuddle.UI.Bookmarker.params); layouts_sidebar=['Message.sidebarCategories', 'Message.sidebarSyndication']","non ssl","implemented"],milestone_index:["/projects/:project_id/milestones","params.title='Milestones'; new Unfuddle.UI.MilestoneIndex(Unfuddle.UI.Bookmarker.params); layouts_sidebar=['Milestone.sidebarCalendar', 'Milestone.sidebarSyndication']","non ssl","implemented"],account_person_index:["/people","params.title='People'; new Unfuddle.UI.PersonIndex(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],person_index:["/projects/:project_id/people","params.title='People'; new Unfuddle.UI.PersonIndex(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],person_settings:["/people/settings","params.title = 'Personal Settings'; new UI.PersonShow(Unfuddle.UI.Bookmarker.params);","force ssl","implemented"],account_person_show:["/people/:person_id","params.title = 'Edit Person'; new UI.PersonShow(Unfuddle.UI.Bookmarker.params);","force ssl","implemented"],project_index:["/projects","params.title='Projects';new Unfuddle.UI.ProjectIndex(Unfuddle.UI.Bookmarker.params)","non ssl","implemented"],project_show:["/projects/:project_id","params.title='Project Overview'; new Unfuddle.UI.Activity(params); layouts_sidebar=['Ticket.sidebarStatus', 'Milestone.sidebarCalendar', 'Project.sidebarSyndication']","non ssl","implemented"],project_settings:["/projects/:project_id/settings","params.title='Project Settings'; new Unfuddle.UI.ProjectSettings(Unfuddle.UI.Bookmarker.params); layouts_sidebar=['Project.sidebarSettings', 'Project.sidebarProjectBackups']","non ssl","implemented"],ticket_report_dynamic:["/ticket_reports/dynamic","params.title = 'Tickets'; new Unfuddle.UI.TicketReport(Unfuddle.UI.Bookmarker.params); layouts_sidebar=['Ticket.sidebarStatus','Ticket.sidebarReports']","non ssl","implemented"],project_ticket_report_dynamic:["/projects/:project_id/ticket_reports/dynamic","params.title = 'Tickets'; new Unfuddle.UI.TicketReport(Unfuddle.UI.Bookmarker.params); layouts_sidebar=['Ticket.sidebarStatus','Ticket.sidebarReports']","non ssl","implemented"],ticket_report_show:["/ticket_reports/:ticket_report_id","params.title = 'Tickets'; new Unfuddle.UI.TicketReport(Unfuddle.UI.Bookmarker.params); layouts_sidebar=['Ticket.sidebarStatus','Ticket.sidebarReports']","non ssl","implemented"],project_ticket_report_show:["/projects/:project_id/ticket_reports/:ticket_report_id","params.title = 'Tickets'; new Unfuddle.UI.TicketReport(Unfuddle.UI.Bookmarker.params); layouts_sidebar=['Ticket.sidebarStatus','Ticket.sidebarReports','TimeTracking.sidebarReports']","non ssl","implemented"],ticket_show:["/projects/:project_id/tickets/:ticket_id","params.title = 'Ticket Show'; new Unfuddle.UI.TicketShow(Unfuddle.UI.Bookmarker.params); layouts_sidebar=['Ticket.sidebarStatus','Ticket.sidebarReports','TimeTracking.sidebarReports']","non ssl","implemented"],ticket_show_by_number:["/projects/:project_id/tickets/by_number/:number","params.title = 'Ticket Show'; new Unfuddle.UI.TicketShow(Unfuddle.UI.Bookmarker.params); layouts_sidebar=['Ticket.sidebarStatus','Ticket.sidebarReports','TimeTracking.sidebarReports']","non ssl","implemented"],repository_index:["/repositories","params.title = 'Repositories'; new UI.RepositoryIndex(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],project_repository_index:["/projects/:project_id/repositories","params.title = 'Repositories'; new UI.RepositoryIndex(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],repository_edit:["/repositories/:repository_id/edit","params.title = 'Repositories'; new UI.RepositoryEdit(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],project_repository_edit:["/projects/:project_id/repositories/:repository_id/edit","params.title = 'Repositories'; new UI.RepositoryEdit(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],repository_browse:["/repositories/:repository_id/browse","params.title = 'Browse'; new UI.RepositoryBrowse(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],project_repository_browse:["/projects/:project_id/repositories/:repository_id/browse","params.title = 'Browse'; new UI.RepositoryBrowse(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],repository_file:["/repositories/:repository_id/file","params.title = 'Browse'; new UI.RepositoryFile(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],project_repository_file:["/projects/:project_id/repositories/:repository_id/file","params.title = 'Browse'; new UI.RepositoryFile(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],repository_commit:["/repositories/:repository_id/commit","params.title = 'Commit'; new UI.RepositoryCommit(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],project_repository_commit:["/projects/:project_id/repositories/:repository_id/commit","params.title = 'Commit'; new UI.RepositoryCommit(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],repository_history:["/repositories/:repository_id/history","params.title = 'History'; new UI.RepositoryHistory(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],project_repository_history:["/projects/:project_id/repositories/:repository_id/history","params.title = 'History'; new UI.RepositoryHistory(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],notebook_index:["/projects/:project_id/notebooks","params.title = 'Notebooks'; new Unfuddle.UI.NotebookIndex(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],notebook_show:["/projects/:project_id/notebooks/:notebook_id","params.title = 'Notebooks'; new Unfuddle.UI.NotebookShow(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],notebook_activity:["/projects/:project_id/notebooks/:notebook_id/activity","params.title = 'Notebooks'; new Unfuddle.UI.NotebookShow(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],notebook_attachments:["/projects/:project_id/notebooks/:notebook_id/attachments","params.title = 'Notebooks'; new Unfuddle.UI.NotebookShow(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],notebook_page_new:["/projects/:project_id/notebooks/:notebook_id/new","params.title = 'Notebooks'; new Unfuddle.UI.NotebookShow(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],notebook_page_show:["/projects/:project_id/notebooks/:notebook_id/pages/:page_id","params.title = 'Notebooks'; new Unfuddle.UI.PageShow(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],notebook_page_show_by_number:["/projects/:project_id/notebooks/:notebook_id/pages/by_number/:page_number","params.title = 'Notebooks'; new Unfuddle.UI.PageShow(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],notebook_page_latest:["/projects/:project_id/notebooks/:notebook_id/pages/:page_id/latest","params.title = 'Notebooks'; new Unfuddle.UI.PageShow(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],compare_project_notebook_page:["/projects/:project_id/notebooks/:notebook_id/pages/:page_id/compare","params.title = 'Notebooks'; new Unfuddle.UI.PageShow(Unfuddle.UI.Bookmarker.params);","non ssl","implemented"],time_invested:["/account/time_invested","params.title = 'Time Invested'; new Unfuddle.UI.TimeInvested(Unfuddle.UI.Bookmarker.params); layouts_sidebar=['Ticket.sidebarStatus']","non ssl","implemented"],project_time_invested:["/projects/:project_id/time_invested","params.title = 'Time Invested'; new Unfuddle.UI.TimeInvested(Unfuddle.UI.Bookmarker.params); layouts_sidebar=['Ticket.sidebarStatus','Ticket.sidebarReports','TimeTracking.sidebarReports']","non ssl","implemented"],project_overall_progress:["/projects/:project_id/overall_progress","params.title = 'Overall Progress'; new Unfuddle.UI.OverallProgress(Unfuddle.UI.Bookmarker.params); layouts_sidebar=['Ticket.sidebarStatus','Ticket.sidebarReports','TimeTracking.sidebarReports']","non ssl","implemented"],session_new:["/session/new","params.title = 'Signin'; new Unfuddle.UI.Session(Unfuddle.UI.Bookmarker.params);","force ssl"],password_reset:["/support/password_reset","params.title = 'Password Reset'; new Unfuddle.UI.PasswordReset(params);","force ssl"],project_search:["/projects/:project_id/search","params.title = 'Search'; new Unfuddle.UI.Search(params);","non ssl","implemented"],account_search:["/account/search","params.title = 'Search'; new Unfuddle.UI.Search(params);","non ssl","implemented"]};

UI.MessageShow=function(i){this.tmp=Unfuddle.UI.Renderer;this.tmp(i);delete this.tmp;this.containerID="#content";this.domID="#message_show_"+i.message_id;this.verifyPermissions=function(){return Globals.currentPerson.seeIf(Globals.currentProject,"canReadMessages")};this.addJsTemplate("message");var self=this;this.dependsOn("Message","/projects/"+i.project_id+"/messages/"+i.message_id,{essential:true});this.dependsOn("Category","/projects/"+i.project_id+"/categories",{essential:true});this.dependsOn("Attachment","/projects/"+i.project_id+"/messages/"+i.message_id+"/attachments",{essential:true});this.checkBeforeRender=function(){this.message=Message.find({conditions:{id:i.message_id}});if(this.message.pending){return false}else{this.message=this.message[0]}return true};this.renderMainLocked=false;this.renderMain=function(){if(this.renderMainLocked){return}this.renderMainLocked=true;this.holder=$("<div class='domID'/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);var e=this.message;var n={message:e,project:Project.find(self.options.project_id)[0],author:Person.find(e.author_id)[0],categories:e.categoriesCollection(),attachments:e.attachmentsCollection(),messageDateFormatted:Utilities.formatDate(e.created_at,{prefix:true}),canCreateMessages:Globals.currentPerson.seeIf(Globals.currentProject,"canCreateMessages"),canManageMessages:Globals.currentPerson.seeIf(Globals.currentProject,"canManageMessages"),canReadPeople:Globals.currentPerson.seeIf(Globals.currentProject,"canReadPeople"),isMSIE:Utilities.isMSIE(),projectHasFeatureAttachments:Globals.currentProject.hasFeature("attachments")};if(n.author){n.authorDisplayName=n.author.displayName(),document.title=e.title+" - Unfuddle"}n.messageBody=Utilities.formatText(this.message.body,{format:this.message.body_format,project:n.project,callback:function(f){$("#show_message_render .body").html(f)}});$.each(n.attachments,function(f,a){a.attachment_type=a.content_type.include("image")?"image":"download";a.attachmentDateFormatted=Utilities.formatDate(a.created_at,{prefix:false,format:"withTime"});a.sizeFormatted=Utilities.formatBytes(a.size)});this.holder.append(Unfuddle.Template.Message.show({locals:n}));$("#message_show_attach_submit_button").click(function(){var h=$("#message_file_input_list .file_input");var g=[];var c=[];var j=[];var m={submit_bttn:$("#message_show_attach_submit_button")};h.each(function(b,d){if(d.value!=""){var a=new Attachment.Base({fileElementId:d.id,filename:d.value.split("\\").pop().split("/").pop(),parent_type:"Message",project_id:self.options.project_id});c.push({resource:a,action:function(f){a.upload(f)},onSuccess:function(){j.push({resource:a,action:function(f){a.parent_id=self.options.message_id;a.message_id=self.options.message_id;a.save(f)},onError:function(){Unfuddle.UI.Helpers.actionCallback(a,m)}})},onError:function(){Unfuddle.UI.Helpers.actionCallback(a,m)}})}});var l={onSuccess:function(){UI.Bookmarker.redirectTo()}};var k={onSuccess:function(){Unfuddle.Utilities.eventChain(j,l)}};Unfuddle.Utilities.eventChain(c,k);return false});$("#message_show_new_message_link").click(function(){new UI.MessageNew({project_id:n.project.id});self.renderMainLocked=true;return false});new UI.CommentIndex({parent:e,project_id:e.project_id,containerID:"#message_show_comments",route:i.route})};this.show()};UI.MessageIndex=function(e){this.tmp=Unfuddle.UI.Renderer;this.tmp(e);delete this.tmp;e.page=e.page||1;e.pageItems=e.pageItems||10;this.containerID="#content";this.domID="#message_index";this.verifyPermissions=function(){return Globals.currentPerson.seeIf(Globals.currentProject,"canReadMessages")};var self=this;this.dependsOn("Message","/projects/"+e.project_id+"/messages",{essential:true});this.dependsOn("Category","/projects/"+e.project_id+"/categories",{essential:true});this.addJsTemplate("message");this.notify=function(f){if(f.endsWith("/attachments")){this.renderAttachments(f)}else{if(f.endsWith("/comments")){this.renderComments(f)}else{this.render()}}};this.renderMain=function(){this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);var g={conditions:{project_id:e.project_id},order:["active_at desc"]};if(e.category_id){$.extend(g.conditions,{evaluate:"object.categories.include("+self.options.category_id+")"})}g.skip=(e.page-1)*e.pageItems;g.limit=e.pageItems;this.messages=Message.find(g);var c=self.options.category_id?Category.find(self.options.category_id)[0]:null;locals={messages:this.messages,category:c,project:Globals.currentProject,canCreateMessages:Globals.currentPerson.seeIf(Globals.currentProject,"canCreateMessages"),canReadPeople:Globals.currentPerson.seeIf(Globals.currentProject,"canReadPeople")};$.each(this.messages,function(f,b){var d=Person.find(b.author_id)[0];if(d){b.authorDisplayName=d.displayName()}b.messageDateFormatted=Utilities.formatDate(b.created_at,{prefix:true});b.categoriesCol=b.categoriesCollection();self.dependsOn("Attachment","/projects/"+b.project_id+"/messages/"+b.id+"/attachments");self.dependsOn("Comment","/projects/"+b.project_id+"/messages/"+b.id+"/comments")});this.holder.append(Unfuddle.Template.Message.index({locals:locals}));$("#new_message_link").click(function(){self.renderMainLocked=true;new UI.MessageNew({project_id:locals.project.id});return false});$.each(this.messages,function(b,d){var h=$("#message_body_holder_"+d.id);h.html(Utilities.formatText(d.body,{format:d.body_format,project:Project.find(e.project_id)[0],constrain:1000,callback:function(f){h.html(f+(d.body.length>1000?"<a href='#/projects/"+self.options.project_id+"/messages/"+d.id+"'>Read more...</a>":""))}})+(d.body.length>1000?"<a href='#/projects/"+self.options.project_id+"/messages/"+d.id+"'>Read more...</a>":""))});Helpers.buildPageLinks(e.page,e.pageItems,this.messages.totalItems);Helpers.buildRecordCounter(e.page,e.pageItems,this.messages.totalItems,"Messages");this.renderAttachments();this.renderComments()};this.renderAttachments=function(l){if(l&&self.messages.pending){return false}var k=[];if(l){k.push(l.split("/")[4])}else{$.each(self.messages,function(f,b){k.push(b.id)})}$.each(k,function(g,c){var j=Attachment.Cache.read({conditions:{project_id:Config.currentProjectID,message_id:c}});if(!j.pending){var m=$("#attachment_summary_message_"+c).html("Attachments: ");if(j.length==0){m.remove()}else{$("#listed_message_"+c).css("padding-bottom","10px");$.each(j,function(f,a){var b=$("<img src='/images/icons/attach.png' alt='Attach'/>");var d=$("<a/>").attr("href",Unfuddle.UI.Bookmarker.bookmarkFor("message_attachment",{project_id:self.options.project_id,message_id:c,attachment_id:a.id})).html(b);var h=$("<a/>").attr("href",Unfuddle.UI.Bookmarker.bookmarkFor("message_attachment",{project_id:self.options.project_id,message_id:c,attachment_id:a.id})).html(a.filename);$("<span/>").attr("style","white-space: nowrap").html(d).append(h).appendTo(m);if(f<j.length-1){m.append(" / ")}})}}})};this.renderComments=function(c){if(c&&self.messages.pending){return false}var j=[];if(c){j.push(c.split("/")[4])}else{$.each(self.messages,function(f,b){j.push(b.id)})}$.each(j,function(f,b){var d=Comment.Cache.read({conditions:{project_id:Config.currentProjectID,parent_type:"Message",parent_id:b},order:["created_at desc"]});if(!d.pending){var h=$("#comment_summary_message_"+b).html("");if(d.length){var g=Person.find(d[0].author_id)[0];$("<a/>").attr("title","most recent "+(Globals.currentPerson.seeIf(Globals.currentProject,"canReadPeople")?("by "+(g?g.displayName():"")):"")+" on "+Utilities.formatDate(d[0].created_at,{hover:false})).attr("href","#/projects/"+self.options.project_id+"/messages/"+b+"[comments]").html(d.length+" Comment"+(d.length>1?"s":"")).appendTo(h)}else{h.remove()}}})};this.show()};UI.MessageNew=function(q){this.tmp=Unfuddle.UI.Renderer;this.tmp(q);delete this.tmp;this.domID="#message_new_wrapper";this.containerID=q.containerID||"#new_message_container";this.verifyPermissions=function(){if(Globals.currentProject){return Globals.currentPerson.seeIf(Globals.currentProject,"canCreateMessages")}else{return Globals.currentPerson.seeIfAtAll("canCreateMessages")}};this.addJsTemplate("message");var self=this;if(Globals.currentProject){this.dependsOn("Category","/projects/"+Globals.currentProject.id+"/categories",{essential:true})}else{this.dependsOn("Category","/categories",{essential:true})}this.renderMainLocked=false;this.renderMain=function(){if(this.renderMainLocked){return}this.renderMainLocked=true;$(this.domID).remove();var i=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);var o={projects:Globals.currentProject?[Globals.currentProject]:Globals.currentPerson.activeProjects(),categories:Globals.currentProject?Category.find({conditions:{project_id:Globals.currentProject.id}}):[],projectsMCreate:[],projectHasFeatureAttachments:Globals.currentProject?Globals.currentProject.hasFeature("attachments"):null,accountHasFeatureAttachments:Globals.currentAccount.hasFeature("attachments"),isAdministrator:Globals.currentPerson.seeIf(Globals.currentAccount,"isAdministrator")};$.each(o.projects,function(f,b){o["categories_project_"+b.id]=Category.find({conditions:{project_id:b.id}});if(Globals.currentPerson.seeIf(b,"canCreateMessages")){o.projectsMCreate.push(b)}});i.append(Unfuddle.Template.Message.form({locals:o,domId:"new_message"}));Unfuddle.UI.Helpers.markupContainer(i.find(".message_form_markup_container"),{attachments:false,domID:"new_message_body"});i.find("a.form_cancel_button").click(function(){self.close();return false});var p=i.find("input.form_submit_button");p.click(function(){if(!Helpers.message_validate("#new_message",false)){return false}if(!Globals.currentProject){self.options.project_id=$("#new_message_proj").val()}Helpers.fdisable(["#new_message_submit"]);Unfuddle.UI.Helpers.toggleAjaxBttn(p,true);var h=[];$.each($("#new_message_project_categories input[type=checkbox]"),function(f,b){if(b.checked){h.push(b.value)}});var g=new Unfuddle.Data.Message.Base;g.title=i.find("#new_message_title")[0].value;g.body=i.find("#new_message_body")[0].value;g.categories=h;g.project_id=self.options.project_id;g.body_format=i.find("#new_message_body_markup")[0]?i.find("#new_message_body_markup")[0].value:Unfuddle.Utilities.getDefaultMarkup();var c={submit_bttn:p};var j=$("#new_message_file_input_list .file_input");var m=[];var l=[];var k=[];j.each(function(b,d){if(d.value!=""){var a=new Attachment.Base({fileElementId:d.id,filename:d.value.split("\\").pop().split("/").pop(),parent_type:"Message",project_id:self.options.project_id});l.push({resource:a,action:function(f){a.upload(f)},onSuccess:function(){k.push({resource:a,action:function(f){a.parent_id=g.id;a.message_id=g.id;a.save(f)},onError:function(){g.destroy();Unfuddle.UI.Helpers.actionCallback(a,c)}})},onError:function(){Unfuddle.UI.Helpers.actionCallback(a,c)}})}});var e={onSuccess:function(){Unfuddle.UI.Helpers.actionCallback(g,c);g.active_at=g.created_at}};var n={onSuccess:function(){g.save(function(){if(g.action_results&&g.action_results.success){Unfuddle.Utilities.eventChain(k,e)}else{Unfuddle.UI.Helpers.actionCallback(g,c)}})}};Unfuddle.Utilities.eventChain(l,n);return false});$("#new_message_title").focus()};this.show()};UI.MessageEdit=function(k){this.tmp=Unfuddle.UI.Renderer;this.tmp(k);delete this.tmp;this.domID="#message_edit_wrapper";this.containerID=k.containerID||"#edit_message_container";this.addJsTemplate("message");var self=this;this.dependsOn("Message","/projects/"+k.project_id+"/messages/"+k.message_id,{essential:true});this.dependsOn("Category","/projects/"+k.project_id+"/categories",{essential:true});this.renderMainLocked=false;this.renderMain=function(){if(this.renderMainLocked){return}this.renderMainLocked=true;$(this.domID).remove();var c=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);var j=Message.find(k.message_id)[0];var m={projects:[Globals.currentProject],categories:Globals.currentProject?Category.find({conditions:{project_id:Globals.currentProject.id}}):[],message:j};$.each(m.projects,function(f,b){m["categories_project_"+b.id]=Category.find({conditions:{project_id:b.id}})});c.append(Unfuddle.Template.Message.form({locals:m,domId:"edit_message"}));Unfuddle.UI.Helpers.markupContainer(c.find(".message_form_markup_container"),{attachments:false,domID:"edit_message_body",markup:j.body_format});c.find(".form_title").html("Edit Message");c.find("#edit_message_show_attachments").remove();$.each(j.categories,function(f,b){$("#edit_message_category_"+b).attr("checked",true)});c.find("a.form_cancel_button").click(function(){self.close();$("#show_message_render").show();return false});var l=c.find("input.form_submit_button").val("Update Message");l.click(function(){if(!Helpers.message_validate("#edit_message",false)){return false}Helpers.fdisable(["#edit_message_submit"]);Helpers.toggleAjaxBttn(l,true);var d=[];$.each($("#edit_message_project_categories input[type=checkbox]"),function(f,b){if(b.checked){d.push(b.value)}});var h=new Message.Base(j);h.title=c.find("#edit_message_title")[0].value;h.body=c.find("#edit_message_body")[0].value;h.categories=d;h.project_id=self.options.project_id;h.body_format=c.find("#edit_message_body_markup")[0]?c.find("#edit_message_body_markup")[0].value:Unfuddle.Utilities.getDefaultMarkup();var g={submit_bttn:l};h.save(function(){if(h.action_results&&h.action_results.success){Unfuddle.UI.Helpers.actionCallback(h,g);h.active_at=h.created_at}else{Unfuddle.UI.Helpers.actionCallback(h,g)}});return false});$("#edit_message_title").focus()};this.show()};

UI.ProjectSettings=function(j){if(!j.project_id){flashNotice("error","Wrong url.")}this.tmp=Unfuddle.UI.Renderer;this.tmp(j);delete this.tmp;this.verifyPermissions=function(){return Globals.currentPerson.seeIf(Project.current(),"isAdministrator")};this.domID="#project_settings";this.containerID="#content";var self=this;this.addJsTemplate("project");this.dependsOn("TicketReport","/projects/"+j.project_id+"/ticket_reports",{essential:true});this.dependsOn("Project","/projects/"+j.project_id+"/initializer",{callback:function(d){self.renderPartials()},findParams:{apiParams:{only:"custom_field_values,components,versions,severities,categories"}}});this.renderMain=function(){this.renderMainLocked=true;var d=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);this.holder=d;self.project=Project.find(j.project_id)[0];if(!self.project){flashNotice("error","There is no project with id "+j.project_id);return}var b={};b.usedAccount=Account.current().disk_usage;b.usedProject=self.project.disk_usage;b.total=Account.current().hasFeature("storage")*1024;b.percentageAccount=(b.usedAccount/(b.total)*100).toFixed(2);b.percentageProject=(b.usedProject/(b.total)*100).toFixed(2);if(b.percentageProject>b.percentageAccount){b.percentageAccount=b.percentageProject}b.widthProject=b.percentageProject>100?100:b.percentageProject;b.widthAccount=b.percentageProject>100?0:(b.percentageAccount-b.percentageProject);b.used=Utilities.formatBytes(b.usedProject*1024);b.available=Utilities.formatBytes(Number(Account.current().hasFeature("storage"))*1024*1024);self.project.s3_bucket_name=self.project.s3_bucket_name||Account.current().subdomain+"-"+self.project.short_name+"-unfuddle-backups";self.project.s3_access_key_id=self.project.s3_access_key_id||"";var e={diskUsageInfo:b,project:self.project,themesAvailable:Unfuddle.Data.Project.themesAvailable(),accountHasFeatureTimeTracking:Account.current().hasFeature("time_tracking"),ticketReports:TicketReport.find({sourceUrl:"/projects/"+j.project_id+"/ticket_reports"})};this.holder.append(Unfuddle.Template.Project.settings({locals:e}));Unfuddle.UI.Helpers.markupContainer(d.find(".markup_main_container"),{collapsed:true,attachments:false});Utilities.linkToHelp(d.find("#close_ticket_simultaneously_default_help"),"button","ticket_workflow",{klass:"myclass"});this.setBindings();this.ctf1Locked=false;this.ctf2Locked=false;this.ctf3Locked=false;this.renderPartials()};this.renderPartials=function(){var e=[["category","categories"],["severity","severities"],["version","versions"],["component","components"]];$.each(e,function(d,b){self[b[1]+"Locked"]=false;self.renderFields(b[0],b[1])});this.renderCustomTicketField1();this.renderCustomTicketField2();this.renderCustomTicketField3()};this.setBindings=function(){$("#project_settings_form").submit(function(){if($("#project_title").val()==""){alert("Title cannot be blank");return false}var a=$("#project_settings_submit");Helpers.toggleAjaxBttn(a,true);var d={};d.title=$("#project_title").val();d.theme=$("#project_settings_theme_selector").val();d.description=$("#project_description").val();d.assignee_on_resolve=$("#project_settings_assignee_on_resolve").val();d.default_ticket_report_id=$("#project_ticket_report_selector").val();d.close_ticket_simultaneously_default=$("#project_close_ticket_simultaneously_default")[0].checked;if(Globals.currentAccount.hasFeature("time_tracking")){d.enable_time_tracking=$("#project_enable_time_tracking")[0].checked}self.project.save(d,function(){if(self.project.action_results.success){self.refresh();self.notifyUser("success","Project settings were successfully saved.")}else{Helpers.toggleAjaxBttn(a,false);self.notifyUser("error",self.project.action_results.errors)}});return false});if(Bookmarker.previousBookmark.url!=window.location.href){$("#project_cancel").attr("href",Bookmarker.previousBookmark.url)}else{$("#project_cancel").attr("href",Bookmarker.currentBookmark.url);$("#project_cancel").click(function(){self.refresh();return false})}$("#request_backup_now_link").click(function(){var d=confirm("Requesting a backup of this project can often take a few minutes.  You will receive an email notification when your backup has been prepared.\n\nAre you sure you want to request a backup of the project?");if(d){var b=new Backup.Base({project_id:j.project_id});b.save(function(){if(b.action_results.success){alert("You have successfully requested a backup be created.  You will receive an email with a download link when the backup has been completed.\n\n\nNOTE: It may take up to 30 minutes to complete the creation of the backup.")}else{alert("There has been an error while processing your request. Please try again.")}})}return false});$("#project_manage_backup_form").submit(function(){var a=$("#manage_backup_submit");Helpers.toggleAjaxBttn(a,true);var d={};d.backup_frequency=$("#project_backup_frequency").val();var b=$("#project_s3_backup_enabled")[0].checked;d.s3_backup_enabled=b;if(b){d.s3_access_key_id=$("#project_s3_access_key_id").val();d.s3_bucket_name=$("#project_s3_bucket_name").val();if($("#project_s3_secret_access_key").val()!=""){d.s3_secret_access_key=$("#project_s3_secret_access_key").val()}}self.project.save(d,function(){if(self.project.action_results.success){self.refresh()}else{Helpers.toggleAjaxBttn(a,false);self.notifyUser("error",self.project.action_results.errors)}});return false})};this.renderFields=function(c,g){if(this[g+"Locked"]){return}var h=$("#projects_"+g);if(h.length==0){return}var f=Unfuddle.Data[c.capitalize()].find({conditions:{project_id:j.project_id}});if(f.pending){return}else{var k={project:Globals.currentProject,widgetType:c,domID:"projects_"+c+"_list"};k[g]=f;h.html(Unfuddle.Template.Project.widget({locals:k}));$("#new_projects_"+c+"_action").click(function(){Utilities.showHideToggle($("#new_projects_"+c+"_action"),$("#new_projects_"+c),{elFocus:$("#projects_"+c+"_new_name")});self[g+"Locked"]=true;return false});$("#new_projects_"+c+"_form").submit(function(){var a=$("#projects_"+c+"_list_add_submit");Helpers.toggleAjaxBttn(a,true);var d=$("#projects_"+c+"_new_name").val();var b=new Unfuddle.Data[c.capitalize()].Base({project_id:j.project_id,name:d});b.save(function(){if(b.action_results.success){self[g+"Locked"]=false;self.renderFields(c,g)}else{self.notifyUser("error",b.action_results.errors);Helpers.toggleAjaxBttn(a,false)}});return false});$("#projects_"+c+"_cancel_add").click(function(){Utilities.showHideToggle($("#new_projects_"+c),$("#new_projects_"+c+"_action"),{elReset:$("#new_projects_"+c+"_form")});self[g+"Locked"]=false;return false});$.each(k[g],function(b,e){$("#"+c+"_"+e.id+"_delete").click(function(){var d=confirm("Are you sure you want to remove the "+c+' "'+e.name+'" from the project?');if(d==true){e.destroy(function(){if(e.action_results.success){self[g+"Locked"]=false;self.renderFields(c,g)}else{self.notifyUser("error",e.action_results.errors)}})}return false});$("#"+c+"_"+e.id+"_edit_link").click(function(){Utilities.showHideToggle($("#projects_"+c+"_"+e.id+"_render"),$("#projects_"+c+"_"+e.id+"_edit"),{elFocus:$("#projects_"+c+"_"+e.id+"_edit_name")});self[g+"Locked"]=true;return false});$("#projects_"+c+"_"+e.id+"_cancel_edit").click(function(){Utilities.showHideToggle($("#projects_"+c+"_"+e.id+"_edit"),$("#projects_"+c+"_"+e.id+"_render"),{elReset:$("#projects_"+c+"_"+e.id+"_edit_form")});self[g+"Locked"]=false;return false});$("#projects_"+c+"_"+e.id+"_edit_form").submit(function(){var a=$("#projects_"+c+"_"+e.id+"_save_submit");var d=$("#projects_"+c+"_"+e.id+"_edit_name").val();if(d==""){alert("The "+c+"'s name cannot be blank!");return false}Helpers.toggleAjaxBttn(a,true);e.save({name:d},function(){if(e.action_results.success){self[g+"Locked"]=false;self.renderFields(c,g)}else{self.notifyUser("error",e.action_results.errors);Helpers.toggleAjaxBttn(a,false)}});return false})})}};this.renderCustomTicketField1=function(){if(this.ctf1Locked){return}var g=$("#project_ticket_field1");if(g.length==0){return}var h=CustomFieldValue.find({conditions:{project_id:j.project_id,field_number:1}});if(h.pending){return}else{var f={project:Project.find(self.options.project_id)[0],widgetType:"custom",customFieldValues:h,domID:"project_ticket_field1",fieldTitle:Project.find(self.options.project_id)[0].ticket_field1_title,fieldDisposition:Project.find(self.options.project_id)[0].ticket_field1_disposition,fieldActive:Project.find(self.options.project_id)[0].ticket_field1_active,fieldNumber:1};g.html(Unfuddle.Template.Project.widget({locals:f}));$("#"+f.domID+"_active_form_update").click(function(){var a=this;var d=$("#ticket_field1_title").val();if(d==""){alert("The custom field's title cannot be blank!");return false}Helpers.toggleAjaxBttn(a,true);var b={};b.ticket_field1_title=d;b.ticket_field1_disposition=$("#ticket_field1_disposition").val();b.ticket_field1_active=$("#ticket_field1_active")[0].checked;self.project.save(b,function(){if(self.project.action_results.success){self.ctf1Locked=false;self.renderCustomTicketField1()}else{self.ctf1Locked=true;Helpers.toggleAjaxBttn(a,false);self.notifyUser("error",self.project.action_results.errors)}});return false});$("#"+f.domID+"_active_form_cancel").click(function(){Utilities.showHideToggle($("#"+f.domID+"_edit"),$("#"+f.domID+"_render"));$("#"+f.domID+"_form")[0].reset();return false});if(f.fieldDisposition=="list"){$("#"+f.domID+"_add_submit").click(function(){var a=this;Helpers.toggleAjaxBttn(a,true);var d=$("#projects_custom_field_value_new_value1").val();field1=new CustomFieldValue.Base({project_id:j.project_id,field_number:f.fieldNumber,value:d});field1.save(function(){if(field1.action_results.success){self.ctf1Locked=false;self.renderCustomTicketField1()}else{Helpers.toggleAjaxBttn(a,false);self.notifyUser("error",field1.action_results.errors)}});return false});$("#"+f.domID+"_cancel_add").click(function(){Utilities.showHideToggle($("#new_projects_custom_field_value"+f.fieldNumber),$("#new_projects_custom_field_value_action"+f.fieldNumber),{elReset:$("#new_projects_custom_field_value_form"+f.fieldNumber)});return false});$.each(h,function(b,e){var c="#projects_custom_field_value_"+e.id;$("#custom_field_value_"+e.id+"_delete").click(function(){var d=confirm('Are you sure you want to remove this value  "'+e.value+'"?');if(d==true){e.destroy(function(){if(e.action_results.success){self.ctf1Locked=false;self.renderCustomTicketField1()}else{self.notifyUser("error",e.action_results.errors)}})}return false});$(c+"_edit_link").click(function(){Utilities.showHideToggle($(c+"_render"),$(c+"_edit"),{elFocus:$(c+"_edit_value")});return false});$(c+"_save_submit").click(function(){var a=this;value=$(c+"_edit_value").val();if(value==""){alert("The value for this custom field cannot be blank!");return false}Helpers.toggleAjaxBttn(a,true);e.save({value:value},function(){if(e.action_results.success){self.ctf1Locked=false;self.renderCustomTicketField1()}else{self.notifyUser("error",e.action_results.errors);Helpers.toggleAjaxBttn(a,false)}});return false});$(c+"_cancel_edit").click(function(){Utilities.showHideToggle($(c+"_edit"),$(c+"_render"),{elReset:$(c+"_edit_form")});return false})})}}};this.renderCustomTicketField2=function(){if(this.ctf2Locked){return}var g=$("#project_ticket_field2");if(g.length==0){return}var h=CustomFieldValue.find({conditions:{field_number:2,project_id:j.project_id}});if(h.pending){return}else{var f={project:Project.find(self.options.project_id)[0],widgetType:"custom",customFieldValues:h,domID:"project_ticket_field2",fieldTitle:Project.find(self.options.project_id)[0].ticket_field2_title,fieldDisposition:Project.find(self.options.project_id)[0].ticket_field2_disposition,fieldActive:Project.find(self.options.project_id)[0].ticket_field2_active,fieldNumber:2};g.html(Unfuddle.Template.Project.widget({locals:f}));$("#"+f.domID+"_active_form_update").click(function(){var a=this;var d=$("#ticket_field2_title").val();if(d==""){alert("The custom field's title cannot be blank!");return false}Helpers.toggleAjaxBttn(a,true);var b={};b.ticket_field2_title=d;b.ticket_field2_disposition=$("#ticket_field2_disposition").val();b.ticket_field2_active=$("#ticket_field2_active")[0].checked;self.project.save(b,function(){if(self.project.action_results.success){self.ctf2Locked=false;self.renderCustomTicketField2()}else{self.ctf2Locked=true;Helpers.toggleAjaxBttn(a,false);self.notifyUser("error",self.project.action_results.errors)}});return false});$("#"+f.domID+"_active_form_cancel").click(function(){Utilities.showHideToggle($("#"+f.domID+"_edit"),$("#"+f.domID+"_render"));$("#"+f.domID+"_form")[0].reset();return false});if(f.fieldDisposition=="list"){$("#"+f.domID+"_add_submit").click(function(){var a=this;Helpers.toggleAjaxBttn(a,true);var d=$("#projects_custom_field_value_new_value2").val();field2=new CustomFieldValue.Base({project_id:j.project_id,field_number:f.fieldNumber,value:d});field2.save(function(){if(field2.action_results.success){self.ctf2Locked=false;self.renderCustomTicketField2()}else{self.ctf2Locked=true;self.notifyUser("error",field2.action_results.errors);Helpers.toggleAjaxBttn(a,false)}});return false});$("#"+f.domID+"_cancel_add").click(function(){Utilities.showHideToggle($("#new_projects_custom_field_value"+f.fieldNumber),$("#new_projects_custom_field_value_action"+f.fieldNumber),{elReset:$("#new_projects_custom_field_value_form"+f.fieldNumber)});return false});$.each(h,function(b,e){var c="#projects_custom_field_value_"+e.id;$("#custom_field_value_"+e.id+"_delete").click(function(){var d=confirm('Are you sure you want to remove this value  "'+e.value+'"?');if(d==true){e.destroy(function(){if(e.action_results.success){self.ctf2Locked=false;self.renderCustomTicketField2()}else{self.notifyUser("error",e.action_results.errors)}})}return false});$(c+"_edit_link").click(function(){Utilities.showHideToggle($(c+"_render"),$(c+"_edit"),{elFocus:$(c+"_edit_value")});return false});$(c+"_save_submit").click(function(){var a=this;value=$(c+"_edit_value").val();if(value==""){alert("The value for this custom field cannot be blank!");return false}Helpers.toggleAjaxBttn(a,true);e.save({value:value},function(){if(e.action_results.success){self.ctf2Locked=false;self.renderCustomTicketField2()}else{self.notifyUser("error",e.action_results.errors);Helpers.toggleAjaxBttn(a,false)}});return false});$(c+"_cancel_edit").click(function(){Utilities.showHideToggle($(c+"_edit"),$(c+"_render"),{elReset:$(c+"_edit_form")});return false})})}}};this.renderCustomTicketField3=function(){if(this.ctf3Locked){return}var g=$("#project_ticket_field3");if(g.length==0){return}var h=CustomFieldValue.find({conditions:{field_number:3,project_id:j.project_id}});if(h.pending){return}else{var f={project:Project.find(self.options.project_id)[0],widgetType:"custom",customFieldValues:h,domID:"project_ticket_field3",fieldTitle:Project.find(self.options.project_id)[0].ticket_field3_title,fieldDisposition:Project.find(self.options.project_id)[0].ticket_field3_disposition,fieldActive:Project.find(self.options.project_id)[0].ticket_field3_active,fieldNumber:3};g.html(Unfuddle.Template.Project.widget({locals:f}));$("#"+f.domID+"_active_form_update").click(function(){var a=this;var d=$("#ticket_field3_title").val();if(d==""){alert("The custom field's title cannot be blank!");return false}Helpers.toggleAjaxBttn(a,true);var b={};b.ticket_field3_title=d;b.ticket_field3_disposition=$("#ticket_field3_disposition").val();b.ticket_field3_active=$("#ticket_field3_active")[0].checked;self.project.save(b,function(){if(self.project.action_results.success){self.ctf3Locked=false;self.renderCustomTicketField3()}else{self.ctf3Locked=true;Helpers.toggleAjaxBttn(a,false);self.notifyUser("error",self.project.action_results.errors)}});return false});$("#"+f.domID+"_active_form_cancel").click(function(){Utilities.showHideToggle($("#"+f.domID+"_edit"),$("#"+f.domID+"_render"));$("#"+f.domID+"_form")[0].reset();return false});if(f.fieldDisposition=="list"){$("#"+f.domID+"_add_submit").click(function(){var a=this;Helpers.toggleAjaxBttn(a,true);var d=$("#projects_custom_field_value_new_value3").val();field3=new CustomFieldValue.Base({project_id:j.project_id,field_number:f.fieldNumber,value:d});field3.save(function(){if(field3.action_results.success){self.ctf3Locked=false;self.renderCustomTicketField3()}else{self.ctf3Locked=true;self.notifyUser("error",field3.action_results.errors);Helpers.toggleAjaxBttn(a,false)}});return false});$("#"+f.domID+"_cancel_add").click(function(){Utilities.showHideToggle($("#new_projects_custom_field_value"+f.fieldNumber),$("#new_projects_custom_field_value_action"+f.fieldNumber),{elReset:$("#new_projects_custom_field_value_form"+f.fieldNumber)});return false});$.each(h,function(b,e){var c="#projects_custom_field_value_"+e.id;$("#custom_field_value_"+e.id+"_delete").click(function(){var d=confirm('Are you sure you want to remove this value  "'+e.value+'"?');if(d==true){e.destroy(function(){if(e.action_results.success){self.ctf3Locked=false;self.renderCustomTicketField3()}else{self.notifyUser("error",e.action_results.errors)}})}return false});$(c+"_edit_link").click(function(){Utilities.showHideToggle($(c+"_render"),$(c+"_edit"),{elFocus:$(c+"_edit_value")});return false});$(c+"_save_submit").click(function(){var a=this;value=$(c+"_edit_value").val();if(value==""){alert("The value for this custom field cannot be blank!");return false}Helpers.toggleAjaxBttn(a,true);e.save({value:value},function(){if(e.action_results.success){self.ctf3Locked=false;self.renderCustomTicketField3()}else{self.notifyUser("error",e.action_results.errors);Helpers.toggleAjaxBttn(a,false)}});return false});$(c+"_cancel_edit").click(function(){Utilities.showHideToggle($(c+"_edit"),$(c+"_render"),{elReset:$(c+"_edit_form")});return false})})}}};this.show()};UI.ProjectJump=function(g){this.tmp=Unfuddle.UI.Renderer;this.tmp(g);delete this.tmp;this.domID="#project_jump_select";this.containerID="#project_jump";this.renderMain=function(){var e=$("<select/>").attr("id",this.domID.slice(1)).attr("name",this.domID.slice(1)).css({"min-width":"180px"}).change(function(){if($("#project_jump_select").val()==""||$("#project_jump_select").val()=="jump"){$("#project_jump_select").val("jump")}else{Unfuddle.UI.Bookmarker.redirectTo($("#project_jump_select").val())}}).append('<option value="jump">Jump to...</option><option value=""/>');var c=Globals.currentPerson.activeProjects();if(c.pending){e.html(ajaxProgressSmall())}else{var self=this;if(c.length>0){$.each(c,function(d,b){$("<option/>").attr("value",Unfuddle.UI.bookmarkForResource(b)).html(b.title).appendTo(e)});e.append('<option value=""/>')}$('<option value="'+Unfuddle.UI.Bookmarker.bookmarkFor("account")+'">Account Dashboard</option>').appendTo(e);if(Globals.currentPerson.is_administrator){$('<option value="'+Unfuddle.UI.Bookmarker.bookmarkFor("account_settings")+'">Account Settings</option>').appendTo(e)}e.appendTo(this.containerID)}};this.show()};UI.ProjectNew=function(e){this.tmp=Unfuddle.UI.Renderer;this.tmp(e);delete this.tmp;this.containerID=e.containerID||"#content";this.domID="#project_new";var self=this;this.addJsTemplate("project");this.renderMainLocked=false;this.renderMain=function(){if(this.renderMainLocked){return}this.renderMainLocked=true;$(this.domID).remove();var d=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);this.holder=d;var b={isAdministrator:Globals.currentPerson.is_administrator,maxProjects:Globals.currentAccount.whatIs("max_projects"),archivedProjects:Globals.currentPerson.archivedProjects(),activeProjects:Globals.currentPerson.activeProjects(),maxArchivedProjects:Globals.currentAccount.whatIs("max_archived_projects"),repoTypes:[["","None"],["svn","Subversion"],["git","Git"]],themesAvailable:Unfuddle.Data.Project.themesAvailable()};this.holder.append(Unfuddle.Template.Project.projectNew({locals:b,domId:"new_project",cssStyle:""}));this.setBindingsNewProject()};this.setBindingsNewProject=function(){if($("#new_project_title")){$("#new_project_title").focus()}$("#new_project_notification_cancel").click(function(){$("#new_project").hide();return false});$("#new_project_cancel").click(function(){$("#new_project").hide();$("#new_project_form")[0].reset();return false});$("#new_project_form").submit(function(){if($("#new_project_title").val()==""){alert("Title cannot be blank");return false}var a=$("#new_project_submit");Helpers.toggleAjaxBttn(a,true);var d=Helpers.getFormValues({model:"Project",prefix:"new_project_"});var b=new Project.Base(d);b.save(function(){if(b.action_results.success){Bookmarker.redirectTo(Bookmarker.bookmarkFor("project_show",{project_id:b.id}))}else{Helpers.toggleAjaxBttn(a,false);self.notifyUser("error",b.action_results.errors)}});return false})};this.show()};UI.ProjectIndex=function(l){this.tmp=Unfuddle.UI.Renderer;this.tmp(l);delete this.tmp;this.containerID="#content";this.domID="#project_index";var self=this;this.addJsTemplate("project");this.addJsTemplate("ticket");this.renderMainLocked=false;this.renderMain=function(){if(this.renderMainLocked){return}this.renderMainLocked=true;$(this.domID).remove();var b=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);this.holder=b;$.extend(this.locals,{isAdministrator:Globals.currentPerson.is_administrator,maxProjects:Account.current().whatIs("max_projects"),archivedProjects:Globals.currentPerson.archivedProjects(),activeProjects:Globals.currentPerson.activeProjects(),maxArchivedProjects:Account.current().whatIs("max_archived_projects"),repoTypes:[["","None"],["svn","Subversion"],["git","Git"]],themesAvailable:Unfuddle.Data.Project.themesAvailable()});var e=!Globals.currentPerson.archivedProjects().length?3:2;var c=this.locals.activeProjects.length;this.locals.activeProjects.forEach(function(d){if(Globals.currentPerson.seeIf(d,"canReadTickets")){d._isAdministrator=Globals.currentPerson.seeIf(d,"isAdministrator");d._canReadTickets=Globals.currentPerson.seeIf(d,"canReadTickets")}});var g=0,h=0,f=0,k=0;h=Math.ceil(c/e);f=h+Math.min(h,c-h);if(e==3){k=f+Math.min(h,c-f)}$.extend(self.locals,{c1:h,c2:f,c3:k,columns:e});this.holder.append(Unfuddle.Template.Project.projectIndex({locals:self.locals}));var j=self.locals.activeProjects.concat(self.locals.archivedProjects);this.setBindings(j);if($.browser.msie&&$.browser.version>="7.0"&&$.browser.version<"8.0"){setTimeout("document.body.className = document.body.className",500);setTimeout("document.body.className = document.body.className",1000);setTimeout("document.body.className = document.body.className",1500)}};this.setBindings=function(m){if(Globals.currentPerson.is_administrator){$("#new_project_link").click(function(){new UI.ProjectNew({containerID:"#new_project_project_index_page"});return false})}update=function(d){var b={};b.archived=!d.archived;d.archived=!d.archived;d.save(b,function(){if(d.action_results.success){self.refresh()}else{self.notifyUser("error",d.action_results.errors)}})};$.each(m,function(j,i){$("#project_"+i.id+(i.archived?"_reactivate":"_archive")).click(function(){if(i.archived){update(i)}else{var d=confirm("Are you sure you want to archive this project? Archived projects become read-only until reactivated.");if(d){update(i)}}return false});$("#project_"+i.id+"_delete").click(function(){var d=confirm("Are you sure you want to permanently delete this project?");if(d){i.destroy(function(){if(i.action_results.success){self.refresh()}else{self.notifyUser("error",i.action_results.errors)}})}return false});if(!i.archived){$("#project_"+i.id+"_progress").click(function(){var a=this;var f=$("#overall_progress_"+i.id);var k=function(e){var c=Milestone.find({conditions:{project_id:i.id}});var g=OverallProgress.find({conditions:{project_id:i.id}});if(!c.pending&&!g.pending){g=g[0];if(f.html()==""){var h={};if(Globals.currentPerson.seeIf(i,"canReadTickets")){h={};h.ticketsTotal=g.entire_project.tickets_active+g.entire_project.tickets_closed;h.projectProgress=g.entire_project;h.canSeeHours=i.actuallyUses("time_tracking")&&Globals.currentPerson.seeIf(i,"canReadPeople")&&h.projectProgress.hours_estimate_current!=0;h.relevantProjects=[i];h.milestoneOptions='<option value="entire_project">Entire Project</option>';$.each(i.activeMilestones(),function(d,b){h.milestoneOptions+='<option value="'+b.id+'">'+b.title+"</option>"})}if(h.ticketsTotal){f.append(Unfuddle.Template.Ticket.sidebarStatus({locals:h,domId:"ticket_status_"+i.id,hideHeading:true,showProjectSelect:false,progressBarHeight:"6px",noScript:(j>0)}))}else{f.append("There are no tickets in this project.")}}f.show()}};if(Globals.currentPerson.seeIf(i,"canReadMilestones")){self.dependsOn("Milestone","/projects/"+i.id+"/milestones",{callback:k})}self.dependsOn("OverallProgress","/projects/"+i.id+"/overall_progress",{callback:k});if(f.is(":hidden")){k()}else{f.hide()}return false})}})};this.show()};

UI.AccountSettings=function(n){this.tmp=Unfuddle.UI.Renderer;this.tmp(n);delete this.tmp;this.verifyPermissions=function(){return Person.current().is_administrator};this.domID="#account_settings";this.containerID="#content";var self=this;this.addJsTemplate("account");this.dependsOn("TicketReport","/ticket_reports",{essential:true});this.dependsOn("Invoice","/invoices",{essential:true});this.renderMain=function(){this.renderMainLocked=true;this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);var d=Account.current();var f=Account.VALID_PLANS;var g=[];if(d){d._percentage=((Account.current().disk_usage/(Account.current().features.storage*1024))*100).toFixed(2);d._storageDisplay=Utilities.formatBytes(d.whatIs("storage")*1024*1024);d._diskUsageDisplay=Utilities.formatBytes(d.disk_usage*1024);$.each(Unfuddle.Data.Account.FEATURES,function(h,c){if(f[d.plan].plan==d.plan){if((d.features[c]!=undefined)&&(f[d.plan][c]!=d.features[c])){f[d.plan].promotional=true;f[d.plan][c]=d.features[c];f[d.plan].days_left=31-(new Date(Date.now()-d.trial_enabled_on)).getDate()}}});$.each(f,function(h,c){c._plan=c.plan.capitalize();c._storage=Utilities.formatBytes(c.storage*1024*1024,{decimal_format:"0"});g.push(c)});var j={account:d,plans:g,featuresRendered:Account.FEATURES_RENDERED,validMarkup:Account.VALID_MARKUP,markupDefaultAccount:d.text_markup.split(",")[0],availableMarkups:d.text_markup.split(","),ticketReports:TicketReport.find({conditions:{parent_type:"Account",parent_id:d.id}}),hasSSL:d.hasFeature("ssl"),invoices:d.invoices()};if(d.flagged_for_billing_error){var k=new Date();k.setDate(k.getDate()-14);var l=!blank(d.billing_error_date)&&(Utilities.parseDate(d.billing_error_date)<k);var m=(d.features.price_per_month>0)&&l;j.delinquent=m}}$.each(j.invoices,function(h,c){c._chargedOn=Utilities.formatDate(Utilities.parseDate(c.charged_on),{format:"default"});c._billingPeriod=Utilities.formatDate(Utilities.parseDate(c.billing_period),{format:"justMY",hover:false});c._amount=c.amount.toFixed(2)});this.holder.append(Unfuddle.Template.Account.accountSettings({locals:j}));this.setBindings()};this.setBindings=function(){$("#account_settings_form").submit(function(){var a=$("#account_settings_submit");if($("#account_title").val()==""){alert("Title cannot be blank");return false}Helpers.toggleAjaxBttn(a,true);var d={};var f=Account.current();if($("#account_title").val()!=f.title){d.title=$("#account_title").val()}if($("#account_plan").val()!=f.plan){d.plan=$("#account_plan").val()}if($("#account_description").val()!=f.description){d.description=$("#account_description").val()}if($("#account_settings_default_ticket_report").val()!=f.default_ticket_report_id){d.default_ticket_report_id=$("#account_settings_default_ticket_report").val()}if(f.hasFeature("ssl")){d.force_ssl=$("#account_force_ssl")[0].checked}var g=$("#account_text_markup_default").val();d.text_markup=g;$.each(Account.VALID_MARKUP,function(h,c){if($("#text_markup_list_"+c.name)[0].checked&&$("#text_markup_list_"+c.name).val()!=g){d.text_markup+=","+$("#text_markup_list_"+c.name).val()}});if($("#account_default_time_zone").val()!=f.default_time_zone){d.default_time_zone=$("#account_default_time_zone").val()}d.billing_cc_number=$("#account_billing_cc_number").val();f.save(d,function(){if(f.action_results.success){if(!Config.development&&location.protocol=="http:"&&Config.ssl){UI.Bookmarker.removeListener();location.href=location.href.replace("http://","https://")}else{self.refresh();self.notifyUser("success","Your account settings have been saved.")}}else{Helpers.toggleAjaxBttn(a,false);self.notifyUser("error",f.action_results.errors)}});return false});if(Bookmarker.previousBookmark.url!=window.location.href){$("#account_settings_cancel_edit").attr("href",Bookmarker.previousBookmark.url)}else{$("#account_settings_cancel_edit").attr("href",Bookmarker.currentBookmark.url);$("#account_settings_cancel_edit").click(function(){self.refresh();return false})}};this.show()};UI.Billing=function(p){this.tmp=Unfuddle.UI.Renderer;this.tmp(p);delete this.tmp;this.verifyPermissions=function(){return Person.current().is_administrator};this.domID="#account_settings_billing";this.containerID="#content";var self=this;Helpers.BILLING_YEARS=[["",""]];var q=(new Date()).getFullYear();for(i=q;i<=q+20;i++){Helpers.BILLING_YEARS.push([i.toString(),i.toString()])}this.addJsTemplate("account");this.dependsOn("Invoice","/invoices",{essential:true});this.renderMain=function(){this.renderMainLocked=true;this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);var d=[];var f=Account.VALID_PLANS;var g=Account.current();$.each(Unfuddle.Data.Account.FEATURES,function(h,c){if(f[g.plan].plan==g.plan){if((g.features[c]!=undefined)&&(f[g.plan][c]!=g.features[c])){f[g.plan].promotional=true;f[g.plan][c]=g.features[c];f[g.plan].days_left=31-(new Date(Date.now()-g.trial_enabled_on)).getDate()}}});$.each(f,function(h,c){c._plan=c.plan.capitalize();c._storage=Utilities.formatBytes(c.storage*1024*1024,{decimal_format:"0"});d.push(c)});if(g.billing_cc_number_short!=null){g._billingCcNumber=Utilities.xLeading(g.billing_cc_number_short,16)}g._billingErrorDate=Utilities.formatDate(g.billing_error_date,{format:"noTime"});var j=new Date();var k=g.billing_error_date&&(j-g.billing_error_date<nDays(14))&&(!g.billing_error_reminded_at||(g.billing_error_reminded_at&&(j-g.billing_error_reminded_at)>=nDays(1)));var l={account:g,plans:d,featuresRendered:Account.FEATURES_RENDERED,billingInformationMissing:p.signup_complete?[]:g.billingInformationMissing(),newOrUpgrade:g.newOrUpgrade(),showRemindMeLater:k};if(g.flagged_for_billing_error){var m=new Date();m.setDate(m.getDate()-14);var n=!blank(g.billing_error_date)&&(Utilities.parseDate(g.billing_error_date)<m);var o=(g.features.price_per_month>0)&&n;l.delinquent=o}this.holder.append(Unfuddle.Template.Account.billing({locals:l}));this.setBindings()};this.setBindings=function(){$("#billing_info_form").submit(function(){var a=$("#billing_submit_button");var h=Account.current();Helpers.toggleAjaxBttn(a,true);var c=Helpers.getFormValues({model:"Account"});c.from="billing";h.save(c,function(){if(h.action_results.success){self.refresh();self.notifyUser("success","Your billing information has been saved.")}else{Helpers.toggleAjaxBttn(a,false);self.notifyUser("error",h.action_results.errors,{message:"prevented this card from being charged"})}delete h.billing_cc_number;delete c.billing_cc_number;delete h.billing_cc_exp_month;delete c.billing_cc_exp_month;delete h.billing_cc_exp_year;delete c.billing_cc_exp_year;delete h.billing_cc_verification_code;delete c.billing_cc_verification_code});return false});$("#billing_remind_later_submit_form").submit(function(){var g=$("#billing_remind_later_submit");Helpers.toggleAjaxBttn(g,true);$.ajax({url:Config.baseApiUrl+"/account/billing_remind_later.json",dataType:"application/json",type:"POST",beforeSend:function(h){if(this.dataType!="script"&&UI.Helpers.checkSessionExpired()){return false}if(location.protocol=="https:"){h.setRequestHeader("X-Unfuddle-Ajax-Secure",1)}h.setRequestHeader("X-Unfuddle-Ajax-Client",1);h.setRequestHeader("X-HTTP-METHOD-OVERRIDE","PUT")},success:function(){Bookmarker.redirectTo(Bookmarker.bookmarkFor("account"))},error:function(h,c,d){var f=[];try{f=JSON.parse(h.responseText)}catch(err){}Helpers.toggleAjaxBttn(g,false);if(f.length<=0){f=["An unexpected error occured. Please try again!"]}Helpers.flashNoticeNow("error",f,{error_title:false})}});return false})};this.show()};UI.ConfirmDelete=function(j){this.tmp=Unfuddle.UI.Renderer;this.tmp(j);delete this.tmp;this.verifyPermissions=function(){return Person.current().is_administrator};this.domID="#account_settings_confirm_delete";this.containerID="#content";this.wholeBody="#body";var self=this;this.addJsTemplate("account");this.checkBeforeRender=function(){var d=true;$.each(Project.find({conditions:{account_id:Account.current().id}}),function(h,c){self.dependsOn("Backup","/projects/"+c.id+"/backups",{essential:true});if(Backup.find({conditions:{project_id:c.id}}).pending){d=false}});return d};this.renderMain=function(){this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);var d=Account.current();var f=Project.find({conditions:{account_id:d.id}});$.each(f,function(h,c){c.latestBackup=c.backupsProcessed()[0];if(c.latestBackup){c.latestBackup._processedAt=Utilities.formatDate(c.latestBackup.processed_at,{format:"withTime"})}});var g={projects:f};this.holder.append(Unfuddle.Template.Account.confirmDelete({locals:g}));this.setBindings(f)};this.setBindings=function(g){$.each(g,function(d,f){$("#create_new_backup_"+f.id).click(function(){var h=confirm("Requesting a backup of this project can often take a few minutes.  You will receive an email notification when your backup has been prepared.\n\nAre you sure you want to request a backup of the project?");if(h){var c=new Backup.Base({project_id:f.id});c.save(function(){if(c.action_results.success){alert("You have successfully requested a backup be created.  You will receive an email with a download link when the backup has been completed.\n\n\nNOTE: It may take up to 30 minutes to complete the creation of the backup.");self.refresh()}else{alert("There has been an error while processing your request. Please try again.")}})}return false})});$("#account_deletion_submit").click(function(){var a=this;Helpers.toggleAjaxBttn(a,true);var h=confirm("Are you ABSOLUTELY sure you want to delete the account?");if(h){var c=Account.current();c.destroy(function(){if(c.action_results.success){UI.Bookmarker.redirectTo("http://unfuddle.com/accounts/deleted")}else{Helpers.toggleAjaxBttn(a,false);self.notifyUser("error",c.action_results.errors)}})}else{Helpers.toggleAjaxBttn(a,false)}return false})};this.show()};UI.Session=function(g){Helpers.showExternalLayout(Unfuddle.Template.General.login(),function(){$("#ajax_username").focus();$("#login_form").submit(function(){var f=$("#submit_credentials");Helpers.toggleAjaxBttn(f,true);$.ajax({beforeSend:function(h){h.setRequestHeader("X-Unfuddle-Ajax-Client",1)},type:"POST",url:Config.baseApiUrl+"/session.json",dataType:"application/json",data:{username:$("#ajax_username").val(),password:$("#ajax_password").val(),remember_me:$("#ajax_remember_me").is(":checked")?1:0},success:function(a,h){$("#form_title img").show();Unfuddle.Data.getBasicDependencies(function(){if(g.reference){UI.Bookmarker.redirectTo(Url.decode(g.reference))}else{UI.Bookmarker.redirectTo("#/")}})},error:function(a,h,c){Helpers.toggleAjaxBttn(f,false);var b=["Wrong credentials. Please try again."];try{var d=[];d=JSON.parse(a.responseText).errors;b=d}catch(e){}$("#apps_signin_form .errors").html(b.join("</br>"));$("#ajax_username").focus()}});return false})})};UI.PasswordReset=function(g){if(g.key&&g.username){Helpers.showExternalLayout(Unfuddle.Template.General.passwordReset(),function(){$("#password").focus();$("#login_form").submit(function(){var f=$("#password_reset_submit");Helpers.toggleAjaxBttn(f,true);$.ajax({beforeSend:function(h){h.setRequestHeader("X-Unfuddle-Ajax-Client",1)},type:"POST",url:Config.baseApiUrl+"/support/change_password.json",dataType:"application/json",data:{key:g.key,username:g.username,password:$("#password").val(),password_confirmation:$("#password_confirmation").val()},success:function(a,h){$(".errors").empty();$(".success").html("Your password has been reset.");setTimeout(function(){Bookmarker.redirectTo(Bookmarker.bookmarkFor("session_new"))},2000)},error:function(a,h,c){Helpers.toggleAjaxBttn(f,false);var b=[];try{var d=[];d=JSON.parse(a.responseText);b=d}catch(e){}if(b.length<=0){b=["Your password could not be reset."]}$(".success").empty();$(".errors").html(b.join("</br>"));$("#password").focus()}});return false})})}else{Helpers.showExternalLayout(Unfuddle.Template.General.passwordReminder(),function(){$("#email").focus();$("#login_form").submit(function(){var f=$("#submit_email");Helpers.toggleAjaxBttn(f,true);$.ajax({beforeSend:function(h){h.setRequestHeader("X-Unfuddle-Ajax-Client",1)},type:"POST",url:Config.baseApiUrl+"/support/password_reminder.json",dataType:"application/json",data:{email:$("#email").val()},success:function(a,h){$(".errors").empty();$(".success").html("Instructions on how to reset your password were sent to your email address.")},error:function(a,h,c){var b=[];try{var d=[];d=JSON.parse(a.responseText);b=d}catch(e){}if(b.length<=0){b=["There are no Unfuddle projects to which this email account has been granted access."]}$(".success").empty();$(".errors").html(b.join("</br>"));$("#email").select()},complete:function(h,c){Helpers.toggleAjaxBttn(f,false)}});return false})})}};UI.Compliance=function(o){this.tmp=Unfuddle.UI.Renderer;this.tmp(o);delete this.tmp;this.verifyPermissions=function(){return Person.current().is_administrator};this.domID="#account_compliance";this.containerID="#content";var self=this;this.addJsTemplate("account");this.checkBeforeRender=function(){var d=true;$.each(Project.find({conditions:{account_id:Account.current().id}}),function(h,c){self.dependsOn("Backup","/projects/"+c.id+"/backups",{essential:true});if(Backup.find({conditions:{project_id:c.id}}).pending){d=false}});return d};this.renderMain=function(){this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);this.locals.maxActiveProjects=Account.current().whatIs("max_projects");this.locals.maxArchivedProjects=Account.current().whatIs("max_archived_projects");this.locals.archivedProjects=Account.current().archivedProjects();this.locals.activeProjects=Account.current().activeProjects();this.locals.maxPeople=Account.current().whatIs("max_people");this.locals.people=Account.current().people();this.locals.projectCompliance=(this.locals.activeProjects.length>this.locals.maxActiveProjects)||(this.locals.archivedProjects.length>this.locals.maxArchivedProjects);this.locals.peopleCompliance=this.locals.people.length>this.locals.maxPeople;var d=this.locals.activeProjects.concat(this.locals.archivedProjects);var f=this.locals.people;$.each(d,function(h,c){c.latestBackup=c.backupsProcessed()[0];if(c.latestBackup){c.latestBackup._processedAt=Utilities.formatDate(c.latestBackup.processed_at,{format:"withTime"})}});this.holder.append(Unfuddle.Template.Account.accountCompliance({locals:this.locals}));this.setBindings(d,f)};this.setBindings=function(m,n){$.each(m,function(d,f){$("#create_new_backup_"+f.id).click(function(){var h=confirm("Requesting a backup of this project can often take a few minutes.  You will receive an email notification when your backup has been prepared.\n\nAre you sure you want to request a backup of the project?");if(h){var c=new Backup.Base({project_id:f.id});c.save(function(){if(c.action_results.success){alert("You have successfully requested a backup be created.  You will receive an email with a download link when the backup has been completed.\n\n\nNOTE: It may take up to 30 minutes to complete the creation of the backup.");self.refresh()}else{alert("There has been an error while processing your request. Please try again.")}})}return false});$((f.archived?"#reactivate_project_":"#archive_project_")+f.id).click(function(){var h={};h.archived=!f.archived;f.archived=!f.archived;f.save(h,function(){if(f.action_results.success){if(Account.current().isCompliant()){Bookmarker.redirectTo(Bookmarker.bookmarkFor("project_index"))}else{Bookmarker.redirectTo()}}});return false})});$("#compliance_projects_form").submit(function(){var f=confirm("Deleting the selected projects is permanent and cannot be undone.\n\nAre you sure you want to proceed?");if(f){var g=$("#compliance_projects_button");Helpers.toggleAjaxBttn(g,true);var j="project_to_remove_";var k={};var l=[];$.each(m,function(h,c){if($("#"+j+c.id).attr("checked")){k[j+c.id]=c.id;l.push(c)}});k.from="compliance";$.ajax({type:"POST",url:Config.baseApiUrl+"/projects/bulk_delete.json",dataType:"application/json",data:k,success:function(){$.each(l,function(h,c){Project.Cache.unCache(c)});var d=["The selected projects have been deleted."];Helpers.flashNotice("success",d,{container:"#content"});if(Account.current().isCompliant()){Bookmarker.redirectTo(Bookmarker.bookmarkFor("account"))}else{self.refresh()}},error:function(a,h,c){Helpers.toggleAjaxBttn(g,false);var b=[];try{var d=[];d=JSON.parse(a.responseText);b=d}catch(e){}if(b.length<=0){b=["An unexpected error occured. Please try again."]}}})}return false});$("#compliance_people_form").submit(function(){var f=confirm("Removing the selected people is permanent and cannot be undone.\n\nAre you sure you want to proceed?");if(f){var g=$("#compliance_people_button");Helpers.toggleAjaxBttn(g,true);var j="person_to_remove_";var k={};var l=[];$.each(n,function(h,c){if($("#"+j+c.id).attr("checked")){k[j+c.id]=c.id;l.push(c)}});$.ajax({type:"POST",url:Config.baseApiUrl+"/people/bulk_delete.json",dataType:"application/json",data:k,success:function(){$.each(l,function(h,c){Person.Cache.unCache(c)});var d=["The selected people have been deleted."];Helpers.flashNotice("success",d,{container:"#content"});if(Account.current().isCompliant()){Bookmarker.redirectTo(Bookmarker.bookmarkFor("account"))}else{self.refresh()}},error:function(a,h,c){Helpers.toggleAjaxBttn(g,false);var b=[];try{var d=[];d=JSON.parse(a.responseText);b=d}catch(e){}if(b.length<=0){b=["An unexpected error occured. Please try again."]}}})}return false})};this.show()};

UI.CommentIndex=function(d){this.tmp=Unfuddle.UI.Renderer;this.tmp(d);delete this.tmp;if(d.parent){this.parent=d.parent}else{if(d.message_id){this.parent=Message.find({conditions:{id:d.message_id,project_id:d.project_id}})[0]}else{if(d.ticket_id){this.parent=Ticket.find({conditions:{id:d.message_id,project_id:d.project_id}})[0]}else{this.parent=null}}}this.containerID=d.containerID||"#comments_container";this.parentType=this.parent.resourceType.toLowerCase();this.domID="#comment_index_"+this.parentType+"_show_"+this.parent.id;var self=this;this.baseUrl="/projects/"+this.options.project_id+"/"+Utilities.getPlural(this.parentType)+"/"+this.parent.id+"/comments";if(!d.comments){this.dependsOn("Comment",this.baseUrl,{essential:true,findParams:{formatted:true},callback:function(e){self.render(e)}})}this.addJsTemplate("comment");this.checkBeforeRender=function(){if(!d.comments){$.each(Comment.find({sourceUrl:this.baseUrl}),function(g,b){self.dependsOn("Attachment",self.baseUrl+"/"+b.id+"/attachments",{callback:function(e){self.renderAttachments(e)}})})}return true};this.notify=function(e){this.render()};this.renderMainLocked=false;this.renderMain=function(){if(this.renderMainLocked){return}this.renderMainLocked=true;holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);if(!d.comments){var u=d.parent.resourceType=="Ticket"?Comment.find({conditions:{parent_type:"ticket",parent_id:d.parent.id},order:["created_at"]}):Comment.find({sourceUrl:this.baseUrl,order:["created_at"]})}var n={project:Globals.currentProject,comments:d.comments?d.comments:u,projectHasFeatureAttachments:Globals.currentProject.hasFeature("attachments"),isProjectAdministrator:Person.current().seeIf(Project.current(),"isAdministrator"),canReadPeople:Person.current().seeIf(Project.current(),"canReadPeople"),currentUrl:window.location.href.split("[")[0]};$.each(n.comments,function(g,b){b.dateFormatted=Utilities.formatDate(b.created_at,{prefix:true});var c=Person.find(b.author_id)[0];if(c){b.authorDisplayName=c.displayName()}b._bodyFormatted=Utilities.formatText(b.body,{format:b.body_format,project:Project.find(d.project_id)[0],comment:b,callback:function(e){$("#"+self.parentType+"_comment_"+b.id+"_render").html(e)}})});holder.append(Unfuddle.Template.Comment.comments({locals:n,parent:self.parent}));$.each(n.comments,function(r,f){if($("#"+self.parentType+"_comment_"+f.id+"_file_input_list")[0]){var l=$("#"+self.parentType+"_comment_"+f.id+"_show_attach_submit_button");l.click(function(){var c=$("#"+self.parentType+"_comment_"+f.id+"_file_input_list .file_input");Helpers.toggleAjaxBttn(l,true);var s=[];var h=[];var i=[];var o={submit_bttn:l};c.each(function(g,b){if(b.value!=""){var a=new Attachment.Base({fileElementId:b.id,filename:b.value.split("\\").pop().split("/").pop(),parent_type:"Comment",project_id:self.parent.project_id});if(self.parentType=="message"){a.message_id=self.parent.id}else{a.ticket_id=self.parent.id}h.push({resource:a,action:function(e){a.upload(e)},onSuccess:function(){i.push({resource:a,action:function(e){a.parent_id=f.id;a.comment_id=f.id;a.save(e)},onSuccess:function(e){if(!d.comments){return}if(!f._attachments){f._attachments=[]}f._attachments.push(Attachment.find(e.id)[0])},onError:function(){Helpers.toggleAjaxBttn(l,false);if(a.action_results.errors.length!=0){alert(a.action_results.errors.join("\n"))}else{alert("Attachment could not be uploaded")}}})},onError:function(){Helpers.toggleAjaxBttn(l,false);if(a.action_results.errors.length!=0){alert(a.action_results.errors.join("\n"))}else{alert("Attachment could not be uploaded")}}})}});var m={onSuccess:function(){Helpers.toggle_ajax_working(false);self.renderMainLocked=false;self.render()}};var p={onSuccess:function(){Unfuddle.Utilities.eventChain(i,m)}};Unfuddle.Utilities.eventChain(h,p);return false})}var j="#"+self.parentType+"_comment_"+f.id;if($(j+"_edit_comment_submit")[0]){var q=$(j+"_edit_comment_submit");q.click(function(){if(!$(j+"_comment_body")[0]||!$(j+"_comment_body_markup")[0]){alert("Comment could not be saved.");return false}Helpers.toggleAjaxBttn(q,true);var g=d.comments?d.comments.filter(function(e){return e.id==f.id})[0]:Comment.find({conditions:{id:f.id,message_id:f.parent_id,project_id:self.parent.project_id}})[0];var b={};b.body=$(j+"_comment_body").val();b.body_format=$(j+"_comment_body_markup").val();b.project_id=self.parent.project_id;if(!g.project_id){g.project_id=self.parent.project_id}g.save(b,function(){if(g.action_results.success){self.refresh()}else{Helpers.toggleAjaxBttn(q,false);self.notifyUser("error",g.action_results.errors)}});Helpers.toggle_ajax_working(false);return false})}$("#"+self.parentType+"_comment_"+f.id+"_actions .comment_destroy").click(function(){if(confirm("Are you sure you want to delete this comment?")){Helpers.toggle_ajax_working(true);self.renderMainLocked=false;f.project_id=self.parent.project_id;f.destroy(function(){if(f.action_results.success){if(d.comments){t=Ticket.find(f.parent_id)[0];if(t._comments){t._comments.remove(f);d.comments=t._comments}}Comment.Cache.unCache(f);UI.Bookmarker.redirectTo()}else{self.NotifyUser("error",f.action_results.errors)}})}})});if($("#new_comment_submit_button")[0]){var k=$("#new_comment_submit_button");k.bind("click",function(){if(!Helpers.comment_validate("#new_comment",false)){return false}if(!$("#new_comment_body")[0]||!$("#new_comment_body_markup")[0]){alert("Comment could not be saved.");return false}Helpers.toggleAjaxBttn(k,true);var c=new Unfuddle.Data.Comment.Base({parent_type:self.parent.resourceType,body:$("#new_comment_body").val(),body_format:$("#new_comment_body_markup").val(),parent_id:self.parent.id,project_id:self.parent.project_id});var s={submit_bttn:k};var h=$("#new_comment_file_input_list .file_input");var i=[];var o=[];var m=[];h.each(function(g,b){if(b.value!=""){if(c.parent_type=="Message"){var a=new Attachment.Base({fileElementId:b.id,filename:b.value.split("\\").pop().split("/").pop(),parent_type:"Comment",project_id:self.options.project_id,message_id:c.parent_id})}else{if(c.parent_type=="Ticket"){var a=new Attachment.Base({fileElementId:b.id,filename:b.value.split("\\").pop().split("/").pop(),parent_type:"Comment",project_id:self.options.project_id,ticket_id:c.parent_id})}}o.push({resource:a,action:function(e){a.upload(e)},onSuccess:function(){m.push({resource:a,action:function(e){a.parent_id=c.id;a.comment_id=c.id;a.save(e)},onSuccess:function(e){if(d.comments){if(!c._attachments){c._attachments=[]}c._attachments.push(new Attachment.Base(e))}},onError:function(){c.destroy();Helpers.toggleAjaxBttn(k,false);if(a.action_results.errors.length!=0){alert(a.action_results.errors.join("\n"))}else{alert("Attachment could not be uploaded")}}})},onError:function(){Helpers.toggleAjaxBttn(k,false);if(a.action_results.errors.length!=0){alert(a.action_results.errors.join("\n"))}else{alert("Attachment could not be uploaded")}}})}});var p={onSuccess:function(){Helpers.toggle_ajax_working(false);if(c.parent_type=="Message"){c.message().active_at=c.created_at}self.renderMainLocked=false;self.render()}};var r={onSuccess:function(){c.save(function(){if(c.action_results&&c.action_results.success){if(d.comments){t=Ticket.find(c.parent_id)[0];if(t){t._comments=t._comments||[];t._comments.push(c);d.comments=t._comments}}Unfuddle.Utilities.eventChain(m,p)}else{Helpers.toggleAjaxBttn(k,false);if(c.action_results.errors.length!=0){alert(c.action_results.errors.join("\n"))}else{alert("Comment could not be saved")}}})}};Unfuddle.Utilities.eventChain(o,r);return false})}this.renderAttachments()};this.renderAttachments=function(s){var h=d.comments?d.comments:Comment.find({sourceUrl:this.baseUrl,order:["created_at"]});if(h.pending){return false}var i=true;$.each(h,function(e,g){if(!d.comments&&!g._attachments){if(Attachment.find({sourceUrl:self.baseUrl+"/"+g.id+"/attachments"}).pending){i=false;return false}}});if(!i){return false}$.each(h,function(g,b){var c={comment:b,domId:(self.parent.resourceType=="Message"?"message":"ticket")+"_comment_"+b.id,attachments:(d.comments)?(b._attachments||[]):Attachment.find({conditions:{parent_type:"Comment",parent_id:b.id}}),canManageMessages:Person.current().seeIf(Project.current(),"canManageMessages")};$.each(c.attachments,function(e,a){a.project_id=self.parent.project_id;a.resourceUrl=Unfuddle.Config.baseUrl+"/projects/"+a.project_id+"/"+(self.parent.resourceType=="Message"?"messages":"tickets")+"/"+b.parent_id+"/comments/"+b.id+"/attachments/"+a.id+"/download";if(self.parent.resourceType=="Message"){a.message_id=self.parent.id}else{a.ticket_id=self.parent.id}a.sizeFormatted=Utilities.formatBytes(a.size)});if($("#"+c.domId+"_attachment_summary")[0]){if(c.attachments.length>0){$("#"+c.domId+"_attachment_summary").html(Unfuddle.Template.Comment.attachment_summary({locals:c}))}else{$("#"+c.domId+"_attachment_summary").html("")}}$.each(c.attachments,function(e,a){if($("#"+c.domId+"_attachment_"+a.id+"_delete")[0]){$("#"+c.domId+"_attachment_"+a.id+"_delete").click(function(){if(confirm("Are you sure you want to permanently delete this attachment?")){self.renderMainLocked=false;a.destroy(function(){if(a.action_results.success){if(d.comments&&b._attachments){b._attachments.remove(a)}Attachment.Cache.unCache(a);self.renderAttachments()}else{self.notifyUser("error",a.action_results.errors)}})}})}})})};this.show()};

UI.Header=function(h){this.tmp=Unfuddle.UI.Renderer;this.tmp(h);delete this.tmp;this.containerID="#header";this.domID="#header_renderer";var self=this;self.baseUrl=h.project_id?("/projects/"+h.project_id):"";this.checkBeforeRender=function(){if((Globals.currentProject&&Globals.currentPerson.seeIf(Globals.currentProject,"canReadTickets"))||(!Globals.currentProject&&Globals.currentPerson.seeIfAtAll("canReadTickets"))){this.dependsOn("TicketReport",self.baseUrl+"/ticket_reports",{essential:true})}else{return true}return!TicketReport.find({sourceUrl:self.baseUrl+"/ticket_reports"}).pending};this.renderMain=function(){this.template=Unfuddle.Template.Layout.header();if(document.title==Account.current().title+" - Unfuddle"){document.title=(Project.current()?Project.current().title:Account.current().title)+" - "+(h.title?h.title+" - ":"")+"Unfuddle"}this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);this.holder.append($(this.template));if(Globals.currentProject&&Globals.currentProject.archived){var c="<div class='archived'><p>";c+="This project is <strong>archived</strong>. Archived projects are read-only and can only be reactivated by an account administrator";if(Globals.currentPerson.is_administrator){c+=" from the account <a href='"+Bookmarker.bookmarkFor("project_index")+"'>project list</a>"}c+=".</p></div>";$("#archive_notice").html(c).show()}else{$("#archive_notice").hide()}if(Config.currentProjectID){$("#wrapper").removeClass("account_wrapper")[0].className=$("#wrapper")[0].className.replace(/\btheme_.*?\b/g,"");$("#wrapper").addClass("theme_"+Project.current().theme).attr("class",$.trim($("#wrapper").attr("class")))}else{$("#wrapper").attr("class",("account_wrapper"+($("#wrapper")[0].className.include("hide_sidebar")?" hide_sidebar":"")))}self.currentScope=Config.currentProjectID?Project.current():Account.current();this.holder.find("#header_title").html($("<a/>").attr("href",Config.currentProjectID?Bookmarker.bookmarkFor("project_show",{ajaxLinks:true}):Bookmarker.bookmarkFor("account",{ajaxLinks:true})).html(self.currentScope.title));this.holder.find("#logged_user").html("Logged in as "+Person.current().username+":");var d=this.holder.find("#main_menu");d.find("li[class^=tab_]").removeClass("selected");var g=(self.currentScope.actual_default_ticket_report_id()?self.currentScope.actual_default_ticket_report_id():"dynamic");var f=Bookmarker.bookmarkFor(Config.currentProjectID?"project_ticket_report_show":"ticket_report_show",{ticket_report_id:g,ajaxLinks:true});var j=Config.currentProjectID?Bookmarker.bookmarkFor("project_show",{ajaxLinks:true}):Bookmarker.bookmarkFor("account",{ajaxLinks:true});var i=Config.currentProjectID?Bookmarker.bookmarkFor("project_settings",{ajaxLinks:true}):Bookmarker.bookmarkFor("account_settings",{ajaxLinks:true});var k=Config.currentProjectID?Bookmarker.bookmarkFor("project_repository_index",{ajaxLinks:true}):Bookmarker.bookmarkFor("repository_index",{ajaxLinks:true});var l=Config.currentProjectID?Bookmarker.bookmarkFor("person_index",{ajaxLinks:true}):Bookmarker.bookmarkFor("account_person_index",{ajaxLinks:true});var n=Config.currentProjectID?Bookmarker.bookmarkFor("notebook_index",{ajaxLinks:true}):"";var o=Config.currentProjectID?Bookmarker.bookmarkFor("milestone_index",{ajaxLinks:true}):"";var p=Config.currentProjectID?Bookmarker.bookmarkFor("message_index",{ajaxLinks:true}):Bookmarker.bookmarkFor("account_message_index",{ajaxLinks:false});var q=Config.currentProjectID?Bookmarker.bookmarkFor("project_time_invested",{ajaxLinks:true}):Bookmarker.bookmarkFor("time_invested",{ajaxLinks:true});if(Config.currentProjectID){var r=$("<li/>").addClass("tab_overview").html($("<a/>").attr("href",j).html("Overview")).appendTo(d);if(Person.current().seeIf(Project.current(),"canReadMessages")){var m=$("<li/>").addClass("tab_messages").html($("<a/>").attr("href",p).html("Messages")).appendTo(d)}if(Person.current().seeIf(Project.current(),"canReadMilestones")){var tabMilestones=$("<li/>").addClass("tab_milestones").html($("<a/>").attr("href",o).html("Milestones")).appendTo(d)}if(Person.current().seeIf(Project.current(),"canReadTickets")){var tabTickets=$("<li/>").addClass("tab_tickets").html($("<a/>").attr("href",f).html("Tickets")).appendTo(d)}if(Person.current().seeIf(Project.current(),"canReadNotebooks")){var tabNotebooks=$("<li/>").addClass("tab_notebooks").html($("<a/>").attr("href",n).html("Notebooks")).appendTo(d)}if(Person.current().seeIf(Project.current(),"canReadSource")){var tabRepositories=$("<li/>").addClass("tab_repositories").html($("<a/>").attr("href",k).html("Repositories")).appendTo(d)}if(Person.current().seeIf(Project.current(),"canReadPeople")){var tabPeople=$("<li/>").addClass("tab_people").html($("<a/>").attr("href",l).html("People")).appendTo(d)}if(Person.current().seeIf(Project.current(),"isAdministrator")){var tabSettings=$("<li/>").addClass("tab_settings").html($("<a/>").attr("href",i).html("Settings")).appendTo(d)}}else{var tabDashboard=$("<li/>").addClass("tab_dashboard").html($("<a/>").attr("href",j).html("Dashboard")).appendTo(d);var tabProjects=$("<li/>").addClass("tab_projects").html($("<a/>").attr("href",UI.Bookmarker.bookmarkFor("project_index",{ajaxLinks:true})).html("Projects")).appendTo(d);if(Person.current().seeIfAtAll("canReadSource")){var tabRepositories=$("<li/>").addClass("tab_repositories").html($("<a/>").attr("href",k).html("Repositories")).appendTo(d)}if(Person.current().seeIfAtAll("canReadTickets")){var tabTickets=$("<li/>").addClass("tab_tickets").html($("<a/>").attr("href",f).html("Tickets")).appendTo(d)}if(Account.current().hasFeature("time_tracking")&&Person.current().seeIfAtAll("canReadTimeEntries")){var tabTimeTracking=$("<li/>").addClass("tab_time_tracking").html($("<a/>").attr("href",q).html("Time Tracking")).appendTo(d)}if(Person.current().seeIfAtAll("canReadPeople")){var tabPeople=$("<li/>").addClass("tab_people").html($("<a/>").attr("href",l).html("People")).appendTo(d)}if(Person.current().seeIf("isAdministrator")){var tabSettings=$("<li/>").addClass("tab_settings").html($("<a/>").attr("href",i).html("Settings")).appendTo(d)}}d.find("li a").click(function(e){if(e.ctrlKey||e.metaKey){window.open(this.href)}else{d.find("li[class^=tab_]").removeClass("selected");$(this).parent().addClass("selected");UI.Bookmarker.redirectTo(this.href,true)}return false});if(m&&self.options.route.indexOf("message")>=0){m.addClass("selected")}else{if(tabPeople&&(self.options.route.indexOf("person")>=0||self.options.route.indexOf("people")>=0)){tabPeople.addClass("selected")}else{if(tabSettings&&(self.options.route.indexOf("settings")>0||self.options.route.indexOf("billing")>0||self.options.route.indexOf("confirm_delete")>0)){tabSettings.addClass("selected")}else{if(tabMilestones&&self.options.route.indexOf("milestone")>=0){tabMilestones.addClass("selected")}else{if(tabNotebooks&&self.options.route.indexOf("notebook")>=0){tabNotebooks.addClass("selected")}else{if(tabProjects&&self.options.route=="project_index"){tabProjects.addClass("selected")}else{if(tabTickets&&self.options.route.indexOf("ticket")>=0){tabTickets.addClass("selected")}else{if(tabTimeTracking&&self.options.route.indexOf("time_invested")>=0){tabTimeTracking.addClass("selected")}else{if(tabRepositories&&self.options.route.indexOf("repository")>=0){tabRepositories.addClass("selected")}else{if(tabDashboard){tabDashboard.addClass("selected")}else{r.addClass("selected")}}}}}}}}}}this.setBindings()};this.setBindings=function(){var j=(Config.development?"http://":"https://");$("#personal_settings_link").attr("href",j+location.host+Config.baseUrl+"/a#/people/settings");$("#sign_out_link").click(function(){$.ajax({url:Config.baseApiUrl+"/session.json",type:"POST",dataType:"application/json",data:{_method:"DELETE"},contentType:"application/x-www-form-urlencoded",async:false,success:function(){location.reload()}});return false});var i=function(){var e=$("#search_query").val().replace(" ","+","g");if(Project.current()){UI.Bookmarker.redirectTo(UI.Bookmarker.bookmarkFor("project_search")+"?query="+Url.encode(e))}else{UI.Bookmarker.redirectTo(UI.Bookmarker.bookmarkFor("account_search")+"?query="+Url.encode(e))}return false};var k=function(g){var f={Ticket:1,Message:2,Comment:3,Changeset:4,Page:5,Milestone:6};g.sort(function(a,b){return f[a.type]-f[b.type]});$.each(g,function(e,result){result._location=Utilities.searchItemLocation(result);if(!Globals.currentProject){result._projectTheme=Project.find(result.project_id)[0]?Project.find(result.project_id)[0].theme:""}if(result.title){result.title=Utilities.formatText(result.title,{format:"compact"});if(result.description){result.description=Utilities.formatText(result.description,{format:"compact"})}var c="";var d="";if(result.type=="Changeset"||result.type=="CommitComment"){c=result.title.split("[")[1].split("]")[0].substring(0,6)+": "+result.description;d=result.title.split("[")[1].split("]")[0]}else{c=result.title;d=result.title}result._title=c.substring(0,30)+(c.length>31?"...":"");result._id=Math.random().toString().substring(2,16);result.label="<div style='width:100%;position:relative;overflow:hidden;max-height:1.1em;'><div id="+result._id+(result._projectTheme?" class='ui-menu-item_autocomplete-theme theme_"+result._projectTheme+"_project_indicator'":"")+" style='padding:0em .4em;overflow:hidden'"+(c.length>31?'tooltip_title="'+c+'"'+(Utilities.isMSIE7?' title="'+c+'"':""):"")+">"+result._title+"</div></div>";result.value=d;result.category=result.type}});return g};$.widget("custom.catcomplete",$.ui.autocomplete,{_renderMenu:function(d,g){var self=this,f="";$.each(g,function(e,c){c._icon=(c.category=="Changeset"?"svn":(c.category=="CommitComment"?"comment.commit":c.category.toLowerCase()))+".png";if(c.category!=f){d.append("<li class='ui-autocomplete-category' style='font-weight:bold;'><div style='width:100%;position:relative;overflow:hidden;'><img style='position:relative;top:3px;' src='/images/icons/"+c._icon+"' /> "+(c.category=="CommitComment"?"Commit Comment":c.category)+"s</div></li>");f=c.category}self._renderItem(d,c)})}});self.locals.maxInstantSearchResults=20;$("#search_query").catcomplete({delay:300,minLength:2,source:function(c,d){$.ajax({type:"GET",dataType:"json",url:Config.baseApiUrl+(Globals.currentProject?"/projects/"+Globals.currentProject.id:"/account")+"/search.json",data:{query:c.term,limit:(Globals.currentProject?5:3),truncate:100,start_index:0,end_index:self.locals.maxInstantSearchResults},success:function(e){results=k(e);if(results&&results[0]&&results[0].total_count){self.locals.resultsLength=results[0].total_count}d(results)}})},select:function(e,c){$("#search_query").autocomplete("close");if(e.ctrlKey||e.metaKey){window.open(Config.baseUrl+"/a"+c.item._location)}else{UI.Bookmarker.redirectTo(c.item._location)}return false},open:function(e,c){self.renderMainLocked=true;initialValue=$("#search_query").val();if(self.locals.resultsLength>self.locals.maxInstantSearchResults){$(".ui-autocomplete").append("<li style='font-weight:bold;'><div style='padding-left:4px;width:100%;position:relative;overflow:hidden;'><br /><a id='instant_search_show_more' onclick='return false;' href='#'>Show More Results...</a></div></li>");$("#instant_search_show_more").click(function(){i();return false})}},close:function(e,c){$("#tooltip").remove();self.renderMainLocked=false}});$("#search_form").submit(function(){i();return false})};this.show()};

Unfuddle.UI.SidebarShow=function(b){this.tmp=Unfuddle.UI.Renderer;this.tmp(b);delete this.tmp;this.domID="#sidebar_content";this.containerID="#sidebar";var self=this;this.baseUrl=b.project_id?("/projects/"+b.project_id):"";$.each(b.layouts,function(c,d){if(d.include("Message")){self.dependsOn("Category","/projects/"+b.project_id+"/categories",{essential:true});self.addJsTemplate("message")}if(d.include("Project.sidebarProjectBackups")){self.dependsOn("Backup","/projects/"+b.project_id+"/backups",{essential:true})}if(d.include("Ticket")){self.addJsTemplate("ticket")}if(d.include("Account")){self.addJsTemplate("account")}if(d.include("Project")){self.addJsTemplate("project")}if(d.include("TimeTracking")){self.addJsTemplate("time_tracking")}});this.checkBeforeRender=function(){var h=true;self.projectsRelevant=Globals.currentProject?[Globals.currentProject]:Globals.currentPerson.projectsByPermission("canReadTickets").filter(function(c){return!c.archived&&!c.sourceUrl.include("initializer")}).sortByExpression("title");$.each(b.layouts,function(c,d){if(d.include("Milestone")){self.addJsTemplate("milestone");if(Globals.currentProject){if(Globals.currentPerson.seeIf(Globals.currentProject,"canReadMilestones")){self.dependsOn("Milestone","/projects/"+b.project_id+"/milestones",{essential:true,findParams:{apiParams:{archived:false}}});if(Milestone.find({sourceUrl:"/projects/"+b.project_id+"/milestones",apiParams:{archived:false}}).pending){h=false}}}else{if(Globals.currentPerson.seeIfAtAll("canReadMilestones")){self.dependsOn("Milestone","/milestones",{essential:true,findParams:{apiParams:{archived:false}}});if(Milestone.find({sourceUrl:"/milestones",apiParams:{archived:false}}).pending){h=false}}}}if(d.include("Ticket.sidebarReports")){if((Globals.currentProject&&Globals.currentPerson.seeIf(Globals.currentProject,"canReadTickets"))||(!Globals.currentProject&&Globals.currentPerson.seeIfAtAll("canReadTickets"))){self.dependsOn("TicketReport",self.baseUrl+"/ticket_reports",{essential:true});if(TicketReport.find({sourceUrl:self.baseUrl+"/ticket_reports"}).pending){h=false}}}if(d.include("Ticket.sidebarStatus")){if((Globals.currentProject&&Globals.currentPerson.seeIf(Globals.currentProject,"canReadMilestones"))||(!Globals.currentProject&&Globals.currentPerson.seeIfAtAll("canReadMilestones"))){self.dependsOn("Milestone",self.baseUrl+"/milestones",{essential:true,findParams:{apiParams:{archived:false}}});if(Milestone.find({sourceUrl:self.baseUrl+"/milestones",apiParams:{archived:false}}).pending){h=false}}if((Globals.currentProject&&Globals.currentPerson.seeIf(Globals.currentProject,"canReadTickets"))||(!Globals.currentProject&&Globals.currentPerson.seeIfAtAll("canReadTickets"))){if(typeof(self.projectsRelevant[0])!="undefined"){self.dependsOn("OverallProgress","/projects/"+self.projectsRelevant[0].id+"/overall_progress",{essential:true,findParams:{apiParams:{archived:false}}});if(OverallProgress.find({sourceUrl:"/projects/"+self.projectsRelevant[0].id+"/overall_progress",apiParams:{archived:false}}).pending){h=false}}}}});return h};this.renderMain=function(){$(this.domID).remove();$("#wrapper").removeClass("hide_sidebar");if((Project.current()&&(b.route.include("source")||b.route.include("repository")||b.route.include("person")||b.route.include("notebook")||b.route.include("page")||b.route.include("search")))||(!Project.current()&&(b.route=="project_index"||b.route.include("person")||b.route.include("compliance")||b.route.include("search")||b.route.include("repository")))){$("#wrapper").addClass("hide_sidebar");return false}var j=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);var f=$('<div id="context_sensitive" />').appendTo(j);$.each(b.layouts,function(m,g){var a={};if(g.include("sidebarCategories")){a={categories:Category.find({conditions:{project_id:b.project_id},order:"title"}),isAdministrator:Person.current().seeIf(Project.current(),"isAdministrator"),options:b};f.append(Unfuddle.Template.Message.sidebarCategories({locals:a}))}else{if(g.include("Message.sidebarSyndication")){a={options:b};f.append(Unfuddle.Template.Message.sidebarSyndication({locals:a}))}else{if(g.include("Milestone.sidebarCalendar")){if(Globals.currentProject){if(Globals.currentPerson.seeIf(Project.current(),"canReadMilestones")){var i=Milestone.find({conditions:{project_id:b.project_id}});a={canReadMilestones:Globals.currentPerson.seeIf(Project.current(),"canReadMilestones"),calendars:Helpers.getCalendarsForMilestones(i)};f.append(Unfuddle.Template.Milestone.sidebarCalendar({locals:a}))}}else{if(Globals.currentPerson.seeIfAtAll("canReadMilestones")){var i=Milestone.find();a={canReadMilestones:true,calendars:Helpers.getCalendarsForMilestones(i)};f.append(Unfuddle.Template.Milestone.sidebarCalendar({locals:a}))}}}else{if(g.include("Ticket.sidebarReports")){if((Globals.currentProject&&Globals.currentPerson.seeIf(Globals.currentProject,"canReadTickets"))||(!Globals.currentProject&&Globals.currentPerson.seeIfAtAll("canReadTickets"))){a.ticketReports=TicketReport.find({sourceUrl:self.baseUrl+"/ticket_reports",order:"title"});a.canManageReports=b.project_id?Person.current().seeIf(Project.current(),"canManageTickets"):Person.current().is_administrator;a.options=self.options;f.append(Unfuddle.Template.Ticket.sidebarReports({locals:a}))}}else{if(g.include("TimeTracking.sidebarReports")){a.actuallyUsesTimeTracking=Project.current().actuallyUses("time_tracking");a.hasFeatureTimeTracking=Project.current().hasFeature("time_tracking");a.canReadPeople=Person.current().seeIf(Project.current(),"canReadPeople");a.options=b;f.append(Unfuddle.Template.TimeTracking.sidebarReports({locals:a}))}else{if(g.include("Ticket.sidebarStatus")){if((Globals.currentProject&&Globals.currentPerson.seeIf(Globals.currentProject,"canReadTickets"))||(!Globals.currentProject&&Globals.currentPerson.seeIfAtAll("canReadTickets"))){a.ticketsTotal=0;if(typeof(self.projectsRelevant[0])!="undefined"){var k=OverallProgress.find(self.projectsRelevant[0].id,{apiParams:{archived:false}});a.ticketsTotal+=k[0].entire_project.tickets_active;a.ticketsTotal+=k[0].entire_project.tickets_closed;a.relevantProjects=self.projectsRelevant;a.milestoneOptions='<option value="entire_project">Entire Project</option>';$.each(a.relevantProjects[0].activeMilestones(),function(c,d){a.milestoneOptions+='<option value="'+d.id+'">'+d.title+"</option>"});a.projectProgress=OverallProgress.find(a.relevantProjects[0].id)[0].entire_project;a.canSeeHours=a.relevantProjects[0].actuallyUses("time_tracking")&&Globals.currentPerson.seeIf(a.relevantProjects[0],"canReadPeople")&&a.projectProgress.hours_estimate_current!=0;f.append(Unfuddle.Template.Ticket.sidebarStatus({locals:a,showProjectSelect:true}))}$("#ticket_status_ticket_status_project_selector_select").change(function(){var c=$(this).val();self.selectLocked=false;self.dependsOn("OverallProgress","/projects/"+c+"/overall_progress",{findParams:{apiParams:{archived:false}},callback:function(){if(!self.selectLocked){self.selectLocked=true;Helpers.ticket_status_show_project("ticket_status",c)}}});if(!self.selectLocked&&!OverallProgress.find({sourceUrl:"/projects/"+c+"/overall_progress",apiParams:{archived:false}}).pending){self.selectLocked=true;Helpers.ticket_status_show_project("ticket_status",c)}return false})}}else{if(g.include("Project.sidebarSettings")){f.append(Unfuddle.Template.Project.sidebarSettings());$("#project_delete").click(function(){if(confirm("Are you sure you want to permanently delete this project?")){var h=Project.current();$.ajax({type:"POST",data:{_method:"DELETE"},dataType:"application/json",contentType:"application/x-www-form-urlencoded",url:Config.baseApiUrl+"/projects/"+b.project_id,success:function(c,d){delete Config.currentProjectID;Project.Cache.unCache(h,true);UI.Bookmarker.redirectTo("#/projects")},error:function(){Helpers.flashNoticeNow("error","An error occured while deleting the project. Please try again!")}})}return false})}else{if(g.include("Project.sidebarProjectBackups")&&Project.current()){a={backups:Backup.find({conditions:{project_id:Project.current().id},order:"created_at DESC"})};$.each(a.backups,function(c,d){d._createdAt=Utilities.formatDate(Utilities.parseDate(d.created_at),{format:"withTime"});if(d.processed_at){d._processedAt=Utilities.formatDate(Utilities.parseDate(d.processed_at),{format:"withTime"})}});f.append(Unfuddle.Template.Project.sidebarProjectBackups({locals:a}))}else{if(g.include("Account.sidebarAccountSettings")){f.append(Unfuddle.Template.Account.sidebarAccountSettings());var l=(Config.development?"http://":"https://");$("#account_change_billing_information").attr("href",l+location.host+Config.baseUrl+"/a#/account/billing");$("#account_reset_access_keys").click(function(){if(confirm("Resetting the access keys for this account will invalidate all RSS feeds and iCal calendars to which people have linked.\n\nAre you sure you want to reset the account access keys?")){$.ajax({type:"POST",beforeSend:function(c){if(this.dataType!="script"&&UI.Helpers.checkSessionExpired()){return false}if(location.protocol=="https:"){c.setRequestHeader("X-Unfuddle-Ajax-Secure",1)}c.setRequestHeader("X-Unfuddle-Ajax-Client",1);c.setRequestHeader("X-HTTP-METHOD-OVERRIDE","PUT")},url:Config.baseApiUrl+"/account/reset_access_keys.json",dataType:"application/json",success:function(){self.notifyUser("success","The access keys for this account have been successfully reset.")},error:function(){var c=[];try{c=JSON.parse(xhr.responseText)}catch(err){}if(c.lenght<=0){c=["An unexpected error occured while resetting the access keys for this account. Please try again!"]}self.notifyUser("error",c)}})}return false})}else{try{f.append(eval("Unfuddle.Template."+g+"({})"))}catch(e){}}}}}}}}}}});j.append(Unfuddle.Template.General.supportFeedback());this.supportFeedback();f.append("<hr/>")};this.supportFeedback=function(){$("#send_feedback_form").submit(function(){var c=$("#feedback").val();if(c!=null&&c.length!=0){$.post(Config.baseUrl+"/api/v1/feedback",{feedback:c+"\n"+location.href});$("#send_feedback_thanks").show()}$("#send_feedback").hide();$("#send_feedback_form")[0].reset();$("#send_feedback_action").show()});return false};this.show()};

if(typeof Unfuddle=="undefined"){var Unfuddle={}}if(typeof Unfuddle.UI=="undefined"){Unfuddle.UI={}}Unfuddle.UI.MilestoneNew=function(h){this.tmp=Unfuddle.UI.Renderer;this.tmp(h);delete this.tmp;this.containerID=h.containerID||"#content";this.domID="#milestone_new";var self=this;this.addJsTemplate("milestone");if(Globals.currentProject){this.dependsOn("Involvement","/projects/"+Config.currentProjectID+"/involvements",{essential:true})}else{$.each(Globals.currentPerson.activeProjects(),function(d,b){self.dependsOn("Involvement","/projects/"+b.id+"/involvements",{essential:true})})}this.renderMain=function(f){this.renderMainLocked=true;this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);var c={dateDashFormat:Utilities.formatDate(new Date,{format:"dashStyle",hover:false}),datePickerFormat:Utilities.formatDate(new Date,{format:"datePicker",hover:false}),relevantProjects:Globals.currentProject?[Globals.currentProject]:Globals.currentPerson.activeProjects()};$.each(c.relevantProjects,function(e,g){g._canReadPeople=Globals.currentPerson.seeIf(g,"canReadPeople");g._involvedPeople=g.involvedPeople().sortByExpression("object.displayName()");$.each(g._involvedPeople,function(d,b){b._displayName=b.displayName()})});this.holder.append(Unfuddle.Template.Milestone.newMilestone({locals:c}));$("#new_milestone").show();this.setBindings(c)};this.setBindings=function(i){$("#new_milestone_title").focus();DatePicker.setDate("#new_milestone_date",Utilities.formatDate(new Date,{format:"dashStyle",hover:false}));$("#new_milestone_form").submit(function(){if($("#new_milestone_title").val()==""){alert("Title cannot be blank");return false}var a=$("#new_milestone_submit");Helpers.toggleAjaxBttn(a,true);var d=$("#new_milestone_date").val();var b=$("#new_milestone_title").val();var e=$("#new_milestone_description").val();var g=$("._new_milestone_responsible").val();var f=Globals.currentProject?Globals.currentProject.id:$("#new_milestone_proj").val();if(g=="none"){g=0}var c=new Milestone.Base({project_id:f,title:b,person_responsible_id:g,due_on:d,description:e});c.save(function(){if(c.action_results.success){self.renderMainLocked=false;if(h.from=="milestones"){UI.Bookmarker.redirectTo()}else{UI.Bookmarker.redirectTo(UI.Bookmarker.bookmarkFor("milestone_index",{project_id:f}))}}else{Helpers.toggleAjaxBttn(a,false);self.notifyUser("error",c.action_results.errors)}});return false});$("#new_milestone_cancel").click(function(){$("#new_milestone").hide();$("#new_milestone_form")[0].reset();DatePicker.setDate("#new_milestone_date",Utilities.formatDate(new Date,{format:"dashStyle",hover:false}));self.renderMainLocked=false;return false});$("#new_milestone_proj").change(function(){$.each(i.relevantProjects,function(d,b){$("#new_milestone_people_responsible_for_"+b.id).hide();$("#new_milestone_people_responsible_for_"+$("#new_milestone_proj").val()).show()})})};this.show()};Unfuddle.UI.MilestoneIndex=function(h){this.tmp=Unfuddle.UI.Renderer;this.tmp(h);delete this.tmp;this.verifyPermissions=function(){return Globals.currentPerson.seeIf(Globals.currentProject,"canReadMilestones")};this.containerID="#content";this.domID="#milestone_index";this.elementsToHighlight=[];var self=this;this.locals={};this.addJsTemplate("milestone");this.dependsOn("Milestone","/projects/"+h.project_id+"/milestones",{essential:true});this.dependsOn("Involvement","/projects/"+Config.currentProjectID+"/involvements",{essential:true});this.checkBeforeRender=function(){if(Person.current().seeIf(Project.current(),"canReadTickets")){self.dependsOn("OverallProgress","/projects/"+h.project_id+"/overall_progress",{callback:self.displayOverallProgress})}return true};this.renderMain=function(e){this.renderMainLocked=true;this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);this.locals.canReadMilestones=Globals.currentPerson.seeIf(Globals.currentProject,"canReadMilestones");this.locals.canReadTickets=Globals.currentPerson.seeIf(Globals.currentProject,"canReadTickets");this.locals.canReadTimeEntries=Globals.currentPerson.seeIf(Globals.currentProject,"canReadTimeEntries");this.locals.actuallyUsesTimeTracking=Globals.currentProject.actuallyUses("time_tracking");this.locals.milestones=Milestone.find({conditions:{project_id:h.project_id},order:"due_on"});$.each(this.locals.milestones,function(){this.dueDashFormat=Utilities.formatDate(this.due_on,{format:"dashStyle",hover:false});this.duePickerFormat=Utilities.formatDate(this.due_on,{format:"datePicker",hover:false});this.formattedDue=Utilities.formatDate(this.due_on);this.formattedDueWeek=Utilities.formatDate(this.due_on,{format:"withWeekdayName"});this.responsible=(Globals.currentPerson.seeIf(Globals.currentProject,"canReadPeople")&&this.personResponsible())?this.personResponsible().displayName():null;this.titleEscaped=Url.encode(this.title);this.descriptionFormatted=Utilities.formatText(this.description,{format:this.description_format,project:Globals.currentProject,callback:function(d){$("#show_milestone_description").html(d)}})});this.locals._involvedPeople=Globals.currentProject.involvedPeople().sortByExpression("object.displayName()");$.each(this.locals._involvedPeople,function(d,b){b._displayName=b.displayName()});this.locals.upcomingMilestones=Globals.currentProject.upcomingMilestones();this.locals.lateMilestones=Globals.currentProject.lateMilestones();this.locals.completeMilestones=Globals.currentProject.completeMilestones();this.locals.archivedMilestones=Globals.currentProject.archivedMilestones();this.locals.isMSIE=Utilities.isMSIE();this.locals.canManageMilestones=Globals.currentPerson.seeIf(Globals.currentProject,"canManageMilestones");this.locals.canReadPeople=Globals.currentPerson.seeIf(Globals.currentProject,"canReadPeople");this.locals.dateDashFormat=Utilities.formatDate(new Date,{format:"dashStyle",hover:false});this.locals.datePickerFormat=Utilities.formatDate(new Date,{format:"datePicker",hover:false});this.holder.append(Unfuddle.Template.Milestone.index({locals:this.locals}));this.displayOverallProgress();this.setBindings()};this.displayOverallProgress=function(e){if(OverallProgress.find({conditions:{project_id:h.project_id}}).pending){return}self.locals.firstProgress=OverallProgress.find(h.project_id)[0];if(self.locals.firstProgress){self.locals.progress=OverallProgress.find(h.project_id)[0].milestones_by_id}else{self.locals.progress=[]}$.each(self.locals.milestones,function(d,b){if(!self.locals.progress[""+b.id]){self.locals.progress[""+b.id]={tickets_closed:0,hours_actual:0,hours_actual_active:0,milestone_id:0,hours_actual_closed:0,hours_estimate_initial:0,hours_estimate_initial_active:0,tickets_active:0,hours_estimate_current:0,hours_estimate_current_active:0}}if(!b.archived){$("#milestone_"+b.id+"_progress").html(Unfuddle.Template.Milestone.progress({domId:"milestone_"+b.id,milestone:b,locals:self.locals}))}else{if($("#milestone_"+b.id+"_progress")[0]&&self.locals.progress[""+b.id]&&self.locals.progress[""+b.id].tickets_active>0){$("#milestone_"+b.id+"_progress").html('<a href="#/projects/'+b.project_id+"/ticket_reports/dynamic?conditions_string=status-neq-closed%2Cmilestone-eq-"+b.id+"&amp;project="+b.project_id+'&amp;title=Active+Tickets+for+Front+Burner">'+self.locals.progress[""+b.id].tickets_active+" Tickets Still Active</a>")}else{$("#milestone_"+b.id+"_progress").remove()}}})};this.setBindings=function(){self.elementsToHighlight.forEach(function(d){$(d).effect("highlight",{},2000)});self.elementsToHighlight=[];$("#new_milestone_link").click(function(){self.renderMainLocked=true;new UI.MilestoneNew({containerID:"#new_milestone_milestone_index",from:"milestones"});return false});$("[id$='_delete_link']").click(function(){if(!confirm("Are you sure you want to delete this milestone from the project?")){return false}var a=this;var d=a.id.match(/milestone_(.*?)_/)[1];var b=Milestone.find(d)[0];b.destroy(function(){if(b.action_results.success){self.refresh()}else{self.notifyUser("error",b.action_results.errors)}});return false});$("[id$='_edit_link']").click(function(){self.renderMainLocked=true;var a=this;var g=a.id.match(/milestone_(.*?)_/)[1];var f=Milestone.find(g)[0];var c="#milestone_"+g;var i=$(c+"_edit");if(i.html()==""){$(Unfuddle.Template.Milestone.edit({locals:self.locals,milestone:f,domId:"milestone_"+f.id})).appendTo(i);$(c+"_edit_form").submit(function(){if($(c+"_edit_title").val()==""){alert("The Title cannot be blank.");return false}var d=$(c+"_edit_submit");Helpers.toggleAjaxBttn(d,true);var b={};self.elementsToHighlight.push(c);b.title=$(c+"_edit_title").val();b.description=$(c+"_edit_milestone_description").val();var e=$(c+"_edit_person_responsible").val();if(e=="none"){e=0}b.person_responsible_id=e;b.due_on=Utilities.parseDate($(c+"_edit_date").val());b.completed=$(c+"_edit_completed").attr("checked");b.shift_subsequent=$(c+"_edit_shift_subsequent").attr("checked");f.save(b,function(){Helpers.toggleAjaxBttn(d,false);if(f.action_results.success){$(c+"_edit").hide();if(b.shift_subsequent){Milestone.Cache.retrieve({sourceUrl:Milestone.getSourceUrl({project_id:self.options.project_id}),callback:function(){self.refresh()}})}else{self.refresh()}}else{self.notifyUser("error",f.action_results.errors)}});return false});$(c+"_edit_cancel").click(function(){$(c+"_edit").hide();$(c+"_edit_form")[0].reset();DatePicker.setDate("#milestone_"+g+"_edit_date",Utilities.formatDate(f.due_on,{format:"dashStyle",hover:false}));$(c+"_render").show();self.renderMainLocked=false;return false});$(c+"_archive").click(function(){self.elementsToHighlight.push(c);f.save({archived:true},function(){if(f.action_results.success){$(c+"_edit").hide();self.refresh()}else{self.notifyUser("error",f.action_results.errors)}});return false})}$(c+"_render").hide();$(c+"_edit").show();return false});$("[id$='_unarchive_link']").click(function(){var a=this;var d=a.id.match(/milestone_(.*?)_/)[1];var b=Milestone.find(d)[0];self.elementsToHighlight.push("#milestone_"+d);b.save({archived:false},function(){if(b.action_results.success){self.refresh()}else{self.notifyUser("error",b.action_results.errors)}});return false});$("input[id^='milestone_'][id$='_render_completed']").click(function(){if(Helpers.checkSessionExpired()){return false}var d=this;var b=d.id.match(/milestone_(.*)_render_completed/)[1];var e=Milestone.find(b)[0];self.elementsToHighlight.push("#milestone_"+b);e.save({completed:!e.completed},function(){if(e.action_results.success){self.refresh()}else{self.notifyUser("error",e.action_results.errors);$(d).attr("checked",e.completed)}})})};this.show()};

UI.TicketShow=function(n){this.tmp=Unfuddle.UI.Renderer;this.tmp(n);delete this.tmp;this.containerID="#content";this.domID="#ticket_show";var self=this;this.addJsTemplate("ticket");if(n.ticket_id){n.id=n.ticket_id}this.baseUrl=Ticket.getSourceUrl(n);this.dependsOn("Ticket",this.baseUrl,{essential:true,findParams:{apiParams:{include:"all",resolver:true}}});this.urlForAllTickets=Ticket.getSourceUrl({project_id:n.project_id});this.verifyPermissions=function(){if(Globals.currentProject){return Globals.currentPerson.seeIf(Globals.currentProject,"canReadTickets")}};this.checkBeforeRender=function(){this.locals.ticket=Ticket.find({sourceUrl:this.baseUrl,apiParams:{include:"all",resolver:true}})[0];if(!this.locals.ticket){var d=n.id?"id "+n.id:"number "+n.number;self.notifyUser("error","There is no ticket with "+d,{message:" "});return false}var b=Globals.currentProject;var c=this.locals.ticket.id;var e="/projects/"+b.id+"/tickets/"+c;var f=true;self.dependsOn("Project","/projects/"+b.id+"/initializer",{essential:true,findParams:{apiParams:{only:"involvements,milestones,custom_field_values,components,versions,severities"}}});if(Project.find({sourceUrl:"/projects/"+b.id+"/initializer",apiParams:{only:"involvements,milestones,custom_field_values,components,versions,severities"}}).pending){f=false}if(Globals.currentPerson.seeIf(Globals.currentProject,"canReadSource")){this.dependsOn("Repository","/projects/"+Globals.currentProject.id+"/repositories",{callback:function(){self.checkAssociatedChangesets()}})}if(!f){return f}return true};this.renderMain=function(c){this.renderMainLocked=true;document.title=Globals.currentProject.title+" - #"+this.locals.ticket.number+": "+this.locals.ticket.summary+" - Unfuddle";var e="/projects/"+Globals.currentProject.id+"/tickets/"+this.locals.ticket.id;this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);this.locals=$.extend(self.locals,{priorityNameDownCase:this.locals.ticket.prettyField("priority").toLowerCase(),priorityNamesList:["","lowest","low","normal","high","highest"],isMSIE:Utilities.isMSIE(),isMSIE7:Utilities.isMSIE7(),isMSIE9:Utilities.isMSIE9(),getMSIEv:Utilities.getMSIEv(),isFF:Utilities.isFF(),spinner:Helpers.ajaxProgressSmall(),canReadMilestones:Globals.currentPerson.seeIf(Globals.currentProject,"canReadMilestones"),canReadPeople:Globals.currentPerson.seeIf(Globals.currentProject,"canReadPeople"),canManageTickets:Globals.currentPerson.seeIf(Globals.currentProject,"canManageTickets"),canReadSource:Globals.currentPerson.seeIf(Globals.currentProject,"canReadSource"),canCreateTickets:Globals.currentPerson.seeIf(Globals.currentProject,"canCreateTickets"),isAdministrator:Globals.currentPerson.seeIf(Globals.currentProject,"isAdministrator"),hasAttachments:Globals.currentProject.hasFeature("attachments"),prettyReporter:this.locals.ticket.prettyField("reporter_id"),eventBubblingCode:Utilities.isFF()?"style='display: block;'":"onclick='Helpers.event_override(event);'",involvedPeople:Globals.currentProject.involvedPeople(),people:Person.find({order:"object.displayName()"})});this.locals.canUpdateTickets=this.locals.canManageTickets||(this.locals.canCreateTickets&&this.locals.ticket.reporter_id==Globals.currentPerson.id);$.each(self.locals.people,function(d,b){b._displayName=b.displayName()});this.locals.ticket.descriptionFormatted=Utilities.formatText(this.locals.ticket.description,{format:this.locals.ticket.description_format,project:Globals.currentProject,callback:function(d){$("#show_ticket_description").html(d)}});this.locals.timeEntries=this.locals.ticket._timeEntries||[];this.locals.dateDashFormat=Utilities.formatDate(new Date,{format:"dashStyle",hover:false});this.locals.datePickerFormat=Utilities.formatDate(new Date,{format:"datePicker",hover:false});if(Globals.currentPerson.notification_scope_tickets=="involved"&&this.locals.ticket._subscriptions){this.locals.interested=this.locals.ticket._subscriptions[Globals.currentPerson.id]}this.locals.canAttach=this.locals.canManageTickets||(this.locals.ticket.reporter_id==Globals.currentPerson.id&&!Globals.currentProject.archived);this.locals.attachments=this.locals.ticket._attachments||[];$.each(self.locals.attachments,function(d,a){a.attachment_type=a.content_type.include("image")?"image":"download";a.attachmentDateFormatted=Utilities.formatDate(a.created_at,{prefix:false,format:"withTime"});a.sizeFormatted=Utilities.formatBytes(a.size)});if(this.locals.ticket.resolver_id){var f=Person.find(this.locals.ticket.resolver_id);if(f&&f[0]){this.locals.prettyResolver=f[0].displayName()}}if(this.locals.ticket.resolution){this.locals.prettyResolution=this.locals.ticket.prettyField("resolution");if(this.locals.ticket.resolution_description){this.locals.ticket.resolutionDescriptionFormatted=Utilities.formatText(this.locals.ticket.resolution_description,{format:this.locals.ticket.resolution_description_format,project:Globals.currentProject,callback:function(d){$("#show_ticket_resolution_description_formatted").html(d)}})}}this.locals.createdOn=Utilities.formatDate(this.locals.ticket.created_at,{prefix:"true"});this.locals.hasTimeTracking=Globals.currentProject.actuallyUses("time_tracking");this.locals.canSeeTimeEntries=this.locals.hasTimeTracking&&this.locals.canReadPeople;this.locals.canCreateTimeEntries=this.locals.canSeeTimeEntries&&this.locals.canManageTickets;this.locals.statusHumanized=this.locals.ticket.status.humanize();for(var h=1;h<=3;h++){this.locals["customField"+h+"Values"]=CustomFieldValue.find({conditions:{project_id:Globals.currentProject.id,field_number:h},order:["value"]})}this.locals.validPriorityList=Ticket.validPriorityList;this.locals.validResolutionList=Ticket.validResolutionList();this.locals.relevantProjects=Globals.currentPerson.activeProjects().filter(function(d){return Globals.currentPerson.seeIf(d,"canCreateTickets")});this.prepareRows();this.prepareRowsForTicketEdit();this.setTicketsCycle();this.holder.append(Unfuddle.Template.Ticket.show({locals:this.locals}));this.renderTimeEntries();new UI.TicketNew({ticket:this.locals.ticket,container:"#new_ticket_holder"});new UI.CommentIndex({parent:this.locals.ticket,project_id:this.locals.ticket.project_id,containerID:"#ticket_show_comments",comments:this.locals.ticket._comments||[]});this.setTicketShowBindings();this.resolveTicketSubmitButton();this.saveChangesOnTicketEdit();this.attachmentActions();this.monitoringTickets();this.checkAssociatedChangesets();this.ticketAssociationActions();this.locals.base_summary_width=this.locals.canReadPeople?41:56;this.retrieveAssociatedTickets();this.locals.auditSince=this.locals.ticket.auditMostRecent().length>0?Utilities.formatDate(this.locals.ticket.auditMostRecent()[0].created_at,{hover:false,format:"utcString"}):"";this.dependsOn("Audit",e+"/audit_trail",{findParams:{apiParams:{since:this.locals.auditSince}},callback:function(){self.checkAuditTrail()}});this.checkAuditTrail();Helpers.markupContainer($("#markItUpEdit_ticket_description"),{markup:this.locals.ticket.description_format,domID:"ticket_description_edit"});Helpers.markupContainer($("#resolution_description_form_markup_container"),{domID:"ticket_resolution_description"});Helpers.markupContainer($("#ticket_edit_resolution_description_form_markup_container"),{markup:this.locals.ticket.resolution_description_format,domID:"ticket_edit_resolution_description"})};this.renderTimeEntries=function(){var c=0;$.each(self.locals.timeEntries,function(d,b){b._personDisplayName=Person.find(b.person_id)[0]?Person.find(b.person_id)[0].displayName():"";b._displayDate=Utilities.formatDate(Utilities.parseDate(b.date),{format:"default",hover:true});b._dateDisplayValueEdit=Utilities.formatDate(Utilities.parseDate(b.date),{format:"datePicker",hover:false});b._dateValueEdit=Utilities.formatDate(Utilities.parseDate(b.date),{format:"dashStyle",hover:false});c=1-c});self.locals.rowColorForTotalHours=c;self.locals.hoursActual=self.locals.ticket.hoursActual().toFixed(2);self.locals.percentageComplete=self.locals.ticket.percentageComplete();self.locals.ticket.hours_estimate_initialFormatted=parseFloat(self.locals.ticket.hours_estimate_initial).toFixed(2);self.locals.ticket.hours_estimate_currentFormatted=parseFloat(self.locals.ticket.hours_estimate_current).toFixed(2);$("#time_tracking").html(Unfuddle.Template.Ticket.timeTracking({locals:self.locals}));this.timeTrackingActions()};this.setTicketsCycle=function(){if(n.cycle&&UI.currentTicketReport){var b=UI.currentTicketReport.tickets.map(function(d){return d.id});var c=b.indexOf(self.locals.ticket.id);if(c<0){return}this.locals.cycle=true;self.locals.previousTicket=UI.currentTicketReport.tickets[(c==0)?b.length-1:c-1];self.locals.nextTicket=UI.currentTicketReport.tickets[(c==b.length-1)?0:c+1]}};this.checkAuditTrail=function(){if(Audit.find({sourceUrl:"/projects/"+Globals.currentProject.id+"/tickets/"+this.locals.ticket.id+"/audit_trail",apiParams:{since:this.locals.auditSince}}).pending){return false}var e=Audit.find({conditions:{record_type:"Ticket",record_id:self.locals.ticket.id},order:["created_at asc"]});$.each(e,function(b,c){if(c&&$("#ticket_audit_"+c.id).length<=0){if(self.locals.canReadPeople&&c.person_id&&Person.find(c.person_id)[0]){c._personDisplayName=Person.find(c.person_id)[0].displayName()}c._createdAt=Utilities.formatDate(c.created_at,{prefix:true});if(c.description&&c.description.length>0){c._description=Utilities.formatText(c.description,{format:"markdown",project:Globals.currentProject,callback:function(d){$("#ticket_audit_"+c.id+"_description").html(d)}})}$("#ticket_audit_placeholder").prepend(Unfuddle.Template.Ticket.audit({locals:self.locals,audit:c}))}})};this.checkAssociatedChangesets=function(){if(Globals.currentProject.repositories().pending||!$("#changeset_associations_holder").length){return false}var e=(self.locals.ticket._changesets||[]).sortByExpression("object.committer_date desc");if(this.locals.canReadSource&&(this.locals.canManageTickets||e.length>0)&&Globals.currentProject.repositories().length>0){this.locals.repositoriesForCurrentProject=Globals.currentProject.repositories();this.locals.baseMessageWidth=this.locals.canReadPeople?54:69;$.each(e,function(d,b){b._displayName=b.displayName()});$("#changeset_associations_holder").html(Unfuddle.Template.Ticket.associatedChangesets({locals:self.locals}));var f=1;$.each(e,function(d,b){f=Math.abs(1-f);if(!$("associated_changeset_"+b.id)||!($("associated_changeset_"+b.id).length>0)){b._committerDateFormatted=Utilities.formatDate(Utilities.parseDate(b.committer_date));b._revisionSevenChars=b.revision.slice(0,7);var c="#/projects/"+Globals.currentProject.id+"/repositories/"+b.repository_id+"/commit?commit="+b.revision;$("#associated_changesets_table").append(Unfuddle.Template.Ticket.associatedChangeset({locals:self.locals,changeset:b,index:f,changesetUrl:c}));self.disassociateChangesetAction(b)}});self.changesetAssociationActions()}};this.changesetAssociationActions=function(){$("#new_changeset_ticket_association_action").click(function(){$("#new_changeset_ticket_association_action").hide();$("#new_changeset_ticket_association").show();$("#new_changeset_ticket_association_revision").focus()});$("#new_changeset_ticket_association_form").submit(function(){var e=$("#new_changeset_ticket_association_submit");revision=$("#new_changeset_ticket_association_revision").val();if(revision!=""){Helpers.toggleAjaxBttn(e,true);var f=self.locals.ticket;f.project_id=Globals.currentProject.id;repository_id=$("#new_changeset_ticket_association_repository").val();if(repository_id!=""){var h=function(d,b){for(var c=0;d&&c<d.length;c++){if(d[c]&&d[c].revision==b){return true}}return false};var g=function(){var b=function(){var d=Changeset.find({conditions:{repository_id:repository_id,revision:revision}});self.locals.ticket._changesets=self.locals.ticket._changesets||[];self.locals.ticket._changesets.push(d[0]);self.checkAssociatedChangesets()};var c=Changeset.find({conditions:{repository_id:repository_id,revision:revision}});if(c&&c[0]){b()}else{self.dependsOn("Changeset","/repositories/"+repository_id+"/changesets/by_revision/"+revision,{callback:function(){b()}})}};if(!h(self.locals.ticket._changesets,revision)){f.associateChangeset(repository_id,revision,g,function(){self.checkAssociatedChangesets()})}else{Helpers.toggleAjaxBttn(e,false);alert("This changeset has been already associated to the current ticket.")}}}return false});if(this.locals.ticket._changesets&&this.locals.ticket._changesets.length>0){$(".associated_changeset_row").hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")})}};this.disassociateChangesetAction=function(b){$("#diassociate_changeset_"+b.id).click(function(){var d=self.locals.ticket;d.project_id=Globals.currentProject.id;d.disassociateChangeset(b.id,function(){self.locals.ticket._changesets.remove(b);self.checkAssociatedChangesets()});return false})};this.attachmentActions=function(){$("#ticket_show_attach_submit_button").click(function(){var e=$("#ticket_file_input_list .file_input");var f=[];var h=[];var g=[];var i={submit_bttn:$("#ticket_show_attach_submit_button")};e.each(function(b,c){if(c.value!=""){var a=new Attachment.Base({fileElementId:c.id,filename:c.value.split("\\").pop().split("/").pop(),parent_type:"Ticket",project_id:self.options.project_id});h.push({resource:a,action:function(d){a.upload(d)},onSuccess:function(){g.push({resource:a,action:function(d){a.parent_id=self.locals.ticket.id;a.ticket_id=self.locals.ticket.id;a.save(d)},onSuccess:function(d){self.locals.ticket._attachments=self.locals.ticket._attachments||[];self.locals.ticket._attachments.push(new Attachment.Base(d))},onError:function(){Unfuddle.UI.Helpers.actionCallback(a,i)}})},onError:function(){Unfuddle.UI.Helpers.actionCallback(a,i)}})}});var m={onSuccess:function(){self.refresh()}};var j={onSuccess:function(){Unfuddle.Utilities.eventChain(g,m)}};Unfuddle.Utilities.eventChain(h,j);return false});$.each(self.locals.attachments,function(b,c){$("#ticket_show_attachment_"+c.id).click(function(){if(confirm("Are you sure you want to permanently delete this attachment?")){at=self.locals.ticket._attachments.filter(function(d){return d.id==c.id})[0];at.project_id=self.locals.ticket.project_id;at.ticket_id=self.locals.ticket.id;at.destroy(function(){if(at.action_results.success){self.locals.ticket._attachments.remove(c);Attachment.Cache.unCache(c);self.refresh()}})}return false})})};this.monitoringTickets=function(){$("#stop_monitoring_ticket_link").click(function(){var d=this;Helpers.toggle_ajax_working(true);Helpers.toggleAjaxBttn(d,true);var b=self.locals.ticket;if(self.locals.interested){var c=self.locals.ticket._subscriptions[Globals.currentPerson.id];c.project_id=Globals.currentProject.id;c.ticket_id=b.id;c.destroy(function(){if(c.action_results.success){self.locals.interested=false;delete self.locals.ticket._subscriptions[Globals.currentPerson.id];$("#stop_monitoring_ticket").hide();$("#start_monitoring_ticket").show()}})}return false});$("#start_monitoring_ticket_link").click(function(){var d=this;Helpers.toggle_ajax_working(true);Helpers.toggleAjaxBttn(d,true);var b=self.locals.ticket;var c=new Subscription.Base;if(!self.locals.interested){c.person_id=Globals.currentPerson.id;c.parent_id=b.id;c.parent_type="Ticket";c.ticket_id=b.id;c.project_id=Globals.currentProject.id;c.save(function(){if(c.action_results.success){self.locals.interested=true;if(!self.locals.ticket._subscriptions){self.locals.ticket._subscriptions={}}self.locals.ticket._subscriptions[Globals.currentPerson.id]=c;$("#start_monitoring_ticket").hide();$("#stop_monitoring_ticket").show()}})}return false})};this.timeTrackingActions=function(){if(this.locals.canCreateTimeEntries){$("#update_time_estimates_form").submit(function(){var d=$("#ticket_time_tracking_update_estimates_submit");Helpers.toggleAjaxBttn(d,true);var b={};b.hours_estimate_initial=$("#ticket_hours_estimate_initial").val();b.hours_estimate_current=$("#ticket_hours_estimate_current").val();t=self.locals.ticket;t.save(b,function(){if(t.action_results.success){Helpers.toggleAjaxBttn(d,false);self.renderTimeEntries()}else{Helpers.flashNotice("error",t.action_results.errors)}})});$("#new_time_entry_form").submit(function(){if(!$("#new_time_entry_description").val()){alert("The following problems were encountered:\n\nDescription can't be blank");return false}var d=this;Helpers.toggleAjaxBttn(d,true);var b=new TimeEntry.Base;var c=self.locals.ticket;b.date=$("#new_time_entry_date").val();b.person_id=$("#new_time_entry_person").val();b.description=$("#new_time_entry_description").val();b.hours=$("#new_time_entry_hours").val();b.ticket_id=self.locals.ticket.id;b.project_id=Globals.currentProject.id;b.save(function(){if(b.action_results.success){c._timeEntries=c._timeEntries||[];c._timeEntries.push(b);if(c.hoursActual()>c.hours_estimate_current){c.hours_estimate_current=c.hoursActual()}self.locals.timeEntries=c._timeEntries||[];self.renderTimeEntries()}else{Helpers.flashNotice("error",b.action_results.errors)}});return false})}$.each(self.locals.timeEntries,function(b,c){if(Globals.currentPerson.is_administrator||c.person_id==Globals.currentPerson.id){$("#time_entry_"+c.id+"_edit_form").submit(function(){c.project_id=Globals.currentProject.id;c.date=$("#time_entry_"+c.id+"_date").val();c.person_id=$("#time_entry_"+c.id+"_person").val();c.description=$("#time_entry_"+c.id+"_description").val();c.hours=$("#time_entry_"+c.id+"_hours").val();c.ticket_id=self.locals.ticket.id;t=self.locals.ticket;c.save(function(){if(c.action_results.success){if(t.hoursActual()>t.hours_estimate_current){t.hours_estimate_current=t.hoursActual()}self.renderTimeEntries()}else{Helpers.flashNotice("The selected Time Entry could not be updated. Please try again.")}})});$("#time_entry_"+c.id+"_delete").click(function(){var d=confirm("Are you sure you want to delete this time entry?");if(d==true){c.project_id=Globals.currentProject.id;c.destroy(function(){if(c.action_results.success){t=self.locals.ticket;t._timeEntries.remove(c);if(t.hoursActual()>t.hours_estimate_current){t.hours_estimate_current=t.hoursActual()}self.renderTimeEntries()}else{Helpers.flashNotice("The selected Time Entry could not be deleted. Please try again.")}})}else{}return false})}})};this.prepareRowsForTicketEdit=function(){var e=[];var f=[];var h="";h+="<td width='20%' class='label' align='right'>Priority: </td><td width='30%'><select id='ticket_priority_edit' name='ticket[priority]' style='width: 100%;'>";$.each(self.locals.validPriorityList,function(d,b){h+="<option value='"+b[1]+"' ";var c=self.locals.ticket;if(c.priority==b[1]){h+="selected='selected'"}h+=">"+b[0]+"</option>"});h+="</select></td>";e.push(h);if(Globals.currentProject.severities().length){var g="";g+="<td class='label' align='right'>Severity: </td><td width='30%'><select id='ticket_severity_id_edit' name='ticket[severity_id]' style='width: 100%'>";g+="<option value='' ";if(!this.locals.ticket.severity_id){g+="selected='selected'"}g+=">&lt;none&gt;</option>";$.each(Globals.currentProject.severities(),function(d,b){var c=self.locals.ticket;g+="<option value='"+b.id+"' ";if(c.severity_id==b.id){g+="selected='selected'"}g+=">"+b.name+"</option>"});g+="</select></td>";e.push(g)}if(Globals.currentProject.components().length){var i="";i+="<td class='label' align='right'>Component: </td><td width='30%'><select id='ticket_component_id_edit' name='ticket[component_id]' style='width: 100%'>";i+="<option value='' ";if(!this.locals.ticket.component_id){i+="selected='selected'"}i+=">&lt;none&gt;</option>";$.each(Globals.currentProject.components(),function(d,b){var c=self.locals.ticket;i+="<option value='"+b.id+"' ";if(c.component_id==b.id){i+="selected='selected'"}i+=">"+b.name+"</option>"});i+="</select></td>";e.push(i)}if(Globals.currentProject.versions().length){var m="";var j=self.locals.ticket;m+="<td class='label' align='right'>Version: </td><td width='30%'><select id='ticket_version_id_edit' name='ticket[version_id]' style='width: 100%'>";m+="<option value='' ";if(!this.locals.ticket.version_id){m+="selected='selected'"}m+=">&lt;none&gt;</option>";$.each(Globals.currentProject.versions(),function(d,b){m+="<option value='"+b.id+"' ";if(j.version_id==b.id){m+="selected='selected'"}m+=">"+b.name+"</option>"});m+="</select></td>";e.push(m)}if(Globals.currentProject.ticket_field1_active){var o="";var j=self.locals.ticket;o+="<td class='label' align='right'>"+Globals.currentProject.ticket_field1_title+": </td><td width='30%'>";if(Globals.currentProject.ticket_field1_disposition=="text"){o+="<input type='text' ";if(this.locals.ticket.field1_value_id){var p=CustomFieldValue.find(this.locals.ticket.field1_value_id)[0];if(p){o+="value='"+p.value}}o+="' style='width: 100%;' name='ticket[field1_value]' id='ticket_field1_value_edit' /></td>"}else{if(Globals.currentProject.ticket_field1_disposition=="list"){o+="<select style='width: 100%;' name='ticket[field1_value_id]' id='ticket_field1_value_id_edit'>";o+="<option value='' ";if(!this.locals.ticket.field1_value_id){o+="selected='selected'"}o+=">&lt;none&gt;</option>";$.each(self.locals.customField1Values,function(d,b){o+="<option value='"+b.id+"' ";if(j.field1_value_id&&j.field1_value_id==b.id){o+="selected='selected'"}o+=">"+b.value+"</option>"});o+="</select></td>"}}e.push(o)}if(Globals.currentProject.ticket_field2_active){var k="";var j=self.locals.ticket;k+="<td class='label' align='right'>"+Globals.currentProject.ticket_field2_title+": </td><td width='30%'>";if(Globals.currentProject.ticket_field2_disposition=="text"){k+="<input type='text' ";if(this.locals.ticket.field2_value_id){var p=CustomFieldValue.find(this.locals.ticket.field2_value_id)[0];if(p){k+="value='"+p.value}}k+="' style='width: 100%;' name='ticket[field2_value]' id='ticket_field2_value_edit' /></td>"}else{if(Globals.currentProject.ticket_field2_disposition=="list"){k+="<select style='width: 100%;' name='ticket[field2_value_id]' id='ticket_field2_value_id_edit'>";k+="<option value='' ";if(!this.locals.ticket.field2_value_id){k+="selected='selected'"}k+=">&lt;none&gt;</option>";$.each(self.locals.customField2Values,function(d,b){k+="<option value='"+b.id+"' ";if(j.field2_value_id&&j.field2_value_id==b.id){k+="selected='selected'"}k+=">"+b.value+"</option>"});k+="</select></td>"}}e.push(k)}if(Globals.currentProject.ticket_field3_active){var l="";var j=self.locals.ticket;l+="<td class='label' align='right'>"+Globals.currentProject.ticket_field3_title+": </td><td width='30%'>";if(Globals.currentProject.ticket_field3_disposition=="text"){l+="<input type='text' ";if(this.locals.ticket.field3_value_id){var p=CustomFieldValue.find(this.locals.ticket.field3_value_id)[0];if(p){l+="value='"+p.value}}l+="' style='width: 100%;' name='ticket[field3_value]' id='ticket_field3_value_edit' /></td>"}else{if(Globals.currentProject.ticket_field3_disposition=="list"){l+="<select style='width: 100%;' name='ticket[field3_value_id]' id='ticket_field3_value_id_edit'>";l+="<option value='' ";if(!this.locals.ticket.field3_value_id){l+="selected='selected'"}l+=">&lt;none&gt;</option>";$.each(self.locals.customField3Values,function(d,b){l+="<option value='"+b.id+"' ";if(j.field3_value_id&&j.field3_value_id==b.id){l+="selected='selected'"}l+=">"+b.value+"</option>"});l+="</select></td>"}}e.push(l)}if(this.locals.canReadPeople){rightCellsAssignee="";var j=self.locals.ticket;rightCellsAssignee+="<td class='label' align='right'>Assign To: </td><td width='30%'>";rightCellsAssignee+="<select style='width: 100%' name='ticket[assignee_id]' id='ticket_assignee_id_edit'>";rightCellsAssignee+="<option value='' ";if(!this.locals.ticket.assignee_id){rightCellsAssignee+="selected='selected'"}rightCellsAssignee+=">&lt;unassigned&gt;</option>";$.each(self.locals.involvedPeople,function(d,b){rightCellsAssignee+="<option value='"+b.id+"'";if(j.assignee_id&&j.assignee_id==b.id){rightCellsAssignee+=" selected='selected'"}rightCellsAssignee+=">";if(Globals.currentPerson.id==b.id){rightCellsAssignee+="Me ("+b.displayName()+")"}else{rightCellsAssignee+=b.displayName()}rightCellsAssignee+="</option>"});rightCellsAssignee+="</select></td>";f.push(rightCellsAssignee)}if(this.locals.canReadMilestones){rightCellsMilestone="";var j=self.locals.ticket;rightCellsMilestone+="<td class='label' align='right'>Milestone: </td><td width='30%'>";rightCellsMilestone+="<select style='width: 100%' name='ticket[milestone_id]' id='ticket_milestone_id_edit'>";rightCellsMilestone+="<option value='' ";if(!this.locals.ticket.milestone_id){rightCellsMilestone+="selected='selected'"}rightCellsMilestone+=">&lt;none&gt;</option>";$.each(Globals.currentProject.activeMilestones(),function(d,b){rightCellsMilestone+="<option value='"+b.id+"'";if(j.milestone_id&&j.milestone_id==b.id){rightCellsMilestone+=" selected='selected'"}rightCellsMilestone+=">"+b.title+"</option>"});rightCellsMilestone+="</select></td>";f.push(rightCellsMilestone)}rightCellsDueOn="";var j=self.locals.ticket;rightCellsDueOn+="<td class='label' align='right'>Due On: </td><td width='30%'><div style='position: relative;'";if(!this.locals.ticket.due_on){rightCellsDueOn+="<div style='position: relative;''>"+Unfuddle.Template.Helpers.datePicker({allowNil:"true",nilText:"No Due Date",domId:"ticket_due_on_edit"})+"</div>"}else{rightCellsDueOn+="<div style='position: relative;''>"+Unfuddle.Template.Helpers.datePicker({dateValue:Utilities.formatDate(this.locals.ticket.due_on,{format:"dashStyle",hover:false}),displayValue:Utilities.formatDate(this.locals.ticket.due_on,{format:"datePicker",hover:false}),allowNil:"true",nilText:"No Due Date",domId:"ticket_due_on_edit"})+"</div>"}rightCellsDueOn+="</div></td>";f.push(rightCellsDueOn);rightCellsStatus="";var j=self.locals.ticket;rightCellsStatus+="<td class='label' align='right'>Status: </td><td width='30%'>";rightCellsStatus+="<select style='width: 100%' name='ticket[status]' id='ticket_status_edit_select'>";rightCellsStatus+="<option value='new'";if(this.locals.ticket.status=="new"){rightCellsStatus+=" selected='selected'"}rightCellsStatus+=">New</option>";rightCellsStatus+="<option value='unaccepted'";if(this.locals.ticket.status=="unaccepted"){rightCellsStatus+=" selected='selected'"}rightCellsStatus+=">Unaccepted</option>";rightCellsStatus+="<option value='reassigned'";if(this.locals.ticket.status=="reassigned"){rightCellsStatus+=" selected='selected'"}rightCellsStatus+=">Reassigned</option>";rightCellsStatus+="<option value='reopened'";if(this.locals.ticket.status=="reopened"){rightCellsStatus+=" selected='selected'"}rightCellsStatus+=">Reopened</option>";rightCellsStatus+="<option value='accepted'";if(this.locals.ticket.status=="accepted"){rightCellsStatus+=" selected='selected'"}rightCellsStatus+=">Accepted</option>";rightCellsStatus+="<option value='resolved'";if(this.locals.ticket.status=="resolved"){rightCellsStatus+=" selected='selected'"}rightCellsStatus+=">Resolved</option>";rightCellsStatus+="<option value='closed'";if(this.locals.ticket.status=="closed"){rightCellsStatus+=" selected='selected'"}rightCellsStatus+=">Closed</option>";rightCellsStatus+="</select></td>";f.push(rightCellsStatus);var s=Math.max(e.length,f.length);var q="";for(var r=0;r<s;r++){q+="<tr"+(r==0?" valign='top'":"")+">";q+=(e[r]?e[r]:"<td></td><td></td>");q+=(f[r]?f[r]:"<td></td><td></td>")+"</tr>"}q+="<tr"+(this.locals.hasTimeTracking?"":" class='last_row'")+">";q+="<td style='border-bottom: 0;'>";q+="<td class='form_note' style='text-align: left;border-bottom: 0;'>"+(this.locals.isAdministrator?"<a class='manage_this' href='#/projects/"+n.project_id+"/settings'>Edit Ticket Fields</a>":"")+"</td>";q+="<td style='border-bottom: 0;'></td><td style='border-bottom: 0;'></td>";this.locals.tableContentsEditTicketTemplate=q};this.prepareRows=function(){var d=[];var b=[];d.push("<td width='25%' class='label'>Priority:</td><td width='25%'>"+this.locals.ticket.prettyField("priority")+"</td>");if(Severity.find({conditions:{project_id:n.project_id}}).length){d.push("<td class='label'>Severity:</td><td>"+this.locals.ticket.prettyField("severity_id")+"</td>")}if(Component.find({conditions:{project_id:n.project_id}}).length){d.push("<td class='label'>Component:</td><td>"+this.locals.ticket.prettyField("component_id")+"</td>")}if(Version.find({conditions:{project_id:n.project_id}}).length){d.push("<td class='label'>Version:</td><td>"+this.locals.ticket.prettyField("version_id")+"</td>")}if(Globals.currentProject.ticket_field1_active){d.push("<td class='label'>"+Globals.currentProject.ticket_field1_title+":</td><td>"+this.locals.ticket.prettyField("field1_value_id")+"</td>")}if(Globals.currentProject.ticket_field2_active){d.push("<td class='label'>"+Globals.currentProject.ticket_field2_title+":</td><td>"+this.locals.ticket.prettyField("field2_value_id")+"</td>")}if(Globals.currentProject.ticket_field3_active){d.push("<td class='label'>"+Globals.currentProject.ticket_field3_title+":</td><td>"+this.locals.ticket.prettyField("field3_value_id")+"</td>")}if(this.locals.ticket.status=="resolved"||this.locals.ticket.status=="closed"){d.push("<td class='label'>Resolution:</td><td>"+this.locals.ticket.prettyField("resolution")+"</td>")}if(this.locals.canReadPeople){b.push("<td class='label'>Reporter:</td><td>"+this.locals.ticket.prettyField("reporter_id")+"</td>");b.push("<td class='label'>Assigned To:</td><td>"+this.locals.ticket.prettyField("assignee_id")+"</td>")}if(this.locals.canReadMilestones){var c=this.locals.ticket.prettyField("milestone_id");var e=this.locals.ticket.milestone_id?'<a title="Show Ticket Report for Milestone" href="'+Config.baseUrl+"/a#/projects/"+this.locals.ticket.project_id+"/ticket_reports/dynamic?title="+c+" Tickets&amp;conditions_string=milestone-eq-"+this.locals.ticket.milestone_id+'&amp;group_by=status">'+c+"</a>":c;b.push("<td class='label'>Milestone:</td><td>"+e+"</td>")}b.push("<td width='25%' class='label'>Due On:</td><td width='25%'>"+this.locals.ticket.prettyField("due_on")+"</td>");var f=Math.max(d.length,b.length);var h="";for(var g=0;g<f;g++){h+="<tr"+(g==0?" valign='top'":"")+">";h+=(d[g]?d[g]:"<td></td><td></td>");h+=(b[g]?b[g]:"<td></td><td></td>")+"</tr>"}this.locals.rightCells=b;this.locals.leftCells=d;this.locals.tableContents=h};var u=false;this.retrieveAssociatedTickets=function(){var c=this.locals.ticket.ticketAssociations();var e=c;for(var f=0;f<c.length-1;f++){for(var h=f+1;h<c.length;h++){if(c[f].associatedTicket.id==c[h].associatedTicket.id){if(c[f].relationship==c[h].relationship){e.splice(h,1)}}}}$.each(e,function(d,b){b._rowColor=d%2;if($("#ticket_association_"+b.random).length<=0){self.renderAssociatedTicket(b)}})};this.renderAssociatedTicket=function(d){d._relationship=d.relationship.capitalize();if(this.locals.canReadPeople){if(d.associatedTicket.assignee_id&&Person.find(d.associatedTicket.assignee_id)&&Person.find(d.associatedTicket.assignee_id)[0]){d.associatedTicket._assigneeDisplayName=Person.find(d.associatedTicket.assignee_id)[0].displayName()}else{d.associatedTicket._assigneeDisplayName="<none>"}}d.associatedTicket._dueOn=d.associatedTicket.prettyField("due_on");d.associatedTicket._status=d.associatedTicket.prettyField("status");$("#tickets_report_table").append(Unfuddle.Template.Ticket.association({locals:this.locals,association:d,assocTicket:d.associatedTicket}));this.ticketAssociationActionsForTable(d)};this.ticketAssociationActions=function(){$("#ticket_associations_add_form").submit(function(){Helpers.toggleAjaxBttn($("#ticket_associations_add_submit"),true);var b=$("#relationship").val();var c=$("#Ticket_search").val();var e="";if(c.match((/^\#(\d*).*/))){e="#"+c.match(/^\#(\d*).*/)[1]+":"}else{e=c}self.locals.ticket.associate({relationship:b,ticketSearch:e,success:function(){$("#Ticket_search").autocomplete("close");$("#ticket_associations_add").hide();$("#ticket_associations_add_form")[0].reset();Helpers.toggleAjaxBttn($("#ticket_associations_add_submit"),false);$("#tickets_report_table").show();self.retrieveAssociatedTickets()},error:function(d){alert("The following errors have occured:\n"+d[0]);Helpers.toggleAjaxBttn($("#ticket_associations_add_submit"),false)}});return false});$("#ticket_associations_actions_new_ticket").click(function(){$("#new_ticket").show();$("#new_ticket_association").val("child");$("#new_ticket_summary").focus();return false});$("#ticket_associations_actions_choose").click(function(){$("#ticket_associations_add").show();$("#Ticket_search").focus();return false})};this.ticketAssociationActionsForTable=function(f){$("#ticket_association_"+f.id).hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")});$("#delete_association_"+f.random).click(function(){var e=function(){self.locals.ticket.removeAssociationCache(f);self.locals.ticket._associatedTickets.remove(f);$("#ticket_association_"+f.random).remove();if(f.relationship=="parent"){var c=self.locals.ticket._associatedTickets.filter(function(object){return(object.relationship=="sibling"&&object.parent_id==f.associatedTicket.id)})||[];$.each(c,function(d,b){self.locals.ticket._associatedTickets.remove(b);$("#ticket_association_"+b.random).remove()})}self.retrieveAssociatedTickets()};self.locals.ticket.disassociate(f,e);return false})};this.setTicketShowBindings=function(){$("#ticket_status_edit_select").change(function(){if($("#ticket_status_edit_select").val()=="resolved"||$("#ticket_status_edit_select").val()=="closed"){$("#ticket_edit_resolution_container").show()}else{$("#ticket_edit_resolution_container").hide()}});Helpers.hideNewbieLink();$("#accept_ticket_link").click(function(){Helpers.toggle_ajax_working(true);var d=self.locals.ticket;var b={};b.status="accepted";b.assignee_id=Unfuddle.Globals.currentPerson.id;d.save(b,function(){Helpers.toggle_ajax_working(true);if(d.action_results.success){self.refresh()}});return false});$("#unaccept_ticket_link").click(function(){Helpers.toggle_ajax_working(true);var d=self.locals.ticket;d.save({status:"unaccepted"},function(){Helpers.toggle_ajax_working(true);if(d.action_results.success){self.refresh()}});return false});$("#verify_and_close_ticket_link").click(function(){Helpers.toggle_ajax_working(true);var d=self.locals.ticket;d.save({status:"closed"},function(){Helpers.toggle_ajax_working(true);if(d.action_results.success){self.refresh()}});return false});$("#reopen_ticket_link").click(function(){Helpers.toggle_ajax_working(true);var d=self.locals.ticket;d.save({status:"reopened"},function(){Helpers.toggle_ajax_working(true);if(d.action_results.success){self.refresh()}});return false});$("#delete_ticket_link").click(function(){var c=confirm("The deletion of a ticket is a rare activity.  Instead, most tickets should simply be closed as invalid.\n\nAre you sure you want to permanently delete this ticket from the project?");if(c==true){var e=self.locals.ticket;e.destroy(function(){if(e.action_results.success){self.currentScope=Config.currentProjectID?Project.current():Account.current();var d=(self.currentScope.actual_default_ticket_report_id()?self.currentScope.actual_default_ticket_report_id():"dynamic");var b=Bookmarker.bookmarkFor(Config.currentProjectID?"project_ticket_report_show":"ticket_report_show",{ticket_report_id:d,ajaxLinks:true});UI.Bookmarker.redirectTo(b)}else{self.notifyUser("error",e.action_results.errors)}})}return false});$("#Ticket_search").autocomplete({source:function(f,h){$.ajax({url:Config.baseApiUrl+self.urlForAllTickets+"/auto_complete_for_Ticket_search.json",data:{"Ticket[search]":f.term},success:function(c){var e=[];$.each(c,function(d,b){if(b.id!=self.locals.ticket.id){e.push(b)}});h(e)}})}})};this.resolveTicketSubmitButton=function(){$("#resolve_ticket_form").submit(function(){var c=self.locals.ticket;var e={};$("#close_simultaneously").attr("checked")?e.status="closed":e.status="resolved";e.resolver_id=Globals.currentPerson.id;e.resolution=$("#ticket_resolution").val();e.resolution_description=$("#ticket_resolution_description").val();e.resolution_description_format=$("#ticket_resolution_description_markup")?$("#ticket_resolution_description_markup").val():Utilities.getDefaultMarkup();if(self.locals.canCreateTimeEntries){e.time_tracking_hours=$("#time_tracking_hours").val();e.time_tracking_description="Ticket Resolved"}c.save(e,function(){if(c.action_results.success){if(self.locals.canSeeTimeEntries){TimeEntry.Cache.retrieve({sourceUrl:TimeEntry.getSourceUrl({project_id:c.project_id,ticket_id:c.id}),callback:function(b){b=b||[];c._timeEntries=b.map(function(d){return new TimeEntry.Base(d)});if(c.hoursActual()>c.hours_estimate_current){c.hours_estimate_current=c.hoursActual()}self.refresh()}})}else{self.refresh()}}else{self.notifyUser("error",c.action_results.errors)}});return false})};this.saveChangesOnTicketEdit=function(){$("#show_ticket_edit_submit").click(function(){var e={};var f=this;Helpers.toggleAjaxBttn(f,true);if(self.locals.ticket.project_id!=$("#ticket_project_id_edit").val()){e.project_id=$("#ticket_project_id_edit").val()}if(self.locals.ticket.summary!=$("#ticket_summary_edit").val()){e.summary=$("#ticket_summary_edit").val()}if($("#ticket_description_edit").val()&&$("#ticket_description_edit").val()!=self.locals.ticket.description){e.description=$("#ticket_description_edit").val()}if(self.locals.ticket.description_format!=$("#ticket_description_edit_markup").val()){e.description_format=$("#ticket_description_edit_markup").val()}if(self.locals.ticket.priority!=$("#ticket_priority_edit").val()){e.priority=$("#ticket_priority_edit").val()}if(self.locals.ticket.severity_id!=$("#ticket_severity_id_edit").val()){e.severity_id=$("#ticket_severity_id_edit").val()}if(self.locals.ticket.version_id!=$("#ticket_version_id_edit").val()){e.version_id=$("#ticket_version_id_edit").val()}if(self.locals.ticket.component_id!=$("#ticket_component_id_edit").val()){e.component_id=$("#ticket_component_id_edit").val()}for(var h=1;h<=3;h++){if(Globals.currentProject["ticket_field"+h+"_active"]){if(Globals.currentProject["ticket_field"+h+"_disposition"]=="text"){e["field"+h+"_value"]=$("#ticket_field"+h+"_value_edit").val();e["field"+h+"_value_id"]=null}else{if(Globals.currentProject["ticket_field"+h+"_disposition"]=="list"){e["field"+h+"_value_id"]=$("#ticket_field"+h+"_value_id_edit").val()}}}}if(self.locals.canReadPeople){e.assignee_id=$("#ticket_assignee_id_edit").val()}if(self.locals.canReadMilestones&&$("#ticket_milestone_id_edit").val()!=self.locals.ticket.milestone_id){e.milestone_id=$("#ticket_milestone_id_edit").val()}e.due_on=$("#ticket_due_on_edit").val()?Utilities.parseDate($("#ticket_due_on_edit").val()):"";var g=e.status;e.status=$("#ticket_status_edit_select").val();if(e.status=="resolved"||e.status=="closed"){e.resolution=$("#ticket_edit_resolution_edit").val();e.resolution_description=$("#ticket_edit_resolution_description").val();e.resolution_description_format=$("#ticket_edit_resolution_description_markup").val();if(g!="resolved"){e.resolver_id=Globals.currentPerson.id}}else{if(e.resolution||e.resolution_description){e.resolution=e.resolution_description=""}}if(Helpers.ticket_validate("#ticket_summary_edit","#ticket_description_edit",true)){var i=self.locals.ticket.project_id;self.locals.ticket.save(e,function(d){if(self.locals.ticket.action_results.success){for(var b=1;b<=3;b++){if(Globals.currentProject["ticket_field"+b+"_disposition"]=="text"&&Globals.currentProject["ticket_field"+b+"_active"]){var c={field_number:b,id:d["field"+b+"_value_id"],value:e["field"+b+"_value"],project_id:d.project_id};CustomFieldValue.Cache.process(c,"/projects/"+d.project_id+"/tickets/"+d.id+"/custom_field_values/"+d["field"+b+"_value_id"])}}if(i==d.project_id){self.refresh()}else{Bookmarker.redirectTo(Bookmarker.bookmarkFor("ticket_show_by_number",{project_id:d.project_id,number:d.number}))}}else{if(self.locals.ticket.action_results.errors){self.notifyUser("error",self.locals.ticket.action_results.errors);Helpers.toggleAjaxBttn(f,false)}}})}return false})};this.show()};UI.TicketNew=function(q){this.tmp=Unfuddle.UI.Renderer;this.tmp(q);delete this.tmp;this.containerID=this.options.container||"#content";this.domID="#ticket_new";var self=this;this.checkBeforeRender=function(){var b=true;this.locals.relevantProjects=Globals.currentProject?[Globals.currentProject]:Globals.currentPerson.activeProjects().filter(function(d){return Globals.currentPerson.seeIf(d,"canCreateTickets")});var c=this.locals.relevantProjects[0];if(!c){return true}self.dependsOn("Project","/projects/"+c.id+"/initializer",{essential:true,findParams:{apiParams:{only:"involvements,milestones,custom_field_values,components,versions,severities"}}});if(Project.find({sourceUrl:"/projects/"+c.id+"/initializer",apiParams:{only:"involvements,milestones,custom_field_values,components,versions,severities"}}).pending){b=false}return b};this.addJsTemplate("ticket");var r=function(c){c.canReadMilestones=Globals.currentPerson.seeIf(c,"canReadMilestones");c.canReadPeople=Globals.currentPerson.seeIf(c,"canReadPeople");c._severities=c.severities();c._components=c.components();c._versions=c.versions();c._involvedPeople=c.involvedPeople();c._activeMilestones=c.activeMilestones();c._timeTrackingEnabled=c.actuallyUses("time_tracking");$.each(c._involvedPeople,function(d,b){b._displayName=b.displayName()});for(var e=1;e<=3;e++){if(c["ticket_field"+e+"_disposition"]=="list"){c["_customField"+e+"Values"]=c.customFieldValues(e)}}};this.renderMain=function(d){if(typeof(this.locals.relevantProjects[0])=="undefined"){return}this.renderMainLocked=true;this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);this.locals.ticket=this.options.ticket;this.locals.hasAttachments=Globals.currentAccount.hasFeature("attachments");var b=this.locals.relevantProjects[0];r(b);this.locals.validPriorityList=Ticket.validPriorityList;var c=(this.options.from=="search_page"||this.options.from=="dashboard")?"":"display: none;";this.holder.append(Unfuddle.Template.Ticket.newTicket({locals:this.locals,Globals:Globals,domId:"new_ticket",cssStyle:c}));$("#new_ticket_summary").focus();this.setTicketNewBindings();Helpers.markupContainer($("#markItUpNew_ticket_new_description"),{domID:"new_ticket_description"})};this.renderMetaData=function(d){r(d);$("#new_ticket_project_ticket_meta_container .ticket_new_options").hide();$("#new_ticket_project_ticket_meta_container").append(Unfuddle.Template.Ticket.metaContainer({locals:this.locals,domId:"new_ticket",Globals:Globals,proj:d,display:true}))};this.setTicketNewBindings=function(){$("#new_ticket_proj").change(function(){var b=$("#new_ticket_proj").val();if($("#new_ticket_project_ticket_meta_"+b).length>0){$("#new_ticket_project_ticket_meta_container .ticket_new_options").hide();$("#new_ticket_project_ticket_meta_"+b).show();return false}var c=Project.find(b)[0];var e=function(d){if(Project.find({sourceUrl:"/projects/"+b+"/initializer",apiParams:{only:"involvements,milestones,custom_field_values,components,versions,severities"}}).pending){return}if($("#new_ticket_project_ticket_meta_"+d.id)>0){return}self.renderMetaData(d)};self.dependsOn("Project","/projects/"+b+"/initializer",{callback:function(){e(c)},findParams:{apiParams:{only:"involvements,milestones,custom_field_values,components,versions,severities"}}});e(c);return false});$("#new_ticket_form").submit(function(){if(!Helpers.ticket_validate("#new_ticket_summary","#new_ticket_new_description",false)){return false}var e=$("#new_ticket_submit");var f=Globals.currentProject?Globals.currentProject:Project.find($("#new_ticket_proj").val())[0];var h="new_ticket_project_ticket_meta_"+f.id;Helpers.toggleAjaxBttn(e,true);var g=new Ticket.Base;g.project_id=f.id;g.summary=$("#new_ticket_summary").val();g.description=$("#new_ticket_description").val();g.description_format=$("#new_ticket_description_markup").val();g.priority=$("#"+h+"_new_priority").val();g.severity_id=$("#"+h+"_new_severity").val();g.component_id=$("#"+h+"_new_component").val();g.version_id=$("#"+h+"_new_version").val();for(var i=1;i<=3;i++){if(f["ticket_field"+i+"_active"]&&f["ticket_field"+i+"_disposition"]=="text"){g["field"+i+"_value"]=$("#ticket_field"+i+"_value").val()}else{g["field"+i+"_value_id"]=$("#ticket_field"+i+"_value_id").val()}}g.assignee_id=$("#"+h+"_new_assignee").val();g.milestone_id=$("#"+h+"_new_milestone").val();g.due_on=Utilities.parseDate($("#new_ticket_due_on_"+f.id).val());g.hours_estimate_initial=$("#"+h+"_hours_estimate_initial").val();$.each(Ticket.fields,function(d,b){Globals.session.ticket[b]=g[b]});if(Globals.session.ticket.due_on){Globals.session.ticket.due_on=Utilities.formatDate(g.due_on,{format:"dashStyle",hover:false})}var m={submit_bttn:e};var j=$("#new_ticket_file_input_list .file_input");var o=[];var p=[];var k=[];j.each(function(b,c){if(c.value!=""){var a=new Attachment.Base({fileElementId:c.id,filename:c.value.split("\\").pop().split("/").pop(),parent_type:"Ticket",project_id:f.id});p.push({resource:a,action:function(d){a.upload(d)},onSuccess:function(){k.push({resource:a,action:function(d){a.parent_id=g.id;a.ticket_id=g.id;a.save(d)},onError:function(){Unfuddle.UI.Helpers.actionCallback(a,m)}})},onError:function(){Unfuddle.UI.Helpers.actionCallback(a,m)}})}});var l={onSuccess:function(){var d="";if(Globals.currentPerson.seeIf(f,"canCreateTicketsOnly")){d="#/projects/"+f.id}else{if(Globals.currentPerson.seeIf(f,"canReadTickets")){d="#/projects/"+f.id+"/tickets/by_number/"+g.number}}Helpers.actionCallback(g,{returnUrl:d})}};var s={onSuccess:function(){g.save(function(){if(g.action_results.success){var b=$("#new_ticket_association").val();if(f.ticket_field1_active||f.ticket_field2_active||f.ticket_field3_active){CustomFieldValue.Cache.retrieve({sourceUrl:"/projects/"+f.id+"/custom_field_values"})}if(b&&b!="none"){self.locals.ticket.associate({relationship:b,ticketSearch:"#"+g.number+":",error:function(d){alert("Ticket association error:\n"+d.join("\n"));Unfuddle.Utilities.eventChain(k,l)},success:function(){Unfuddle.Utilities.eventChain(k,l)}})}else{Unfuddle.Utilities.eventChain(k,l)}}else{$.extend(m,{returnUrl:window.location.href});Helpers.actionCallback(g,m)}})}};Unfuddle.Utilities.eventChain(p,s);return false})};this.show()};

UI.TicketReport=function(f){this.tmp=Unfuddle.UI.Renderer;this.tmp(f);delete this.tmp;this.domID="#report_render_wrapper";this.containerID="#content";if(f.project_id){this.skope="project";this.baseUrl="/projects/"+f.project_id+"/ticket_reports/"}else{this.skope="account";this.baseUrl="/ticket_reports/"}this.report=null;var self=this;self.addJsTemplate("ticket");self.dependsOn("TicketReport",self.baseUrl.slice(0,self.baseUrl.length-1),{essential:true});this.getReportData=function(){if(self.gettingReportData){return}self.gettingReportData=true;var b=$("<div class='domID'/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);var d={report:{}};if(f.ticket_report_id){d.report.title=TicketReport.find(f.ticket_report_id)[0].title;d.rss_feed_url=Config.baseUrl+(f.project_id?"/projects/"+f.project_id:"")+"/ticket_reports/"+f.ticket_report_id+"/generate.rss?aak="+Globals.currentAccount.access_key+"&pak="+Globals.currentPerson.access_key;d.csv_url=Config.baseUrl+(f.project_id?"/projects/"+f.project_id:"")+"/ticket_reports/"+f.ticket_report_id+"/generate.csv";d.ics_feed_url=Config.baseUrl+(f.project_id?"/projects/"+f.project_id:"")+"/ticket_reports/"+f.ticket_report_id+"/generate.ics?aak="+Globals.currentAccount.access_key+"&pak="+Globals.currentPerson.access_key;$.getJSON(Config.baseApiUrl+self.baseUrl+f.ticket_report_id+"/generate?pretty=true&exclude_description=true",function(a){self.report=new TicketReport.Base(a);self.report.processData();self.gettingReportData=false;self.render()})}else{var h={parent_type:f.project_id?"Project":"Account",parent_id:f.project_id?f.project_id:Globals.currentAccount.id};"conditions_string fields_string sort_direction sort_by group_by title".split(" ").forEach(function(a){if(f[a]){h[a]=decodeURIComponent(f[a].replace(/\+/g," "))}});if(f.new_report){h.groups=[{tickets:[]}];self.report=new TicketReport.Base(h);self.gettingReportData=false;self.report.processData()}else{d.report.title=h.title;var g=[];"conditions_string fields_string sort_direction sort_by group_by title".split(" ").forEach(function(a){if(h[a]){g.push(a+"="+h[a])}});d.rss_feed_url=Config.baseUrl+(f.project_id?"/projects/"+f.project_id:"")+"/ticket_reports/dynamic.rss?aak="+Globals.currentAccount.access_key+"&pak="+Globals.currentPerson.access_key+"&"+g.join("&");d.csv_url=Config.baseUrl+(f.project_id?"/projects/"+f.project_id:"")+"/ticket_reports/dynamic.csv?"+g.join("&");d.ics_feed_url=Config.baseUrl+(f.project_id?"/projects/"+f.project_id:"")+"/ticket_reports/dynamic.ics?aak="+Globals.currentAccount.access_key+"&pak="+Globals.currentPerson.access_key+"&"+g.join("&");h.pretty=true;h.exclude_description=true;$.getJSON(Config.baseApiUrl+self.baseUrl+"dynamic",h,function(a){self.report=new TicketReport.Base(a);self.report.processData();self.gettingReportData=false;self.render()})}}b.html(Unfuddle.Template.Ticket.ticketReportWaiting({locals:d}))};this.checkBeforeRender=function(a){var b=true;if(!self.report){self.getReportData();if(self.gettingReportData){b=false}}if(this.skope=="project"){self.dependsOn("Project","/projects/"+f.project_id+"/initializer",{callback:function(){self.renderDialogs()},findParams:{apiParams:{only:"involvements,milestones,custom_field_values,components,versions,severities"}}})}else{self.dependsOn("Account","/initializer",{callback:function(){self.renderDialogs()},findParams:{apiParams:{only:"involvements,milestones,custom_field_values,components,versions,severities"}}})}if(!b){return false}return true};var s=function(){var o=$("#ticket_report_conditions_string");var e=$("#ticket_report_fields_string");var j=["priority","component","version","severity","field_1","field_2","field_3","status","resolution","due_on"];if(self.locals.canReadMilestones){j.push("milestone")}if(self.locals.canReadPeople){$.merge(j,["reporter","assignee"])}var r=self.locals.fieldsAll;var c="";o.val("");e.val("");for(var q=0;q<r.length;q++){if($("#report_options_field_"+r[q]).attr("checked")==true){if(e.val()!=""){e.val(e.val()+" ,")}e.val(e.val()+r[q])}}var k=[];$.each(self.locals.criteria,function(a,b){if(a!="total"&&$("#and_statement_box_"+a+"_body")[0]){var d=[];for(var h=1;h<=b;h++){if($("#or_statement_box_"+a+"_"+h)[0]){var g=$("#condition_criteria_field_"+a+"_"+h).val();var n=$("#condition_criteria_exp_"+a+"_"+h).val();var m=$("#condition_criteria_value_"+a+"_"+h).val();if(m!="any"){d.push(g+"-"+n+"-"+m)}}}if(d.length>0){k.push(d.join("|"))}}});o.val(k.join(","))};this.renderMainLocked=false;this.regenerated=false;this.renderMain=function(){if(!this.renderMainLocked){this.renderMainLocked=true}UI.currentTicketReport={title:self.report.title,link:location.href,tickets:[]};$.each(self.report.groups,function(a,b){UI.currentTicketReport.tickets=UI.currentTicketReport.tickets.concat(b.tickets)});document.title=(Globals.currentProject?Globals.currentProject.title:Globals.currentAccount.title)+" - "+self.report.title+" - Unfuddle";self.currentScope=f.project_id?Project.current():Account.current();self.ticketReports=(self.skope=="project")?TicketReport.find({sourceUrl:"/projects/"+f.project_id+"/ticket_reports"}):TicketReport.find({sourceUrl:"/ticket_reports"});var o=$("<div class='domID'/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);o.html(ajaxProgressSmall());self.lastTicketIndex=-1;var e=self.report;var j=Globals.currentPerson;var r=((e.ofProject()&&j.seeIf(e.parent(),"canManageReports"))||(e.ofAccount()&&j.is_administrator));self.canReadPeople=((e.ofProject()&&j.seeIf(e.parent(),"canReadPeople"))||(e.ofAccount()&&j.seeIfAtAll("canReadPeople")));var c=((e.ofProject()&&j.seeIf(e.parent(),"canManageTickets"))||(e.ofAccount()&&j.seeIfAtAll("canManageTickets")));self.canReadMilestones=((e.ofProject()&&j.seeIf(e.parent(),"canReadMilestones"))||(e.ofAccount()&&j.seeIfAtAll("canReadMilestones")));var q=((e.ofProject()&&j.seeIf(e.parent(),"canCreateTickets"))||(e.ofAccount()&&j.seeIfAtAll("canCreateTickets")));e.ofProject_=e.ofProject();$.each(Person.current().activeProjects(),function(a,b){b.actuallyUsesTimeTracking=b.actuallyUses("time_tracking")});e.fieldHeading={};$.each(e.fields,function(a,b){e.fieldHeading[b]=Ticket.fieldHeading(b,(e.parent_type=="Project"?Project.find(e.parent_id)[0]:null))});$.each(e.groups,function(n,m){$.each(m.tickets,function(d,h){var g=e.groups[n].tickets[d];g.__hoursActual=g.hours_actual;g.__percentageComplete=g.percentage_complete;g.priorityName_=g.priorityName();g.priorityNameDowncase=g.priorityName_.toLowerCase();g.percentageComplete_=g.percentage_complete;g.createdAtFormatted=Utilities.formatDate(g.created_at,{format:"auto",hover:true});g.updatedAtFormatted=Utilities.formatDate(g.updated_at,{format:"auto",hover:true});g.closedOnFormatted=g.closed_on?Utilities.formatDate(g.closed_on,{format:"auto",hover:true}):"&lt;none&gt;";g.associatedTickets_=g.associatedTickets();g.project_=g.project();$.each(e.fields,function(a,b){g["prettyField_"+b]=g.prettyField(b)});g.prettyField_milestone_description=(g.milestone_id&&Milestone.find(g.milestone_id).length>0)?Milestone.find(g.milestone_id)[0].description:null;$.each(g.associatedTickets_,function(a,b){b.ticket._prettyFieldAssociation=b.relationship.capitalize().slice(0,1)+b.ticket.number});e.groups[n].tickets[d]=g})});var k={report:e,fieldWidthTotal:e.fieldWidthTotal(e.fields,e.project_id),totalTickets:e.totalTickets(),fieldsAll:e.fieldsAll.remove("selector"),project:Project.current(),options:f,canReadPeople:self.canReadPeople,canReadMilestones:self.canReadMilestones,canManageTickets:c,canManageReports:r,canCreateTickets:q,eventBubblingCode:Utilities.isFF()?"style='display: block;'":"onclick='Helpers.event_override(event);'",isFF:Utilities.isFF(),new_report:self.options.new_report||false};if(!e.id){dymanicParams=[];$.each(e.dynamicParams(),function(a,b){dymanicParams.push(a+"="+b)});k.rss_feed_url=Config.baseUrl+(f.project_id?"/projects/"+f.project_id:"")+"/ticket_reports/dynamic.rss?aak="+Globals.currentAccount.access_key+"&pak="+Globals.currentPerson.access_key+"&"+dymanicParams.join("&");k.csv_url=Config.baseUrl+(f.project_id?"/projects/"+f.project_id:"")+"/ticket_reports/dynamic.csv?"+dymanicParams.join("&");k.ics_feed_url=Config.baseUrl+(f.project_id?"/projects/"+f.project_id:"")+"/ticket_reports/dynamic.ics?aak="+Globals.currentAccount.access_key+"&pak="+Globals.currentPerson.access_key+"&"+dymanicParams.join("&")}else{k.rss_feed_url=Config.baseUrl+(f.project_id?"/projects/"+f.project_id:"")+"/ticket_reports/"+e.id+"/generate.rss?aak="+Globals.currentAccount.access_key+"&pak="+Globals.currentPerson.access_key;k.csv_url=Config.baseUrl+(f.project_id?"/projects/"+f.project_id:"")+"/ticket_reports/"+e.id+"/generate.csv";k.ics_feed_url=Config.baseUrl+(f.project_id?"/projects/"+f.project_id:"")+"/ticket_reports/"+e.id+"/generate.ics?aak="+Globals.currentAccount.access_key+"&pak="+Globals.currentPerson.access_key}k.report.parent_=e.parent();k.report.hasTimeTrackingFields=!k.report.fields.every(function(a){return a!="hours_estimate_initial"&&a!="hours_estimate_current"&&a!="hours_actual"});k.report.groups.forEach(function(d){if(!d.running_totals){d.running_totals={hours_estimate_initial:0,hours_estimate_current:0,hours_actual:0};d.tickets.forEach(function(a){d.running_totals.hours_estimate_initial+=a.hours_estimate_initial;d.running_totals.hours_estimate_current+=a.hours_estimate_current;d.running_totals.hours_actual+=a.hours_actual})}$.each(d.running_totals,function(a,b){d.runningTotalsFormatted=d.runningTotalsFormatted||{};d.runningTotalsFormatted[a]=b.toFixed(2)})});if(self.options.new_report=="true"){k.report.fields=[]}if(k.report.group_by=="milestone"){$.each(k.report.groups,function(a,b){if(b.tickets.length>0&&b.tickets[0].prettyField_milestone_description){b.description=b.tickets[0].prettyField_milestone_description}})}var u=Unfuddle.Template.Ticket.report({locals:k});o[0].innerHTML=u;if(q){new UI.TicketNew({container:"#new_ticket_holder"})}self.locals=k;self.renderReportTickets({stopAtTicketIndex:499});self.renderDialogs()};this.renderDialogs=function(){if(!self.report){return}if(!$("#report_options_dialog")[0]||!$("#tickets_update_dialog")[0]){return}if(this.skope=="project"){if(Project.find({sourceUrl:"/projects/"+f.project_id+"/initializer",apiParams:{only:"involvements,milestones,custom_field_values,components,versions,severities"}}).pending){return}}else{if(Account.find({sourceUrl:"/initializer",apiParams:{only:"involvements,milestones,custom_field_values,components,versions,severities"}}).pending){return}}var c=self.report;var q=$.merge([["&lt;none&gt;",""]],c.validGroupByList().map(function(b){var d=null;if(c.ofProject()){if(b=="field_1"){d=c.parent().ticket_field1_title}else{if(b=="field_2"){d=c.parent().ticket_field2_title}else{if(b=="field_3"){d=c.parent().ticket_field3_title}}}}return[(d?d:b.humanize().split(" ").map(function(a){return a.capitalize()}).join(" ")),b]}));var k=$.merge([["&lt;none&gt;",""]],c.validSortByList().map(function(b){var d=null;if(c.ofProject()){if(b=="field_1"){d=c.parent().ticket_field1_title}else{if(b=="field_2"){d=c.parent().ticket_field2_title}else{if(b=="field_3"){d=c.parent().ticket_field3_title}}}}return[(d?d:b.humanize().split(" ").map(function(a){return a.capitalize()}).join(" ")),b]}));var u=c.fieldsAll.remove("selector").map(function(b){var d=null;if(b=="number"||b=="created_at"||b=="updated_at"||b=="last_comment_at"){d=b.humanize().split(" ").map(function(a){return a.capitalize()}).join(" ")}else{if(b=="field_1"){d=c.ofProject()&&c.parent().ticket_field1_title&&!c.parent().ticket_field1_title==""?c.parent().ticket_field1_title:"Field 1"}else{if(b=="field_2"){d=c.ofProject()&&c.parent().ticket_field2_title&&!c.parent().ticket_field2_title==""?c.parent().ticket_field2_title:"Field 2"}else{if(b=="field_3"){d=c.ofProject()&&c.parent().ticket_field3_title&&!c.parent().ticket_field3_title==""?c.parent().ticket_field3_title:"Field 3"}else{d=Ticket.fieldHeading(b).name}}}}return[d,b,(c.fields.indexOf(b)>=0)]});var p=[[["Priority","priority"],[[["is","eq"],["is not","neq"],["is greater than","gt"],["is less than","lt"]],c.conditionFor("priority").expression],[($.merge([["anything","any"]],Ticket.validPriorityList)),c.conditionFor("priority").value]]];var l={leftCells:[]},i="";l.projects=[$.merge([["No Change","no_change"]],Person.current().projectsByPermission("canCreateTickets").filter(function(a){return!a.archived}).map(function(a){return[a.title,a.id]})),"no_change"];l.priorities=[$.merge([["No Change","no_change"]],Ticket.validPriorityList),"no_change"];l.dueOnCells='<td class="label" align="right">Due On:</td><td>        <div style="position: relative;">'+Unfuddle.Template.Helpers.datePicker({domId:"tickets_update_due_on",idsToHide:'["#tickets_update_status"]',allowNil:true,nilText:"No Change",allowNone:true,noneText:"No Date"})+"</div>      </td>";if(self.canReadMilestones){var z=c.ofProject()?Milestone.find({conditions:{project_id:f.project_id,archived:false},order:["object.title.toLowerCase()"]}):Milestone.find({conditions:{archived:false},order:["Project.find(object.project_id)[0].title.toLowerCase()","object.title.toLowerCase()"]});p.push([["Milestone","milestone"],[[["is","eq"],["is not","neq"]],c.conditionFor("milestone").expression],[$.merge($.merge([["anything","any"],["next upcoming","next_upcoming"]],z.map(function(a){return[c.ofProject()?a.title:(Project.find(a.project_id)[0].title+": "+a.title),a.id]})),[["&lt;none&gt;","0"]]),c.conditionFor("milestone").value]]);l.milestoneCells='<td class="label" align="right">Milestone:</td>         <td>           <select id="tickets_update_milestone" class="select_box">';$.each($.merge([["No Change","no_change"],["&lt;none&gt;","none"]],z.filter(function(a){return!a.completed}).map(function(a){return[c.ofProject()?a.title:(Project.find(a.project_id)[0].title+": "+a.title),a.id]})),function(a,b){l.milestoneCells+="                  <option "+(b[1]=="no_change"?'selected="selected" ':"")+'value="'+b[1]+'">'+b[0]+"</option>"});l.milestoneCells+="           </select>         </td>"}if(self.canReadPeople){var v=c.ofProject()?c.parent().involvedPeople():Account.current().people();p.push([["Assignee","assignee"],[[["is","eq"],["is not","neq"]],c.conditionFor("assignee").expression],[$.merge($.merge([["anybody","any"],["the person viewing the report","current"]],v.map(function(a){return[(a.id==Person.current().id?("Me ("+soy.$$escapeHtml(a.displayName())+")"):soy.$$escapeHtml(a.displayName())),a.id]})),[["&lt;none&gt;","0"]]),c.conditionFor("assignee").value]]);p.push([["Reporter","reporter"],[[["is","eq"],["is not","neq"]],c.conditionFor("reporter").expression],[$.merge([["anybody","any"],["the person viewing the report","current"]],v.map(function(a){return[(a.id==Person.current().id?("Me ("+soy.$$escapeHtml(a.displayName())+")"):soy.$$escapeHtml(a.displayName())),a.id]})),c.conditionFor("reporter").value]]);l.people=[$.merge([["No Change","no_change"],["<unassigned>","none"]],v.map(function(a){return[(a.id==Person.current().id?("Me ("+soy.$$escapeHtml(a.displayName())+")"):soy.$$escapeHtml(a.displayName())),a.id]})),"no_change"]}p.push([["Status","status"],[[["is","eq"],["is not","neq"]],c.conditionFor("status").expression],[$.merge([["anything","any"]],Ticket.validStatusList()),c.conditionFor("status").value]]);l.statusCells='<td class="label" align="right">Status:</td>       <td>         <select id="tickets_update_status" class="select_box">';$.each($.merge([["No Change","no_change"]],Ticket.validStatusList()),function(a,b){l.statusCells+="                <option "+(b[1]=="no_change"?'selected="selected" ':"")+'value="'+b[1]+'">'+b[0]+"</option>"});l.statusCells+="         </select>       </td>";p.push([["Resolution","resolution"],[[["is","eq"],["is not","neq"]],c.conditionFor("resolution").expression],[$.merge($.merge([["anything","any"]],Ticket.validResolutionList()),[["&lt;none&gt;","0"]]),c.conditionFor("resolution").value]]);l.resolutionCells='<select id="tickets_update_resolution" class="select_box">';$.each(Ticket.validResolutionList(),function(a,b){l.resolutionCells+="                <option "+(b[1]=="fixed"?'selected="selected" ':"")+'value="'+b[1]+'">'+b[0]+"</option>"});l.resolutionCells+="         </select>";var w=c.ofProject()?Severity.find({conditions:{project_id:c.parent().id},order:["object.name.toLowerCase()"]}):Severity.find({order:["object.project().title.toLowerCase()","object.name.toLowerCase()"]});p.push([["Severity","severity"],[[["is","eq"],["is not","neq"]],c.conditionFor("severity").expression],[$.merge($.merge([["anything","any"]],w.map(function(a){return[(c.ofProject()?a.name:(a.project().title+": "+a.name)),a.id]})),[["&lt;none&gt;","0"]]),c.conditionFor("severity").value]]);if(w.length){i='<td class="label" align="right">Severity:</td>         <td>           <select id="tickets_update_severity" class="select_box">';$.each($.merge([["No Change","no_change"],["&lt;none&gt;","none"]],w.map(function(a){return[(c.ofProject()?a.name:(a.project().title+": "+a.name)),a.id]})),function(a,b){i+="                  <option "+(b[1]=="no_change"?'selected="selected" ':"")+'value="'+b[1]+'">'+b[0]+"</option>"});i+="           </select>         </td>";l.leftCells.push(i)}var x=c.ofProject()?Component.find({conditions:{project_id:c.parent().id}}):Component.find({order:["object.project().title","name"]});p.push([["Component","component"],[[["is","eq"],["is not","neq"]],c.conditionFor("component").expression],[$.merge($.merge([["anything","any"]],x.map(function(a){return[(c.ofProject()?a.name:(a.project().title+": "+a.name)),a.id]})),[["&lt;none&gt;","0"]]),c.conditionFor("component").value]]);if(x.length){i='<td class="label" align="right">Component:</td>           <td>             <select id="tickets_update_component" class="select_box">';$.each($.merge([["No Change","no_change"],["&lt;none&gt;","none"]],x.map(function(a){return[(c.ofProject()?a.name:(a.project().title+": "+a.name)),a.id]})),function(a,b){i+="                    <option "+(b[1]=="no_change"?'selected="selected" ':"")+'value="'+b[1]+'">'+b[0]+"</option>"});i+="             </select>           </td>";l.leftCells.push(i)}var y=c.ofProject()?Version.find({conditions:{project_id:c.parent().id}}):Version.find({order:["object.project().title","name"]});p.push([["Version","version"],[[["is","eq"],["is not","neq"]],c.conditionFor("version").expression],[$.merge($.merge([["anything","any"]],y.map(function(a){return[(c.ofProject()?a.name:(a.project().title+": "+a.name)),a.id]})),[["&lt;none&gt;","0"]]),c.conditionFor("version").value]]);if(y.length){i='<td class="label" align="right">Version:</td>           <td>             <select id="tickets_update_version" class="select_box">';$.each($.merge([["No Change","no_change"],["&lt;none&gt;","none"]],y.map(function(a){return[(c.ofProject()?a.name:(a.project().title+": "+a.name)),a.id]})),function(a,b){i+="                    <option "+(b[1]=="no_change"?'selected="selected" ':"")+'value="'+b[1]+'">'+b[0]+"</option>"});i+="             </select>           </td>";l.leftCells.push(i)}if((c.ofProject()&&c.parent().ticket_field1_active)||!c.ofProject()){var B=c.ofProject()?CustomFieldValue.find({conditions:{project_id:c.parent().id,field_number:1}}):CustomFieldValue.find({conditions:{field_number:1}},{order:["object.project().title","value"]});p.push([[(c.ofProject()&&c.parent().ticket_field1_title&&!c.parent().ticket_field1_title==""?c.parent().ticket_field1_title:"Field 1"),"field_1"],[[["is","eq"],["is not","neq"]],c.conditionFor("field_1").expression],[$.merge($.merge([["anything","any"]],B.map(function(a){return[(c.ofProject()?a.value:(a.project().title+": "+a.value)),a.id]})),[["&lt;none&gt;","0"]]),c.conditionFor("field_1").value]])}if((c.ofProject()&&c.parent().ticket_field1_active)){i='<td class="label" align="right">'+(c.parent().ticket_field1_title&&!c.parent().ticket_field1_title==""?soy.$$escapeHtml(c.parent().ticket_field1_title):"Field 1")+":</td>         <td>";if(c.parent().ticket_field1_disposition=="list"){i+='<select id="tickets_update_field1_value_id" class="select_box" style="width:100%">';$.each($.merge([["No Change","no_change"],["&lt;none&gt;","none"]],CustomFieldValue.find({conditions:{project_id:c.parent().id,field_number:1}}).map(function(a){return[(c.ofProject()?a.value:(a.project().title+": "+a.value)),a.id]})),function(a,b){i+="                  <option "+(b[1]=="no_change"?'selected="selected" ':"")+'value="'+b[1]+'">'+b[0]+"</option>"});i+="           </select>"}else{i+='          <input type="text" value="No Change" style="width: 100%;" name="field1_value" id="tickets_update_field1_value" />'}i+="        </td>";l.leftCells.push(i)}if((c.ofProject()&&c.parent().ticket_field2_active)||!c.ofProject()){var C=c.ofProject()?CustomFieldValue.find({conditions:{project_id:c.parent().id,field_number:2}}):CustomFieldValue.find({conditions:{field_number:2}},{order:["object.project().title","value"]});p.push([[(c.ofProject()&&c.parent().ticket_field2_title&&!c.parent().ticket_field2_title==""?c.parent().ticket_field2_title:"Field 2"),"field_2"],[[["is","eq"],["is not","neq"]],c.conditionFor("field_2").expression],[$.merge($.merge([["anything","any"]],C.map(function(a){return[(c.ofProject()?a.value:(a.project().title+": "+a.value)),a.id]})),[["&lt;none&gt;","0"]]),c.conditionFor("field_2").value]])}if((c.ofProject()&&c.parent().ticket_field2_active)){i='<td class="label" align="right">'+(c.parent().ticket_field2_title&&!c.parent().ticket_field2_title==""?soy.$$escapeHtml(c.parent().ticket_field2_title):"Field 2")+":</td>         <td>";if(c.parent().ticket_field2_disposition=="list"){i+='<select id="tickets_update_field2_value_id" class="select_box" style="width:100%">';$.each($.merge([["No Change","no_change"],["&lt;none&gt;","none"]],CustomFieldValue.find({conditions:{project_id:c.parent().id,field_number:2}}).map(function(a){return[(c.ofProject()?a.value:(a.project().title+": "+a.value)),a.id]})),function(a,b){i+="                  <option "+(b[1]=="no_change"?'selected="selected" ':"")+'value="'+b[1]+'">'+b[0]+"</option>"});i+="           </select>"}else{i+='          <input type="text" value="No Change" style="width: 100%;" name="field1_value" id="tickets_update_field2_value" />'}i+="        </td>";l.leftCells.push(i)}if((c.ofProject()&&c.parent().ticket_field3_active)||!c.ofProject()){var D=c.ofProject()?CustomFieldValue.find({conditions:{project_id:c.parent().id,field_number:3}}):CustomFieldValue.find({conditions:{field_number:3}},{order:["object.project().title","value"]});p.push([[(c.ofProject()&&c.parent().ticket_field3_title&&!c.parent().ticket_field3_title==""?c.parent().ticket_field3_title:"Field 3"),"field_3"],[[["is","eq"],["is not","neq"]],c.conditionFor("field_3").expression],[$.merge($.merge([["anything","any"]],D.map(function(a){return[(c.ofProject()?a.value:(a.project().title+": "+a.value)),a.id]})),[["&lt;none&gt;","0"]]),c.conditionFor("field_3").value]])}if((c.ofProject()&&c.parent().ticket_field3_active)){i='<td class="label" align="right">'+(c.parent().ticket_field3_title&&!c.parent().ticket_field3_title==""?soy.$$escapeHtml(c.parent().ticket_field3_title):"Field 3")+":</td>         <td>";if(c.parent().ticket_field3_disposition=="list"){i+='<select id="tickets_update_field3_value_id" class="select_box" style="width:100%">';$.each($.merge([["No Change","no_change"],["&lt;none&gt;","none"]],CustomFieldValue.find({conditions:{project_id:c.parent().id,field_number:3}}).map(function(a){return[(c.ofProject()?a.value:(a.project().title+": "+a.value)),a.id]})),function(a,b){i+="                  <option "+(b[1]=="no_change"?'selected="selected" ':"")+'value="'+b[1]+'">'+b[0]+"</option>"});i+="           </select>"}else{i+='          <input type="text" value="No Change" style="width: 100%;" name="field1_value" id="tickets_update_field3_value" />'}i+="        </td>";l.leftCells.push(i)}p.push([["Due on","due_on"],[[["is","eq"]],"eq"],[[["anything","any"],["before today","before_today"],["after today","after_today"],["in the next 7 days","next_7_days"],["in the next 30 days","next_30_days"],["in the last 7 days","last_7_days"],["in the last 30 days","last_30_days"]],c.conditionFor("due_on").value]]);self.locals=$.extend({},self.locals,{validGroupByList:q,validSortByList:k,fieldsList:u,criteriaList:p,bulkUpdateOptions:l});self.locals.conditions=[];if(c.conditions_string){$.each(c.conditions_string.split(","),function(d,h){if(h){if(!h.include("|")){if(h.split("-")[2]){self.locals.conditions.push([h.split("-")])}}else{var g=[];$.each(h.split("|"),function(a,b){if(b.split("-")[2]){g.push(b.split("-"))}});self.locals.conditions.push(g)}}})}$("#report_options_dialog").html(Unfuddle.Template.Ticket.reportOptionsDialog({locals:self.locals}));$("#tickets_update_dialog").html(Unfuddle.Template.Ticket.ticketsUpdateDialog({locals:self.locals}));Helpers.markupContainer($("#tickets_update_resolution_description_markup_wrapper"),{attachments:false,domID:"tickets_update_resolution_description",collapsed:true});$("#tickets_update_resolution_description").height("auto");if(self.options.new_report=="true"){$("#report_options_regenerate_submit").val("Generate Report");self.currentScope=Config.currentProjectID?Project.current():Account.current();var E=(self.currentScope.actual_default_ticket_report_id()?self.currentScope.actual_default_ticket_report_id():"dynamic");var F=Bookmarker.bookmarkFor(Config.currentProjectID?"project_ticket_report_show":"ticket_report_show",{ticket_report_id:E,ajaxLinks:true});$("#report_options_form_cancel").attr({href:F,onClick:""});delete self.options.new_report}this.populateOrCriteria=function(g,n,m){var o=m[0]||"none";var e="";var j="";if(o!="none"){$.each(self.locals.criteriaList,function(d,h){if(o==h[0][1]){$.each(h[1][0],function(a,b){e+="<option value='"+b[1]+"'"+(m[1]&&m[1]==b[1]?"selected='selected'":"")+">"+b[0]+"</option>"});$.each(h[2][0],function(a,b){j+="<option value='"+b[1]+"'"+(m[2]&&m[2]==b[1]?"selected='selected'":"")+">"+b[0]+"</option>"})}})}$("#condition_criteria_exp_"+g+"_"+n).html(e);$("#condition_criteria_value_"+g+"_"+n).html(j);return false};this.renderAndBox=function(a,b){var d=b||false;$("#statements_here").append(Unfuddle.Template.Ticket.criteriaAndOptions({and:a}));self.locals.criteria.total++;self.actionsOnAnd(a);self.locals.criteria[(self.locals.criteria.total).toString()]=0;if(d){self.renderOrBox(a,["priority","eq","any"])}};this.renderOrBox=function(a,b){self.locals.criteria[a]++;$("#and_statement_box_"+a+"_body").append(Unfuddle.Template.Ticket.criteriaOrOptions({locals:self.locals,and:a,or:self.locals.criteria[a],defaultOr:b}));self.actionsOnOr(a,self.locals.criteria[a]);self.populateOrCriteria(a,self.locals.criteria[a],b)};this.actionsOnAnd=function(a){if(a!="1"){$("#delete_and_"+a).click(function(){$("#and_statement_table_"+a).remove();return false})}$("#add_another_or_"+a).click(function(){self.renderOrBox(a,["priority","eq","any"]);return false})};this.actionsOnOr=function(b,d){$("#condition_criteria_field_"+b+"_"+d).change(function(){var a=[this.value,null,null];self.populateOrCriteria(b,d,a)});if(b!="1"||d!=1){$("#delete_or_"+b+"_"+d).click(function(){if(b!="1"&&$(".statement_box_in_"+b).length==1){$("#and_statement_table_"+b).remove()}else{$("#or_statement_box_"+b+"_"+d).remove()}return false})}};var A=function(){$("#statements_here").html("");self.locals.criteria={total:0};if(!c.conditions_string){self.renderAndBox("1",true)}else{$.each(self.locals.conditions,function(d,h){self.renderAndBox((d+1).toString());$.each(h,function(a,b){self.renderOrBox((d+1).toString(),b)})})}};A();$("#report_options_form_cancel").click(function(){$("#report_options_dialog").hide();A();return false});$("#add_another_and").click(function(){self.renderAndBox((self.locals.criteria.total+1).toString(),true);self.actionsOnAnd((self.locals.criteria.total+1).toString());return false});$("#report_options_delete_report").click(function(){if(!f.ticket_report_id){return false}Helpers.toggle_ajax_working(true);if(confirm("Are you sure you want to delete this ticket report?")){var a=TicketReport.find({sourceUrl:self.baseUrl+f.ticket_report_id})[0];if(f.project_id){a.project_id=f.project_id}a.destroy(function(){if(a.action_results.success){Helpers.toggle_ajax_working(false);UI.Bookmarker.redirectTo("#"+self.baseUrl+(self.currentScope.default_ticket_report_id||(self.ticketReports.length?self.ticketReports[0].id:"dynamic")),true)}else{Helpers.toggle_ajax_working(false);alert(a.action_results.errors.join("\n"))}})}return false});$("#report_options_save_submit").click(function(){s();var a=this;Helpers.toggleAjaxBttn(a,true);$("#report_options_regenerate_submit").attr("disabled",true);var b=f.ticket_report_id?TicketReport.find({sourceUrl:self.baseUrl+f.ticket_report_id})[0]:c;b.conditions_string=$("#ticket_report_conditions_string").val()||"priority-eq-any";b.fields_string=$("#ticket_report_fields_string").val();b.sort_direction=$("#report_options_sort_direction").val();b.sort_by=$("#report_options_sort_by").val();b.group_by=$("#report_options_group_by").val();b.title=$("#report_options_title").val();if(self.options.project_id){b.project_id=self.options.project_id}b.save(function(){if(b.action_results.success){UI.Bookmarker.redirectTo((b.ofProject()?("#/projects/"+b.parent_id+"/ticket_reports/"+b.id):"#/ticket_reports/"+b.id),true)}else{Helpers.toggleAjaxBttn(a,false);$("#report_options_regenerate_submit").attr("disabled",false);alert(b.action_results.errors.join("\n"))}});return false});$("#report_options_regenerate_submit,#report_refresh_link").click(function(){var b=$("#report_options_regenerate_submit");if(b.is(":disabled")){return}Helpers.toggleAjaxBttn(b,true);$("#report_options_save_submit").attr("disabled",true);s();if(self.report.id){var d=self.report.id;var h=new TicketReport.Base({conditions_string:$("#ticket_report_conditions_string").val(),fields_string:$("#ticket_report_fields_string").val(),sort_direction:$("#report_options_sort_direction").val(),sort_by:$("#report_options_sort_by").val(),group_by:$("#report_options_group_by").val(),title:$("#report_options_title").val(),parent_type:self.options.project_id?"Project":"Account",parent_id:self.options.project_id?self.options.project_id:Account.current().id});TicketReport.generate(h,{local:false,pretty:true,exclude_description:true,callback:function(a){self.report=new TicketReport.Base(a);self.report.id=c.id;self.report.processData();self.regenerated=true;Helpers.toggleAjaxBttn(b,false);self.refresh()}})}else{$.extend(self.report,{conditions_string:$("#ticket_report_conditions_string").val(),fields_string:$("#ticket_report_fields_string").val(),sort_direction:$("#report_options_sort_direction").val(),sort_by:$("#report_options_sort_by").val(),group_by:$("#report_options_group_by").val(),title:$("#report_options_title").val(),parent_type:self.options.project_id?"Project":"Account",parent_id:self.options.project_id?self.options.project_id:Account.current().id});UI.Bookmarker.redirectTo(TicketReport.getDynamicUrl(self.report)+"&show_options=true",true)}return false});$("#tickets_update_form").submit(function(){var e=$("#tickets_update_submit");Helpers.toggleAjaxBttn(e,true);self.selectedTickets=$.makeArray($("#tickets_report_table .ticket_select:checked").map(function(a,b){return parseInt(b.id.split("_")[2])}))||[];var j={tickets_update_action:$("#tickets_update_action").val()};if(j.tickets_update_action=="change_attributes"){$.each(["project","priority","status","assignee","severity","milestone","component","version","field_1_value_id","field1_value","field1_value_id","field2_value","field3_value","field3_value_id","field2_value_id","due_on","optional_comment_change_attributes"],function(a,b){j[b]=$("#tickets_update_"+b).val()})}else{$.extend(j,{close_simultaneously:$("#close_simultaneously").is(":checked")?1:0,resolution:$("#tickets_update_resolution").val(),resolution_description:$("#tickets_update_resolution_description").val(),resolution_description_format:$("#tickets_update_resolution_description_markup").val(),optional_comment_resolve:$("#tickets_update_optional_comment_resolve").val()})}var r=function(o){$.each(self.selectedTickets,function(a,b){t=Ticket.find(b);Ticket.Cache.unCache(t)});$.each(o.groups,function(n,m){$.each(m.tickets,function(d,h){var g=["field1_value_id","field2_value_id","field3_value_id"];$.each(g,function(a,b){if(h[b]){self.dependsOn("CustomFieldValue","/projects/"+h.project_id+"/custom_field_values/"+h[b],{essential:true})}})})});return false};$.ajax({type:"POST",beforeSend:function(a){if(this.dataType!="script"&&UI.Helpers.checkSessionExpired()){return false}if(location.protocol=="https:"){a.setRequestHeader("X-Unfuddle-Ajax-Secure",1)}a.setRequestHeader("X-Unfuddle-Ajax-Client",1);a.setRequestHeader("X-HTTP-METHOD-OVERRIDE","PUT")},url:Config.baseApiUrl+self.baseUrl+"bulk_update.json",dataType:"application/json",data:$.extend({},j,{selected_tickets:self.selectedTickets.join(",")}),success:function(){TicketReport.generate(self.report,{local:false,callback:function(a){r(a);self.report=null;self.report=new TicketReport.Base(a);self.report.processData();self.options.show_options=false;self.renderMainLocked=false;Helpers.toggleAjaxBttn(e,false);self.render()}})},error:function(a){var b=[];try{b=JSON.parse(a.responseText)}catch(err){}if(b.length<=0){b=["An unexpected error occured. Please try again!"]}alert(b.join("\n"))}});return false})};this.renderReportTickets=function(n){n=$.extend({},{stopAtTicketIndex:-1,report:self.report},n);var m=-1;var o=0;var e="";var j=true;n.report.groups.forEach(function(a){var b=a.tickets.length;for(var d=0;d<b;d++){m++;if(m<=self.lastTicketIndex){continue}else{if(n.stopAtTicketIndex!=-1&&m>n.stopAtTicketIndex){j=false;m--;break}else{if(d==0){e+=Unfuddle.Template.Ticket.ticketReportGroupHeading({locals:self.locals,group:a,groupTicketsCount:b,index:o})}e+=Unfuddle.Template.Ticket.ticketReportTicket({locals:self.locals,ticket:a.tickets[d],index:d});if(d==b-1&&self.report.hasTimeTrackingFields){e+=Unfuddle.Template.Ticket.ticketReportGroupFooter({locals:self.locals,group:a})}}}}if(j==false){return false}o++});if(!j){e+=Unfuddle.Template.Ticket.ticketReportShowMore({locals:self.locals,ticketIndex:m})}self.lastTicketIndex=m;$("#show_more_links").remove();$("#tickets_report_table").append(e);if(self.selectedTickets){self.selectedTickets.forEach(function(a){$("#ticket_select_"+a).attr("checked",true)});delete(self.selectedTickets)}self.report.fields.forEach(function(g){$(".field_heading_"+g).click(function(){s();var d=this;Helpers.toggleAjaxBttn(d,true);$("#report_options_save_submit").attr("disabled",true);var h=new TicketReport.Base(self.report);self.report.sort_direction=self.report.sort_by==g?(self.report.sort_direction=="ASC"?"DESC":"ASC"):"ASC";self.report.sort_by=g;if(self.report.groups){$.each(self.report.groups,function(a,b){b.tickets=Ticket.sort(b.tickets,self.report.sort_by,self.report.sort_direction)})}if($("#report_options_dialog").is(":visible")){self.options.show_options=true}else{self.options.show_options=null}self.renderMainLocked=false;self.regenerated=true;Helpers.toggleAjaxBttn(d,false);self.render();return false})});$("#show_all_tickets").click(function(){self.renderReportTickets({stopAtTicketIndex:-1});return false});$("#show_more_tickets").click(function(){self.renderReportTickets({stopAtTicketIndex:self.lastTicketIndex+500});return false})};this.show()};

UI.NotebookIndex=function(g){this.tmp=Unfuddle.UI.Renderer;this.tmp(g);delete this.tmp;this.containerID="#content";this.domID="#notebook_index";var self=this;this.verifyPermissions=function(){return Globals.currentPerson.seeIf(Project.current(),"canReadNotebooks")};this.dependsOn("Notebook","/projects/"+g.project_id+"/notebooks",{essential:true});this.addJsTemplate("notebook");this.checkBeforeRender=function(){self.pagesReady=true;$.each(Notebook.find({sourceUrl:"/projects/"+self.options.project_id+"/notebooks"}),function(d,b){self.dependsOn("Page","/projects/"+self.options.project_id+"/notebooks/"+b.id+"/pages",{callback:self.renderPages});if(Page.find({sourceUrl:"/projects/"+self.options.project_id+"/notebooks/"+b.id+"/pages"}).pending){self.pagesReady=null}});return true};this.notify=function(d){this.render()};this.renderMainLocked=false;this.renderMain=function(){if(this.renderMainLocked){return}this.renderMainLocked=true;this.holder=$("<div class='domID'/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);var h={canCreateNotebooks:Person.current().seeIf(Project.current(),"canCreateNotebooks"),canManageNotebooks:Person.current().seeIf(Project.current(),"canManageNotebooks"),canReadPeople:Person.current().seeIf(Project.current(),"canReadPeople"),project:Project.current(),notebooks:Notebook.find({conditions:{project_id:g.project_id},order:"title"}),pagesReady:self.pagesReady};$.each(h.notebooks,function(d,b){b.resourceUrl=self.pagesReady?b.defaultPage()?("#/projects/"+g.project_id+"/notebooks/"+b.id+"/pages/"+b.defaultPage().rootPage().id+"/latest"):"#/projects/"+g.project_id+"/notebooks/"+b.id:b.default_page_number?("#/projects/"+g.project_id+"/notebooks/"+b.id+"/pages/by_number/"+b.default_page_number):"#/projects/"+g.project_id+"/notebooks/"+b.id;b.uniquePages_=b.uniquePages();b._pagesCount=self.pagesReady?b.uniquePages_.length:" ?";b.mostRecent_=b.mostRecent();b.updatedAtFormatted=Utilities.formatDate(b.updated_at,{format:"withTime"});if(b.mostRecent_){b.authorDisplayName=Person.find(b.mostRecent().author_id)[0]?Person.find(b.mostRecent().author_id)[0].displayName():"";b.recentUpdatedAtFormatted=Utilities.formatDate(b.mostRecent().updated_at,{format:"withTime"});b.recentMessageFormatted=Utilities.formatText(b.mostRecent().message,{format:"plain",constrain:"80",notebook:b,project:Project.current(),person:Person.current()})}});this.holder.append(Unfuddle.Template.Notebook.index({locals:h}));if($.browser.msie&&$.browser.version>="7.0"&&$.browser.version<"8.0"){setTimeout("document.body.className = document.body.className",500);setTimeout("document.body.className = document.body.className",1000);setTimeout("document.body.className = document.body.className",1500)}$("#new_notebook_form").submit(function(){Helpers.toggleAjaxBttn($("#new_notebook_submit"),true);if($("#new_notebook_title").val()==""){alert("Notebook title cannot be blank.");Helpers.toggleAjaxBttn($("#new_notebook_submit"),false);return false}var d=new Notebook.Base({project_id:g.project_id,title:$("#new_notebook_title").val()});d.save(function(){if(!(d.action_results&&d.action_results.success)){alert(d.action_results.errors.join(",\n"))}});Helpers.toggle_ajax_working(false);Helpers.toggleAjaxBttn($("#new_notebook_submit"),false);self.renderMainLocked=false;return false});$.each(h.notebooks,function(b,f){$("#notebook_edit_"+f.id+"_link").click(function(){if(!self.pagesReady){self.editNotebookNumberPending=f.id}else{Helpers.notebook_edit(f.id)}});$("#list_notebook_edit_"+f.id).submit(function(){Helpers.toggleAjaxBttn($("#list_notebook_edit_"+f.id+"_submit"),true);if($("#notebook_title_"+f.id).val()==""){alert("Notebook title cannot be blank.");Helpers.toggleAjaxBttn($(this),false);return false}var d={title:$("#notebook_title_"+f.id).val(),default_page_number:$("#list_notebook_edit_"+f.id+"_page").val()};self.renderMainLocked=false;f.save(d);Helpers.toggle_ajax_working(false);return false})});if(self.pagesReady&&self.editNotebookNumberPending){Helpers.notebook_edit(self.editNotebookNumberPending);delete(self.editNotebookNumberPending)}if(!self.pagesReady){self.renderPages()}};this.renderPages=function(){var f=true;$.each(Notebook.find({sourceUrl:"/projects/"+self.options.project_id+"/notebooks"}),function(d,b){if(Page.find({sourceUrl:"/projects/"+self.options.project_id+"/notebooks/"+b.id+"/pages"}).pending){f=false;return false}});if(!f){return}self.pagesReady=true;self.refresh()};this.show()};UI.NotebookShow=function(e){this.tmp=Unfuddle.UI.Renderer;this.tmp(e);delete this.tmp;this.containerID="#content";this.domID="#notebook_show";var self=this;this.verifyPermissions=function(){return Globals.currentPerson.seeIf(Project.current(),"canReadNotebooks")};this.dependsOn("Notebook","/projects/"+e.project_id+"/notebooks/"+e.notebook_id,{essential:true});this.dependsOn("Attachment","/projects/"+e.project_id+"/notebooks/"+e.notebook_id+"/attachments",{essential:true});this.dependsOn("Page","/projects/"+e.project_id+"/notebooks/"+e.notebook_id+"/pages",{essential:true});this.addJsTemplate("notebook");this.addJsTemplate("page");this.checkBeforeRender=function(){this.notebook=Notebook.find({conditions:{project_id:e.project_id,id:e.notebook_id}});if(this.notebook.pending){return false}else{this.notebook=this.notebook[0]}return true};this.notify=function(d){this.render()};this.renderMainLocked=false;this.renderMain=function(){if(this.renderMainLocked){return}this.renderMainLocked=true;var k=true;this.holder=$("<div class='domID'/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);var c={canManageNotebooks:Person.current().seeIf(Project.current(),"canManageNotebooks"),canReadPeople:Person.current().seeIf(Project.current(),"canReadPeople"),isAdministrator:Person.current().seeIf(Project.current(),"isAdministrator"),project:Project.current(),notebook:this.notebook,options:e,hasFeatureAttachments:Project.current().hasFeature("attachments")};c.notebook.resourceUrl=c.notebook.defaultPage()?("#/projects/"+e.project_id+"/notebooks/"+c.notebook.id+"/pages/"+c.notebook.defaultPage().rootPage().id+"/latest"):"#/projects/"+e.project_id+"/notebooks/"+c.notebook.id;c.notebook.uniquePages_=c.notebook.uniquePages();c.notebook._pagesCount=c.notebook.uniquePages_.length;c.notebook.defaultPage_=c.notebook.defaultPage();c.notebook.updatedAtFormatted=Utilities.formatDate(c.notebook.updated_at,{format:"withTime"});c.notebook.attachments=c.notebook.attachmentsCollection();c.notebook.fileSize_=c.notebook.fileSize();$.each(c.notebook.uniquePages_,function(d,b){b.root_page=b.rootPage();b.authorDisplayName=Person.find(b.author_id)[0]?Person.find(b.author_id)[0].displayName():"";b.updatedAtFormatted=Utilities.formatDate(b.updated_at,{format:"withTime"});b.updatedAtFormattedText=$(b.updatedAtFormatted).text();b.messageFormatted=Utilities.formatText(b.message,{format:"compact",constrain:"80",page:b,project:Project.current(),person:Person.current()})});$.each(c.notebook.attachments,function(d,a){a.sizeFormatted=Utilities.formatBytes(a.size);a.updatedAtFormatted=Utilities.formatDate(a.updated_at,{format:"with_time"})});if(e.route=="notebook_attachments"){this.holder.append(Unfuddle.Template.Notebook.attachments({locals:c}))}else{if(e.route=="notebook_show"||e.route=="notebook_page_new"){this.holder.append(Unfuddle.Template.Notebook.show({locals:c}))}else{c.notebookActivity=Page.Cache.read({conditions:{notebook_id:e.notebook_id,evaluate:"Math.round(((new Date()) - object.updated_at)/(1000*60*60*24))<=14"},order:["updated_at DESC"]});$.each(c.notebookActivity,function(d,b){b.createdAtFormatted=Utilities.formatDate(b.created_at,{prefix:true});b.authorDisplayName=Person.find(b.author_id)[0]?Person.find(b.author_id)[0].displayName():"";b.headPage_=b.headPage();b.rootPage_=b.rootPage();b.messageFormatted=Utilities.formatText(b.message,{format:"plain"})});this.holder.append(Unfuddle.Template.Notebook.activity({locals:c}))}}if($.browser.msie&&$.browser.version>="7.0"&&$.browser.version<"8.0"){setTimeout("document.body.className = document.body.className",500);setTimeout("document.body.className = document.body.className",1000);setTimeout("document.body.className = document.body.className",1500)}Unfuddle.UI.Helpers.markupContainer(this.holder.find("#new_page_formatted_body_container"),{attachments:false,domID:"new_page_body",unfParams:{project:Project.find(self.notebook.project_id)[0],notebook:self.notebook}});var j=function(){c.notebook.attachments=c.notebook.attachmentsCollection();c.notebook.fileSize_=c.notebook.fileSize();$.each(c.notebook.attachments,function(d,a){a.sizeFormatted=Utilities.formatBytes(a.size);a.updatedAtFormatted=Utilities.formatDate(a.updated_at,{format:"with_time"})});$("#notebook_heading").html(Unfuddle.Template.Notebook.heading({locals:c,title:"Attachments"}));if($("#show_page_new_attachments")[0]){$("#show_page_new_attachments").html(Unfuddle.Template.Notebook.attachmentsMini({locals:c,domId:"new"}));$("#notebook_new_show_attach_submit").click(function(){i("new_page_form",this)});$("#notebook_show_attachments").html(Unfuddle.Template.Notebook.notebookAttachments({locals:c}));$("#notebook_show_attach_submit").click(function(){i("attachments_page",this)})}$.each(c.notebook.attachments,function(d,a){$(".notebook_attachment_delete_"+a.id).click(function(){if(confirm("Are you sure you want to permanently delete this attachment?")){a.project_id=e.project_id;Helpers.toggle_ajax_working(true);a.destroy(function(){if(a.action_results.success){Helpers.toggle_ajax_working(false);j()}else{Helpers.toggle_ajax_working(false);alert("Could not delete attachment")}})}return false})});if(!k){$("#show_page_new_attachments .notebook_attachment_panel, #notebook_heading h1 span, #notebook_attachments_list tr").effect("highlight",{},1000)}};var i=function(h,g){Helpers.toggleAjaxBttn(g,true);var o=h=="new_page_form"?$("#notebook_new_file_input_list .file_input"):$("#notebook_file_input_list .file_input");var r=[];var l=[];var m=[];var n={submit_bttn:$(g)};o.each(function(b,f){if(f.value!=""){var a=new Attachment.Base({fileElementId:f.id,filename:f.value.split("\\").pop().split("/").pop(),parent_type:"Notebook",project_id:self.options.project_id});l.push({resource:a,action:function(d){a.upload(d)},onSuccess:function(){m.push({resource:a,action:function(d){a.parent_id=self.options.notebook_id;a.notebook_id=self.options.notebook_id;a.save(d)},onError:function(){Helpers.toggleAjaxBttn(g,false);Helpers.actionCallback(a,n)}})},onError:function(){Helpers.toggleAjaxBttn(g,false);Helpers.actionCallback(a,n)}})}});var p={onSuccess:function(){Helpers.toggleAjaxBttn(g,false);j()}};var q={onSuccess:function(){Utilities.eventChain(m,p)}};Utilities.eventChain(l,q);return false};$("#notebook_new_show_attach_submit").click(function(){i("new_page_form",this)});if(self.options.route=="notebook_attachments"){$("#notebook_show_attach_submit").click(function(){i("attachments_page",this)})}j();$("#new_page_link").click(function(){$("#new_page").show();$("#new_page_title").focus();return false});$("#show_page_new_submit").click(function(){if($("#new_page_title").val()==""){alert("Title cannot be blank!");return false}Helpers.toggleAjaxBttn(this,true);var d=this;var b=new Page.Base({project_id:self.options.project_id,notebook_id:self.options.notebook_id,title:$("#new_page_title").val(),body:$("#new_page_body").val(),body_format:$("#new_page_body_markup").val()});b.save(function(){Helpers.toggleAjaxBttn(d,false);if(b.action_results&&b.action_results.success){UI.Bookmarker.redirectTo("#/projects/"+self.options.project_id+"/notebooks/"+self.options.notebook_id+"/pages/"+b.id+"/latest");Globals.currentAccount.notebook_pages++}else{alert(b.action_results.errors.join(",\n"))}});return false});k=false;if(e.route=="notebook_page_new"){$("#new_page").show();$("#new_page_title").focus();if(e.title){$("#new_page_title").val(Url.decode(e.title.replace(/\+/g," ")))}}};this.show()};

UI.PageShow=function(d){this.tmp=Unfuddle.UI.Renderer;this.tmp(d);delete this.tmp;this.containerID="#content";this.domID="#page_holder";this.addJsTemplate("page");this.addJsTemplate("notebook");var self=this;self.currentYear=(new Date).getFullYear();this.dependsOn("Notebook","/projects/"+d.project_id+"/notebooks/"+d.notebook_id,{essential:true});this.dependsOn("Page","/projects/"+d.project_id+"/notebooks/"+d.notebook_id+"/pages",{essential:true});this.dependsOn("Attachment","/projects/"+d.project_id+"/notebooks/"+d.notebook_id+"/attachments",{essential:true});this.diffString=null;if(d.route=="compare_project_notebook_page"){$.get(Unfuddle.Config.baseApiUrl+"/projects/"+self.options.project_id+"/notebooks/"+self.options.notebook_id+"/pages/"+self.options.page_id+"/compare.diff",{version_a:d.version_a,version_b:d.version_b},function(e){self.diffString=Utilities.formatDiff(e);self.renderDiff()})}this.renderMain=function(){this.renderMainLocked=false;this.holder=$("<div/>").attr("id","page_holder").appendTo(this.containerID);var f=d.page_id?Page.find({conditions:{notebook_id:d.notebook_id,id:d.page_id}})[0]:Page.find({conditions:{notebook_id:d.notebook_id,number:d.page_number}})[0];if(d.route=="notebook_page_latest"||d.route=="notebook_page_show_by_number"){f=f.headPage()}this.page=f;var g=Notebook.find({conditions:{project_id:d.project_id,id:d.notebook_id}})[0];var o=f.versions().map(function(e){return e});var c={canManageNotebooks:Person.current().seeIf(Project.current(),"canManageNotebooks"),canReadPeople:Person.current().seeIf(Project.current(),"canReadPeople"),isAdministrator:Person.current().seeIf(Project.current(),"isAdministrator"),project:Project.current(),notebook:g,options:d,page:f,page_versions:o,showEdit:(d.route!="compare_project_notebook_page")&&Person.current().seeIf(Project.current(),"canManageNotebooks")&&((f.version&&f.version==f.versions()[0].version)||!f.version),hasFeatureAttachments:Project.current().hasFeature("attachments"),isMSIE:Utilities.isMSIE(),currentView:"show"};c.notebook.resourceUrl=c.notebook.defaultPage()?("#/projects/"+d.project_id+"/notebooks/"+c.notebook.id+"/pages/"+c.notebook.defaultPage().rootPage().id+"/latest"):"#/projects/"+d.project_id+"/notebooks/"+c.notebook.id;c.notebook.uniquePages_=c.notebook.uniquePages();c.notebook._pagesCount=c.notebook.uniquePages_.length;c.notebook.defaultPage_=c.notebook.defaultPage();c.notebook.updatedAtFormatted=Utilities.formatDate(c.notebook.updated_at,{format:"withTime"});c.notebook.attachments=c.notebook.attachmentsCollection();c.notebook.fileSize_=c.notebook.fileSize();c.page.pageVersions=Page.find({conditions:{notebook_id:g.id,number:f.number},order:["version asc"]});c.page.versions_=c.page.versions();c.page.version_a=c.page.versions()[0];c.page.version_b=c.page.versions()[1];$.each(c.notebook.pagesCollection(),function(e,b){b.rootPage_=b.rootPage();b.headPage_=b.headPage();b.nextVersion_=b.nextVersion();b.previousVersion_=b.previousVersion();b.authorDisplayName=Person.find(b.author_id)[0]?Person.find(b.author_id)[0].displayName():"";b.updatedAtFormatted=Utilities.formatDate(b.updated_at,{format:"withTime"});b.createdAtFormatted=Utilities.formatDate(b.created_at,{prefix:"true"});b.createdEqualsUpdated=b.createt_at==b.updated_at;b.messageFormatted=Utilities.formatText(b.message,{format:"compact"})});$.each(c.notebook.attachments,function(e,a){a.sizeFormatted=Utilities.formatBytes(a.size);a.updatedAtFormatted=Utilities.formatDate(a.updated_at,{format:"with_time"})});c.page.rootPage_=c.page.rootPage();if(d.route=="compare_project_notebook_page"){c.currentView="compare"}f.bodyFormatted=Utilities.formatText(f.body,{format:f.body_format,project:Project.find(d.project_id)[0],notebook:g,callback:function(e){f.bodyFormatted=e;self.render()}});this.holder.html(Unfuddle.Template.Page.show({locals:c}));if($.browser.msie&&$.browser.version>="7.0"&&$.browser.version<"8.0"){setTimeout("document.body.className = document.body.className",500);setTimeout("document.body.className = document.body.className",1000);setTimeout("document.body.className = document.body.className",1500)}Unfuddle.UI.Helpers.markupContainer(this.holder.find("#edit_page_formatted_body_container"),{attachments:false,domID:"edit_page_body",markup:f.body_format,unfParams:{project:Project.find(g.project_id)[0],notebook:g,page:f}});Unfuddle.UI.Helpers.markupContainer(this.holder.find("#new_page_formatted_body_container"),{attachments:false,domID:"new_page_body",unfParams:{project:Project.find(g.project_id)[0],notebook:g,page:f}});$("#new_page_link").click(function(){$("#new_page").show();$("#new_page_title").focus();return false});if(d.route=="compare_project_notebook_page"){$("#show_page_compare").html(Helpers.ajaxProgressSmall());this.renderDiff()}var k=function(p,h){Helpers.toggleAjaxBttn(h,true);var q=p=="new_page_form"?$("#notebook_new_file_input_list .file_input"):$("#notebook_edit_file_input_list .file_input");var t=[];var l=[];var m=[];var n={submit_bttn:$(h)};q.each(function(b,i){if(i.value!=""){var a=new Attachment.Base({fileElementId:i.id,filename:i.value.split("\\").pop().split("/").pop(),parent_type:"Notebook",project_id:self.options.project_id});l.push({resource:a,action:function(e){a.upload(e)},onSuccess:function(){m.push({resource:a,action:function(e){a.parent_id=self.options.notebook_id;a.notebook_id=self.options.notebook_id;a.save(e)},onError:function(){Helpers.toggleAjaxBttn(h,false);Helpers.actionCallback(a,n)}})},onError:function(){Helpers.toggleAjaxBttn(h,false);Helpers.actionCallback(a,n)}})}});var r={onSuccess:function(){Helpers.toggleAjaxBttn(h,false);j()}};var s={onSuccess:function(){Utilities.eventChain(m,r)}};Utilities.eventChain(l,s);return false};var j=function(){c.notebook.attachments=c.notebook.attachmentsCollection();c.notebook.fileSize_=c.notebook.fileSize();if($("#show_page_new_attachments")[0]){$("#show_page_new_attachments").html(Unfuddle.Template.Notebook.attachmentsMini({locals:c,domId:"new"}));$("#notebook_new_show_attach_submit").click(function(){k("new_page_form",this)})}if($("#show_page_edit_attachments")[0]){$("#show_page_edit_attachments").html(Unfuddle.Template.Notebook.attachmentsMini({locals:c,domId:"edit"}));$("#notebook_edit_show_attach_submit").click(function(){k("edit_page_form",this)})}$.each(c.notebook.attachments,function(e,a){a.sizeFormatted=Utilities.formatBytes(a.size);a.updatedAtFormatted=Utilities.formatDate(a.updated_at,{format:"with_time"});$(".notebook_attachment_delete_"+a.id).click(function(){if(confirm("Are you sure you want to permanently delete this attachment?")){a.project_id=d.project_id;Helpers.toggle_ajax_working(true);a.destroy(function(){if(a.action_results.success){Helpers.toggle_ajax_working(false);j()}else{Helpers.toggle_ajax_working(false);alert("Could not delete attachment")}})}return false})});$(".notebook_attachment_panel").effect("highlight",{},1000)};j();$("#show_page_new_submit").click(function(){if($("#new_page_title").val()==""){alert("Title cannot be blank!");return false}Helpers.toggleAjaxBttn(this,true);var e=this;var b=new Page.Base({project_id:self.options.project_id,notebook_id:self.options.notebook_id,title:$("#new_page_title").val(),body:$("#new_page_body").val(),body_format:$("#new_page_body_markup").val()});b.save(function(){Helpers.toggleAjaxBttn(e,false);if(b.action_results&&b.action_results.success){UI.Bookmarker.redirectTo("#/projects/"+self.options.project_id+"/notebooks/"+self.options.notebook_id+"/pages/"+b.id+"/latest",true)}else{alert(b.action_results.errors.join(",\n"))}});return false});$("#menu_view_page a, #notebook_cancel_edit_link").click(function(){if(c.currentView!="compare"){self.renderMainLocked=false;self.render();return false}});$("#menu_edit_page a").click(function(){self.renderMainLocked=true;Helpers.notebook_edit_page();return false});$("#menu_history_page a").click(function(){if(c.currentView!="compare"){self.renderMainLocked=true;Helpers.notebook_history_page();return false}});$("#menu_delete_page a").click(function(){if(confirm("Are you sure you want to permanently delete all versions of this page from the notebook? \n\nNOTE: Individual versions of a page cannot be deleted.")){self.renderMainLocked=true;var b=Page.find({conditions:{id:c.page.id,notebook_id:c.notebook.id}})[0];b.project_id=c.project.id;b.destroy(function(){if(b.action_results.success){Page.find({conditions:{number:b.number,notebook_id:b.notebook_id}}).forEach(function(e){Page.Cache.unCache(e)});Config.accountNotebookPagesTotal--;Globals.currentAccount.notebook_pages--;UI.Bookmarker.redirectTo("#/projects/"+c.project.id+"/notebooks/"+c.notebook.id)}else{alert(b.action_results.errors.split("\n")||"Could not delete the page.")}})}return false});$(".edit_page_submit_bttn").click(function(){var e=this;if($("#page_title").val()==""){alert("Title cannot be blank!");return false}Helpers.toggleAjaxBttn(this,true);var b=$.extend(new Page.Base,self.page);b.title=$("#page_title").val();b.body=$("#edit_page_body").val();b.body_format=$("#edit_page_body_markup").val();b.message=$("#page_message").val();b.minor=$("#minor").attr("checked")?"1":"0";b.project_id=self.options.project_id;b.save(function(){Helpers.toggleAjaxBttn(e,false);if(b.action_results&&b.action_results.success){UI.Bookmarker.redirectTo("#/projects/"+self.options.project_id+"/notebooks/"+self.options.notebook_id+"/pages/"+b.id+"/latest",true)}else{alert(b.action_results.errors.join(",\n"))}});return false})};this.renderDiff=function(){if(self.diffString==null){return false}$("#show_page_compare").html(self.diffString)};this.show()};

UI.RepositoryNew=function(h){this.tmp=Unfuddle.UI.Renderer;this.tmp(h);delete this.tmp;this.containerID=h.containerID;this.domID="#repository_new";this.holder=$(this.containerID);var self=this;this.addJsTemplate("repository");this.renderMain=function(){this.renderMainLocked=true;var e={projects:Globals.currentPerson.activeProjects().sortByExpression(["object.title.toLowerCase()"])};this.holder.append(Unfuddle.Template.Repository.repositoryNew({locals:e}));this.setBindings(e,h)};this.setBindings=function(f){$("#new_repository_form").submit(function(){if($("#new_repository_title").val()==""){alert("Title cannot be blank");return false}var a=$("#new_repository_submit");Helpers.toggleAjaxBttn(a,true);var c=Helpers.getFormValues({model:"Repository",prefix:"new_repository_"});c.projects=[];$.each(f.projects,function(e,b){if($("#project_"+b.id).attr("checked")){c.projects.push(b.id)}});var d=new Repository.Base(c);d.save(function(e){if(d.action_results.success){var b={repository_id:e.id,commits_count:{}};ActivityGraph.Cache.process(b,"/repositories/"+e.id+"/activity_graph");h.parent.refresh();$("#notice_container").html("")}else{Helpers.toggleAjaxBttn(a,false);self.notifyUser("error",d.action_results.errors)}});return false});$("#new_repository_cancel").click(function(){$("#new_repository_form")[0].reset();$("#new_repository").remove();return false})};this.show()};UI.RepositoryEdit=function(g){this.tmp=Unfuddle.UI.Renderer;this.tmp(g);delete this.tmp;this.containerID="#content";this.domID="#repository_edit";var self=this;this.addJsTemplate("repository");this.checkBeforeRender=function(){var e=true;this.dependsOn("Repository","/repositories/"+g.repository_id,{essential:true});if(Repository.find(g.repository_id).pending){e=false}return e};this.renderMain=function(){this.renderMainLocked=true;this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);var c=Repository.find(g.repository_id)[0];c._diskUsage=c.disk_usage*1024||0;c.callback_url=c.callback_url==null?"":c.callback_url;c.changesets_managed_manually=c.changesets_managed_manually==null?false:c.changesets_managed_manually;c.powerful_commit_messages=c.powerful_commit_messages==null?false:c.powerful_commit_messages;var d=Utilities.formatBytes(Globals.currentAccount.disk_usage*1024,{value_only:true,unit:"megabytes"});var f=c._diskUsage?Utilities.formatBytes(c._diskUsage,{value_only:true,unit:"megabytes"}):0;var h=Globals.currentAccount.whatIs("storage");var k=((d/h)*100).toFixed(2);var l=((f/h)*100).toFixed(2);if(l>k){k=l}var o=l>100?100:l;var n=l>100?0:(k-l);var m={repository:c,projects:Project.find().sortByExpression(["object.archived"]),widthRepository:o,widthAccount:n,percentageRepository:l,usedRepository:Utilities.formatBytes(c._diskUsage),totalAvailable:Utilities.formatBytes(h*1024*1024)};$.each(m.projects,function(e,b){b._associatedWithRepo=c.projects.indexOf(b.id)>=0});this.holder.append(Unfuddle.Template.Repository.editRepository({locals:m}));this.setBindings(m)};this.setBindings=function(f){$("#repository_settings_form").submit(function(){var c=f.repository;var a=$("#repository_settings_submit");Helpers.toggleAjaxBttn(a,true);var d=Helpers.getFormValues({model:"Repository",prefix:"repository_",containerId:"repository_settings_form"});d.projects=[];$.each(f.projects,function(e,b){if($("#project_"+b.id).attr("checked")){d.projects.push(b.id)}});c.save(d,function(){if(c.action_results.success){c.projects=d.projects;self.renderMainLocked=false;Helpers.flashNotice("success",["Repository settings were successfully saved."]);UI.Bookmarker.redirectTo(UI.Bookmarker.bookmarkFor((Globals.currentProject?"project_":"")+"repository_index"))}else{Helpers.toggleAjaxBttn(a,false);self.notifyUser("error",c.action_results.errors)}});return false})};this.show()};UI.RepositoryIndex=function(h){this.tmp=Unfuddle.UI.Renderer;this.tmp(h);delete this.tmp;this.containerID="#content";this.domID="#repository_index";var self=this;this.addJsTemplate("repository");this.baseUrl=h.project_id?("/projects/"+h.project_id+"/repositories"):("/repositories");this.dependsOn("Repository",this.baseUrl,{essential:true});this.activityGraph=function(){if(ActivityGraph.find({sourceUrl:self.baseUrl+"/activity_graphs"}).pending||Changeset.find({sourceUrl:self.baseUrl+"/changesets/latest"}).pending){return}$.each(this.locals.repositories,function(i,repository){repository._activity=repository.activityGraph();$("#activity_graph_"+repository.id).html(Unfuddle.Template.Repository.graph({repository:repository}));$("#repo_"+repository.id+"_latest_changeset_info").html(repository.latestChangesetInfo())})};this.renderMain=function(c){this.renderMainLocked=true;var d=Globals.currentProject?Globals.currentProject.repositories():Repository.find();this.locals.repositories=d.sortByExpression(["object.title.toLowerCase()"]);var f=(new Date).justDate();f.setDate(f.getDate()-30);f=Utilities.formatDate(f,{format:"dashStyle",hover:false});this.holder=$(this.domID)[0]?$(this.domID):$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);$.each(this.locals.repositories,function(e,b){b._url=b.url();b._activity=b.activityGraph();b._metaDescription=b.latestChangesetInfo()});this.holder.append(Unfuddle.Template.Repository.index({locals:this.locals}));if(Globals.currentPerson.is_administrator){this.setAdminBindings(self.locals)}self.dependsOn("ActivityGraph",self.baseUrl+"/activity_graphs",{callback:function(){self.activityGraph()}});self.dependsOn("Changeset",self.baseUrl+"/changesets/latest",{callback:function(){self.activityGraph()}})};this.setAdminBindings=function(c){$("#repository_new_link").click(function(){if($("#new_repository").length<=0){new UI.RepositoryNew({containerID:"#repository_new_placeholder",parent:self})}return false});$.each(c.repositories,function(e,b){$("#repository_"+b.id+"_delete").click(function(){if(confirm("Are you sure you want to permanently delete this repository ("+b.title+")?")){b.destroy(function(){if(b.action_results.success){self.refresh()}else{self.notifyUser("error",b.action_results.errors)}})}return false})})};this.show()};UI.RepositoryBreadcrumbs=function(g){this.tmp=Unfuddle.UI.Renderer;this.tmp(g);delete this.tmp;if(g.path&&g.path[0]!="/"){g.path="/"+g.path}this.containerID="#breadcrumbs_placeholder";this.domID="#repository_breadcrumbs";var self=this;this.baseUrl="/repositories/"+g.repository_id+"/commit";this.locals.repository=g.locals.repository;if(g.locals.repository.system=="git"){this.dependsOn("RepositoryBranch","/repositories/"+g.repository_id+"/branches",{essential:true});if(g.commit=="head"){this.dependsOn("Commit",self.baseUrl,{essential:true})}else{this.dependsOn("Commit",self.baseUrl,{essential:true,findParams:{apiParams:{commit:g.commit}}})}}this.checkBeforeRender=function(){var e=true;this.dependsOn("Repository","/repositories/"+g.repository_id,{essential:true});if(Repository.find(g.repository_id).pending){e=false}return e};this.renderMain=function(){this.renderMainLocked=true;this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);if(this.locals.repository.system=="git"){this.locals.branches=RepositoryBranch.find({sourceUrl:"/repositories/"+g.repository_id+"/branches",conditions:{type:"branch"}});this.locals.tags=RepositoryBranch.find({sourceUrl:"/repositories/"+g.repository_id+"/branches",conditions:{type:"tag"}});this.locals.commit=(g.commit=="head")?Commit.find({sourceUrl:self.baseUrl})[0]:Commit.find({sourceUrl:self.baseUrl,apiParams:{commit:g.commit}})[0];if(!this.locals.commit){return true}if(this.locals.commit.branch){$.each(self.locals.branches,function(e,b){if(self.locals.commit.commit==b.commit){self.locals.branchForSelect=b.name;if(b.name=="master"){return false}}})}else{if(this.locals.commit.tag){var k=RepositoryBranch.find({conditions:{type:"tag",name:this.locals.commit.tag}})[0];commit=this.locals.commit;a_tag=k;if(this.locals.commit.commit==k.commit){this.locals.tagForSelect=$.trim(this.locals.commit.tag)}}}if(!this.locals.branchForSelect&&!this.locals.tagForSelect){this.locals.commitForSelect=g.commit.slice(0,6)}}else{if(this.locals.repository.system=="svn"){var l=(Globals.currentProject?"project_":"")+"repository_commit";var o=UI.Bookmarker.bookmarkFor(l,g)+"?path=/&commit="+g.commit;this.locals.commitLink=Helpers.htmlTag("<a>",{href:o},g.commit)}}var n=g.path.split("/").slice(1),m="";if(g.route.indexOf("commit")<0){$.each(n,function(e,b){var c="/"+n.slice(0,e+1).join("/");var d=(Globals.currentProject?"project_":"")+"repository_"+((g.scope=="file"&&e==n.length-1)?"file":"browse");var f=UI.Bookmarker.bookmarkFor(d,g)+"?path="+c+"&commit="+g.commit;var h=e<n.length-1||g.route.indexOf("history")>=0;if(b!=""){m+=(h?"/"+Helpers.htmlTag("<a>",{href:f},b):"/"+b)}})}this.locals.pathLinks=m;this.holder.append(Unfuddle.Template.Repository.breadcrumbs({locals:this.locals}));if($.browser.msie&&$.browser.version>="7.0"&&$.browser.version<"8.0"){setTimeout("document.body.className = document.body.className",500);setTimeout("document.body.className = document.body.className",1000);setTimeout("document.body.className = document.body.className",1500)}this.setBindings()};this.setBindings=function(){$("#repository_branch_select").change(function(){var e=(Globals.currentProject?"project_":"")+"repository_browse";var b=UI.Bookmarker.bookmarkFor(e,g)+"?commit="+$(this).val();UI.Bookmarker.redirectTo(b,true)})};this.show()};UI.RepositoryCurrentCommit=function(c){this.tmp=Unfuddle.UI.Renderer;this.tmp(c);delete this.tmp;this.containerID="#repository_commit_info_placeholder";this.domID="#repository_current_commit";var self=this;c.commit=c.commit||"head";var d="/repositories/"+c.repository_id+"/commit";this.dependsOn("Commit",d,{essential:true,findParams:{apiParams:{commit:c.commit}}});this.renderMain=function(){this.renderMainLocked=true;this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);this.locals.repository=Repository.find(c.repository_id)[0];this.locals.canReadPeople=this.locals.repository.seeIf(Globals.currentPerson,"canReadPeople");var e=Commit.find({sourceUrl:d,apiParams:{commit:c.commit}})[0];var b={commit:e.commit,author:e.author,_displayName:e.author,_messageFormatted:Utilities.formatText(e.message,{format:"plain",constrain:1000,project:self.locals.repository.associatedProjects().length==1?self.locals.repository.associatedProjects()[0]:null,callback:function(){self.refresh()}}),tree:e.tree,parents:e.parents,_commitDateFormatted:Utilities.formatDate(Utilities.parseDate(e.committer_date),{prefix:true,format:"withTime"})};this.holder.append(Unfuddle.Template.Repository.historyBox({locals:this.locals,historyItem:b,row_color:"row_0"}))};this.show()};UI.RepositoryBrowse=function(d){this.tmp=Unfuddle.UI.Renderer;this.tmp(d);delete this.tmp;d.commit=d.commit||"head";d.path=d.path?((d.path.length>1&&d.path.slice(-1)=="/")?d.path.slice(0,-1):d.path):"/";if(d.path&&d.path[0]!="/"){d.path="/"+d.path}this.containerID="#content";this.domID="#repository_browse";var self=this;this.addJsTemplate("repository");this.locals.scope="tree";var f="/repositories/"+d.repository_id+"/tree.json?commit="+d.commit+"&path="+d.path;var h="/repositories/"+d.repository_id+"/tree.json?changesets=true&commit="+d.commit+"&path="+d.path;this.dependsOn("Repository","/repositories/"+d.repository_id,{essential:true});this.dependsOn("RepositoryTree",f,{essential:true});this.dependsOn("RepositoryTree",h,{callback:function(e){self.renderWholeTable(e)}});this.renderMain=function(){this.renderMainLocked=true;this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);this.locals.repositoryTree=RepositoryTree.find({sourceUrl:f})[0];this.locals.repository=Repository.find(d.repository_id)[0];this.locals.repoEmpty=this.locals.repository.empty;if(!this.locals.repoEmpty){if(d.commit=="head"&&this.locals.repositoryTree){d.commit=this.locals.repositoryTree.commit}this.locals.canReadPeople=this.locals.repository.seeIf(Globals.currentPerson,"canReadPeople");this.locals.repoTimeout=false;this.locals.isMSIE=Utilities.isMSIE();this.locals.spinner=Helpers.ajaxProgressSmall();this.locals.path=d.path;this.locals.previousPath=d.path.split("/").length<=2?"/":d.path.split("/").slice(0,-1).join("/");var e=(Globals.currentProject?"project_":"")+"repository_history";var b=UI.Bookmarker.bookmarkFor(e,d)+"?path="+d.path+"&commit="+d.commit;this.locals.historyLink=Helpers.htmlTag("<a>",{href:b},"History");this.locals.downloadTreeHref=Config.baseApiUrl+"/repositories/"+d.repository_id+"/download_revision?commit="+d.commit+"&path="+d.path;this.prepareTheTree()}this.holder.append(Unfuddle.Template.Repository.browse({locals:this.locals}));if(!this.locals.repoEmpty){new UI.RepositoryBreadcrumbs(d);new UI.RepositoryCurrentCommit(d);this.renderWholeTable(false,this.locals.repositoryTree)}};var k=false;this.renderWholeTable=function(e,b){var c=$("#repository_browser");if(!c.length||k){return}self.locals.repositoryTree=b||RepositoryTree.find({conditions:{commit:d.commit,path:d.path}})[0];if(!self.locals.repositoryTree){return}self.prepareTheTree();c.replaceWith(Unfuddle.Template.Repository.browseTable({locals:self.locals}));if(e){k=true}};this.prepareTheTree=function(){if(self.locals.repositoryTree){$.each(self.locals.repositoryTree.nodes,function(e,b){if(b.changeset){b._revision=b.changeset.revision.slice(0,7);b._authorDate=Utilities.formatDate(Utilities.parseDate(b.changeset.author_date),{format:"tiny"});if(self.locals.canReadPeople){b._authorName=b.changeset.displayName()}c=(Globals.currentProject?"project_":"")+"repository_commit";b._commitBookmark=UI.Bookmarker.bookmarkFor(c,d)+"?commit="+b.changeset.revision}if(b.type=="file"){b._sizeFormatted=Utilities.formatBytes(b.size)}var c=(Globals.currentProject?"project_":"")+"repository_"+(b.type=="dir"?"browse":"file");b._bookmark=UI.Bookmarker.bookmarkFor(c,d)+"?path="+(b.name==".."?self.locals.previousPath:d.path+(d.path!="/"?"/":"")+Url.encode(b.name))+"&commit="+self.locals.repositoryTree.commit});if(this.locals.repositoryTree.nodes.length==1){this.locals.emptyDir=true}}};this.show()};UI.RepositoryFile=function(f){this.tmp=Unfuddle.UI.Renderer;this.tmp(f);delete this.tmp;if(f.path&&f.path[0]!="/"){f.path="/"+f.path}this.containerID="#content";this.domID="#repository_file";var self=this;this.addJsTemplate("repository");this.locals.scope="file";f.blame=f.blame||false;f.commit=f.commit||"head";f.path=Url.decode(f.path);var h="/repositories/"+f.repository_id+"/file";this.dependsOn("Repository","/repositories/"+f.repository_id,{essential:true});this.dependsOn("RepositoryFile",h,{essential:true,findParams:{apiParams:{path:f.path,blame:f.blame,commit:f.commit}}});this.renderMain=function(){this.locals.repositoryFile=RepositoryFile.find({sourceUrl:h,apiParams:{path:f.path,blame:f.blame,commit:f.commit}})[0];if(!this.locals.repositoryFile){return}this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);this.locals.repository=Repository.find(f.repository_id)[0];this.locals.canReadPeople=this.locals.repository.seeIf(Globals.currentPerson,"canReadPeople");this.locals.repoTimeout=false;this.locals.isMSIE=Utilities.isMSIE();if(f.commit=="head"&&this.locals.repositoryFile){f.commit=this.locals.repositoryFile.commit}this.locals._sizeFormatted=Utilities.formatBytes(this.locals.repositoryFile.size);this.locals.showBlame=f.blame=="true"?true:false;this.locals.repositoryFile.lines=this.locals.repositoryFile.lines?this.locals.repositoryFile.lines:[];if(f.blame=="true"&&this.locals.canReadPeople){$.each(self.locals.repositoryFile.lines,function(e,b){if(!b.changeset){return true}b._changeset=b.changeset.revision.slice(0,7);b._author=b.changeset.author_name.length>14?b.changeset.author_name.slice(0,14):b.changeset.author_name.concat(new Array(14-b.changeset.author_name.length+1).join(" "));b._committerDate=Utilities.formatDate(Utilities.parseDate(b.changeset.committer_date),{format:"tiny"})})}var c=(Globals.currentProject?"project_":"")+"repository_history";var d=UI.Bookmarker.bookmarkFor(c,f)+"?path="+f.path+"&commit="+f.commit;this.locals.historyLink=Helpers.htmlTag("<a>",{href:d},"History");this.locals.commit=f.commit;this.holder.append(Unfuddle.Template.Repository.browse({locals:this.locals}));Helpers.highlightSyntax($("#code_pretty_print")[0],f.path);new UI.RepositoryBreadcrumbs(f);new UI.RepositoryCurrentCommit(f)};this.show()};UI.RepositoryHistory=function(c){this.tmp=Unfuddle.UI.Renderer;this.tmp(c);delete this.tmp;if(c.path&&c.path[0]!="/"){c.path="/"+c.path}c.page=c.page||1;c.pageItems=c.pageItems||10;c.path=c.path?((c.path.length>1&&c.path.slice(-1)=="/")?c.path.slice(0,-1):c.path):"/";c.commit=c.commit||"head";this.containerID="#content";this.domID="#repository_history_wrapper";var self=this;this.addJsTemplate("repository");this.dependsOn("Repository",c.project_id?("/projects/"+c.project_id+"/repositories"):("/repositories"),{essential:true});this.baseUrl="/repositories/"+c.repository_id+"/history";this.dependsOn("RepositoryHistory",this.baseUrl,{essential:true,findParams:{apiParams:{page:c.page,count:c.pageItems,path:c.path,commit:c.commit}}});this.renderMain=function(){this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);this.locals.repository=Repository.find(c.repository_id)[0];this.locals.canReadPeople=this.locals.repository.seeIf(Globals.currentPerson,"canReadPeople");this.locals.commits=RepositoryHistory.find({sourceUrl:self.baseUrl,apiParams:{page:c.page,count:c.pageItems,path:c.path,commit:c.commit}});$.each(this.locals.commits,function(e,b){b._displayName=b.displayName();b._messageFormatted=Utilities.formatText(b.message,{format:"plain",constrain:1000,project:self.locals.repository.associatedProjects().length==1?self.locals.repository.associatedProjects()[0]:null,callback:function(){self.refresh()}})});document.title=(Globals.currentProject?Globals.currentProject.title:Globals.currentAccount.title)+" - History: "+this.locals.repository.title+" - Unfuddle";$.each(this.locals.commits,function(e,b){b._commitDateFormatted=Utilities.formatDate(b.committer_date,{prefix:true,format:"withTime"})});this.locals.path=c.path;this.holder.append(Unfuddle.Template.Repository.history({locals:this.locals}));if(this.locals.commits&&this.locals.commits.length>0){c.scope=this.locals.commits[0].scope}new UI.RepositoryBreadcrumbs(c);if(this.locals.commits&&this.locals.commits.length>0){c.totalCount=this.locals.commits[0].total_count;Helpers.buildPageLinks(c.page,c.pageItems,c.totalCount);if(c.totalCount<=c.pageItems){$("#paginator_bottom_wrapper").remove()}}};this.show()};UI.RepositoryCommit=function(j){this.tmp=Unfuddle.UI.Renderer;this.tmp(j);delete this.tmp;if(j.path&&j.path[0]!="/"){j.path="/"+j.path}this.containerID="#content";this.domID="#repository_commit_render";var self=this;this.addJsTemplate("repository");this.addJsTemplate("commit_comment");j.commit=j.commit||"head";j.path=j.path?((j.path.length>1&&j.path.slice(-1)=="/")?j.path.slice(0,-1):j.path):"/";var q="/repositories/"+j.repository_id+"/commit";this.dependsOn("Repository",j.project_id?("/projects/"+j.project_id+"/repositories"):("/repositories"),{essential:true});this.dependsOn("Commit",q,{essential:true,findParams:{apiParams:{commit:j.commit,commit_comments:true}}});this.dependsOn("Commit",q+"?commit=head",{essential:true});this.renderMain=function(){renderMainLocked=true;this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);this.locals.repository=Repository.find({conditions:{id:j.repository_id}})[0];this.locals.commit=Commit.find({sourceUrl:q,apiParams:{commit:j.commit,commit_comments:true}})[0]||{};this.locals.commit_comments=CommitComment.find({conditions:{commit:this.locals.commit.commit,repository_id:this.locals.repository.id}}).sortByExpression("created_at");this.locals.displayCommitComments=false||Globals.currentAccount.hasFeature("beta");$.each(this.locals.commit_comments,function(e,b){b._canDelete=((b.author_id==Globals.currentPerson.id)||self.locals.repository.seeIf(Globals.currentPerson,"isAdministrator"));b.dateFormatted=Utilities.formatDate(b.created_at,{prefix:true});var c=Person.find(b.author_id)[0];if(c){b.authorDisplayName=c.displayName()}b._bodyFormatted=Utilities.formatText(b.body,{format:"plain"})});this.locals.commitHead=Commit.find({sourceUrl:q+"?commit=head"})[0];this.locals.commitTooBig=self.locals.commit?!self.locals.commit.files:true;var o=[],n=[],m=[],g=[],s=[];if(!this.locals.commitTooBig){this.locals.historyItem={commit:this.locals.commit.commit,author:this.locals.commit.author,_displayName:this.locals.commit.author,_messageFormatted:Utilities.formatText(this.locals.commit.message,{format:"plain",project:self.locals.repository.associatedProjects().length==1?self.locals.repository.associatedProjects()[0]:null,callback:function(){self.refresh()}}),tree:this.locals.commit.tree,parents:this.locals.commit.parents,_commitDateFormatted:Utilities.formatDate(Utilities.parseDate(this.locals.commit.committer_date),{prefix:true,format:"withTime"})};$.each(self.locals.commit.files,function(e,b){if(b.file.action=="added"){o.push(b)}if(b.file.action=="deleted"){n.push(b)}if(b.file.action=="updated"){m.push(b)}if(b.file.action=="moved"){g.push(b)}if(b.file.action=="copied"){s.push(b)}})}$.each(m,function(e,b){if(b.file.content=="text"&&self.locals.commit.diffs[b.file.name]){self.locals.commit.diffs[b.file.name+"_formatted"]=Utilities.formatDiffCommit(self.locals.commit.diffs[b.file.name],e)}});this.locals.filesAdded=o;this.locals.filesDeleted=n;this.locals.filesUpdated=m;this.locals.filesMoved=g;this.locals.filesCopied=s;this.locals.canReadPeople=this.locals.repository.seeIf(Globals.currentPerson,"canReadPeople");this.holder.append(Unfuddle.Template.Repository.commitPage({locals:this.locals}));var w="repository_"+this.locals.repository.id+"_commit_"+this.locals.commit.commit;var r=[];$.each(this.locals.commit_comments,function(e,b){if(!b.line_number||!b.file_version){r.push(b)}});r.sortByExpression("created_at");if(this.locals.displayCommitComments){$("#commit_show_comments").append(Unfuddle.Template.CommitComment.simpleCommitCommentIndex({domId:w,inline:false,locals:this.locals,commit_comments:r}));$(".commit_comment").mouseenter(function(){$(".commit_comment_icon").removeClass("commit_comment_icon_scroll");$(".has_comments .commit_comment_icon .commit_comment_number").html(function(){return $(this).attr("rel")});$("#"+this.id+"_comment").addClass("commit_comment_icon_scroll");$(".has_comments #"+this.id+"_comment .commit_comment_number").html("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");return false});$(".code_holder_with_comments").mouseleave(function(){$(".commit_comment_icon").removeClass("commit_comment_icon_scroll");$(".has_comments .commit_comment_icon .commit_comment_number").html(function(){return $(this).attr("rel")});return false});var p=function(c){var d=c.split("linenumber")[0].split("file")[1];var f=m[d].file.name;var h=c.split("linenumber")[1].split("fileversion")[0];var k=c.split("fileversion")[1];var l=[];$.each(self.locals.commit_comments,function(e,b){if(b.file==f&&b.line_number==h&&b.file_version==k){l.push(b)}});l.sortByExpression("created_at");$("#"+c).after(Unfuddle.Template.CommitComment.newInlineCommitComment({domId:c,inline:true,locals:self.locals,commit_comments:l}));$("#"+c+"_form").submit(function(){self.submitSimpleCommitComment(c)});t(c)};$(".commit_comment_icon").click(function(){var e=this.id.split("_comment")[0];if(($("#"+e+"_inline_form").length>0)){$("#"+e+"_inline_form").remove();return false}p(e);return false});self.submitSimpleCommitComment=function(e,b){if(!b){var c=e.split("linenumber")[0].split("file")[1];var d=e.split("linenumber")[1].split("fileversion")[0];var f=e.split("fileversion")[1]}if(!d){d=null}if(!c){var file=null}else{var file=m[c].file.name}if(!f){f=null}var h=new Unfuddle.Data.CommitComment.Base({body:$("#"+e+"_body").val(),body_format:"plain",repository_id:self.locals.repository.id,commit:self.locals.commit.commit,file:file,line_number:d,file_version:f});h.save(function(){if(h.action_results.success){self.refresh();if(e&&!b&&$("#"+e+"_inline_form").length<=0){p(e)}}});return false};var t=function(c){$(".repo_comment_delete").click(function(){var e=this.id.split("comment_delete_")[1];var b=CommitComment.find(e)[0];b.destroy(function(){if(b.action_results.success){self.refresh();if(c&&$("#"+c+"_inline_form").length<=0){p(c)}}});return false})};t();var u="repository_"+this.locals.repository.id+"_commit_"+this.locals.commit.commit;$("#"+u+"_submit_button").click(function(){self.submitSimpleCommitComment(u,true);return false});var v=Unfuddle.UI.Bookmarker.currentBookmark.anchor&&Unfuddle.UI.Bookmarker.currentBookmark.anchor.split("commit_comment_")[1]?Unfuddle.UI.Bookmarker.currentBookmark.anchor.split("commit_comment_")[1]:null;$.each(this.locals.commit_comments,function(c,d){var f=null;$.each(m,function(e,b){if(b.file.name==d.file){f=e}});if((f!=null)&&(d.line_number!=null)&&(d.file_version!=null)){var h=parseInt($("#file"+f+"linenumber"+d.line_number+"fileversion"+d.file_version+" .comment_scroll div.commit_comment_number").attr("rel"));h+=1;$("#file"+f+"linenumber"+d.line_number+"fileversion"+d.file_version+" .comment_scroll div.commit_comment_number").attr("rel",h);$("#file"+f+"linenumber"+d.line_number+"fileversion"+d.file_version+" .comment_scroll div.commit_comment_number").html(h);$("#file"+f+"linenumber"+d.line_number+"fileversion"+d.file_version+" .comment_scroll").removeClass("has_comments");$("#file"+f+"linenumber"+d.line_number+"fileversion"+d.file_version+" .comment_scroll").addClass("has_comments");if(v!=null&&v==d.id){var k="file"+f+"linenumber"+d.line_number+"fileversion"+d.file_version;p(k)}}});$(".expand_comments").click(function(){var c=this.id.split("expand_comments_file_")[1];$(".commit_comment").each(function(e,b){if(b.id.search("file"+c+"linenumber")>=0&&$("#"+b.id.replace("_inline_form","")+"_inline_form").length<=0&&$(this).children().first().attr("class").search("has_comments")>=0){p(b.id)}});$("#expand_comments_file_"+c).hide();$("#collapse_comments_file_"+c).show();return false});$(".collapse_comments").click(function(){var c=this.id.split("collapse_comments_file_")[1];$(".commit_comment").each(function(e,b){if(b.id.search("file"+c+"linenumber")>=0&&b.id.search("_inline_form")>=0){$(this).remove()}});$("#expand_comments_file_"+c).show();$("#collapse_comments_file_"+c).hide();return false})}new UI.RepositoryBreadcrumbs(j)};this.show()};UI.RepositoryEmpty=function(e){this.tmp=Unfuddle.UI.Renderer;this.tmp(e);delete this.tmp;e.commit=e.commit||"head";e.path=e.path?((e.path.length>1&&e.path.slice(-1)=="/")?e.path.slice(0,-1):e.path):"/";this.containerID="#content";this.domID="#repository_empty";var self=this;this.addJsTemplate("repository");this.dependsOn("Repository","/repositories/"+e.repository_id,{essential:true});this.renderMain=function(){this.locals.repository=Repository.find({conditions:{id:e.repository_id}})};this.show()};

UI.PermissionUtilities={setPermissionFormBindings:function(c,d,e,f){$("#"+e+"submit").click(function(){Helpers.toggleAjaxBttn(this,true);var a=Helpers.getFormValues({prefix:e+"perm_",fields:UI.PermissionUtilities.resourcesLines});a.is_administrator=$("#"+e+"is_administrator").is(":checked");a.project_id=d.id;a.person_id=c.id;var b=d.involvements()[c.id]||new Involvement.Base(a);b.save(a,function(){if(b.action_results.success){f.renderMainLocked=false;f.refresh()}else{alert(b.action_results.errors.join("\n")||"Your request could not be completed");Helpers.toggleAjaxBttn(this,false)}});return false})},resourcesLines:["messages","tickets","people","milestones","notebooks","source"],permissions:["isAdministrator","canReadMessages","canReadTickets","canReadMilestones","canReadNotebooks","canReadSource","canManagePeople"]};UI.PersonNew=function(f){this.tmp=Unfuddle.UI.Renderer;this.tmp(f);delete this.tmp;this.verifyPermissions=function(){return(Globals.currentPerson.seeIfAtAll("canInvitePeople"))};this.containerID=f.containerID||"#content";this.domID="#person_invite_new";var self=this;this.addJsTemplate("person");this.renderMain=function(){this.holder=$("<div/>").attr("id",self.domID.slice(1)).appendTo(this.containerID);var e={isAdministrator:Globals.currentPerson.is_administrator,relevantProjects:Globals.currentProject?[Globals.currentProject]:Globals.currentPerson.activeProjects(),projectsCanInvite:Globals.currentPerson.projectsByPermission("canInvitePeople").filter(function(a){return!a.archived}),peopleCount:Globals.currentAccount.peopleCollection().length,maxPeople:Globals.currentAccount.whatIs("max_people"),people:Globals.currentProject?Globals.currentProject.involvedPeople():Globals.currentAccount.peopleCollection()};e.relevantProjects.forEach(function(d){UI.PermissionUtilities.permissions.forEach(function(a){d["_"+a]=Globals.currentPerson.seeIf(d,a)});d._selectOptions={};d._permSelectOptions={};UI.PermissionUtilities.resourcesLines.forEach(function(c){d._selectOptions[c]=Involvement.permSelectOptionsSubjective(c,d,Globals.currentPerson);d._permSelectOptions[c]=Involvement.permSelectOptions(c);if(Globals.currentProject&&Globals.currentPerson.seeIf(Globals.currentProject,"isAdministrator")){e.people.forEach(function(a){var b=Globals.currentProject.involvements();d["_person_"+a.id+"_perm_"+c]=Globals.currentProject.permValueFor(a,c,b);d["_person_"+a.id+"_perm_is_admin"]=Globals.currentProject.permValueFor(a,"is_administrator",b)})}})});this.holder.append(Unfuddle.Template.Person.invitePerson({locals:e}));this.setBindings()};this.setBindings=function(){if($("#person_email")){$("#person_email").focus()}$("#invite_person_form").submit(function(){Helpers.invite_person_submit("#invite_person_form",function(a){if(!a.success){alert(a.errors.join("\n")||"Person could not be invited.")}else{UI.Bookmarker.redirectTo()}});return false})};this.show()};UI.PersonIndex=function(i){this.tmp=Unfuddle.UI.Renderer;this.tmp(i);delete this.tmp;this.verifyPermissions=function(){return(Config.currentProjectID?Globals.currentPerson.seeIf(Globals.currentProject,"canReadPeople"):Globals.currentPerson.seeIfAtAll("canReadPeople"))};this.containerID="#content";this.domID="#person_index";var self=this;this.addJsTemplate("person");if(i.project_id){this.addJsTemplate("project")}else{this.addJsTemplate("account")}if(Config.currentProjectID){this.dependsOn("Involvement","/projects/"+Config.currentProjectID+"/involvements",{essential:true})}else{this.dependsOn("Involvement","/involvements",{callback:function(a){self.refresh()}})}this.renderMain=function(e){var f=new Date;self.renderMainLocked=true;this.holder=$("<div/>").attr("id",self.domID.slice(1)).appendTo(this.containerID);var g=i.project_id?Globals.currentProject:Globals.currentAccount;var h=Globals.currentAccount.peopleCollection({adminsFirst:true});this.locals={isAdministrator:Globals.currentPerson.is_administrator,canInvitePeople:Globals.currentPerson.seeIf(Globals.currentProject,"canInvitePeople"),canInvitePeopleAtAll:Globals.currentProject?Globals.currentPerson.seeIf(Globals.currentProject,"canInvitePeople"):Globals.currentPerson.seeIfAtAll("canInvitePeople"),peopleCount:h.length,maxPeople:Globals.currentAccount.whatIs("max_people"),relevantProjects:Globals.currentProject?[Globals.currentProject]:Globals.currentPerson.activeProjects(),people:Globals.currentProject?Globals.currentProject.involvedPeople({adminsFirst:true}):h,projectsCanInvite:Globals.currentPerson.projectsByPermission("canInvitePeople").filter(function(a){return!a.archived})};if(Globals.currentProject){this.locals.currentProject=Globals.currentProject;this.locals.currentProject._isAdministrator=Globals.currentPerson.seeIf(self.locals.currentProject,"isAdministrator")}h.forEach(function(a){a._displayName=a.displayName(true)});self.locals.otherPeople=Globals.currentProject?h:[];self.locals.people.forEach(function(a){if(a.last_signed_in){a._lastSignIn=Utilities.formatDate(a.last_signed_in,{prefix:true})}if(Globals.currentProject){self.locals.otherPeople.remove(a)}else{var b=Involvement.find({conditions:{person_id:a.id}});a._projectsInvolvedCount=Involvement.find({sourceUrl:"/involvements"}).pending?-1:b.length;a._removable=a.removable()}});self.locals.relevantProjects.forEach(function(d){UI.PermissionUtilities.permissions.forEach(function(a){d["_"+a]=Globals.currentPerson.seeIf(d,a)});d._selectOptions={};d._permSelectOptions={};UI.PermissionUtilities.resourcesLines.forEach(function(c){d._selectOptions[c]=Involvement.permSelectOptionsSubjective(c,d,Globals.currentPerson);d._permSelectOptions[c]=Involvement.permSelectOptions(c);if(Globals.currentProject){self.locals.people.forEach(function(a){if(Globals.currentPerson.seeIf(Globals.currentProject,"isAdministrator")){var b=Globals.currentProject.involvements();d["_person_"+a.id+"_perm_"+c]=Globals.currentProject.permValueFor(a,c,b)}d["_person_"+a.id+"_perm_is_admin"]=Globals.currentProject.permValueFor(a,"is_administrator",b)})}})});var j=Unfuddle.Template.Person.index({locals:self.locals});this.holder.append(j);this.setBindings();if($.browser.msie&&$.browser.version>="7.0"&&$.browser.version<"8.0"){setTimeout("document.body.className = document.body.className",500);setTimeout("document.body.className = document.body.className",1000);setTimeout("document.body.className = document.body.className",1500)}};this.setBindings=function(){$("#invite_person_link").click(function(){new UI.PersonNew({containerID:"#invite_person_people_index"});return false});$("a.edit_permissions_link").click(function(){var a=$(this).attr("id").match(/(.+)_person_(\d+)_edit_permissions/);var b=a[1],c=a[2];var d=Person.find(c)[0];var e=$("#"+b+"_person_"+c+"_edit_permissions");if(e.html()==""){e.append(Unfuddle.Template.Project.permissionsForInvolved({locals:self.locals,domId:b,person:d}));Unfuddle.UI.PermissionUtilities.setPermissionFormBindings(d,Globals.currentProject,b+"_person_"+c+"_",self)}$("#"+b+"_person_"+c+"_container_actions").hide();e.show();return false});$("a.remove_person_link").click(function(){var a=$(this).attr("id").match(/remove_person_(\d+)/)[1];var b=Person.find(a)[0];if(confirm("Are you sure you want to remove this person from the "+(Globals.currentProject?"project":"account")+"?")){var c=Globals.currentProject?b.involvements()[Globals.currentProject.id]:b;c.destroy(function(){if(c.action_results.success){self.refresh()}else{alert(c.action_results.errors.join("\n")||"Person could not be removed.")}})}return false});$("a.add_to_project_link").click(function(){var a=$(this).attr("id").match(/(.+)_add_to_project_(\d+)_link/);var b=a[1],c=a[2];var d=Person.find(c)[0];var e=$("#"+b+"_add_to_project_"+c+"_add_to_project");if(e.html()==""){e.append(Unfuddle.Template.Project.permissionsForUninvolved({locals:self.locals,domId:b,person:d}));Unfuddle.UI.PermissionUtilities.setPermissionFormBindings(d,Globals.currentProject,b+"_add_to_project_"+c+"_",self)}$("#"+b+"_add_to_project_"+c+"_container_actions").hide();e.show();return false});$("a.edit_person_link").each(function(){var a=$(this).attr("id").match(/edit_person_(\d+)/)[1];var b=(Config.development?"http://":"https://");$(this).attr("href",b+location.host+Config.baseUrl+"/a"+Bookmarker.bookmarkFor("account_person_show",{person_id:a}))})};this.show()};UI.PersonShow=function(f){this.tmp=Unfuddle.UI.Renderer;this.tmp(f);delete this.tmp;this.verifyPermissions=function(){if(!f.person_id||Globals.currentPerson.is_administrator||Globals.currentPerson.id==f.person_id){return true}var c=Person.find(f.person_id)[0];if(c.is_administrator&&!Globals.currentPerson.is_administrator){return false}var d=false;var e=Globals.currentPerson.projectsDeliberate().filter(function(a){return Globals.currentPerson.seeIf(a,"canManagePeople")});proj=e[0];$.each(e,function(a,b){if(b.involvedPeople().map(function(pers){return pers.id}).indexOf(c.id)>=0){d=true;return false}});return d};this.containerID="#content";this.domID="#person_show";this.addJsTemplate("person");var self=this;var g=f.person_id||Globals.currentPerson.id;this.dependsOn("Involvement","/people/"+g+"/involvements",{essential:true});if(g==Globals.currentPerson.id){this.dependsOn("PublicKey","/people/"+g+"/public_keys",{essential:true})}this.checkBeforeRender=function(){var c=true;if(f.person_id&&!Globals.currentPerson.is_administrator&&Globals.currentPerson.id!=f.person_id){var d=Person.find(f.person_id)[0];var e=Globals.currentPerson.projectsDeliberate().filter(function(a){return Globals.currentPerson.seeIf(a,"canManagePeople")});proj=e[0];$.each(e,function(a,b){self.dependsOn("Involvement","/projects/"+b.id+"/involvements",{essential:true});if(Involvement.find({conditions:{project_id:b.id}}).pending){c=false}})}return c};this.renderMain=function(){this.renderMainLocked=true;this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);this.locals.person=f.person_id?Person.find(f.person_id)[0]:Globals.currentPerson;this.locals.publicKeys=PublicKey.find({conditions:{person_id:self.locals.person.id}});this.locals.personEdit=!!f.person_id;this.locals.accountMarkups=Account.current().textMarkups();this.locals.notificationOptions=[["never","never"],["immediate","immediately upon changes"],["30mins","every 30 minutes"],["hourly","hourly"],["dailyam","daily, in the morning"],["dailypm","daily, in the afternoon"]];if(this.locals.personEdit&&Globals.currentPerson.is_administrator){var c=this.locals.person.involvements();this.locals.otherProjects=Project.find({order:"archived, title, short_name"});this.locals.person._projectsDeliberate=this.locals.person.projectsDeliberate();this.locals.person._projectsDeliberate.forEach(function(b){UI.PermissionUtilities.permissions.forEach(function(a){b["_"+a]=Globals.currentPerson.seeIf(b,a)});self.locals.otherProjects.remove(b)});Project.find().forEach(function(b){b._selectOptions={};b._permSelectOptions={};UI.PermissionUtilities.resourcesLines.forEach(function(a){b._permSelectOptions[a]=Involvement.permSelectOptions(a);b["_person_"+self.locals.person.id+"_perm_"+a]=self.locals.person.permValueFor(b,a,c)});b["_person_"+self.locals.person.id+"_perm_is_admin"]=self.locals.person.permValueFor(b,"is_administrator",c)})}this.holder.append(Unfuddle.Template.Person.show({locals:this.locals}));this.setBindings()};this.setBindings=function(){$("#person_save_changes_button").click(function(){var a=$.extend({is_administrator:$("#is_administrator").is(":checked")},Helpers.getFormValues({model:"Person"}));if(!self.validatePeopleForm(a)){return false}var b=this;Helpers.toggleAjaxBttn(b,true);self.locals.person.update(a,function(){if(self.locals.person.action_results.success){self.refresh();self.notifyUser("success","Your settings were successfully saved")}else{Helpers.toggleAjaxBttn(b,false);self.notifyUser("error",self.locals.person.action_results.errors)}});return false});$("#new_person_public_key_form").submit(function(){var a=Helpers.getFormValues({model:"PublicKey",prefix:"person_public_key_new_"});a.person_id=self.locals.person.id;if(!self.validatePublicKeysForm(a)){return false}var b=new PublicKey.Base(a);var c=$("#person_public_keys_list_add_submit");Helpers.toggleAjaxBttn(c,true);b.save(function(){if(b.action_results.success){self.refresh()}else{Helpers.toggleAjaxBttn(c,false);alert(b.action_results.errors.join("\n"))}});return false});if(self.locals.publicKeys){$.each(self.locals.publicKeys,function(b,c){$("#person_public_key_"+c.id+"_delete").click(function(){var a=confirm('Are you sure you want to remove the publicKey "'+c.title+'" from the person?');if(a==true){c.destroy(function(){if(c.action_results.success){self.refresh()}else{alert(c.action_results.errors.join("\n"))}})}return false});$("#person_public_key_"+c.id+"_edit_form").submit(function(){var a=Helpers.getFormValues({model:"PublicKey",prefix:"person_public_key_"+c.id+"_edit_"});if(!self.validatePublicKeysForm(a)){return false}c.save(a,function(){if(c.action_results.success){self.refresh()}else{alert(c.action_results.errors.join("\n"))}});return false})})}$("#re_send_email").click(function(){if(confirm("Are you sure you want to reset this person's password and re-send the welcome email?")){$.ajax({type:"POST",url:Config.baseApiUrl+"/people/resend_welcome.json",dataType:"application/json",data:{id:self.locals.person.id},success:function(){alert("Welcome email has been re-sent.")},error:function(){alert("An unexpected error occured while re-sending the Welcome email. Please try again!")}})}return false});$("#remove_person").click(function(){if(confirm("Are you sure you want to remove this person from the account?")){self.locals.person.destroy(function(){if(self.locals.person.action_results.success){UI.Bookmarker.redirectTo(Config.baseUrl+"/a#/people")}else{self.userNotify("error",self.locals.person.action_results.errors)}})}return false});if(self.locals.personEdit&&Globals.currentPerson.is_administrator){self.locals.person._projectsDeliberate.forEach(function(b){$("#project_list_person_"+self.locals.person.id+"_project_"+b.id+"_remove").click(function(){if(confirm("Are you sure you want to remove this person from the project ?")){var a=self.locals.person.involvements()[b.id];a.destroy(function(){if(a.action_results.success){self.renderMainLocked=false;self.render()}else{alert(a.action_results.errors.join("\n")||"Person could not be removed from this project.")}})}return false});Unfuddle.UI.PermissionUtilities.setPermissionFormBindings(self.locals.person,b,"project_list_person_"+self.locals.person.id+"_project_"+b.id+"_",self)});self.locals.otherProjects.forEach(function(a){Unfuddle.UI.PermissionUtilities.setPermissionFormBindings(self.locals.person,a,"project_list_person_"+self.locals.person.id+"_add_to_project_"+a.id+"_",self)})}};this.validatePeopleForm=function(a){var b=[];if(a.username==""){b.push("Username can't be blank")}if(!a.username.match(/^[a-z]+[a-z0-9]*$/)){b.push("Username may only contain lowercase letters [a-z] and no spaces or special characters")}if(a.username.length<3||a.username.length>20){b.push("Username should be between 3 and 20 characters")}if(a.email==""){b.push("Email can't be blank")}if(!a.email.match(/([a-zA-Z0-9_\-])+(\.([a-zA-Z0-9_\-])+)*@((\[(((([0-1])?([0-9])?[0-9])|(2[0-4][0-9])|(2[0-5][0-5])))\.(((([0-1])?([0-9])?[0-9])|(2[0-4][0-9])|(2[0-5][0-5])))\.(((([0-1])?([0-9])?[0-9])|(2[0-4][0-9])|(2[0-5][0-5])))\.(((([0-1])?([0-9])?[0-9])|(2[0-4][0-9])|(2[0-5][0-5]))\]))|((([a-zA-Z0-9])+(([\-])+([a-zA-Z0-9])+)*\.)+([a-zA-Z])+(([\-])+([a-zA-Z0-9])+)*))/)){b.push("Email is invalid")}if(a.password!=""&&a.password!=a.password_confirmation){b.push("The password and confirmation must match")}if(b.length){alert(b.join("\n"));return false}return true};this.validatePublicKeysForm=function(a){var b=[];if(a.title==""){b.push("Title can't be blank")}if(a.value==""){b.push("Value can't be blank")}if(b.length){alert(b.join("\n"));return false}return true};this.show()};

UI.TimeInvested=function(h){this.tmp=Unfuddle.UI.Renderer;this.tmp(h);delete this.tmp;this.containerID="#content";this.domID="#time_invested_render";this.baseUrl=h.project_id?"/projects/"+h.project_id+"/time_invested":"/account/time_invested";this.addJsTemplate("time_tracking");if((Globals.currentProject&&Globals.currentPerson.seeIf(Globals.currentProject,"canReadMilestones"))||(!Globals.currentProject&&Globals.currentPerson.seeIfAtAll("canReadMilestones"))){this.dependsOn("Milestone",(h.project_id?("/projects/"+h.project_id):"")+"/milestones",{essential:true,findParams:{apiParams:{archived:false}}})}var self=this;this.renderPass=false;var f=new Date();this.report={};this.reportDefault={group_by:"person",sort_by:"date",sort_direction:"ASC",end_date:Utilities.formatDate(f,{format:"dashStyle",hover:false}),start_date:Utilities.formatDate(new Date(f.setDate(f.getDate()-6)),{format:"dashStyle",hover:false})};$.extend(self.report,self.reportDefault);this.locals={preselectedDate:"last_7_days",rangeType:"date_range"};this.checkBeforeRender=function(){var a=true;return self.renderPass&&a};this.runReport=function(e,d){$.ajax({type:"GET",url:Config.baseApiUrl+self.baseUrl+".json",dataType:"json",data:$.extend(e,{tickets:true}),success:function(g,b){self.tickets={};$.each(g.tickets,function(a,c){self.tickets[c.id]=new Ticket.Base(c)});d(g)},error:function(a,c,g){var b=[];try{b=JSON.parse(a.responseText)}catch(err){}if(b.length<=0){b=["An unexpected error occured. Please try again!"]}Helpers.toggleAjaxBttn($("#time_tracking_regenerate_submit"),false);alert(b.join("\n"))}})};this.runReport($.extend({},self.report,{preselected_date:self.locals.preselectedDate,range_type:"date_range"}),function(a){if(!a.sort_by){a.sort_by="date"}if(!a.sort_direction){a.sort_direction="ASC"}self.report=a;self.renderPass=true;self.render()});this.renderMain=function(){this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);var d=self.locals;$.extend(d,{options:h,selectDateOptions:[["today","today"],["yesterday","yesterday"],["last 7 days","last_7_days"],["last week (Mon-Sun)","last_week"],["last business week (Mon-Fri)","last_business_week"],["this month","this_month"],["last month","last_month"],["all time","all_time"]],groupByOptions:[["<none>","none"],["Person","person"],["Project","project"],["Ticket","ticket"],["Component","component"],["Version","version"]],fieldWidthTotal:0});self.report.fields=["project","date","milestone","ticket","person","description","hours"];if(h.project_id){self.report.fields.remove("project");if(!Person.current().seeIf(Project.current(),"canReadMilestones")){self.report.fields.remove("milestone")}else{d.groupByOptions.push(["Milestone","milestone"])}}else{if(!Person.current().seeIfAtAll("canReadMilestones")){self.report.fields.remove("milestone")}else{d.groupByOptions.push(["Milestone","milestone"])}if(self.report.group_by){self.report.fields.remove(self.report.group_by)}}$.each(self.report.fields,function(a,c){d.fieldWidthTotal+=TimeEntry.fieldHeading(c).width_weight;self.report.fieldHeading=self.report.fieldHeading||{};self.report.fieldHeading[c]=TimeEntry.fieldHeading(c)});self.report.groups.forEach(function(e){e._totalFormatted=e.total.toFixed(2);$.each(e.time_entries,function(c,g){e.time_entries[c]=new TimeEntry.Base(g);var b=e.time_entries[c];b.__ticket=self.tickets[b.ticket_id];b._ticket=b.ticket();b._ticket.priority_name_downcase=b._ticket.priorityName().toLowerCase();b._canReadMilestones=Globals.currentPerson.seeIf(Project.find(b._ticket.project_id)[0],"canReadMilestones");self.report.fields.forEach(function(a){b._prettyField=b._prettyField||{};b._prettyField[a]=a=="date"?Utilities.formatDate(b.prettyField(a),{format:"withoutTime"}):b.prettyField(a)})})});var i={startDateFormatted:self.report.start_date?Utilities.formatDate(self.report.start_date,{format:"datePicker",hover:false}):"No Date",endDateFormatted:Utilities.formatDate(self.report.end_date,{format:"datePicker",hover:false})};$.extend(self.report,i);self.report.title="Time Invested"+(self.report.group_by?(" by "+self.report.group_by.toString().humanize()):"");self.report.fieldsLength=self.report.fields.length;this.holder.append(Unfuddle.Template.TimeTracking.timeInvested({locals:d,report:self.report}));$("#date_range_form").submit(function(){var c=$("#time_tracking_regenerate_submit");Helpers.toggleAjaxBttn(c,false);var g={group_by:$("#group_by").val(),sort_by:self.report.sort_by||"date",sort_direction:self.report.sort_direction||"ASC",end_date:$("#end_date").val()||Utilities.formatDate(new Date,{format:"dashStyle",hover:false}),start_date:$("#start_date").val(),range_type:$("input[@name='range_type']:checked").val(),preselected_date:$("#preselected_date").val()};self.locals.rangeType=g.range_type;self.locals.preselectedDate=g.preselected_date;self.runReport(g,function(a){if(!a.sort_by){a.sort_by="date"}if(!a.sort_direction){a.sort_direction="ASC"}self.report=a;self.refresh()})});self.report.fields.forEach(function(a){$("."+a+"_sort").click(function(){self.report.sort_direction=self.report.sort_by==a?(self.report.sort_direction=="ASC"?"DESC":"ASC"):"ASC";self.report.sort_by=a;self.report=TimeEntry.reportSort(self.report);self.refresh();return false})})};this.show()};UI.OverallProgress=function(f){this.tmp=Unfuddle.UI.Renderer;this.tmp(f);delete this.tmp;this.containerID="#content";this.domID="#overall_progress_render";this.baseUrl="/projects/"+f.project_id+"/overall_progress";this.addJsTemplate("time_tracking");var self=this;this.renderPass=false;this.report={};this.reportDefault={title:"Overall Progress",fields:["number","summary","assignee","status","hours_estimate_initial","hours_estimate_current","hours_actual","percentage_complete"],sort_by:null,sort_direction:null,entire_project:{},groups:{}};$.extend(self.report,self.reportDefault);this.checkBeforeRender=function(){var e=true;if(Globals.currentPerson.seeIf(Globals.currentProject,"canReadMilestones")){if(!self.timeInvestedReport){$.ajax({type:"GET",url:Config.baseApiUrl+"/projects/"+f.project_id+"/time_invested.json",dataType:"json",data:{preselected_date:"all_time",range_type:"preselected",group_by:"ticket"},success:function(a,c){self.timeInvestedReport=a;self.refresh()},error:function(a,c,g){var b=[];try{b=JSON.parse(a.responseText)}catch(err){}if(b.length<=0){b=["An unexpected error occured. Please try again!"]}alert(b.join("\n"))}})}this.dependsOn("Milestone","/projects/"+f.project_id+"/milestones",{essential:true,findParams:{apiParams:{archived:false}}});this.dependsOn("OverallProgress",this.baseUrl,{essential:true,findParams:{apiParams:{tickets:true}}});if(OverallProgress.find({sourceUrl:this.baseUrl,apiParams:{tickets:true}}).pending||Milestone.find({sourceUrl:"/projects/"+f.project_id+"/milestones",apiParams:{archived:false}}).pending){e=false}}else{self.timeInvestedReport={};this.dependsOn("OverallProgress",this.baseUrl,{essential:true,findParams:{apiParams:{archived:false}}});if(OverallProgress.find({sourceUrl:this.baseUrl,apiParams:{archived:false}}).pending){e=false}}return!!self.timeInvestedReport&&e};this.renderMain=function(){this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);var i={options:f,fieldWidthTotal:0,canReadMilestones:Globals.currentPerson.seeIf(Globals.currentProject,"canReadMilestones")};$.extend(self.report,OverallProgress.find(f.project_id)[0]);self.report.fieldsLength=self.report.fields.length;if(Globals.currentPerson.seeIf(Globals.currentProject,"canReadMilestones")){var h={};self.timeInvestedReport.groups.forEach(function(a){h[a.time_entries[0].ticket_id]=parseFloat(a.total)});$.each(self.report.milestones,function(e,d){if(!d.milestone_id){return true}d._title=Milestone.find(d.milestone_id)[0].title;d.tickets=d.tickets.map(function(a){return new Ticket.Base(a)});$.each(d.tickets,function(g,b){b.__hoursActual=h[b.id]||0;b._percentageComplete=b.percentageComplete();b.priority_name_downcase=b.priorityName().toLowerCase();$.each(self.report.fields,function(a,c){b._prettyField=b._prettyField||{};b._prettyField[c]=b.prettyField(c)})})});$.each(self.report.fields,function(a,c){i.fieldWidthTotal+=Ticket.fieldHeading(c).width_weight;self.report.fieldHeading=self.report.fieldHeading||{};self.report.fieldHeading[c]=Ticket.fieldHeading(c)})}this.holder.append(Unfuddle.Template.TimeTracking.overallProgress({locals:i,report:self.report}));self.report.fields.forEach(function(a){$("."+a+"_sort").click(function(){self.report.sort_direction=self.report.sort_by==a?(self.report.sort_direction=="ASC"?"DESC":"ASC"):"ASC";self.report.sort_by=a;self.report=OverallProgress.reportSort(self.report);self.refresh();return false})})};this.show()};

UI.Search=function(b){this.tmp=Unfuddle.UI.Renderer;this.tmp(b);delete this.tmp;var b=$.extend({query:""},b);this.domID="#search_page_render";this.containerID="#content";var self=this;var g=Globals.currentAccount.hasFeature("beta");this.filters=[{name:"changesets"},{name:"comments"},{name:"messages"},{name:"milestones"},{name:"notebooks"},{name:"tickets"}];if(g){this.filters.push({name:"commit_comments"})}this.addJsTemplate("search");this.checkBeforeRender=function(){if(!self.results&&!self.searchCallPending){this.makeSearchCall()}return!!self.results};this.makeSearchCall=function(){self.searchCallPending=true;b.query=Url.decode(b.query.replace(/\+/g," "));b.page=b.page||1;self.parameters={truncate:250,query:b.query};self.pageItems=50;if(b.filter){self.parameters.filter=Url.decode(b.filter)}if(b.page){self.parameters.page=b.page;self.parameters.start_index=(self.parameters.page-1)*self.pageItems;self.parameters.end_index=self.parameters.page*self.pageItems-1}$.ajax({type:"GET",data:self.parameters,dataType:"json",url:Config.baseApiUrl+(b.project_id?"/projects/"+b.project_id:"/account")+"/search.json",success:function(a,c){delete(self.searchCallPending);if(a==null){a=[]}self.results=a;self.refresh()},error:function(a,c,e){delete(self.searchCallPending);var d=[];try{d=JSON.parse(a.responseText)}catch(err){}if(d.length<=0){d=["An unexpected error occured. Please try again!"]}self.notifyUser("error",d)}})};this.renderMain=function(){this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);var e=self.pageItems;var d=self.results;var f=!b.filter?[]:Url.decode(b.filter).split(",");$.each(this.filters,function(a,c){c._capitalized=c.name.capitalize();c._checked=!b.filter||f.include(c.name)});$.each(d,function(a,result){result.project=Project.find(result.project_id)?Project.find(result.project_id)[0]:null;if(result.updated_at){result._updatedAt=Utilities.formatDate(result.updated_at,{format:"withTime"})}result._description=Utilities.formatText(result.description,{format:"compact"});result._location=Utilities.searchItemLocation(result);if(result.type=="Milestone"){result._dueOn=Utilities.formatDate(Utilities.parseDate(result.due_on),{format:"noTime"});if(result.person_responsible_id){result._personResponsible=Person.find(result.person_responsible_id)[0]?Person.find(result.person_responsible_id)[0].displayName():""}}if(result.type=="Ticket"){result._status=result.status.humanize().toUpperCase()}if(result.type=="Comment"){result._authorDisplayName=Person.find(result.author_id)[0]?Person.find(result.author_id)[0].displayName():""}if((result.type=="Changeset"||result.type=="CommitComment")&&result.created_at){result._createdAt=Utilities.formatDate(result.created_at,{format:"withTime"});if(result.author_id){result._authorDisplayName=Person.find(result.author_id)[0]?Person.find(result.author_id)[0].displayName():""}}});var h={projects:Globals.currentAccount.activeProjects(),currentProject:Globals.currentProject,results:d,query:b.query,filters:this.filters,totalResults:d.length>0?d[0].total_count:0,startIndex:self.parameters.start_index,endIndex:self.parameters.start_index-1+d.length,canManageMilestonesAtAll:Globals.currentPerson.seeIfAtAll("canManageMilestones"),canInvitePeopleAtAll:Globals.currentPerson.seeIfAtAll("canInvitePeople"),canCreateMessagesAtAll:Globals.currentPerson.seeIfAtAll("canCreateMessages"),canCreateTicketsAtAll:Globals.currentPerson.seeIfAtAll("canCreateTickets"),beta:g};this.holder.append(Unfuddle.Template.Search.searchPage({locals:h}));this.setFilter();this.setBindings(h);Helpers.buildPageLinks(b.page,e,h.totalResults)};this.setBindings=function(f){$.each(this.filters,function(a,c){$("#filter_"+c.name).click(function(){self.setFilter()})});clickSubmit=function(){self.setFilter();var a=Url.encode($("#filter").val());var c=$("#search_again_scope_selector").val();var e=Url.encode($("#temp_query").val()).replace(/\+/g,"%2B").replace(/%20/g,"+");var d="?query="+e+(a==""?"":"&filter="+a);if(c=="search_account"){UI.Bookmarker.redirectTo(UI.Bookmarker.bookmarkFor("account_search")+d,true)}else{UI.Bookmarker.redirectTo(UI.Bookmarker.bookmarkFor("project_search",{project_id:c})+d,true)}};$("#search_again_form").submit(function(){clickSubmit();return false});if(f.canCreateMessagesAtAll){$("#message_new_link").click(function(){self.renderMainLocked=false;var a=b;a.containerID="#message_new_search_page";new UI.MessageNew(a);return false})}if(Globals.currentPerson.is_administrator){$("#project_new_link").click(function(){self.renderMainLocked=false;var a=b;a.containerID="#project_new_search_page";new UI.ProjectNew(a);return false})}if(f.canManageMilestonesAtAll){$("#milestone_new_link").click(function(){self.renderMainLocked=false;var a=b;a.containerID="#milestone_new_search_page";new UI.MilestoneNew(a);return false})}if(f.canCreateTicketsAtAll){$("#ticket_new_link").click(function(){self.renderMainLocked=false;var a=b;a.container="#ticket_new_search_page";a.from="search_page";new UI.TicketNew(a);return false})}if(f.canInvitePeopleAtAll){$("#person_new_link").click(function(){self.renderMainLocked=false;var a=b;a.containerID="#person_new_search_page";new UI.PersonNew(a);return false})}};this.setFilter=function(){var a=["changesets","comments","messages","milestones","notebooks","tickets"];if(g){a.push("commit_comments")}var c=[];for(var e=0;e<a.length;e++){if($("#filter_"+a[e])[0].checked){c.push(a[e])}}$("#filter")[0].value=c.join(",")};this.show()};

UI.Activity=function(i){this.tmp=Unfuddle.UI.Renderer;this.tmp(i);delete this.tmp;this.domID="#overview_page";this.containerID="#content";var self=this;this.addJsTemplate("activity");this.checkBeforeRender=function(){var a=Globals.currentProject;var b=Globals.currentPerson;this.locals.canCreateMessages=a?b.seeIf(a,"canCreateMessages"):b.seeIfAtAll("canCreateMessages");this.locals.canManageMilestones=a?b.seeIf(a,"canManageMilestones"):b.seeIfAtAll("canManageMilestones");this.locals.canReadTickets=a?b.seeIf(a,"canReadTickets"):b.seeIfAtAll("canReadTickets");this.locals.canCreateTickets=a?b.seeIf(a,"canCreateTickets"):b.seeIfAtAll("canCreateTickets");this.locals.canInvitePeople=a?b.seeIf(a,"canInvitePeople"):b.seeIfAtAll("canInvitePeople");this.locals.canReadMessages=a?b.seeIf(a,"canReadMessages"):b.seeIfAtAll("canReadMessages");this.locals.canReadMilestones=a?b.seeIf(a,"canReadMilestones"):b.seeIfAtAll("canReadMilestones");this.locals.scope=a?"project":"account";this.locals.upcomingTicketsHolder=(self.locals.scope=="project"?"project_"+Globals.currentProject.id:"account")+"_upcoming_tickets_holder";this.locals.projects=a?[a]:Globals.currentPerson.activeProjects();this.locals.recentActivityPlaceholder=(self.locals.scope=="project"?"project_"+Globals.currentProject.id:"account")+"_recent_activity_placeholder";this.locals.limit=50;this.locals.offset=0;if(this.locals.canReadMessages){self.dependsOnMessagesUrl=Globals.currentProject?("/projects/"+Globals.currentProject.id+"/messages"):"/messages";var d=new Date();self.messagesApiParams={active_after:Utilities.formatDate(new Date(d.setDate(d.getDate()-14)),{format:"dashStyle",hover:false}),comments:true};Message.Cache.retrieve({sourceUrl:self.dependsOnMessagesUrl,apiParams:self.messagesApiParams,callback:function(){self.renderRecentMessages("/messages")}})}if(this.locals.canReadMilestones){this.dependsOn("Milestone",(a?("/projects/"+a.id):"")+"/milestones",{findParams:{apiParams:{archived:false}},callback:function(c){self.renderUpcomingMilestones(c);self.renderLateMilestones(c)}})}if(this.locals.canReadTickets){Ticket.getUpcoming(function(c){self.upcomingTickets=c;self.renderUpcomingTickets("/tickets/upcoming")},{project:Globals.currentProject})}Activity.retrieve((a?"/projects/"+a.id:"/account")+"/activity",{limit:self.locals.limit,offset:self.locals.offset},function(c){if(c&&c[0]){self.endDate=c[0].created_at}self.activityData=c;self.renderActivity("/activity")});return true};this.renderMain=function(){this.renderMainLocked=true;this.holder=$("<div/>").attr("id",this.domID.slice(1)).appendTo(this.containerID);this.holder.append(Unfuddle.Template.Activity.viewActivity({locals:this.locals}));this.recentMessagesRendered=false;this.renderedActivity=this.renderedActivity||false;if(this.locals.canReadMilestones){this.renderedMilestones={};this.renderedMilestones.late=false;this.renderedMilestones.upcoming=false;this.renderUpcomingMilestones("renderMain");this.renderLateMilestones("renderMain")}this.renderRecentMessages("renderMain");this.renderActivity("renderMain");this.setNewBindings()};this.setNewBindings=function(){if(this.locals.canCreateMessages){$("#message_new_link").click(function(){var c=i;c.containerID="#message_new_dashboard";new Unfuddle.UI.MessageNew(c);return false})}if(this.locals.canManageMilestones){$("#milestone_new_link").click(function(){var c=i;c.containerID="#milestone_new_dashboard";new Unfuddle.UI.MilestoneNew(c);return false})}if(this.locals.canCreateTickets){$("#ticket_new_link").click(function(){var c=i;c.container="#ticket_new_dashboard";c.from="dashboard";new Unfuddle.UI.TicketNew(c);return false})}if(Globals.currentPerson.is_administrator&&this.locals.scope=="account"){$("#project_new_link").click(function(){var c=i;c.containerID="#project_new_dashboard";new Unfuddle.UI.ProjectNew(c);return false})}if(this.locals.canInvitePeople){$("#person_new_link").click(function(){var c=i;c.containerID="#person_new_dashboard";new Unfuddle.UI.PersonNew(c);return false})}};this.renderRecentMessages=function(e){if(this.recentMessagesRendered||!e){return}var f=$("#recent_messages_placeholder").html('<img class="ajax_progress_small" src="/images/ajax.16.black.gif" />');if(e=="renderMain"){return}this.locals.scope=Globals.currentProject?"project":"account";this.locals.messages=Message.find({sourceUrl:self.dependsOnMessagesUrl,apiParams:self.messagesApiParams,order:"active_at DESC"});$.each(self.locals.messages,function(c,a){var b=Project.find(a.project_id)[0];a._theme=b.theme;a._projectTitle=b.title;a._canReadPeople=Globals.currentPerson.seeIf(b,"canReadPeople");if(a._canReadPeople){var d=Person.find(a.author_id)[0];a.authorDisplayName=d?d.displayName():""}a.messageDateFormatted=Utilities.formatDate(a.created_at,{prefix:true})});f.html(Unfuddle.Template.Activity.recentMessagesBlock({locals:this.locals}));$.each(self.locals.messages,function(a,b){var d=$("#message_body_holder_"+b.id);d.html(Utilities.formatText(b.body,{format:b.body_format,constrain:Globals.currentProject?751:251,project:Project.find(b.project_id)[0],callback:function(c){d.html(c)}}));self.renderComments(b)});if(e!="renderMain"){this.recentMessagesRendered=true}this.checkEmptyRecentMessages()};this.renderComments=function(c){var a=$("#comment_count_message_"+c.id);var b=c.comments||[];b.sortByExpression("created_at desc");var d=b[0];if(d){if(c._canReadPeople){var e=Person.find(d.author_id)[0];d._authorDisplayName=e?e.displayName():""}d._createdAt=Utilities.formatDate(d.created_at,{prefix:true,hover:false});a.html(Unfuddle.Template.Activity.commentCount({count:b.length,lastComment:d,message:c}))}};this.prepareMilestones=function(g,j){var h=[];var k=$("#milestones_"+g);$.each(self.locals.projects,function(e,f){$.each(g=="late"?f.lateMilestones():f.upcomingMilestones(),function(a,b){b._project=f;b._dueOn=b.due_on?Utilities.formatDate(b.due_on,{format:"short"}):"<none>";b._titleEscaped=Url.encode(b.title);b._descriptionFormatted=Utilities.formatText(b.description,{format:b.description_format,project:Globals.currentProject,callback:function(c){$("#show_milestone_description").html(c)}});if(b.person_responsible_id&&Globals.currentPerson.seeIf(f,"canReadPeople")){var d=Person.find(b.person_responsible_id)[0];b._personResponsible=d?d.displayName():""}h.push(b)})});this.locals[g+"Milestones"]=h.length>0?h.sortByExpression("object.due_on asc"):[];if(h.length>0){k.html(Unfuddle.Template.Activity[g+"Milestones"]({locals:this.locals}))}if(j!="renderMain"){this.renderedMilestones[g]=true}this.checkEmptyMilestones()};this.renderUpcomingMilestones=function(c){if(!c||this.renderedMilestones.upcoming){return false}this.prepareMilestones("upcoming",c)};this.renderLateMilestones=function(c){if(!c||this.renderedMilestones.late){return false}this.prepareMilestones("late",c)};this.checkEmptyMilestones=function(){if(this.renderedMilestones.late&&this.renderedMilestones.upcoming&&this.locals.lateMilestones.length<=0&&this.locals.upcomingMilestones.length<=0){$("#no_recent_milestones").html(Unfuddle.Template.Activity.noRecentMilestones())}};this.checkEmptyRecentMessages=function(){if(this.recentMessagesRendered&&this.locals.messages.length<=0){$("#recent_messages_placeholder").html(Unfuddle.Template.Activity.noRecentMessages())}};this.renderUpcomingTickets=function(b){if(!b||this.renderedUpcomingTickets){return false}if(self.locals.canReadTickets){$.each(self.upcomingTickets,function(c,a){a._priority=a.priorityName().toLowerCase();a._project=a.project();a._dueOnFormatted=Utilities.formatDate(a.due_on,{format:"withoutTime"})});$("#"+self.locals.upcomingTicketsHolder).html(Unfuddle.Template.Activity.upcomingTickets({locals:{upcomingTickets:self.upcomingTickets}}));if(b!="renderMain"){this.renderedUpcomingTickets=true}}};this.checkEmptyRecentActivity=function(){if(this.renderedActivity&&this.locals.recentActivity.length<=0){if(this.locals.offset>0){$("#show_older_recent_activity").html(Unfuddle.Template.Activity.noRecentActivity({locals:this.locals}))}else{$("#"+self.locals.recentActivityPlaceholder).html(Unfuddle.Template.Activity.noRecentActivity({locals:this.locals}))}}};this.renderActivity=function(h){if(!h||this.renderedActivity){return false}if(self.activityData==null){$("#"+self.locals.recentActivityPlaceholder).html('<img class="ajax_progress_small" src="/images/ajax.16.black.gif" />');return}this.locals.recentActivity=this.activityData.filter(function(c){return["Comment","Changeset","Milestone","Ticket","Page","CommitComment"].include(c.record_type)});$.each(self.locals.projects,function(e,f){$.each(self.locals.recentActivity,function(c,a){a._project=Project.find(a.project_id)[0];a._event=a.pastTense(a.event);a._createdAt=Utilities.formatDate(a.created_at,{prefix:true});a._recordType=a.record?a.record.comment?a.record.comment.parent_type.toLowerCase():"":"";if(!a.id){a.id=Math.random().toString().substring(2,16)}if(a.person_id&&Globals.currentPerson.seeIf(f,"canReadPeople")){var b=Person.find(a.person_id)[0];a._personName=b?b.displayName():""}if(a.record_type=="Changeset"){a._createdAt=Utilities.formatDate(a.record.changeset.committer_date,{prefix:true})}if(a.record_type=="Milestone"){a.record.milestone._titleEscaped=Url.encode(a.record.milestone.title)}if(a.record_type=="Ticket"){if(a.record.ticket.resolution&&a.record.ticket.resolution!=""){var d=new Ticket.Base(a.record.ticket);a._prettyResolution=d.prettyField("resolution")}}if(a.record_type=="CommitComment"){}})});if(h=="show_more"){$("#older_recent_activity_placeholder").append(Unfuddle.Template.Activity.recentActivity({locals:this.locals}))}else{$("#"+self.locals.recentActivityPlaceholder).html(Unfuddle.Template.Activity.recentActivity({locals:this.locals}))}$.each(self.locals.recentActivity,function(a,b){if(b.record_type=="Comment"){var d=$("#comment_body_holder_"+b.id);d.html(Utilities.formatText(b.record.comment.body,{format:"plain",project:b._project,constrain:250,callback:function(c){d.html(c)}}))}if(b.record_type=="CommitComment"){var e=$("#commit_comment_body_holder_"+b.id);e.html(Utilities.formatText(b.record.commit_comment.body,{format:"plain",project:b._project,constrain:250,callback:function(c){e.html(c)}}))}if(b.record_type=="Changeset"){var f=$("#changeset_body_holder_"+b.id);f.html(Utilities.formatText(b.record.changeset.message,{format:"plain",project:b._project,constrain:250,callback:function(c){f.html(c)}}))}if(b.record_type=="Ticket"){if(b.event=="reassign"){var g=$("#ticket_description_holder_"+b.id);g.html(Utilities.formatText(b.description,{format:"markdown",project:b._project,callback:function(c){g.html(c)}}))}}if(b.record_type=="Page"){var j=$("#page_body_holder_"+b.id);if(b.description&&b.description.length>0){j.html(Utilities.formatText(b.description,{format:self.locals.scope=="account"?"plain":"markdown",project:b._project,constrain:self.locals.scope=="account"?250:null,callback:function(c){j.html(c)}}))}}});if($("#show_older_progress_img").length>0){$("#show_older_progress").html("")}if(h!="renderMain"){this.renderedActivity=true}this.checkEmptyRecentActivity();$("#show_older_recent_activity_link").click(function(){self.locals.offset+=self.locals.limit;if($("#show_older_progress_img").length<=0){$("#show_older_progress").append('<img id="show_older_progress_img" class="ajax_progress_small" src="/images/ajax.16.black.gif" />')}Activity.retrieve((Globals.currentProject?"/projects/"+Globals.currentProject.id:"/account")+"/activity",$.extend({limit:self.locals.limit,offset:self.locals.offset},self.endDate?{endDate:self.endDate}:{}),function(c){self.activityData=c;self.renderedActivity=false;$("#show_older_recent_activity_link").unbind("click");self.renderActivity("show_more")});return false})};this.renderUpcomingTickets=function(b){if(!b||this.renderedUpcomingTickets){return false}if(self.locals.canReadTickets){$.each(self.upcomingTickets,function(c,a){a._priority=a.priorityName().toLowerCase();a._project=a.project();a._dueOnFormatted=Utilities.formatDate(a.due_on,{format:"withoutTime"})});$("#"+self.locals.upcomingTicketsHolder).html(Unfuddle.Template.Activity.upcomingTickets({locals:{upcomingTickets:self.upcomingTickets}}));if(b!="renderMain"){this.renderedUpcomingTickets=true}}};this.show()};

$(document).ready(function(){$.ajaxSetup({beforeSend:function(a){if(this.dataType!="script"&&UI.Helpers.checkSessionExpired()){return false}if(location.protocol=="https:"){a.setRequestHeader("X-Unfuddle-Ajax-Secure",1)}a.setRequestHeader("X-Unfuddle-Ajax-Client",1)}});$("#ajax_working").bind("ajaxStart",function(){$(this).show()}).bind("ajaxStop",function(){$(this).hide()});Unfuddle.UI.Bookmarker.addListener();setInterval("Unfuddle.Utilities.checkSessionExpiration()",5*60*1000);Unfuddle.Data.getBasicDependencies(function(){UI.Bookmarker.redirectTo()})});

// This file was automatically generated from helpers.soy.
// Please don't edit this file by hand.

if (typeof Unfuddle == 'undefined') { var Unfuddle = {}; }
if (typeof Unfuddle.Template == 'undefined') { Unfuddle.Template = {}; }
if (typeof Unfuddle.Template.Helpers == 'undefined') { Unfuddle.Template.Helpers = {}; }


Unfuddle.Template.Helpers.datePicker = function(opt_data) {
  return '<input type="hidden" value="' + ((opt_data.dateValue) ? soy.$$escapeHtml(opt_data.dateValue) : '') + '" id="' + soy.$$escapeHtml(opt_data.domId) + '"/><a onclick="DatePicker.toggleDatePicker(\'#' + soy.$$escapeHtml(opt_data.domId) + '\', ' + ((opt_data.allowNil) ? soy.$$escapeHtml(opt_data.allowNil) : 'false') + ', ' + ((opt_data.nilText) ? '\'' + soy.$$escapeHtml(opt_data.nilText) + '\'' : '\'No Date\'') + ', ' + ((opt_data.allowNone) ? soy.$$escapeHtml(opt_data.allowNone) : 'false') + ', ' + ((opt_data.noneText) ? '\'' + soy.$$escapeHtml(opt_data.noneText) + '\'' : '\'No Date\'') + ', ' + ((opt_data.idsToHide) ? soy.$$escapeHtml(opt_data.idsToHide) : '[]') + '); return false;" href="#" class="date_picker_link" id="' + soy.$$escapeHtml(opt_data.domId) + '_link" ' + ((opt_data.tabIndex) ? 'tabindex="' + soy.$$escapeHtml(opt_data.tabIndex) + '"' : '') + '>' + ((opt_data.displayValue) ? soy.$$escapeHtml(opt_data.displayValue) : soy.$$escapeHtml(opt_data.nilText)) + '</a> <a onclick="DatePicker.toggleDatePicker(\'#' + soy.$$escapeHtml(opt_data.domId) + '\', ' + ((opt_data.allowNil) ? soy.$$escapeHtml(opt_data.allowNil) : 'false') + ', ' + ((opt_data.nilText) ? '\'' + soy.$$escapeHtml(opt_data.nilText) + '\'' : '\'No Date\'') + ', ' + ((opt_data.allowNone) ? soy.$$escapeHtml(opt_data.allowNone) : 'false') + ', ' + ((opt_data.noneText) ? '\'' + soy.$$escapeHtml(opt_data.noneText) + '\'' : '\'No Date\'') + ', ' + ((opt_data.idsToHide) ? soy.$$escapeHtml(opt_data.idsToHide) : '[]') + '); return false;" href="#" class="date_picker_link"><img alt="Change Date" src="/images/icons/ics.png"/></a><div style="display: none;" id="' + soy.$$escapeHtml(opt_data.domId) + '_calendar" class="date_picker"></div>';
};


Unfuddle.Template.Helpers.select = function(opt_data) {
  var output = '<select' + ((opt_data.id != null) ? ' id=\'' + soy.$$escapeHtml(opt_data.id) + '\'' : '') + ((opt_data.attributes) ? ' ' + opt_data.attributes : '') + '>';
  if (opt_data.options) {
    var pairList113 = opt_data.options;
    var pairListLen113 = pairList113.length;
    for (var pairIndex113 = 0; pairIndex113 < pairListLen113; pairIndex113++) {
      var pairData113 = pairList113[pairIndex113];
      output += '<option value="' + soy.$$escapeHtml(pairData113[0]) + '" ' + ((pairData113[0] == opt_data.selectedValue) ? 'selected="selected"' : '') + ' ' + ((pairData113[2] && pairData113[2] == 'disabled') ? 'disabled="disabled"' : '') + '>' + soy.$$escapeHtml(pairData113[1]) + '</option>';
    }
  }
  if (opt_data.optionsRuby) {
    var pairList130 = opt_data.optionsRuby;
    var pairListLen130 = pairList130.length;
    for (var pairIndex130 = 0; pairIndex130 < pairListLen130; pairIndex130++) {
      var pairData130 = pairList130[pairIndex130];
      output += '<option value="' + soy.$$escapeHtml(pairData130[1]) + '" ' + ((pairData130[1] == opt_data.selectedValue) ? 'selected="selected"' : '') + ' ' + ((pairData130[2] && pairData130[2] == 'disabled') ? 'disabled="disabled"' : '') + '>' + soy.$$escapeHtml(pairData130[0]) + '</option>';
    }
  }
  output += '</select>';
  return output;
};


Unfuddle.Template.Helpers.backupsList = function(opt_data) {
  var output = '';
  if (opt_data.backup.processed) {
    if (opt_data.backup.parts > 1) {
      if (opt_data.sidebar) {
        output += '<li id="parts_list_' + soy.$$escapeHtml(opt_data.backup.id) + '" class="parts_list"><a href="#" onclick=\'$("#parts_list_' + soy.$$escapeHtml(opt_data.backup.id) + ' ul").toggle(); return false;\'>' + opt_data.backup._processedAt + ' (' + soy.$$escapeHtml(opt_data.backup.parts) + ' parts)</a><ul style="display: none;">';
        var iLimit163 = opt_data.backup.parts;
        for (var i163 = 0; i163 < iLimit163; i163++) {
          output += '<li><a href="' + soy.$$escapeHtml(Config.baseApiUrl) + '/projects/' + soy.$$escapeHtml(opt_data.backup.project_id) + '/backups/' + soy.$$escapeHtml(opt_data.backup.id) + '/parts/' + soy.$$escapeHtml(i163 + 1) + '/download">part ' + soy.$$escapeHtml(i163 + 1) + '</a></li>';
        }
        output += '</ul></li>';
      } else {
        output += '<a href="#" onclick="$(\'#backup_' + soy.$$escapeHtml(opt_data.backup.id) + '_parts\').toggle(); return false;">' + opt_data.backup._processedAt + ' (' + soy.$$escapeHtml(opt_data.backup.parts) + ' parts)</a> <span style="display: none;" id="backup_' + soy.$$escapeHtml(opt_data.backup.id) + '_parts">';
        var iLimit187 = opt_data.backup.parts;
        for (var i187 = 0; i187 < iLimit187; i187++) {
          output += '<a href="' + soy.$$escapeHtml(Config.baseApiUrl) + '/projects/' + soy.$$escapeHtml(opt_data.backup.project_id) + '/backups/' + soy.$$escapeHtml(opt_data.backup.id) + '/parts/' + soy.$$escapeHtml(i187 + 1) + '/download">part ' + soy.$$escapeHtml(i187 + 1) + '</a> ';
        }
        output += '</span>';
      }
    } else {
      output += ((opt_data.sidebar) ? '<li>' : '') + '<a href="' + soy.$$escapeHtml(Config.baseApiUrl) + '/projects/' + soy.$$escapeHtml(opt_data.backup.project_id) + '/backups/' + soy.$$escapeHtml(opt_data.backup.id) + '/download">' + opt_data.backup._processedAt + '</a>' + ((opt_data.sidebar) ? '</li>' : '');
    }
  } else {
    output += ((opt_data.sidebar) ? '<li>' : '') + opt_data.backup._createdAt + ' <em>(processing...)</em>' + ((opt_data.sidebar) ? '</li>' : '');
  }
  return output;
};

// This file was automatically generated from general.soy.
// Please don't edit this file by hand.

if (typeof Unfuddle == 'undefined') { var Unfuddle = {}; }
if (typeof Unfuddle.Template == 'undefined') { Unfuddle.Template = {}; }
if (typeof Unfuddle.Template.General == 'undefined') { Unfuddle.Template.General = {}; }


Unfuddle.Template.General.supportFeedback = function(opt_data) {
  return '<div style="display: none;" id="send_feedback"><h3>We want to hear from you!</h3><p>Is there something you feel Unfuddle could do better for you? We want to know!</p><form id="send_feedback_form" onsubmit="return false;"><div style="float: left; width: 100%;"><textarea rows="6" name="feedback" id="feedback" cols="10"/><div style="clear: both; height: 0px; font-size: 0pt; line-height: 0pt;"></div></div><div class="actions"><input type="submit" id="send_feedback_submit" value="Send"/> or  <a onclick="$(\'#send_feedback\').hide(); $(\'#send_feedback_form\')[0].reset(); $(\'#send_feedback_action\').show(); return false;" href="#">Cancel</a></div></form></div><div style="display: none;" id="send_feedback_thanks"><h3>Thanks for your feedback!</h3><p>We are constantly trying to make Unfuddle better and your feedback directly influences the changes we make.</p></div><div class="icon_adjust" id="send_feedback_action"><img src="/images/icons/comment.png" alt="Comment"/> <a onclick="$(\'#send_feedback_action\').hide(); $(\'#send_feedback_thanks\').hide(); $(\'#send_feedback\').show(); $(\'#feedback\').focus(); return false;" href="#">Send Feedback to Unfuddle</a></div>';
};


Unfuddle.Template.General.login = function(opt_data) {
  return '<h1 class="masthead">' + Config.accountTitle + '</h1><form id="login_form" onsubmit="return false;" method="post"><h2 id="form_title">Welcome Back <img src="/images/ajax.dots.gif" style="display:none" /></h2><fieldset id="apps_signin_form"><div class=\'errors\'></div><label for="username">Username:<span>*</span></label><input id="ajax_username" name="username" type="username" required=""><label for="password">Password:<span>*</span></label><input id="ajax_password" name="password" type="password" required=""><div style="margin-top: 10px;"><input id="ajax_remember_me" name="ajax_remember_me" type="checkbox" value="1"/><label for="ajax_remember_me">Remember Me</label></div><div style="position: relative;height: 52px;"><label for="password_reset"><a tabindex="10" href="#/support/password_reset">Password Reset</a></label><button id="submit_credentials" type="submit" class="gp_button">Sign In</button></div></fieldset></form>';
};


Unfuddle.Template.General.oldLogin = function(opt_data) {
  return '<h1 id="account_sign_in_title" style="text-align: center; margin: 10px auto 5px; display:none">&nbsp;<span style="white-space: nowrap;">Sign In</span></h1><div id="notice_container"></div><div id="login_page" class="wide"><p class="ajax_login_notice">Your session has expired. Please sign in to continue working.</p><div class="page_form"><form id="login_form" onsubmit="return false;" method="POST"><div class="panel" id="account_signin" style="width: 496px; margin: 0 auto 40px auto;"><div class="tl"></div><div class="tr"></div><div class="signin_type_select"><div id="user_pass_select" style="display: none;"><a href="#" onclick="$(\'#ajax_openid_url\').val(\'\');$(\'#sign_in_user_pass_select,#open_id_select,#password_reminder,#sign_in_username_password\').show();$(\'#sign_in_openid,#user_pass_select,#openid_help\').hide();return false;">Use username/password</a></div><div id="open_id_select"><a href="#" onclick="$(\'#ajax_username,#ajax_password\').val(\'\');$(\'#sign_in_user_pass_select,#open_id_select,#password_reminder,#sign_in_username_password\').hide();$(\'#sign_in_openid,#user_pass_select,#openid_help\').show();return false;" style="text-decoration: none;"><img style="position: relative; top: 3px;" src="/images/icons/openid_small_logo_yellow.gif" /> </a><a href="#" onclick="$(\'#ajax_username,#ajax_password\').val(\'\');$(\'#sign_in_user_pass_select,#open_id_select,#password_reminder,#sign_in_username_password\').hide();$(\'#sign_in_openid,#user_pass_select,#openid_help\').show();return false;">Use OpenID</a></div></div><div id="sign_in_username_password"><table class="invisible" style="width: 470px;"><tr valign="middle"><td width="70"><div class="label" style="margin-top: 0;">Username:</div></td><td><div><input type="text" value="" style="width: 400px;" onchange="if(Unfuddle.Utilities){Unfuddle.Utilities.delaySessionExpirationWith(2*60*1000);}" onkeypress="if(Unfuddle.Utilities){Unfuddle.Utilities.delaySessionExpirationWith(2*60*1000);}" name="ajax_username" id="ajax_username" class="title" /></div></td></tr><tr valign="middle"><td style="padding-bottom: 0;"><div class="label" style="margin-top: 0;">Password:</div></td><td style="padding-bottom: 0;"><div><input type="password" value="" style="width: 400px;" onchange="if(Unfuddle.Utilities){Unfuddle.Utilities.delaySessionExpirationWith(2*60*1000);}" onkeypress="if(Unfuddle.Utilities){Unfuddle.Utilities.delaySessionExpirationWith(2*60*1000);}" name="ajax_password" id="ajax_password" class="title" /></div></td></tr></table></div><div id="sign_in_openid" style="display: none;"><table class="invisible" style="width: 493px;"><tr valign="middle"><td width="80" style="width: 80px; text-align: right;"><div class="label" style="margin-top: 0;">OpenID:</div></td><td><div><input type="text" value="" style="width: 375px;" name="ajax_openid_url" id="ajax_openid_url" class="title" /></div></td></tr></table></div><table class="invisible" style="width: 490px;"><tr valign="middle"><td style="width: 86px; padding: 10px 0 3px 0;"></td><td style="width: 150px; padding: 10px 0 3px 0;"><div id="password_reminder" style="margin: 0; text-align: left;"><a tabindex="1000" href="#/support/password_reset">Password Reset</a></div><div style="display:none; position: relative; margin: 0pt; text-align: left;" id="openid_help"><a onclick="window.open(this.href,\'help_window\',\'height=400,width=600,scrollbars=1,resizable=1\');return false;" title="Help" class="link_to_help" href="http://unfuddle.com/docs/topics/openid"><img src="/images/icons/help.gif" class="help_button" alt="What is this?"></a> <a onclick="window.open(this.href,\'help_window\',\'height=400,width=600,scrollbars=1,resizable=1\');return false;" title="Help" class="link_to_help" href="http://unfuddle.com/docs/topics/openid">What is Open ID?</a></div></td><td style="width: 168px; padding: 10px 3px 3px 3px; text-align: right;"><div style="text-align: right; margin: 0pt;"><input type="checkbox" value="1" name="ajax_remember_me" id="ajax_remember_me"> <label for="ajax_remember_me">Remember Me</label></div></td><td style="width: 37px; padding: 10px 0 3px 3px;"><div style="text-align: right; margin: 0pt;"><input id="submit_credentials" type="submit" value="Sign In" name="commit"></div></td></tr></table><div class="clear"></div><div class="bl"></div><div class="br"></div></div></form></div></div>';
};


Unfuddle.Template.General.passwordReminder = function(opt_data) {
  return '<div class="success"></div><form id="login_form" onsubmit="return false;" method="post"><h2>Password Reset</h2><fieldset><div class=\'errors\'></div><label>Please enter your email address where you will soon receive instructions regarding the password reset.</label><label for="email">Email:<span>*</span></label><input id="email" name="email" type="email" required=""><div><button id="submit_email" type="submit" class="gp_button">Submit</button></div></fieldset></form>';
};


Unfuddle.Template.General.passwordReset = function(opt_data) {
  return '<div class="success"></div><form id="login_form" onsubmit="return false;" method="post"><h2>Password Reset</h2><fieldset><div class=\'errors\'></div><label>Enter the new password and confirm it.</label><label for="password">Password:<span>*</span></label><input id="password" name="password" type="password" required=""><label for="password_confirmation">Confirmation:<span>*</span></label><input id="password_confirmation" name="password_confirmation" type="password" required=""><div><button id="submit_email" type="submit" class="gp_button">Submit</button></div></fieldset></form>';
};

// This file was automatically generated from layout.soy.
// Please don't edit this file by hand.

if (typeof Unfuddle == 'undefined') { var Unfuddle = {}; }
if (typeof Unfuddle.Template == 'undefined') { Unfuddle.Template = {}; }
if (typeof Unfuddle.Template.Layout == 'undefined') { Unfuddle.Template.Layout = {}; }


Unfuddle.Template.Layout.header = function(opt_data) {
  return '<h1 id="header_title"></h1><ul id="main_menu"></ul><ul id="aux_menu"><li id="logged_user"></li> <li><a target="_blank" href="http://unfuddle.com/support">Help</a></li> <li><a id="personal_settings_link">Personal Settings</a></li> <li><a id="sign_out_link" href="#">Sign Out</a></li></ul><form id="search_form" onsubmit="return false;"><div id="search_box" style="position:absolute;"><input type="search" name="search_query" id="search_query" style="position:relative;z-index:100;width:200px" /> <span class="label">Search:</span></div></form>';
};


Unfuddle.Template.Layout.pageLayout = function(opt_data) {
  return '<!-- <div id="page_layout" style="height:100%;"> --><div id="wrap"><div id="container"><header class="clearfix"><div><a href="https://unfuddle.com" id="logo"><img src="/images/logo_sm_white.png" alt="Unfuddle" width="281" height="68"></a><nav><ul id="main_nav"><li><a href="https://unfuddle.com/support">Support</a></li><li><a href="https://unfuddle.com/blog">Blog</a></li><!-- <li><a class="action" href="https://unfuddle.com/signup">Sign Up</a></li> --></ul></nav></div></header><div id="main" role="main" class="clearfix"></div></div></div><footer><div id="contact-info"><a href="https://unfuddle.com/blog">Blog </a><a href="https://unfuddle.com/community">Forums </a><a href="https://twitter.com/unfuddle" rel="external" target="_blank">Twitter</a></div><div id="legal">&copy;2006-' + soy.$$escapeHtml(opt_data.currentYear) + ' <a href="/">Unfuddle</a> LLC. All rights reserved.<span><a href="https://unfuddle.com/privacy_policy" target="_blank"> Privacy Policy </a><a href="https://unfuddle.com/terms_of_service" target="_blank">Terms of Service </a><a href="https://unfuddle.com/security" target="_blank"> Security</a></span></div></footer><!-- </div> -->';
};


